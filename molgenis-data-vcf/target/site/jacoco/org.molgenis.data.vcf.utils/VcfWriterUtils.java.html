<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>VcfWriterUtils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">data-vcf</a> &gt; <a href="index.source.html" class="el_package">org.molgenis.data.vcf.utils</a> &gt; <span class="el_source">VcfWriterUtils.java</span></div><h1>VcfWriterUtils.java</h1><pre class="source lang-java linenums">package org.molgenis.data.vcf.utils;

import com.google.common.collect.Lists;
import net.sf.samtools.util.BlockCompressedInputStream;
import org.apache.commons.lang3.StringUtils;
import org.molgenis.data.Entity;
import org.molgenis.data.MolgenisDataException;
import org.molgenis.data.MolgenisInvalidFormatException;
import org.molgenis.data.meta.model.Attribute;
import org.molgenis.data.meta.model.EntityType;
import org.molgenis.data.vcf.VcfRepository;
import org.molgenis.data.vcf.model.VcfAttributes;

import java.io.*;
import java.util.*;
import java.util.stream.Collectors;
import java.util.stream.StreamSupport;

import static com.google.common.base.Joiner.on;
import static com.google.common.base.Strings.isNullOrEmpty;
import static com.google.common.collect.Iterables.transform;
import static java.nio.charset.StandardCharsets.UTF_8;
import static java.util.stream.Collectors.joining;
import static org.molgenis.data.meta.AttributeType.BOOL;
import static org.molgenis.data.support.EntityTypeUtils.isReferenceType;
import static org.molgenis.data.vcf.VcfRepository.DEFAULT_ATTRIBUTE_DESCRIPTION;
import static org.molgenis.data.vcf.model.VcfAttributes.*;

<span class="nc" id="L29">public class VcfWriterUtils</span>
{
	public static final String VARIANT = &quot;VARIANT&quot;;
	public static final String EFFECT = &quot;EFFECT&quot;;
	private static final char ANNOTATION_FIELD_SEPARATOR = ';';
	private static final String SPACE_PIPE_SEPERATOR = &quot; | &quot;;

<span class="nc" id="L36">	private static final LinkedList&lt;String&gt; VCF_ATTRIBUTE_NAMES = new LinkedList&lt;&gt;(</span>
<span class="nc" id="L37">			Arrays.asList(CHROM, POS, ID, REF, ALT, QUAL, FILTER));</span>
	private static final char PIPE_SEPARATOR = '|';

	/**
	 * Convert an vcfEntity to a VCF line Only output attributes that are in the attributesToInclude list, or all if
	 * attributesToInclude is empty
	 */
	public static void writeVcfHeader(File inputVcfFile, BufferedWriter outputVCFWriter,
			List&lt;Attribute&gt; addedAttributes) throws MolgenisInvalidFormatException, IOException
	{
<span class="nc" id="L47">		writeVcfHeader(inputVcfFile, outputVCFWriter, addedAttributes, Collections.emptyList());</span>
<span class="nc" id="L48">	}</span>

	/**
	 * Checks for previous annotations
	 *
	 * @param attributesToInclude , the Attribute to write to the VCF file, if empty writes all attributes
	 */
	public static void writeVcfHeader(File inputVcfFile, BufferedWriter outputVCFWriter,
			List&lt;Attribute&gt; addedAttributes, List&lt;String&gt; attributesToInclude)
			throws MolgenisInvalidFormatException, IOException
	{
<span class="nc" id="L59">		System.out.println(&quot;Detecting VCF column header...&quot;);</span>

<span class="nc" id="L61">		Scanner inputVcfFileScanner = createVcfFileScanner(inputVcfFile);</span>
<span class="nc" id="L62">		String line = inputVcfFileScanner.nextLine();</span>

<span class="nc" id="L64">		Map&lt;String, String&gt; infoHeaderLinesMap = new LinkedHashMap&lt;&gt;();</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">		if (line.startsWith(VcfRepository.PREFIX))</span>
		{
<span class="nc" id="L67">			line = processHeaders(outputVCFWriter, inputVcfFileScanner, line, infoHeaderLinesMap);</span>
<span class="nc" id="L68">			System.out.println(&quot;\nHeader line found:\n&quot; + line);</span>

<span class="nc" id="L70">			checkColumnHeaders(outputVCFWriter, inputVcfFileScanner, line);</span>
<span class="nc" id="L71">			writeInfoHeaders(outputVCFWriter, addedAttributes, attributesToInclude, infoHeaderLinesMap);</span>
<span class="nc" id="L72">			writeColumnHeaders(outputVCFWriter, line);</span>
		}
		else
		{
<span class="nc" id="L76">			outputVCFWriter.close();</span>
<span class="nc" id="L77">			inputVcfFileScanner.close();</span>
<span class="nc" id="L78">			throw new MolgenisInvalidFormatException(</span>
					&quot;Did not find ## on the first line, are you sure it is a VCF file?&quot;);
		}

<span class="nc" id="L82">		inputVcfFileScanner.close();</span>
<span class="nc" id="L83">	}</span>

	private static Scanner createVcfFileScanner(File vcfFile) throws IOException
	{
<span class="nc" id="L87">		InputStream inputStream = new FileInputStream(vcfFile);</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">		if (vcfFile.getName().endsWith(&quot;.gz&quot;))</span>
		{
<span class="nc" id="L90">			inputStream = new BlockCompressedInputStream(inputStream);</span>
		}
<span class="nc" id="L92">		return new Scanner(inputStream, UTF_8.name());</span>
	}

	/**
	 * Overload of writeToVcf to support a simpler call with only Entity and Writer.
	 */
	public static void writeToVcf(Entity vcfEntity, BufferedWriter writer) throws IOException
	{
<span class="nc" id="L100">		writeToVcf(vcfEntity, new ArrayList&lt;&gt;(), new ArrayList&lt;&gt;(), writer);</span>
<span class="nc" id="L101">	}</span>

	/**
	 * Convert an vcfEntity to a VCF line Only output attributes that are in the attributesToInclude list, or all if
	 * attributesToInclude is empty
	 */
	public static void writeToVcf(Entity vcfEntity, List&lt;Attribute&gt; addedAttributes, List&lt;String&gt; attributesToInclude,
			BufferedWriter writer) throws IOException
	{
<span class="nc" id="L110">		addStandardFieldsToVcf(vcfEntity, writer);</span>
<span class="nc" id="L111">		writeInfoData(vcfEntity, writer, addedAttributes, attributesToInclude);</span>

		// if we have SAMPLE data, add to output VCF
<span class="nc" id="L114">		Iterable&lt;Entity&gt; sampleEntities = vcfEntity.getEntities(SAMPLES);</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">		if (sampleEntities != null)</span>
		{
<span class="nc" id="L117">			addSampleEntitiesToVcf(sampleEntities, writer);</span>
		}
<span class="nc" id="L119">	}</span>

	// ****************
	// * Parse header *
	// ****************

	private static String processHeaders(BufferedWriter outputVCFWriter, Scanner inputVcfFileScanner, String line,
			Map&lt;String, String&gt; infoHeaderLinesMap) throws IOException
	{
<span class="nc bnc" id="L128" title="All 2 branches missed.">		while (inputVcfFileScanner.hasNextLine())</span>
		{
<span class="nc bnc" id="L130" title="All 2 branches missed.">			if (line.startsWith(VcfRepository.PREFIX + VcfAttributes.INFO))</span>
			{
<span class="nc" id="L132">				infoHeaderLinesMap.put(VcfUtils.getIdFromInfoField(line), line);</span>
			}
<span class="nc bnc" id="L134" title="All 2 branches missed.">			else if (line.startsWith(VcfRepository.PREFIX))</span>
			{
<span class="nc" id="L136">				outputVCFWriter.write(line);</span>
<span class="nc" id="L137">				outputVCFWriter.newLine();</span>
			}
			else
			{
				break;
			}
<span class="nc" id="L143">			line = inputVcfFileScanner.nextLine();</span>

<span class="nc" id="L145">			System.out.print(&quot;.&quot;);</span>
		}
<span class="nc" id="L147">		return line;</span>
	}

	private static void checkColumnHeaders(BufferedWriter outputVCFWriter, Scanner inputVcfFileScanner, String line)
			throws IOException, MolgenisInvalidFormatException
	{
<span class="nc bnc" id="L153" title="All 2 branches missed.">		if (!line.startsWith(CHROM))</span>
		{
<span class="nc" id="L155">			outputVCFWriter.close();</span>
<span class="nc" id="L156">			inputVcfFileScanner.close();</span>
<span class="nc" id="L157">			throw new MolgenisInvalidFormatException(</span>
					&quot;Header does not start with #CHROM, are you sure it is a VCF file?&quot;);
		}
<span class="nc" id="L160">	}</span>

	// ****************
	// * Write header *
	// ****************

	private static void writeColumnHeaders(BufferedWriter outputVCFWriter, String line) throws IOException
	{
<span class="nc" id="L168">		outputVCFWriter.write(line);</span>
<span class="nc" id="L169">		outputVCFWriter.newLine();</span>
<span class="nc" id="L170">	}</span>

	private static void writeInfoHeaders(BufferedWriter outputVCFWriter, List&lt;Attribute&gt; annotatorAttributes,
			List&lt;String&gt; attributesToInclude, Map&lt;String, String&gt; infoHeaderLinesMap) throws IOException
	{
<span class="nc" id="L175">		Map&lt;String, Attribute&gt; annotatorAttributesMap = VcfUtils.getAttributesMapFromList(annotatorAttributes);</span>
<span class="nc" id="L176">		writeExistingInfoHeaders(outputVCFWriter, infoHeaderLinesMap, annotatorAttributesMap);</span>
<span class="nc" id="L177">		writeAddedInfoHeaders(outputVCFWriter, attributesToInclude, annotatorAttributesMap, infoHeaderLinesMap);</span>
<span class="nc" id="L178">	}</span>

	private static void writeAddedInfoHeaders(BufferedWriter outputVCFWriter, List&lt;String&gt; attributesToInclude,
			Map&lt;String, Attribute&gt; annotatorAttributes, Map&lt;String, String&gt; infoHeaderLinesMap) throws IOException
	{
<span class="nc bnc" id="L183" title="All 2 branches missed.">		for (Attribute annotatorInfoAttr : annotatorAttributes.values())</span>
		{
<span class="nc bnc" id="L185" title="All 4 branches missed.">			if (attributesToInclude.isEmpty() || attributesToInclude.contains(annotatorInfoAttr.getName())</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">					|| isReferenceType(annotatorInfoAttr))</span>
			{
<span class="nc" id="L188">				outputVCFWriter.write(</span>
<span class="nc" id="L189">						createInfoStringFromAttribute(annotatorAttributes.get(annotatorInfoAttr.getName()),</span>
<span class="nc" id="L190">								attributesToInclude, infoHeaderLinesMap.get(annotatorInfoAttr.getName())));</span>
<span class="nc" id="L191">				outputVCFWriter.newLine();</span>
			}
<span class="nc" id="L193">		}</span>
<span class="nc" id="L194">	}</span>

	private static String createInfoStringFromAttribute(Attribute infoAttribute, List&lt;String&gt; attributesToInclude,
			String currentInfoField)
	{
<span class="nc" id="L199">		String attributeName = infoAttribute.getName();</span>
<span class="nc" id="L200">		StringBuilder sb = new StringBuilder();</span>

<span class="nc" id="L202">		sb.append(&quot;##INFO=&lt;ID=&quot;);</span>
<span class="nc" id="L203">		sb.append(attributeName);</span>
		// FIXME: once we support list of primitives we can calculate based on combination of type and nillable
<span class="nc" id="L205">		sb.append(&quot;,Number=.&quot;);</span>
<span class="nc" id="L206">		sb.append(&quot;,Type=&quot;);</span>
<span class="nc" id="L207">		sb.append(VcfUtils.toVcfDataType(infoAttribute.getDataType()));</span>
<span class="nc" id="L208">		sb.append(&quot;,Description=\&quot;&quot;);</span>

		// http://samtools.github.io/hts-specs/VCFv4.1.pdf --&gt; &quot;The Description
		// value must be surrounded by double-quotes. Double-quote character can be escaped with backslash \ and
		// backslash as \\.&quot;
<span class="nc bnc" id="L213" title="All 2 branches missed.">		if (StringUtils.isBlank(infoAttribute.getDescription()))</span>
		{
<span class="nc bnc" id="L215" title="All 4 branches missed.">			if (isReferenceType(infoAttribute) &amp;&amp; !attributeName.equals(SAMPLES))</span>
			{
<span class="nc bnc" id="L217" title="All 2 branches missed.">				String currentAttributesString =</span>
<span class="nc" id="L218">						currentInfoField != null ? currentInfoField.substring((currentInfoField.indexOf(&quot;'&quot;) + 1),</span>
<span class="nc" id="L219">								currentInfoField.lastIndexOf(&quot;'&quot;)) : &quot;&quot;;</span>
<span class="nc" id="L220">				writeRefAttributePartsToInfoDescription(infoAttribute, attributesToInclude, attributeName, sb,</span>
						currentAttributesString);
<span class="nc" id="L222">			}</span>
			else
			{
<span class="nc" id="L225">				sb.append(DEFAULT_ATTRIBUTE_DESCRIPTION);</span>
			}
		}
		else
		{
<span class="nc" id="L230">			sb.append(infoAttribute.getDescription().replace(&quot;\&quot;&quot;, &quot;\\\&quot;&quot;).replace(&quot;\n&quot;, &quot; &quot;));</span>
		}
<span class="nc" id="L232">		sb.append(&quot;\&quot;&gt;&quot;);</span>
<span class="nc" id="L233">		return sb.toString();</span>
	}

	private static void writeRefAttributePartsToInfoDescription(Attribute infoAttribute,
			List&lt;String&gt; attributesToInclude, String attributeName, StringBuilder sb, String existingAttributes)
	{
<span class="nc" id="L239">		Iterable&lt;Attribute&gt; atomicAttributes = infoAttribute.getRefEntity().getAtomicAttributes();</span>
<span class="nc" id="L240">		sb.append(attributeName);</span>
<span class="nc" id="L241">		sb.append(&quot; annotations: '&quot;);</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">		if (!existingAttributes.isEmpty())</span>
		{
<span class="nc" id="L244">			sb.append(existingAttributes);</span>
<span class="nc" id="L245">			sb.append(&quot; | &quot;);</span>
		}
<span class="nc" id="L247">		sb.append(refAttributesToString(atomicAttributes, attributesToInclude).replace(&quot;\\&quot;, &quot;\\\\&quot;)</span>
<span class="nc" id="L248">																			  .replace(&quot;\&quot;&quot;, &quot;\\\&quot;&quot;)</span>
<span class="nc" id="L249">																			  .replace(&quot;\n&quot;, &quot; &quot;));</span>
<span class="nc" id="L250">		sb.append(&quot;'&quot;);</span>
<span class="nc" id="L251">	}</span>

	private static String refAttributesToString(Iterable&lt;Attribute&gt; atomicAttributes, List&lt;String&gt; attributesToInclude)
	{
<span class="nc" id="L255">		Iterable&lt;Attribute&gt; attributes = StreamSupport.stream(atomicAttributes.spliterator(), false)</span>
<span class="nc bnc" id="L256" title="All 4 branches missed.">													  .filter(attribute -&gt; (attribute.isVisible() &amp;&amp; isOutputAttribute(</span>
<span class="nc" id="L257">															  attribute, Lists.newArrayList(atomicAttributes),</span>
															  attributesToInclude)))
<span class="nc" id="L259">													  .collect(Collectors.toList());</span>
<span class="nc" id="L260">		return on(SPACE_PIPE_SEPERATOR).join(transform(attributes, Attribute::getName));</span>
	}

	private static void writeExistingInfoHeaders(BufferedWriter outputVCFWriter, Map&lt;String, String&gt; infoHeaderLinesMap,
			Map&lt;String, Attribute&gt; annotatorAttributes) throws IOException
	{
<span class="nc bnc" id="L266" title="All 2 branches missed.">		for (String infoHeaderFieldKey : infoHeaderLinesMap.keySet())</span>
		{
<span class="nc bnc" id="L268" title="All 2 branches missed.">			if (!annotatorAttributes.containsKey(infoHeaderFieldKey))</span>
			{
<span class="nc" id="L270">				outputVCFWriter.write(infoHeaderLinesMap.get(infoHeaderFieldKey));</span>
<span class="nc" id="L271">				outputVCFWriter.newLine();</span>
			}
<span class="nc" id="L273">		}</span>
<span class="nc" id="L274">	}</span>

	// ***************
	// * Write data *
	// ***************

	private static void addStandardFieldsToVcf(Entity vcfEntity, BufferedWriter writer) throws IOException
	{
<span class="nc bnc" id="L282" title="All 2 branches missed.">		for (String attribute : VCF_ATTRIBUTE_NAMES)</span>
		{
<span class="nc" id="L284">			Object value = vcfEntity.get(attribute);</span>
<span class="nc" id="L285">			String stringValue = &quot;.&quot;;</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">			if (value != null) stringValue = value.toString();</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">			if (stringValue.isEmpty()) stringValue = &quot;.&quot;;</span>
<span class="nc" id="L288">			writer.write(stringValue);</span>
<span class="nc" id="L289">			writer.write('\t');</span>
<span class="nc" id="L290">		}</span>
<span class="nc" id="L291">	}</span>

	private static void writeInfoData(Entity vcfEntity, BufferedWriter writer, List&lt;Attribute&gt; annotatorAttributes,
			List&lt;String&gt; attributesToInclude) throws IOException
	{
<span class="nc" id="L296">		boolean hasInfoFields = false;</span>

<span class="nc" id="L298">		List&lt;Attribute&gt; attributes = StreamSupport.stream(vcfEntity.getEntityType().getAllAttributes().spliterator(),</span>
				false)
<span class="nc bnc" id="L300" title="All 2 branches missed.">												  .filter(attr -&gt; !(VCF_ATTRIBUTE_NAMES.contains(attr.getName()) || attr</span>
<span class="nc" id="L301">														  .getName()</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">														  .equals(INFO)))</span>
<span class="nc" id="L303">												  .filter(attr -&gt; isOutputAttribute(attr, annotatorAttributes,</span>
														  attributesToInclude))
<span class="nc" id="L305">												  .collect(Collectors.toList());</span>

<span class="nc" id="L307">		List&lt;String&gt; infoFieldStrs = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">		for (Attribute attribute : attributes)</span>
		{
<span class="nc" id="L310">			String infoFieldStr = getInfoFieldString(vcfEntity, attribute);</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">			if (infoFieldStr != null)</span>
			{
<span class="nc" id="L313">				infoFieldStrs.add(infoFieldStr);</span>
			}
<span class="nc" id="L315">		}</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">		hasInfoFields = !infoFieldStrs.isEmpty();</span>
<span class="nc" id="L317">		writer.append(infoFieldStrs.stream().collect(joining(String.valueOf(ANNOTATION_FIELD_SEPARATOR))));</span>

<span class="nc" id="L319">		String refEntityAttributesInfoFields = parseRefAttributesToDataString(vcfEntity, annotatorAttributes,</span>
				attributesToInclude);
<span class="nc bnc" id="L321" title="All 2 branches missed.">		if (!isNullOrEmpty(refEntityAttributesInfoFields))</span>
		{
<span class="nc bnc" id="L323" title="All 2 branches missed.">			if (hasInfoFields)</span>
			{
<span class="nc" id="L325">				writer.append(ANNOTATION_FIELD_SEPARATOR);</span>
			}
<span class="nc" id="L327">			writer.append(refEntityAttributesInfoFields);</span>
<span class="nc" id="L328">			hasInfoFields = true;</span>
		}
<span class="nc bnc" id="L330" title="All 2 branches missed.">		if (!hasInfoFields)</span>
		{
<span class="nc" id="L332">			writer.append('.');</span>
		}
<span class="nc" id="L334">	}</span>

	private static String parseRefAttributesToDataString(Entity vcfEntity, List&lt;Attribute&gt; annotatorAttributes,
			List&lt;String&gt; attributesToInclude)
	{
<span class="nc" id="L339">		Iterable&lt;Attribute&gt; attributes = vcfEntity.getEntityType().getAllAttributes();</span>
<span class="nc" id="L340">		StringBuilder refEntityInfoFields = new StringBuilder();</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">		for (Attribute attribute : attributes)</span>
		{
<span class="nc" id="L343">			String attributeName = attribute.getName();</span>
<span class="nc bnc" id="L344" title="All 4 branches missed.">			if (isReferenceType(attribute) &amp;&amp; !attributeName.equals(SAMPLES))</span>
			{
				// If the MREF field is empty, no effects were found, so we do not add an EFFECT field to this entity
<span class="nc bnc" id="L347" title="All 4 branches missed.">				if (vcfEntity.get(attributeName) != null &amp;&amp; isOutputAttribute(attribute, annotatorAttributes,</span>
						attributesToInclude))
				{

<span class="nc" id="L351">					parseRefFieldsToInfoField(vcfEntity.getEntities(attributeName), attribute, refEntityInfoFields,</span>
							annotatorAttributes, attributesToInclude);
				}
			}

<span class="nc" id="L356">		}</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">		if (refEntityInfoFields.length() &gt; 0</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">				&amp;&amp; refEntityInfoFields.charAt(refEntityInfoFields.length() - 1) == ANNOTATION_FIELD_SEPARATOR)</span>
		{
<span class="nc" id="L360">			refEntityInfoFields.setLength(refEntityInfoFields.length() - 1);</span>
		}
<span class="nc" id="L362">		return refEntityInfoFields.toString();</span>
	}

	private static String getInfoFieldString(Entity vcfEntity, Attribute attribute)
	{
<span class="nc" id="L367">		String infoFieldValue = null;</span>

<span class="nc" id="L369">		String infoAttrName = attribute.getName();</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">		if (attribute.getDataType() == BOOL)</span>
		{
<span class="nc" id="L372">			Boolean infoAttrBoolValue = vcfEntity.getBoolean(infoAttrName);</span>
<span class="nc bnc" id="L373" title="All 4 branches missed.">			if (infoAttrBoolValue != null &amp;&amp; infoAttrBoolValue)</span>
			{
<span class="nc" id="L375">				infoFieldValue = infoAttrName;</span>
			}
<span class="nc" id="L377">		}</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">		else if (!isReferenceType(attribute))</span>
		{

<span class="nc" id="L381">			Object infoAttrStringValue = vcfEntity.get(infoAttrName);</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">			if (infoAttrStringValue != null)</span>
			{
<span class="nc" id="L384">				infoFieldValue = infoAttrName + '=' + infoAttrStringValue.toString();</span>
			}
		}

<span class="nc" id="L388">		return infoFieldValue;</span>
	}

	/**
	 * Create a INFO field annotation and add values
	 */
	private static void parseRefFieldsToInfoField(Iterable&lt;Entity&gt; refEntities, Attribute attribute,
			StringBuilder refEntityInfoFields, List&lt;Attribute&gt; annotatorAttributes, List&lt;String&gt; attributesToInclude)
	{
<span class="nc" id="L397">		boolean secondValuePresent = false;</span>
<span class="nc bnc" id="L398" title="All 2 branches missed.">		for (Entity refEntity : refEntities)</span>
		{
<span class="nc" id="L400">			Iterable&lt;Attribute&gt; refAttributes = refEntity.getEntityType().getAttributes();</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">			if (!secondValuePresent)</span>
			{
<span class="nc" id="L403">				refEntityInfoFields.append(attribute.getName());</span>
<span class="nc" id="L404">				refEntityInfoFields.append(&quot;=&quot;);</span>
<span class="nc" id="L405">				addEntityValuesToRefEntityInfoField(refEntityInfoFields, refEntity, refAttributes, annotatorAttributes,</span>
						attributesToInclude);
			}
			else
			{
<span class="nc" id="L410">				refEntityInfoFields.append(&quot;,&quot;);</span>
<span class="nc" id="L411">				addEntityValuesToRefEntityInfoField(refEntityInfoFields, refEntity, refAttributes, annotatorAttributes,</span>
						attributesToInclude);
			}
<span class="nc" id="L414">			secondValuePresent = true;</span>
<span class="nc" id="L415">		}</span>
<span class="nc" id="L416">		refEntityInfoFields.append(ANNOTATION_FIELD_SEPARATOR);</span>
<span class="nc" id="L417">	}</span>

	/**
	 * Add the values of each EFFECT entity to the info field
	 */
	private static void addEntityValuesToRefEntityInfoField(StringBuilder refEntityInfoFields, Entity refEntity,
			Iterable&lt;Attribute&gt; refAttributes, List&lt;Attribute&gt; annotatorAttributes, List&lt;String&gt; attributesToInclude)
	{
<span class="nc" id="L425">		boolean previousValuePresent = false;</span>
<span class="nc bnc" id="L426" title="All 2 branches missed.">		for (Attribute refAttribute : refAttributes)</span>
		{
<span class="nc bnc" id="L428" title="All 6 branches missed.">			if (refAttribute.isVisible() &amp;&amp; !isReferenceType(refAttribute) &amp;&amp; isOutputAttribute(refAttribute,</span>
					annotatorAttributes, attributesToInclude))
			{
<span class="nc bnc" id="L431" title="All 2 branches missed.">				if (previousValuePresent) refEntityInfoFields.append(PIPE_SEPARATOR);</span>
<span class="nc bnc" id="L432" title="All 2 branches missed.">				String value = refEntity.getString(refAttribute.getName()) == null ? &quot;&quot; : refEntity.getString(</span>
<span class="nc" id="L433">						refAttribute.getName());</span>
<span class="nc" id="L434">				refEntityInfoFields.append(value);</span>
<span class="nc" id="L435">				previousValuePresent = true;</span>
			}
<span class="nc" id="L437">		}</span>
<span class="nc" id="L438">	}</span>

	// *****************
	// * Write samples *
	// *****************

	private static void addSampleEntitiesToVcf(Iterable&lt;Entity&gt; sampleEntities, BufferedWriter writer)
			throws IOException
	{
<span class="nc" id="L447">		boolean first = true;</span>
<span class="nc bnc" id="L448" title="All 2 branches missed.">		for (Entity sample : sampleEntities)</span>
		{
<span class="nc" id="L450">			writer.append('\t');</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">			if (first)</span>
			{
<span class="nc" id="L453">				writeFormatString(writer, sample);</span>
			}
<span class="nc" id="L455">			writeSampleData(writer, sample);</span>
<span class="nc" id="L456">			first = false;</span>
<span class="nc" id="L457">		}</span>
<span class="nc" id="L458">	}</span>

	private static void writeSampleData(BufferedWriter writer, Entity sample) throws IOException
	{
<span class="nc" id="L462">		StringBuilder sampleColumn = new StringBuilder();</span>
<span class="nc bnc" id="L463" title="All 2 branches missed.">		if (sample.getEntityType().getAttribute(FORMAT_GT) != null)</span>
		{
<span class="nc" id="L465">			String sampleAttrValue = sample.getString(FORMAT_GT);</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">			if (sampleAttrValue != null)</span>
			{
<span class="nc" id="L468">				sampleColumn.append(sampleAttrValue);</span>
			}
			else
			{
<span class="nc" id="L472">				sampleColumn.append(&quot;.&quot;);</span>
			}

		}
<span class="nc" id="L476">		EntityType entityType = sample.getEntityType();</span>
<span class="nc bnc" id="L477" title="All 2 branches missed.">		for (Attribute sampleAttribute : entityType.getAttributes())</span>
		{
<span class="nc" id="L479">			String sampleAttributeName = sampleAttribute.getName();</span>
<span class="nc bnc" id="L480" title="All 4 branches missed.">			if (!sampleAttributeName.equals(FORMAT_GT) &amp;&amp; !sampleAttributeName.equals(VcfRepository.ORIGINAL_NAME))</span>
			{
				// skip the field that were generated for the use of the entity within molgenis
<span class="nc bnc" id="L483" title="All 4 branches missed.">				if (!sampleAttribute.equals(entityType.getIdAttribute()) &amp;&amp; !sampleAttribute.equals(</span>
<span class="nc" id="L484">						entityType.getLabelAttribute()))</span>
				{
<span class="nc bnc" id="L486" title="All 2 branches missed.">					if (sampleColumn.length() != 0) sampleColumn.append(&quot;:&quot;);</span>
<span class="nc" id="L487">					Object sampleAttrValue = sample.get(sampleAttributeName);</span>
<span class="nc bnc" id="L488" title="All 2 branches missed.">					if (sampleAttrValue != null)</span>
					{
<span class="nc" id="L490">						sampleColumn.append(sampleAttrValue.toString());</span>
					}
					else
					{
<span class="nc" id="L494">						sampleColumn.append(&quot;.&quot;);</span>
					}
				}
			}
<span class="nc" id="L498">		}</span>
<span class="nc" id="L499">		writer.write(sampleColumn.toString());</span>
<span class="nc" id="L500">	}</span>

	private static void writeFormatString(BufferedWriter writer, Entity sample) throws IOException
	{
<span class="nc" id="L504">		StringBuilder formatColumn = new StringBuilder();</span>
		// write GT first if available
<span class="nc bnc" id="L506" title="All 2 branches missed.">		if (sample.getEntityType().getAttribute(FORMAT_GT) != null)</span>
		{
<span class="nc" id="L508">			formatColumn.append(FORMAT_GT);</span>
		}
<span class="nc" id="L510">		EntityType entityType = sample.getEntityType();</span>
<span class="nc bnc" id="L511" title="All 2 branches missed.">		for (Attribute sampleAttribute : entityType.getAttributes())</span>
		{
<span class="nc" id="L513">			String sampleAttributeName = sampleAttribute.getName();</span>
<span class="nc bnc" id="L514" title="All 4 branches missed.">			if (!sampleAttributeName.equals(FORMAT_GT) &amp;&amp; !sampleAttributeName.equals(VcfRepository.ORIGINAL_NAME))</span>
			{
				// skip the field that were generated for the use of the entity within molgenis
<span class="nc bnc" id="L517" title="All 4 branches missed.">				if (!sampleAttribute.equals(entityType.getIdAttribute()) &amp;&amp; !sampleAttribute.equals(</span>
<span class="nc" id="L518">						entityType.getLabelAttribute()))</span>
				{
<span class="nc bnc" id="L520" title="All 2 branches missed.">					if (formatColumn.length() != 0) formatColumn.append(':');</span>
<span class="nc" id="L521">					formatColumn.append(sampleAttributeName);</span>
				}
			}
<span class="nc" id="L524">		}</span>
<span class="nc bnc" id="L525" title="All 2 branches missed.">		if (formatColumn.length() &gt; 0)</span>
		{
<span class="nc" id="L527">			formatColumn.append('\t');</span>
<span class="nc" id="L528">			writer.write(formatColumn.toString());</span>
		}
		else
		{
<span class="nc" id="L532">			throw new MolgenisDataException(&quot;Missing FORMAT information while trying to print first sample&quot;);</span>
		}
<span class="nc" id="L534">	}</span>

	// *********************
	// * Utility functions *
	// *********************

	private static boolean isOutputAttribute(Attribute attribute, List&lt;Attribute&gt; addedAttributes,
			List&lt;String&gt; attributesToInclude)
	{
<span class="nc" id="L543">		List&lt;Attribute&gt; expandedAddedAttributes = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L544" title="All 2 branches missed.">		for (Attribute annotatorAttr : addedAttributes)</span>
		{
<span class="nc bnc" id="L546" title="All 2 branches missed.">			if (isReferenceType(annotatorAttr))</span>
<span class="nc" id="L547">				expandedAddedAttributes.addAll(Lists.newArrayList(annotatorAttr.getRefEntity().getAtomicAttributes()));</span>
<span class="nc" id="L548">			else expandedAddedAttributes.add(annotatorAttr);</span>
<span class="nc" id="L549">		}</span>

<span class="nc" id="L551">		List&lt;String&gt; annotatorAttributeNames = expandedAddedAttributes.stream()</span>
<span class="nc" id="L552">																	  .map(Attribute::getName)</span>
<span class="nc" id="L553">																	  .collect(Collectors.toList());</span>
		// always write all fields that were not added by this annotation run.
		// else write the field if it was specified or if nothing was sepcified at all.
<span class="nc bnc" id="L556" title="All 4 branches missed.">		return (!annotatorAttributeNames.contains(attribute.getName()) || attributesToInclude.contains(</span>
<span class="nc bnc" id="L557" title="All 4 branches missed.">				attribute.getName()) || attributesToInclude.isEmpty()) &amp;&amp; attribute.isVisible() &amp;&amp; !attribute.getName()</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">																											 .equals(VcfAttributes.SAMPLES);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>