<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ThingModifyCommandAdapter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Eclipse Ditto :: Protocol Adapter</a> &gt; <a href="index.source.html" class="el_package">org.eclipse.ditto.protocoladapter</a> &gt; <span class="el_source">ThingModifyCommandAdapter.java</span></div><h1>ThingModifyCommandAdapter.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2017 Bosch Software Innovations GmbH.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v2.0
 * which accompanies this distribution, and is available at
 * https://www.eclipse.org/org/documents/epl-2.0/index.php
 *
 * Contributors:
 *    Bosch Software Innovations GmbH - initial contribution
 */
package org.eclipse.ditto.protocoladapter;

import java.util.HashMap;
import java.util.Map;
import java.util.Optional;

import org.eclipse.ditto.json.JsonObject;
import org.eclipse.ditto.json.JsonPointer;
import org.eclipse.ditto.json.JsonValue;
import org.eclipse.ditto.signals.commands.things.modify.CreateThing;
import org.eclipse.ditto.signals.commands.things.modify.DeleteAclEntry;
import org.eclipse.ditto.signals.commands.things.modify.DeleteAttribute;
import org.eclipse.ditto.signals.commands.things.modify.DeleteAttributes;
import org.eclipse.ditto.signals.commands.things.modify.DeleteFeature;
import org.eclipse.ditto.signals.commands.things.modify.DeleteFeatureDefinition;
import org.eclipse.ditto.signals.commands.things.modify.DeleteFeatureProperties;
import org.eclipse.ditto.signals.commands.things.modify.DeleteFeatureProperty;
import org.eclipse.ditto.signals.commands.things.modify.DeleteFeatures;
import org.eclipse.ditto.signals.commands.things.modify.DeleteThing;
import org.eclipse.ditto.signals.commands.things.modify.ModifyAcl;
import org.eclipse.ditto.signals.commands.things.modify.ModifyAclEntry;
import org.eclipse.ditto.signals.commands.things.modify.ModifyAttribute;
import org.eclipse.ditto.signals.commands.things.modify.ModifyAttributes;
import org.eclipse.ditto.signals.commands.things.modify.ModifyFeature;
import org.eclipse.ditto.signals.commands.things.modify.ModifyFeatureDefinition;
import org.eclipse.ditto.signals.commands.things.modify.ModifyFeatureProperties;
import org.eclipse.ditto.signals.commands.things.modify.ModifyFeatureProperty;
import org.eclipse.ditto.signals.commands.things.modify.ModifyFeatures;
import org.eclipse.ditto.signals.commands.things.modify.ModifyThing;
import org.eclipse.ditto.signals.commands.things.modify.ThingModifyCommand;

/**
 * Adapter for mapping a {@link ThingModifyCommand} to and from an {@link Adaptable}.
 */
final class ThingModifyCommandAdapter extends AbstractAdapter&lt;ThingModifyCommand&gt; {

    private ThingModifyCommandAdapter(final Map&lt;String, JsonifiableMapper&lt;ThingModifyCommand&gt;&gt; mappingStrategies) {
<span class="fc" id="L49">        super(mappingStrategies);</span>
<span class="fc" id="L50">    }</span>

    /**
     * Returns a new ThingModifyCommandAdapter.
     *
     * @return the adapter.
     */
    public static ThingModifyCommandAdapter newInstance() {
<span class="fc" id="L58">        return new ThingModifyCommandAdapter(mappingStrategies());</span>
    }

    private static Map&lt;String, JsonifiableMapper&lt;ThingModifyCommand&gt;&gt; mappingStrategies() {
<span class="fc" id="L62">        final Map&lt;String, JsonifiableMapper&lt;ThingModifyCommand&gt;&gt; mappingStrategies = new HashMap&lt;&gt;();</span>

<span class="fc" id="L64">        mappingStrategies.put(CreateThing.TYPE,</span>
<span class="fc" id="L65">                adaptable -&gt; CreateThing.of(thingFrom(adaptable), initialPolicyForCreateThingFrom(adaptable),</span>
<span class="fc" id="L66">                        dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L67">        mappingStrategies.put(ModifyThing.TYPE,</span>
<span class="fc" id="L68">                adaptable -&gt; ModifyThing.of(thingIdFrom(adaptable), thingFrom(adaptable),</span>
<span class="fc" id="L69">                        initialPolicyForModifyThingFrom(adaptable), dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L70">        mappingStrategies.put(DeleteThing.TYPE,</span>
<span class="fc" id="L71">                adaptable -&gt; DeleteThing.of(thingIdFrom(adaptable), dittoHeadersFrom(adaptable)));</span>

<span class="fc" id="L73">        mappingStrategies.put(ModifyAcl.TYPE,</span>
<span class="fc" id="L74">                adaptable -&gt; ModifyAcl.of(thingIdFrom(adaptable), aclFrom(adaptable), dittoHeadersFrom(adaptable)));</span>

<span class="fc" id="L76">        mappingStrategies.put(ModifyAclEntry.TYPE, adaptable -&gt; ModifyAclEntry.of(thingIdFrom(adaptable),</span>
<span class="fc" id="L77">                aclEntryFrom(adaptable), dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L78">        mappingStrategies.put(DeleteAclEntry.TYPE, adaptable -&gt; DeleteAclEntry.of(thingIdFrom(adaptable),</span>
<span class="fc" id="L79">                authorizationSubjectFrom(adaptable), dittoHeadersFrom(adaptable)));</span>

<span class="fc" id="L81">        mappingStrategies.put(ModifyAttributes.TYPE, adaptable -&gt; ModifyAttributes.of(thingIdFrom(adaptable),</span>
<span class="fc" id="L82">                attributesFrom(adaptable), dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L83">        mappingStrategies.put(DeleteAttributes.TYPE,</span>
<span class="fc" id="L84">                adaptable -&gt; DeleteAttributes.of(thingIdFrom(adaptable), dittoHeadersFrom(adaptable)));</span>

<span class="fc" id="L86">        mappingStrategies.put(ModifyAttribute.TYPE, adaptable -&gt; ModifyAttribute.of(thingIdFrom(adaptable),</span>
<span class="fc" id="L87">                attributePointerFrom(adaptable), attributeValueFrom(adaptable), dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L88">        mappingStrategies.put(DeleteAttribute.TYPE, adaptable -&gt; DeleteAttribute.of(thingIdFrom(adaptable),</span>
<span class="fc" id="L89">                attributePointerFrom(adaptable), dittoHeadersFrom(adaptable)));</span>

<span class="fc" id="L91">        mappingStrategies.put(ModifyFeatures.TYPE, adaptable -&gt; ModifyFeatures.of(thingIdFrom(adaptable),</span>
<span class="fc" id="L92">                featuresFrom(adaptable), dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L93">        mappingStrategies.put(DeleteFeatures.TYPE,</span>
<span class="fc" id="L94">                adaptable -&gt; DeleteFeatures.of(thingIdFrom(adaptable), dittoHeadersFrom(adaptable)));</span>

<span class="fc" id="L96">        mappingStrategies.put(ModifyFeature.TYPE,</span>
<span class="fc" id="L97">                adaptable -&gt; ModifyFeature.of(thingIdFrom(adaptable), featureFrom(adaptable),</span>
<span class="fc" id="L98">                        dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L99">        mappingStrategies.put(DeleteFeature.TYPE, adaptable -&gt; DeleteFeature.of(thingIdFrom(adaptable),</span>
<span class="fc" id="L100">                featureIdFrom(adaptable), dittoHeadersFrom(adaptable)));</span>

<span class="fc" id="L102">        mappingStrategies.put(ModifyFeatureDefinition.TYPE,</span>
<span class="fc" id="L103">                adaptable -&gt; ModifyFeatureDefinition.of(thingIdFrom(adaptable), featureIdFrom(adaptable),</span>
<span class="fc" id="L104">                        featureDefinitionFrom(adaptable), dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L105">        mappingStrategies.put(DeleteFeatureDefinition.TYPE, adaptable -&gt; DeleteFeatureDefinition</span>
<span class="fc" id="L106">                .of(thingIdFrom(adaptable), featureIdFrom(adaptable), dittoHeadersFrom(adaptable)));</span>

<span class="fc" id="L108">        mappingStrategies.put(ModifyFeatureProperties.TYPE,</span>
<span class="fc" id="L109">                adaptable -&gt; ModifyFeatureProperties.of(thingIdFrom(adaptable), featureIdFrom(adaptable),</span>
<span class="fc" id="L110">                        featurePropertiesFrom(adaptable), dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L111">        mappingStrategies.put(DeleteFeatureProperties.TYPE, adaptable -&gt; DeleteFeatureProperties</span>
<span class="fc" id="L112">                .of(thingIdFrom(adaptable), featureIdFrom(adaptable), dittoHeadersFrom(adaptable)));</span>

<span class="fc" id="L114">        mappingStrategies</span>
<span class="fc" id="L115">                .put(ModifyFeatureProperty.TYPE,</span>
<span class="fc" id="L116">                        adaptable -&gt; ModifyFeatureProperty.of(thingIdFrom(adaptable), featureIdFrom(adaptable),</span>
<span class="fc" id="L117">                                featurePropertyPointerFrom(adaptable), featurePropertyValueFrom(adaptable),</span>
<span class="fc" id="L118">                                dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L119">        mappingStrategies.put(DeleteFeatureProperty.TYPE, adaptable -&gt; DeleteFeatureProperty.of(thingIdFrom(adaptable),</span>
<span class="fc" id="L120">                featureIdFrom(adaptable), featurePropertyPointerFrom(adaptable), dittoHeadersFrom(adaptable)));</span>

<span class="fc" id="L122">        return mappingStrategies;</span>
    }

    @Override
    protected String getType(final Adaptable adaptable) {
<span class="fc" id="L127">        final TopicPath topicPath = adaptable.getTopicPath();</span>
<span class="fc" id="L128">        final JsonPointer path = adaptable.getPayload().getPath();</span>
<span class="fc" id="L129">        final String commandName = getAction(topicPath) + upperCaseFirst(PathMatcher.match(path));</span>
<span class="fc" id="L130">        return topicPath.getGroup() + &quot;.&quot; + topicPath.getCriterion() + &quot;:&quot; + commandName;</span>
    }

    @Override
    public Adaptable toAdaptable(final ThingModifyCommand command, final TopicPath.Channel channel) {
<span class="fc" id="L135">        final TopicPathBuilder topicPathBuilder = ProtocolFactory.newTopicPathBuilder(command.getThingId());</span>

<span class="fc" id="L137">        final CommandsTopicPathBuilder commandsTopicPathBuilder =</span>
<span class="fc" id="L138">                fromTopicPathBuilderWithChannel(topicPathBuilder, channel);</span>

<span class="fc" id="L140">        final String commandName = command.getClass().getSimpleName().toLowerCase();</span>
<span class="fc bfc" id="L141" title="All 2 branches covered.">        if (commandName.startsWith(TopicPath.Action.CREATE.toString())) {</span>
<span class="fc" id="L142">            commandsTopicPathBuilder.create();</span>
<span class="fc bfc" id="L143" title="All 2 branches covered.">        } else if (commandName.startsWith(TopicPath.Action.MODIFY.toString())) {</span>
<span class="fc" id="L144">            commandsTopicPathBuilder.modify();</span>
<span class="fc bfc" id="L145" title="All 2 branches covered.">        } else if (commandName.startsWith(TopicPath.Action.DELETE.toString())) {</span>
<span class="fc" id="L146">            commandsTopicPathBuilder.delete();</span>
        } else {
<span class="fc" id="L148">            throw UnknownCommandException.newBuilder(commandName).build();</span>
        }

<span class="fc" id="L151">        final PayloadBuilder payloadBuilder = Payload.newBuilder(command.getResourcePath());</span>

<span class="fc" id="L153">        final Optional&lt;JsonValue&gt; value = command.getEntity(command.getImplementedSchemaVersion());</span>
<span class="fc" id="L154">        value.ifPresent(payloadBuilder::withValue);</span>

<span class="fc" id="L156">        return Adaptable.newBuilder(commandsTopicPathBuilder.build())</span>
<span class="fc" id="L157">                .withPayload(payloadBuilder.build())</span>
<span class="fc" id="L158">                .withHeaders(ProtocolFactory.newHeadersWithDittoContentType(command.getDittoHeaders()))</span>
<span class="fc" id="L159">                .build();</span>
    }

    private static JsonObject initialPolicyForCreateThingFrom(final Adaptable adaptable) {
<span class="fc" id="L163">        return adaptable.getPayload().getValue()</span>
<span class="fc" id="L164">                .map(JsonValue::asObject)</span>
<span class="fc" id="L165">                .map(o -&gt; o.getValue(CreateThing.JSON_INLINE_POLICY).map(JsonValue::asObject).orElse(null))</span>
<span class="fc" id="L166">                .orElse(null);</span>
    }

    private static JsonObject initialPolicyForModifyThingFrom(final Adaptable adaptable) {
<span class="fc" id="L170">        return adaptable.getPayload().getValue()</span>
<span class="fc" id="L171">                .map(JsonValue::asObject)</span>
<span class="fc" id="L172">                .map(o -&gt; o.getValue(ModifyThing.JSON_INLINE_POLICY).map(JsonValue::asObject).orElse(null))</span>
<span class="fc" id="L173">                .orElse(null);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.0.201801022044</span></div></body></html>