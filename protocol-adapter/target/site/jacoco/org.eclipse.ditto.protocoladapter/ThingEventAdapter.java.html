<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ThingEventAdapter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Eclipse Ditto :: Protocol Adapter</a> &gt; <a href="index.source.html" class="el_package">org.eclipse.ditto.protocoladapter</a> &gt; <span class="el_source">ThingEventAdapter.java</span></div><h1>ThingEventAdapter.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2017 Bosch Software Innovations GmbH.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v2.0
 * which accompanies this distribution, and is available at
 * https://www.eclipse.org/org/documents/epl-2.0/index.php
 *
 * Contributors:
 *    Bosch Software Innovations GmbH - initial contribution
 */
package org.eclipse.ditto.protocoladapter;

import java.util.HashMap;
import java.util.Map;
import java.util.Optional;

import org.eclipse.ditto.json.JsonMissingFieldException;
import org.eclipse.ditto.json.JsonPointer;
import org.eclipse.ditto.json.JsonValue;
import org.eclipse.ditto.signals.events.things.AclEntryCreated;
import org.eclipse.ditto.signals.events.things.AclEntryDeleted;
import org.eclipse.ditto.signals.events.things.AclEntryModified;
import org.eclipse.ditto.signals.events.things.AclModified;
import org.eclipse.ditto.signals.events.things.AttributeCreated;
import org.eclipse.ditto.signals.events.things.AttributeDeleted;
import org.eclipse.ditto.signals.events.things.AttributeModified;
import org.eclipse.ditto.signals.events.things.AttributesCreated;
import org.eclipse.ditto.signals.events.things.AttributesDeleted;
import org.eclipse.ditto.signals.events.things.AttributesModified;
import org.eclipse.ditto.signals.events.things.FeatureCreated;
import org.eclipse.ditto.signals.events.things.FeatureDefinitionCreated;
import org.eclipse.ditto.signals.events.things.FeatureDefinitionDeleted;
import org.eclipse.ditto.signals.events.things.FeatureDefinitionModified;
import org.eclipse.ditto.signals.events.things.FeatureDeleted;
import org.eclipse.ditto.signals.events.things.FeatureModified;
import org.eclipse.ditto.signals.events.things.FeaturePropertiesCreated;
import org.eclipse.ditto.signals.events.things.FeaturePropertiesDeleted;
import org.eclipse.ditto.signals.events.things.FeaturePropertiesModified;
import org.eclipse.ditto.signals.events.things.FeaturePropertyCreated;
import org.eclipse.ditto.signals.events.things.FeaturePropertyDeleted;
import org.eclipse.ditto.signals.events.things.FeaturePropertyModified;
import org.eclipse.ditto.signals.events.things.FeaturesCreated;
import org.eclipse.ditto.signals.events.things.FeaturesDeleted;
import org.eclipse.ditto.signals.events.things.FeaturesModified;
import org.eclipse.ditto.signals.events.things.PolicyIdCreated;
import org.eclipse.ditto.signals.events.things.PolicyIdModified;
import org.eclipse.ditto.signals.events.things.ThingCreated;
import org.eclipse.ditto.signals.events.things.ThingDeleted;
import org.eclipse.ditto.signals.events.things.ThingEvent;
import org.eclipse.ditto.signals.events.things.ThingModified;

/**
 * Adapter for mapping a {@link ThingEvent} to and from an {@link Adaptable}.
 */
final class ThingEventAdapter extends AbstractAdapter&lt;ThingEvent&gt; {

    private ThingEventAdapter(final Map&lt;String, JsonifiableMapper&lt;ThingEvent&gt;&gt; mappingStrategies) {
<span class="fc" id="L59">        super(mappingStrategies);</span>
<span class="fc" id="L60">    }</span>

    /**
     * Returns a new ThingEventAdapter.
     *
     * @return the adapter.
     */
    public static ThingEventAdapter newInstance() {
<span class="fc" id="L68">        return new ThingEventAdapter(mappingStrategies());</span>
    }

    private static Map&lt;String, JsonifiableMapper&lt;ThingEvent&gt;&gt; mappingStrategies() {
<span class="fc" id="L72">        final Map&lt;String, JsonifiableMapper&lt;ThingEvent&gt;&gt; mappingStrategies = new HashMap&lt;&gt;();</span>

<span class="fc" id="L74">        mappingStrategies.put(ThingCreated.TYPE,</span>
<span class="fc" id="L75">                adaptable -&gt; ThingCreated.of(thingFrom(adaptable), revisionFrom(adaptable),</span>
<span class="fc" id="L76">                        dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L77">        mappingStrategies.put(ThingModified.TYPE,</span>
<span class="fc" id="L78">                adaptable -&gt; ThingModified.of(thingFrom(adaptable), revisionFrom(adaptable),</span>
<span class="fc" id="L79">                        dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L80">        mappingStrategies.put(ThingDeleted.TYPE,</span>
<span class="fc" id="L81">                adaptable -&gt; ThingDeleted.of(thingIdFrom(adaptable), revisionFrom(adaptable),</span>
<span class="fc" id="L82">                        dittoHeadersFrom(adaptable)));</span>

<span class="fc" id="L84">        mappingStrategies.put(AclModified.TYPE, adaptable -&gt; AclModified</span>
<span class="fc" id="L85">                .of(thingIdFrom(adaptable), aclFrom(adaptable), revisionFrom(adaptable),</span>
<span class="fc" id="L86">                        dittoHeadersFrom(adaptable)));</span>

<span class="fc" id="L88">        mappingStrategies.put(AclEntryCreated.TYPE, adaptable -&gt; AclEntryCreated</span>
<span class="fc" id="L89">                .of(thingIdFrom(adaptable), aclEntryFrom(adaptable), revisionFrom(adaptable),</span>
<span class="fc" id="L90">                        dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L91">        mappingStrategies.put(AclEntryModified.TYPE, adaptable -&gt; AclEntryModified</span>
<span class="fc" id="L92">                .of(thingIdFrom(adaptable), aclEntryFrom(adaptable), revisionFrom(adaptable),</span>
<span class="fc" id="L93">                        dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L94">        mappingStrategies.put(AclEntryDeleted.TYPE, adaptable -&gt; AclEntryDeleted</span>
<span class="fc" id="L95">                .of(thingIdFrom(adaptable), authorizationSubjectFrom(adaptable), revisionFrom(adaptable),</span>
<span class="fc" id="L96">                        dittoHeadersFrom(adaptable)));</span>

<span class="fc" id="L98">        mappingStrategies.put(AttributesCreated.TYPE, adaptable -&gt; AttributesCreated</span>
<span class="fc" id="L99">                .of(thingIdFrom(adaptable), attributesFrom(adaptable), revisionFrom(adaptable),</span>
<span class="fc" id="L100">                        dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L101">        mappingStrategies.put(AttributesModified.TYPE, adaptable -&gt; AttributesModified</span>
<span class="fc" id="L102">                .of(thingIdFrom(adaptable), attributesFrom(adaptable), revisionFrom(adaptable),</span>
<span class="fc" id="L103">                        dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L104">        mappingStrategies.put(AttributesDeleted.TYPE, adaptable -&gt; AttributesDeleted</span>
<span class="fc" id="L105">                .of(thingIdFrom(adaptable), revisionFrom(adaptable), dittoHeadersFrom(adaptable)));</span>

<span class="fc" id="L107">        mappingStrategies.put(AttributeCreated.TYPE, adaptable -&gt; AttributeCreated</span>
<span class="fc" id="L108">                .of(thingIdFrom(adaptable), attributePointerFrom(adaptable), attributeValueFrom(adaptable),</span>
<span class="fc" id="L109">                        revisionFrom(adaptable), dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L110">        mappingStrategies.put(AttributeModified.TYPE, adaptable -&gt; AttributeModified</span>
<span class="fc" id="L111">                .of(thingIdFrom(adaptable), attributePointerFrom(adaptable), attributeValueFrom(adaptable),</span>
<span class="fc" id="L112">                        revisionFrom(adaptable), dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L113">        mappingStrategies.put(AttributeDeleted.TYPE, adaptable -&gt; AttributeDeleted</span>
<span class="fc" id="L114">                .of(thingIdFrom(adaptable), attributePointerFrom(adaptable), revisionFrom(adaptable),</span>
<span class="fc" id="L115">                        dittoHeadersFrom(adaptable)));</span>

<span class="fc" id="L117">        mappingStrategies.put(FeaturesCreated.TYPE, adaptable -&gt; FeaturesCreated</span>
<span class="fc" id="L118">                .of(thingIdFrom(adaptable), featuresFrom(adaptable), revisionFrom(adaptable),</span>
<span class="fc" id="L119">                        dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L120">        mappingStrategies.put(FeaturesModified.TYPE, adaptable -&gt; FeaturesModified</span>
<span class="fc" id="L121">                .of(thingIdFrom(adaptable), featuresFrom(adaptable), revisionFrom(adaptable),</span>
<span class="fc" id="L122">                        dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L123">        mappingStrategies.put(FeaturesDeleted.TYPE, adaptable -&gt; FeaturesDeleted</span>
<span class="fc" id="L124">                .of(thingIdFrom(adaptable), revisionFrom(adaptable), dittoHeadersFrom(adaptable)));</span>

<span class="fc" id="L126">        mappingStrategies.put(FeatureCreated.TYPE, adaptable -&gt; FeatureCreated</span>
<span class="fc" id="L127">                .of(thingIdFrom(adaptable), featureFrom(adaptable), revisionFrom(adaptable),</span>
<span class="fc" id="L128">                        dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L129">        mappingStrategies.put(FeatureModified.TYPE, adaptable -&gt; FeatureModified</span>
<span class="fc" id="L130">                .of(thingIdFrom(adaptable), featureFrom(adaptable), revisionFrom(adaptable),</span>
<span class="fc" id="L131">                        dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L132">        mappingStrategies.put(FeatureDeleted.TYPE, adaptable -&gt; FeatureDeleted</span>
<span class="fc" id="L133">                .of(thingIdFrom(adaptable), featureIdFrom(adaptable), revisionFrom(adaptable),</span>
<span class="fc" id="L134">                        dittoHeadersFrom(adaptable)));</span>

<span class="fc" id="L136">        mappingStrategies.put(FeatureDefinitionCreated.TYPE, adaptable -&gt; FeatureDefinitionCreated</span>
<span class="fc" id="L137">                .of(thingIdFrom(adaptable), featureIdFrom(adaptable), featureDefinitionFrom(adaptable),</span>
<span class="fc" id="L138">                        revisionFrom(adaptable), dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L139">        mappingStrategies.put(FeatureDefinitionModified.TYPE, adaptable -&gt; FeatureDefinitionModified</span>
<span class="fc" id="L140">                .of(thingIdFrom(adaptable), featureIdFrom(adaptable), featureDefinitionFrom(adaptable),</span>
<span class="fc" id="L141">                        revisionFrom(adaptable), dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L142">        mappingStrategies.put(FeatureDefinitionDeleted.TYPE, adaptable -&gt; FeatureDefinitionDeleted</span>
<span class="fc" id="L143">                .of(thingIdFrom(adaptable), featureIdFrom(adaptable), revisionFrom(adaptable),</span>
<span class="fc" id="L144">                        dittoHeadersFrom(adaptable)));</span>

<span class="fc" id="L146">        mappingStrategies.put(FeaturePropertiesCreated.TYPE, adaptable -&gt; FeaturePropertiesCreated</span>
<span class="fc" id="L147">                .of(thingIdFrom(adaptable), featureIdFrom(adaptable), featurePropertiesFrom(adaptable),</span>
<span class="fc" id="L148">                        revisionFrom(adaptable), dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L149">        mappingStrategies.put(FeaturePropertiesModified.TYPE, adaptable -&gt; FeaturePropertiesModified</span>
<span class="fc" id="L150">                .of(thingIdFrom(adaptable), featureIdFrom(adaptable), featurePropertiesFrom(adaptable),</span>
<span class="fc" id="L151">                        revisionFrom(adaptable), dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L152">        mappingStrategies.put(FeaturePropertiesDeleted.TYPE, adaptable -&gt; FeaturePropertiesDeleted</span>
<span class="fc" id="L153">                .of(thingIdFrom(adaptable), featureIdFrom(adaptable), revisionFrom(adaptable),</span>
<span class="fc" id="L154">                        dittoHeadersFrom(adaptable)));</span>

<span class="fc" id="L156">        mappingStrategies.put(FeaturePropertyCreated.TYPE, adaptable -&gt; FeaturePropertyCreated</span>
<span class="fc" id="L157">                .of(thingIdFrom(adaptable), featureIdFrom(adaptable), featurePropertyPointerFrom(adaptable),</span>
<span class="fc" id="L158">                        featurePropertyValueFrom(adaptable), revisionFrom(adaptable), dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L159">        mappingStrategies.put(FeaturePropertyModified.TYPE, adaptable -&gt; FeaturePropertyModified</span>
<span class="fc" id="L160">                .of(thingIdFrom(adaptable), featureIdFrom(adaptable), featurePropertyPointerFrom(adaptable),</span>
<span class="fc" id="L161">                        featurePropertyValueFrom(adaptable), revisionFrom(adaptable), dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L162">        mappingStrategies.put(FeaturePropertyDeleted.TYPE, adaptable -&gt; FeaturePropertyDeleted</span>
<span class="fc" id="L163">                .of(thingIdFrom(adaptable), featureIdFrom(adaptable), featurePropertyPointerFrom(adaptable),</span>
<span class="fc" id="L164">                        revisionFrom(adaptable), dittoHeadersFrom(adaptable)));</span>

<span class="fc" id="L166">        mappingStrategies.put(PolicyIdCreated.TYPE, adaptable -&gt; PolicyIdCreated</span>
<span class="fc" id="L167">                .of(thingIdFrom(adaptable), policyIdFrom(adaptable), revisionFrom(adaptable),</span>
<span class="fc" id="L168">                        dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L169">        mappingStrategies.put(PolicyIdModified.TYPE, adaptable -&gt; PolicyIdModified</span>
<span class="fc" id="L170">                .of(thingIdFrom(adaptable), policyIdFrom(adaptable), revisionFrom(adaptable),</span>
<span class="fc" id="L171">                        dittoHeadersFrom(adaptable)));</span>

<span class="fc" id="L173">        return mappingStrategies;</span>
    }

    private static long revisionFrom(final Adaptable adaptable) {
<span class="pc" id="L177">        return adaptable.getPayload().getRevision().orElseThrow(() -&gt; JsonMissingFieldException.newBuilder()</span>
<span class="nc" id="L178">                .fieldName(Payload.JsonFields.REVISION.getPointer().toString()).build());</span>
    }

    @Override
    protected String getType(final Adaptable adaptable) {
<span class="fc" id="L183">        final TopicPath topicPath = adaptable.getTopicPath();</span>
<span class="fc" id="L184">        final JsonPointer path = adaptable.getPayload().getPath();</span>
<span class="fc" id="L185">        final String eventName = PathMatcher.match(path) + getActionNameWithFirstLetterUpperCase(topicPath);</span>
<span class="fc" id="L186">        return topicPath.getGroup() + &quot;.&quot; + topicPath.getCriterion() + &quot;:&quot; + eventName;</span>
    }

    private static String getActionNameWithFirstLetterUpperCase(final TopicPath topicPath) {
<span class="fc" id="L190">        return topicPath.getAction()</span>
<span class="fc" id="L191">                .map(TopicPath.Action::toString)</span>
<span class="fc" id="L192">                .map(AbstractAdapter::upperCaseFirst)</span>
<span class="pc" id="L193">                .orElseThrow(() -&gt; new NullPointerException(&quot;TopicPath did not contain an Action!&quot;));</span>
    }

    @Override
    public Adaptable toAdaptable(final ThingEvent event, final TopicPath.Channel channel) {
<span class="fc" id="L198">        final TopicPathBuilder topicPathBuilder = ProtocolFactory.newTopicPathBuilder(event.getThingId());</span>

        final EventsTopicPathBuilder eventsTopicPathBuilder;
<span class="pc bpc" id="L201" title="1 of 2 branches missed.">        if (channel == TopicPath.Channel.TWIN) {</span>
<span class="fc" id="L202">            eventsTopicPathBuilder = topicPathBuilder.twin().events();</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">        } else if (channel == TopicPath.Channel.LIVE) {</span>
<span class="nc" id="L204">            eventsTopicPathBuilder = topicPathBuilder.live().events();</span>
        } else {
<span class="nc" id="L206">            throw new IllegalArgumentException(&quot;Unknown Channel '&quot; + channel + &quot;'&quot;);</span>
        }

<span class="fc" id="L209">        final String eventName = event.getClass().getSimpleName().toLowerCase();</span>
<span class="fc bfc" id="L210" title="All 2 branches covered.">        if (eventName.contains(TopicPath.Action.CREATED.toString())) {</span>
<span class="fc" id="L211">            eventsTopicPathBuilder.created();</span>
<span class="fc bfc" id="L212" title="All 2 branches covered.">        } else if (eventName.contains(TopicPath.Action.MODIFIED.toString())) {</span>
<span class="fc" id="L213">            eventsTopicPathBuilder.modified();</span>
<span class="fc bfc" id="L214" title="All 2 branches covered.">        } else if (eventName.contains(TopicPath.Action.DELETED.toString())) {</span>
<span class="fc" id="L215">            eventsTopicPathBuilder.deleted();</span>
        } else {
<span class="fc" id="L217">            throw UnknownEventException.newBuilder(eventName).build();</span>
        }

<span class="fc" id="L220">        final PayloadBuilder payloadBuilder = Payload.newBuilder(event.getResourcePath()) //</span>
<span class="fc" id="L221">                .withRevision(event.getRevision());</span>

<span class="fc" id="L223">        final Optional&lt;JsonValue&gt; value =</span>
<span class="fc" id="L224">                event.getEntity(event.getDittoHeaders().getSchemaVersion().orElse(event.getLatestSchemaVersion()));</span>
<span class="fc" id="L225">        value.ifPresent(payloadBuilder::withValue);</span>

<span class="fc" id="L227">        return Adaptable.newBuilder(eventsTopicPathBuilder.build()) //</span>
<span class="fc" id="L228">                .withPayload(payloadBuilder.build()) //</span>
<span class="fc" id="L229">                .withHeaders(ProtocolFactory.newHeadersWithDittoContentType(event.getDittoHeaders())) //</span>
<span class="fc" id="L230">                .build();</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.0.201801022044</span></div></body></html>