<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ThingModifyCommandResponseAdapter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Eclipse Ditto :: Protocol Adapter</a> &gt; <a href="index.source.html" class="el_package">org.eclipse.ditto.protocoladapter</a> &gt; <span class="el_source">ThingModifyCommandResponseAdapter.java</span></div><h1>ThingModifyCommandResponseAdapter.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2017 Bosch Software Innovations GmbH.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v2.0
 * which accompanies this distribution, and is available at
 * https://www.eclipse.org/org/documents/epl-2.0/index.php
 *
 * Contributors:
 *    Bosch Software Innovations GmbH - initial contribution
 */
package org.eclipse.ditto.protocoladapter;

import java.util.HashMap;
import java.util.Map;
import java.util.Optional;

import org.eclipse.ditto.json.JsonPointer;
import org.eclipse.ditto.json.JsonValue;
import org.eclipse.ditto.signals.commands.things.modify.CreateThingResponse;
import org.eclipse.ditto.signals.commands.things.modify.DeleteAclEntryResponse;
import org.eclipse.ditto.signals.commands.things.modify.DeleteAttributeResponse;
import org.eclipse.ditto.signals.commands.things.modify.DeleteAttributesResponse;
import org.eclipse.ditto.signals.commands.things.modify.DeleteFeatureDefinitionResponse;
import org.eclipse.ditto.signals.commands.things.modify.DeleteFeaturePropertiesResponse;
import org.eclipse.ditto.signals.commands.things.modify.DeleteFeaturePropertyResponse;
import org.eclipse.ditto.signals.commands.things.modify.DeleteFeatureResponse;
import org.eclipse.ditto.signals.commands.things.modify.DeleteFeaturesResponse;
import org.eclipse.ditto.signals.commands.things.modify.DeleteThingResponse;
import org.eclipse.ditto.signals.commands.things.modify.ModifyAclEntryResponse;
import org.eclipse.ditto.signals.commands.things.modify.ModifyAclResponse;
import org.eclipse.ditto.signals.commands.things.modify.ModifyAttributeResponse;
import org.eclipse.ditto.signals.commands.things.modify.ModifyAttributesResponse;
import org.eclipse.ditto.signals.commands.things.modify.ModifyFeatureDefinitionResponse;
import org.eclipse.ditto.signals.commands.things.modify.ModifyFeaturePropertiesResponse;
import org.eclipse.ditto.signals.commands.things.modify.ModifyFeaturePropertyResponse;
import org.eclipse.ditto.signals.commands.things.modify.ModifyFeatureResponse;
import org.eclipse.ditto.signals.commands.things.modify.ModifyFeaturesResponse;
import org.eclipse.ditto.signals.commands.things.modify.ModifyThingResponse;
import org.eclipse.ditto.signals.commands.things.modify.ThingModifyCommandResponse;

/**
 * Adapter for mapping a {@link ThingModifyCommandResponse} to and from an {@link Adaptable}.
 */
final class ThingModifyCommandResponseAdapter extends AbstractAdapter&lt;ThingModifyCommandResponse&gt; {

    private ThingModifyCommandResponseAdapter(
            final Map&lt;String, JsonifiableMapper&lt;ThingModifyCommandResponse&gt;&gt; mappingStrategies) {

<span class="fc" id="L50">        super(mappingStrategies);</span>
<span class="fc" id="L51">    }</span>

    /**
     * Returns a new ThingModifyCommandResponseAdapter.
     *
     * @return the adapter.
     */
    public static ThingModifyCommandResponseAdapter newInstance() {
<span class="fc" id="L59">        return new ThingModifyCommandResponseAdapter(mappingStrategies());</span>
    }

    @SuppressWarnings({&quot;squid:MethodCyclomaticComplexity&quot;, &quot;squid:S1067&quot;})
    private static Map&lt;String, JsonifiableMapper&lt;ThingModifyCommandResponse&gt;&gt; mappingStrategies() {
<span class="fc" id="L64">        final Map&lt;String, JsonifiableMapper&lt;ThingModifyCommandResponse&gt;&gt; mappingStrategies = new HashMap&lt;&gt;();</span>

<span class="fc" id="L66">        addTopLevelResponses(mappingStrategies);</span>

<span class="fc" id="L68">        addAclResponses(mappingStrategies);</span>

<span class="fc" id="L70">        addAttributeResponses(mappingStrategies);</span>

<span class="fc" id="L72">        addFeatureResponses(mappingStrategies);</span>

<span class="fc" id="L74">        return mappingStrategies;</span>
    }

    @Override
    protected String getType(final Adaptable adaptable) {
<span class="fc" id="L79">        final TopicPath topicPath = adaptable.getTopicPath();</span>
<span class="fc" id="L80">        final JsonPointer path = adaptable.getPayload().getPath();</span>
<span class="fc" id="L81">        final String commandName = getAction(topicPath) + upperCaseFirst(PathMatcher.match(path));</span>
<span class="fc" id="L82">        return topicPath.getGroup() + &quot;.responses:&quot; + commandName;</span>
    }

    @Override
    public Adaptable toAdaptable(final ThingModifyCommandResponse commandResponse, final TopicPath.Channel channel) {
<span class="fc" id="L87">        final String responseName = commandResponse.getClass().getSimpleName().toLowerCase();</span>
<span class="fc bfc" id="L88" title="All 2 branches covered.">        if (!responseName.endsWith(&quot;response&quot;)) {</span>
<span class="fc" id="L89">            throw UnknownCommandResponseException.newBuilder(responseName).build();</span>
        }

<span class="fc" id="L92">        final TopicPathBuilder topicPathBuilder = ProtocolFactory.newTopicPathBuilder(commandResponse.getId());</span>

<span class="fc" id="L94">        final CommandsTopicPathBuilder commandsTopicPathBuilder =</span>
<span class="fc" id="L95">                fromTopicPathBuilderWithChannel(topicPathBuilder, channel);</span>

<span class="fc" id="L97">        final String commandName = commandResponse.getClass().getSimpleName().toLowerCase();</span>
<span class="fc bfc" id="L98" title="All 2 branches covered.">        if (commandName.startsWith(TopicPath.Action.CREATE.toString())) {</span>
<span class="fc" id="L99">            commandsTopicPathBuilder.create();</span>
<span class="fc bfc" id="L100" title="All 2 branches covered.">        } else if (commandName.startsWith(TopicPath.Action.MODIFY.toString())) {</span>
<span class="fc" id="L101">            commandsTopicPathBuilder.modify();</span>
<span class="pc bpc" id="L102" title="1 of 2 branches missed.">        } else if (commandName.startsWith(TopicPath.Action.DELETE.toString())) {</span>
<span class="fc" id="L103">            commandsTopicPathBuilder.delete();</span>
        } else {
<span class="nc" id="L105">            throw UnknownCommandException.newBuilder(commandName).build();</span>
        }

<span class="fc" id="L108">        final PayloadBuilder payloadBuilder = Payload.newBuilder(commandResponse.getResourcePath()) //</span>
<span class="fc" id="L109">                .withStatus(commandResponse.getStatusCode());</span>

<span class="fc" id="L111">        final Optional&lt;JsonValue&gt; value = commandResponse.getEntity(commandResponse.getImplementedSchemaVersion());</span>
<span class="fc" id="L112">        value.ifPresent(payloadBuilder::withValue);</span>

<span class="fc" id="L114">        return Adaptable.newBuilder(commandsTopicPathBuilder.build()) //</span>
<span class="fc" id="L115">                .withPayload(payloadBuilder.build()) //</span>
<span class="fc" id="L116">                .withHeaders(ProtocolFactory.newHeadersWithDittoContentType(commandResponse.getDittoHeaders())) //</span>
<span class="fc" id="L117">                .build();</span>
    }

    private static void addTopLevelResponses(
            final Map&lt;String, JsonifiableMapper&lt;ThingModifyCommandResponse&gt;&gt; mappingStrategies) {
<span class="fc" id="L122">        mappingStrategies.put(CreateThingResponse.TYPE,</span>
<span class="fc" id="L123">                adaptable -&gt; CreateThingResponse.of(thingFrom(adaptable), dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L124">        mappingStrategies.put(ModifyThingResponse.TYPE,</span>
<span class="fc bfc" id="L125" title="All 2 branches covered.">                adaptable -&gt; isCreated(adaptable)</span>
<span class="fc" id="L126">                        ? ModifyThingResponse.created(thingFrom(adaptable), dittoHeadersFrom(adaptable))</span>
<span class="fc" id="L127">                        : ModifyThingResponse.modified(thingIdFrom(adaptable), dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L128">        mappingStrategies.put(DeleteThingResponse.TYPE,</span>
<span class="fc" id="L129">                adaptable -&gt; DeleteThingResponse.of(thingIdFrom(adaptable), dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L130">    }</span>

    private static void addAclResponses(
            final Map&lt;String, JsonifiableMapper&lt;ThingModifyCommandResponse&gt;&gt; mappingStrategies) {
<span class="fc" id="L134">        mappingStrategies.put(ModifyAclResponse.TYPE,</span>
<span class="fc" id="L135">                adaptable -&gt; ModifyAclResponse.modified(thingIdFrom(adaptable), aclFrom(adaptable),</span>
<span class="fc" id="L136">                        dittoHeadersFrom(adaptable)));</span>

<span class="fc" id="L138">        mappingStrategies.put(ModifyAclEntryResponse.TYPE,</span>
<span class="fc bfc" id="L139" title="All 2 branches covered.">                adaptable -&gt; isCreated(adaptable)</span>
<span class="fc" id="L140">                        ? ModifyAclEntryResponse.created(thingIdFrom(adaptable), aclEntryFrom(adaptable),</span>
<span class="fc" id="L141">                        dittoHeadersFrom(adaptable))</span>
<span class="fc" id="L142">                        : ModifyAclEntryResponse.modified(thingIdFrom(adaptable), aclEntryFrom(adaptable),</span>
<span class="fc" id="L143">                        dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L144">        mappingStrategies.put(DeleteAclEntryResponse.TYPE,</span>
<span class="fc" id="L145">                adaptable -&gt; DeleteAclEntryResponse.of(thingIdFrom(adaptable), authorizationSubjectFrom(adaptable),</span>
<span class="fc" id="L146">                        dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L147">    }</span>

    private static void addAttributeResponses(
            final Map&lt;String, JsonifiableMapper&lt;ThingModifyCommandResponse&gt;&gt; mappingStrategies) {
<span class="fc" id="L151">        mappingStrategies.put(ModifyAttributesResponse.TYPE,</span>
<span class="fc bfc" id="L152" title="All 2 branches covered.">                adaptable -&gt; isCreated(adaptable)</span>
<span class="fc" id="L153">                        ? ModifyAttributesResponse.created(thingIdFrom(adaptable), attributesFrom(adaptable),</span>
<span class="fc" id="L154">                        dittoHeadersFrom(adaptable))</span>
<span class="fc" id="L155">                        : ModifyAttributesResponse.modified(thingIdFrom(adaptable), dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L156">        mappingStrategies.put(DeleteAttributesResponse.TYPE,</span>
<span class="fc" id="L157">                adaptable -&gt; DeleteAttributesResponse.of(thingIdFrom(adaptable), dittoHeadersFrom(adaptable)));</span>

<span class="fc" id="L159">        mappingStrategies.put(ModifyAttributeResponse.TYPE,</span>
<span class="fc bfc" id="L160" title="All 2 branches covered.">                adaptable -&gt; isCreated(adaptable)</span>
                        ?
<span class="fc" id="L162">                        ModifyAttributeResponse.created(thingIdFrom(adaptable), attributePointerFrom(adaptable),</span>
<span class="fc" id="L163">                                attributeValueFrom(adaptable),</span>
<span class="fc" id="L164">                                dittoHeadersFrom(adaptable))</span>
<span class="fc" id="L165">                        : ModifyAttributeResponse.modified(thingIdFrom(adaptable), attributePointerFrom(adaptable),</span>
<span class="fc" id="L166">                        dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L167">        mappingStrategies.put(DeleteAttributeResponse.TYPE,</span>
<span class="fc" id="L168">                adaptable -&gt; DeleteAttributeResponse.of(thingIdFrom(adaptable), attributePointerFrom(adaptable),</span>
<span class="fc" id="L169">                        dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L170">    }</span>

    private static void addFeatureResponses(
            final Map&lt;String, JsonifiableMapper&lt;ThingModifyCommandResponse&gt;&gt; mappingStrategies) {
<span class="fc" id="L174">        mappingStrategies.put(ModifyFeaturesResponse.TYPE,</span>
<span class="fc bfc" id="L175" title="All 2 branches covered.">                adaptable -&gt; isCreated(adaptable)</span>
<span class="fc" id="L176">                        ? ModifyFeaturesResponse.created(thingIdFrom(adaptable), featuresFrom(adaptable),</span>
<span class="fc" id="L177">                        dittoHeadersFrom(adaptable))</span>
<span class="fc" id="L178">                        : ModifyFeaturesResponse.modified(thingIdFrom(adaptable), dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L179">        mappingStrategies.put(DeleteFeaturesResponse.TYPE,</span>
<span class="fc" id="L180">                adaptable -&gt; DeleteFeaturesResponse.of(thingIdFrom(adaptable), dittoHeadersFrom(adaptable)));</span>

<span class="fc" id="L182">        mappingStrategies.put(ModifyFeatureResponse.TYPE,</span>
<span class="fc bfc" id="L183" title="All 2 branches covered.">                adaptable -&gt; isCreated(adaptable)</span>
<span class="fc" id="L184">                        ? ModifyFeatureResponse.created(thingIdFrom(adaptable), featureFrom(adaptable),</span>
<span class="fc" id="L185">                        dittoHeadersFrom(adaptable))</span>
<span class="fc" id="L186">                        : ModifyFeatureResponse.modified(thingIdFrom(adaptable), featureIdFrom(adaptable),</span>
<span class="fc" id="L187">                        dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L188">        mappingStrategies.put(DeleteFeatureResponse.TYPE,</span>
<span class="fc" id="L189">                adaptable -&gt; DeleteFeatureResponse.of(thingIdFrom(adaptable), featureIdFrom(adaptable),</span>
<span class="fc" id="L190">                        dittoHeadersFrom(adaptable)));</span>

<span class="fc" id="L192">        mappingStrategies.put(ModifyFeatureDefinitionResponse.TYPE,</span>
<span class="fc bfc" id="L193" title="All 2 branches covered.">                adaptable -&gt; isCreated(adaptable)</span>
<span class="fc" id="L194">                        ? ModifyFeatureDefinitionResponse.created(thingIdFrom(adaptable), featureIdFrom(adaptable),</span>
<span class="fc" id="L195">                        featureDefinitionFrom(adaptable),</span>
<span class="fc" id="L196">                        dittoHeadersFrom(adaptable))</span>
<span class="fc" id="L197">                        : ModifyFeatureDefinitionResponse.modified(thingIdFrom(adaptable), featureIdFrom(adaptable),</span>
<span class="fc" id="L198">                        dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L199">        mappingStrategies.put(DeleteFeatureDefinitionResponse.TYPE,</span>
<span class="fc" id="L200">                adaptable -&gt; DeleteFeatureDefinitionResponse.of(thingIdFrom(adaptable), featureIdFrom(adaptable),</span>
<span class="fc" id="L201">                        dittoHeadersFrom(adaptable)));</span>

<span class="fc" id="L203">        mappingStrategies.put(ModifyFeaturePropertiesResponse.TYPE,</span>
<span class="fc bfc" id="L204" title="All 2 branches covered.">                adaptable -&gt; isCreated(adaptable)</span>
<span class="fc" id="L205">                        ? ModifyFeaturePropertiesResponse.created(thingIdFrom(adaptable), featureIdFrom(adaptable),</span>
<span class="fc" id="L206">                        featurePropertiesFrom(adaptable),</span>
<span class="fc" id="L207">                        dittoHeadersFrom(adaptable))</span>
<span class="fc" id="L208">                        : ModifyFeaturePropertiesResponse.modified(thingIdFrom(adaptable), featureIdFrom(adaptable),</span>
<span class="fc" id="L209">                        dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L210">        mappingStrategies.put(DeleteFeaturePropertiesResponse.TYPE,</span>
<span class="fc" id="L211">                adaptable -&gt; DeleteFeaturePropertiesResponse.of(thingIdFrom(adaptable), featureIdFrom(adaptable),</span>
<span class="fc" id="L212">                        dittoHeadersFrom(adaptable)));</span>

<span class="fc" id="L214">        mappingStrategies.put(ModifyFeaturePropertyResponse.TYPE,</span>
<span class="fc bfc" id="L215" title="All 2 branches covered.">                adaptable -&gt; isCreated(adaptable)</span>
<span class="fc" id="L216">                        ? ModifyFeaturePropertyResponse.created(thingIdFrom(adaptable), featureIdFrom(adaptable),</span>
<span class="fc" id="L217">                        featurePropertyPointerFrom(adaptable),</span>
<span class="fc" id="L218">                        featurePropertyValueFrom(adaptable), dittoHeadersFrom(adaptable))</span>
<span class="fc" id="L219">                        : ModifyFeaturePropertyResponse.modified(thingIdFrom(adaptable), featureIdFrom(adaptable),</span>
<span class="fc" id="L220">                        featurePropertyPointerFrom(adaptable),</span>
<span class="fc" id="L221">                        dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L222">        mappingStrategies.put(DeleteFeaturePropertyResponse.TYPE, adaptable -&gt; DeleteFeaturePropertyResponse</span>
<span class="fc" id="L223">                .of(thingIdFrom(adaptable), featureIdFrom(adaptable), featurePropertyPointerFrom(adaptable),</span>
<span class="fc" id="L224">                        dittoHeadersFrom(adaptable)));</span>
<span class="fc" id="L225">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.0.201801022044</span></div></body></html>