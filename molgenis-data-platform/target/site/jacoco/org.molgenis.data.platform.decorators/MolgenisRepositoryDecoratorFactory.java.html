<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MolgenisRepositoryDecoratorFactory.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">data-platform</a> &gt; <a href="index.source.html" class="el_package">org.molgenis.data.platform.decorators</a> &gt; <span class="el_source">MolgenisRepositoryDecoratorFactory.java</span></div><h1>MolgenisRepositoryDecoratorFactory.java</h1><pre class="source lang-java linenums">package org.molgenis.data.platform.decorators;

import org.molgenis.data.*;
import org.molgenis.data.cache.l1.L1Cache;
import org.molgenis.data.cache.l1.L1CacheRepositoryDecorator;
import org.molgenis.data.cache.l2.L2Cache;
import org.molgenis.data.cache.l2.L2CacheRepositoryDecorator;
import org.molgenis.data.cache.l3.L3Cache;
import org.molgenis.data.cache.l3.L3CacheRepositoryDecorator;
import org.molgenis.data.decorator.DynamicRepositoryDecoratorRegistry;
import org.molgenis.data.index.IndexActionRegisterService;
import org.molgenis.data.index.IndexActionRepositoryDecorator;
import org.molgenis.data.index.IndexedRepositoryDecoratorFactory;
import org.molgenis.data.listeners.EntityListenerRepositoryDecorator;
import org.molgenis.data.listeners.EntityListenersService;
import org.molgenis.data.security.RepositorySecurityDecorator;
import org.molgenis.data.security.aggregation.AggregateAnonymizer;
import org.molgenis.data.security.aggregation.AggregateAnonymizerRepositoryDecorator;
import org.molgenis.data.security.owned.RowLevelSecurityRepositoryDecoratorFactory;
import org.molgenis.data.transaction.TransactionInformation;
import org.molgenis.data.transaction.TransactionalRepositoryDecorator;
import org.molgenis.data.validation.*;
import org.molgenis.security.core.UserPermissionEvaluator;
import org.molgenis.settings.AppSettings;
import org.springframework.stereotype.Component;
import org.springframework.transaction.PlatformTransactionManager;

import static java.util.Objects.requireNonNull;

@Component
public class MolgenisRepositoryDecoratorFactory implements RepositoryDecoratorFactory
{
	private final EntityManager entityManager;
	private final EntityAttributesValidator entityAttributesValidator;
	private final AggregateAnonymizer aggregateAnonymizer;
	private final AppSettings appSettings;
	private final DataService dataService;
	private final SystemRepositoryDecoratorRegistry systemRepositoryDecoratorRegistry;
	private final DynamicRepositoryDecoratorRegistry dynamicRepositoryDecoratorRegistry;
	private final IndexActionRegisterService indexActionRegisterService;
	private final IndexedRepositoryDecoratorFactory indexedRepositoryDecoratorFactory;
	private final L1Cache l1Cache;
	private final EntityListenersService entityListenersService;
	private final L2Cache l2Cache;
	private final TransactionInformation transactionInformation;
	private final L3Cache l3Cache;
	private final PlatformTransactionManager transactionManager;
	private final QueryValidator queryValidator;
	private final DefaultValueReferenceValidator defaultValueReferenceValidator;
	private final UserPermissionEvaluator permissionService;
	private final RowLevelSecurityRepositoryDecoratorFactory rowLevelSecurityRepositoryDecoratorFactory;

	public MolgenisRepositoryDecoratorFactory(EntityManager entityManager,
			EntityAttributesValidator entityAttributesValidator, AggregateAnonymizer aggregateAnonymizer,
			AppSettings appSettings, DataService dataService,
			SystemRepositoryDecoratorRegistry repositoryDecoratorRegistry,
			DynamicRepositoryDecoratorRegistry dynamicRepositoryDecoratorRegistry,
			IndexActionRegisterService indexActionRegisterService,
			IndexedRepositoryDecoratorFactory indexedRepositoryDecoratorFactory, L1Cache l1Cache, L2Cache l2Cache,
			TransactionInformation transactionInformation, EntityListenersService entityListenersService,
			L3Cache l3Cache, PlatformTransactionManager transactionManager, QueryValidator queryValidator,
			DefaultValueReferenceValidator defaultValueReferenceValidator, UserPermissionEvaluator permissionService,
			RowLevelSecurityRepositoryDecoratorFactory rowLevelSecurityRepositoryDecoratorFactory)

<span class="nc" id="L65">	{</span>
<span class="nc" id="L66">		this.entityManager = requireNonNull(entityManager);</span>
<span class="nc" id="L67">		this.entityAttributesValidator = requireNonNull(entityAttributesValidator);</span>
<span class="nc" id="L68">		this.aggregateAnonymizer = requireNonNull(aggregateAnonymizer);</span>
<span class="nc" id="L69">		this.appSettings = requireNonNull(appSettings);</span>
<span class="nc" id="L70">		this.dataService = requireNonNull(dataService);</span>
<span class="nc" id="L71">		this.systemRepositoryDecoratorRegistry = requireNonNull(repositoryDecoratorRegistry);</span>
<span class="nc" id="L72">		this.dynamicRepositoryDecoratorRegistry = requireNonNull(dynamicRepositoryDecoratorRegistry);</span>
<span class="nc" id="L73">		this.indexActionRegisterService = requireNonNull(indexActionRegisterService);</span>
<span class="nc" id="L74">		this.indexedRepositoryDecoratorFactory = requireNonNull(indexedRepositoryDecoratorFactory);</span>
<span class="nc" id="L75">		this.l1Cache = requireNonNull(l1Cache);</span>
<span class="nc" id="L76">		this.entityListenersService = requireNonNull(entityListenersService);</span>
<span class="nc" id="L77">		this.l2Cache = requireNonNull(l2Cache);</span>
<span class="nc" id="L78">		this.transactionInformation = requireNonNull(transactionInformation);</span>
<span class="nc" id="L79">		this.l3Cache = requireNonNull(l3Cache);</span>
<span class="nc" id="L80">		this.transactionManager = requireNonNull(transactionManager);</span>
<span class="nc" id="L81">		this.queryValidator = requireNonNull(queryValidator);</span>
<span class="nc" id="L82">		this.defaultValueReferenceValidator = requireNonNull(defaultValueReferenceValidator);</span>
<span class="nc" id="L83">		this.permissionService = requireNonNull(permissionService);</span>
<span class="nc" id="L84">		this.rowLevelSecurityRepositoryDecoratorFactory = requireNonNull(rowLevelSecurityRepositoryDecoratorFactory);</span>
<span class="nc" id="L85">	}</span>

	@Override
	public Repository&lt;Entity&gt; createDecoratedRepository(Repository&lt;Entity&gt; repository)
	{
<span class="nc" id="L90">		Repository&lt;Entity&gt; decoratedRepository = repository;</span>

		// 15. Query the L2 cache before querying the database
<span class="nc" id="L93">		decoratedRepository = new L2CacheRepositoryDecorator(decoratedRepository, l2Cache, transactionInformation);</span>

		// 14. Query the L1 cache before querying the database
<span class="nc" id="L96">		decoratedRepository = new L1CacheRepositoryDecorator(decoratedRepository, l1Cache);</span>

		// 13. Route specific queries to the index
<span class="nc" id="L99">		decoratedRepository = indexedRepositoryDecoratorFactory.create(decoratedRepository);</span>

		// 12. Query the L3 cache before querying the index
<span class="nc" id="L102">		decoratedRepository = new L3CacheRepositoryDecorator(decoratedRepository, l3Cache, transactionInformation);</span>

		// 11. Register the cud action needed to index indexed repositories
<span class="nc" id="L105">		decoratedRepository = new IndexActionRepositoryDecorator(decoratedRepository, indexActionRegisterService);</span>

		// 10. Custom decorators for system entity types
<span class="nc" id="L108">		decoratedRepository = systemRepositoryDecoratorRegistry.decorate(decoratedRepository);</span>

		// 9. Perform cascading deletes
<span class="nc" id="L111">		decoratedRepository = new CascadeDeleteRepositoryDecorator(decoratedRepository, dataService);</span>

		// 8. Row level security decorator
<span class="nc" id="L114">		decoratedRepository = rowLevelSecurityRepositoryDecoratorFactory.createDecoratedRepository(decoratedRepository);</span>

		// 7. Entity reference resolver decorator
<span class="nc" id="L117">		decoratedRepository = new EntityReferenceResolverDecorator(decoratedRepository, entityManager);</span>

		// 6. Entity listener
<span class="nc" id="L120">		decoratedRepository = new EntityListenerRepositoryDecorator(decoratedRepository, entityListenersService);</span>

		// 5. validation decorator
<span class="nc" id="L123">		decoratedRepository = new RepositoryValidationDecorator(dataService, decoratedRepository,</span>
				entityAttributesValidator, defaultValueReferenceValidator);

		// 4. aggregate anonymization decorator
<span class="nc" id="L127">		decoratedRepository = new AggregateAnonymizerRepositoryDecorator&lt;&gt;(decoratedRepository, aggregateAnonymizer,</span>
				appSettings);

		// 3. security decorator
<span class="nc" id="L131">		decoratedRepository = new RepositorySecurityDecorator(decoratedRepository, permissionService);</span>

		// 2. transaction decorator
<span class="nc" id="L134">		decoratedRepository = new TransactionalRepositoryDecorator&lt;&gt;(decoratedRepository, transactionManager);</span>

		// 1. query validation decorator
<span class="nc" id="L137">		decoratedRepository = new QueryValidationRepositoryDecorator&lt;&gt;(decoratedRepository, queryValidator);</span>

		// 0. Dynamic decorators
<span class="nc" id="L140">		decoratedRepository = dynamicRepositoryDecoratorRegistry.decorate(decoratedRepository);</span>

<span class="nc" id="L142">		return decoratedRepository;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>