<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReflectUtils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">redis-proxy-core</a> &gt; <a href="index.source.html" class="el_package">com.rains.proxy.core.utils</a> &gt; <span class="el_source">ReflectUtils.java</span></div><h1>ReflectUtils.java</h1><pre class="source lang-java linenums">
package com.rains.proxy.core.utils;

import java.lang.reflect.Array;
import java.lang.reflect.Field;
import java.lang.reflect.Method;
import java.lang.reflect.Modifier;
import java.util.*;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ConcurrentMap;

/**
 * 反射相关的辅助类
 * 
 * @author liubing
 * 
 */
<span class="nc" id="L18">public class ReflectUtils {</span>
    public static final String PARAM_CLASS_SPLIT = &quot;,&quot;;
    public static final String EMPTY_PARAM = &quot;void&quot;;
<span class="nc" id="L21">    private static final Class&lt;?&gt;[] EMPTY_CLASS_ARRAY = new Class&lt;?&gt;[0];</span>

<span class="nc" id="L23">    private static final ConcurrentMap&lt;String, Class&lt;?&gt;&gt; name2ClassCache = new ConcurrentHashMap&lt;String, Class&lt;?&gt;&gt;();</span>
<span class="nc" id="L24">    private static final ConcurrentMap&lt;Class&lt;?&gt;, String&gt; class2NameCache = new ConcurrentHashMap&lt;Class&lt;?&gt;, String&gt;();</span>

<span class="nc" id="L26">    private static final String[] PRIMITIVE_NAMES = new String[] {&quot;boolean&quot;, &quot;byte&quot;, &quot;char&quot;, &quot;double&quot;, &quot;float&quot;, &quot;int&quot;, &quot;long&quot;, &quot;short&quot;,</span>
            &quot;void&quot;};

<span class="nc" id="L29">    private static final Class&lt;?&gt;[] PRIMITIVE_CLASSES = new Class[] {boolean.class, byte.class, char.class, double.class, float.class,</span>
            int.class, long.class, short.class, Void.TYPE};

    private static final int PRIMITIVE_CLASS_NAME_MAX_LENGTH = 7;

    /**
     * 获取method方式的接口参数，以逗号分割，拼接clz列表。 如果没有参数，那么void表示
     * 
     * @param method
     * @return
     */
    public static String getMethodParamDesc(Method method) {
<span class="nc bnc" id="L41" title="All 4 branches missed.">        if (method.getParameterTypes() == null || method.getParameterTypes().length == 0) {</span>
<span class="nc" id="L42">            return EMPTY_PARAM;</span>
        }

<span class="nc" id="L45">        StringBuilder builder = new StringBuilder();</span>

<span class="nc" id="L47">        Class&lt;?&gt;[] clzs = method.getParameterTypes();</span>

<span class="nc bnc" id="L49" title="All 2 branches missed.">        for (Class&lt;?&gt; clz : clzs) {</span>
<span class="nc" id="L50">            String className = getName(clz);</span>
<span class="nc" id="L51">            builder.append(className).append(PARAM_CLASS_SPLIT);</span>
        }

<span class="nc" id="L54">        return builder.substring(0, builder.length() - 1);</span>
    }

    /**
     * 获取方法的标示 : method_name + &quot;(&quot; + paramDesc + &quot;)&quot;
     * 
     * @param method
     * @return
     */
    public static String getMethodDesc(Method method) {
<span class="nc" id="L64">        String methodParamDesc = getMethodParamDesc(method);</span>
<span class="nc" id="L65">        return getMethodDesc(method.getName(), methodParamDesc);</span>
    }

    /**
     * 获取方法的标示 : method_name + &quot;(&quot; + paramDesc + &quot;)&quot;
     * 
     * @param
     * @return
     */
    public static String getMethodDesc(String methodName, String paramDesc) {
<span class="nc bnc" id="L75" title="All 2 branches missed.">        if (paramDesc == null) {</span>
<span class="nc" id="L76">            return methodName + &quot;()&quot;;</span>
        } else {
<span class="nc" id="L78">            return methodName + &quot;(&quot; + paramDesc + &quot;)&quot;;</span>
        }
    }

    public static Class&lt;?&gt;[] forNames(String classList) throws ClassNotFoundException {
<span class="nc bnc" id="L83" title="All 6 branches missed.">        if (classList == null || &quot;&quot;.equals(classList) || EMPTY_PARAM.equals(classList)) {</span>
<span class="nc" id="L84">            return EMPTY_CLASS_ARRAY;</span>
        }

<span class="nc" id="L87">        String[] classNames = classList.split(PARAM_CLASS_SPLIT);</span>
<span class="nc" id="L88">        Class&lt;?&gt;[] classTypes = new Class&lt;?&gt;[classNames.length];</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">        for (int i = 0; i &lt; classNames.length; i++) {</span>
<span class="nc" id="L90">            String className = classNames[i];</span>

<span class="nc" id="L92">            classTypes[i] = forName(className);</span>
        }

<span class="nc" id="L95">        return classTypes;</span>
    }

    public static Class&lt;?&gt; forName(String className) throws ClassNotFoundException {
<span class="nc bnc" id="L99" title="All 4 branches missed.">        if (null == className || &quot;&quot;.equals(className)) {</span>
<span class="nc" id="L100">            return null;</span>
        }

<span class="nc" id="L103">        Class&lt;?&gt; clz = name2ClassCache.get(className);</span>

<span class="nc bnc" id="L105" title="All 2 branches missed.">        if (clz != null) {</span>
<span class="nc" id="L106">            return clz;</span>
        }

<span class="nc" id="L109">        clz = forNameWithoutCache(className);</span>

        // 应该没有内存消耗过多的可能，除非有些代码很恶心，创建特别多的类
<span class="nc" id="L112">        name2ClassCache.putIfAbsent(className, clz);</span>

<span class="nc" id="L114">        return clz;</span>
    }

    private static Class&lt;?&gt; forNameWithoutCache(String className) throws ClassNotFoundException {
<span class="nc bnc" id="L118" title="All 2 branches missed.">        if (!className.endsWith(&quot;[]&quot;)) { // not array</span>
<span class="nc" id="L119">            Class&lt;?&gt; clz = getPrimitiveClass(className);</span>

<span class="nc bnc" id="L121" title="All 2 branches missed.">            clz = (clz != null) ? clz : Class.forName(className, true, Thread.currentThread().getContextClassLoader());</span>
<span class="nc" id="L122">            return clz;</span>
        }

<span class="nc" id="L125">        int dimensionSiz = 0;</span>

<span class="nc bnc" id="L127" title="All 2 branches missed.">        while (className.endsWith(&quot;[]&quot;)) {</span>
<span class="nc" id="L128">            dimensionSiz++;</span>

<span class="nc" id="L130">            className = className.substring(0, className.length() - 2);</span>
        }

<span class="nc" id="L133">        int[] dimensions = new int[dimensionSiz];</span>

<span class="nc" id="L135">        Class&lt;?&gt; clz = getPrimitiveClass(className);</span>

<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (clz == null) {</span>
<span class="nc" id="L138">            clz = Class.forName(className, true, Thread.currentThread().getContextClassLoader());</span>
        }

<span class="nc" id="L141">        return Array.newInstance(clz, dimensions).getClass();</span>
    }

    /**
     * 需要支持一维数组、二维数组等
     * 
     * @param
     * @return
     */
    public static String getName(Class&lt;?&gt; clz) {
<span class="nc bnc" id="L151" title="All 2 branches missed.">        if (clz == null) {</span>
<span class="nc" id="L152">            return null;</span>
        }

<span class="nc" id="L155">        String className = class2NameCache.get(clz);</span>

<span class="nc bnc" id="L157" title="All 2 branches missed.">        if (className != null) {</span>
<span class="nc" id="L158">            return className;</span>
        }

<span class="nc" id="L161">        className = getNameWithoutCache(clz);</span>

        // 与name2ClassCache同样道理，如果没有恶心的代码，这块内存大小应该可控
<span class="nc" id="L164">        class2NameCache.putIfAbsent(clz, className);</span>

<span class="nc" id="L166">        return className;</span>
    }

    private static String getNameWithoutCache(Class&lt;?&gt; clz) {
<span class="nc bnc" id="L170" title="All 2 branches missed.">        if (!clz.isArray()) {</span>
<span class="nc" id="L171">            return clz.getName();</span>
        }

<span class="nc" id="L174">        StringBuilder sb = new StringBuilder();</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">        while (clz.isArray()) {</span>
<span class="nc" id="L176">            sb.append(&quot;[]&quot;);</span>
<span class="nc" id="L177">            clz = clz.getComponentType();</span>
        }

<span class="nc" id="L180">        return clz.getName() + sb.toString();</span>
    }

    public static Class&lt;?&gt; getPrimitiveClass(String name) {
        // check if is primitive class
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (name.length() &lt;= PRIMITIVE_CLASS_NAME_MAX_LENGTH) {</span>
<span class="nc" id="L186">            int index = Arrays.binarySearch(PRIMITIVE_NAMES, name);</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">            if (index &gt;= 0) {</span>
<span class="nc" id="L188">                return PRIMITIVE_CLASSES[index];</span>
            }
        }
<span class="nc" id="L191">        return null;</span>
    }

    /**
     * 获取clz public method
     * 
     * &lt;pre&gt;
     *      1）不包含构造函数
     *      2）不包含Object.class
     *      3）包含该clz的父类的所有public方法
     * &lt;/pre&gt;
     * 
     * @param clz
     * @return
     */
    public static List&lt;Method&gt; getPublicMethod(Class&lt;?&gt; clz) {
<span class="nc" id="L207">        Method[] methods = clz.getMethods();</span>
<span class="nc" id="L208">        List&lt;Method&gt; ret = new ArrayList&lt;Method&gt;();</span>

<span class="nc bnc" id="L210" title="All 2 branches missed.">        for (Method method : methods) {</span>

<span class="nc" id="L212">            boolean isPublic = Modifier.isPublic(method.getModifiers());</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">            boolean isNotObjectClass = method.getDeclaringClass() != Object.class;</span>

<span class="nc bnc" id="L215" title="All 4 branches missed.">            if (isPublic &amp;&amp; isNotObjectClass) {</span>
<span class="nc" id="L216">                ret.add(method);</span>
            }
        }

<span class="nc" id="L220">        return ret;</span>
    }

    public static Object getEmptyObject(Class&lt;?&gt; returnType) {
<span class="nc" id="L224">        return getEmptyObject(returnType, new HashMap&lt;Class&lt;?&gt;, Object&gt;(), 0);</span>
    }

    private static Object getEmptyObject(Class&lt;?&gt; returnType, Map&lt;Class&lt;?&gt;, Object&gt; emptyInstances, int level) {
<span class="nc bnc" id="L228" title="All 2 branches missed.">        if (level &gt; 2) return null;</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">        if (returnType == null) {</span>
<span class="nc" id="L230">            return null;</span>
<span class="nc bnc" id="L231" title="All 4 branches missed.">        } else if (returnType == boolean.class || returnType == Boolean.class) {</span>
<span class="nc" id="L232">            return false;</span>
<span class="nc bnc" id="L233" title="All 4 branches missed.">        } else if (returnType == char.class || returnType == Character.class) {</span>
<span class="nc" id="L234">            return '\0';</span>
<span class="nc bnc" id="L235" title="All 4 branches missed.">        } else if (returnType == byte.class || returnType == Byte.class) {</span>
<span class="nc" id="L236">            return (byte) 0;</span>
<span class="nc bnc" id="L237" title="All 4 branches missed.">        } else if (returnType == short.class || returnType == Short.class) {</span>
<span class="nc" id="L238">            return (short) 0;</span>
<span class="nc bnc" id="L239" title="All 4 branches missed.">        } else if (returnType == int.class || returnType == Integer.class) {</span>
<span class="nc" id="L240">            return 0;</span>
<span class="nc bnc" id="L241" title="All 4 branches missed.">        } else if (returnType == long.class || returnType == Long.class) {</span>
<span class="nc" id="L242">            return 0L;</span>
<span class="nc bnc" id="L243" title="All 4 branches missed.">        } else if (returnType == float.class || returnType == Float.class) {</span>
<span class="nc" id="L244">            return 0F;</span>
<span class="nc bnc" id="L245" title="All 4 branches missed.">        } else if (returnType == double.class || returnType == Double.class) {</span>
<span class="nc" id="L246">            return 0D;</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">        } else if (returnType.isArray()) {</span>
<span class="nc" id="L248">            return Array.newInstance(returnType.getComponentType(), 0);</span>
<span class="nc bnc" id="L249" title="All 2 branches missed.">        } else if (returnType.isAssignableFrom(ArrayList.class)) {</span>
<span class="nc" id="L250">            return new ArrayList&lt;Object&gt;(0);</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">        } else if (returnType.isAssignableFrom(HashSet.class)) {</span>
<span class="nc" id="L252">            return new HashSet&lt;Object&gt;(0);</span>
<span class="nc bnc" id="L253" title="All 2 branches missed.">        } else if (returnType.isAssignableFrom(HashMap.class)) {</span>
<span class="nc" id="L254">            return new HashMap&lt;Object, Object&gt;(0);</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">        } else if (String.class.equals(returnType)) {</span>
<span class="nc" id="L256">            return &quot;&quot;;</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">        } else if (!returnType.isInterface()) {</span>
            try {
<span class="nc" id="L259">                Object value = emptyInstances.get(returnType);</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">                if (value == null) {</span>
<span class="nc" id="L261">                    value = returnType.newInstance();</span>
<span class="nc" id="L262">                    emptyInstances.put(returnType, value);</span>
                }
<span class="nc" id="L264">                Class&lt;?&gt; cls = value.getClass();</span>
<span class="nc bnc" id="L265" title="All 4 branches missed.">                while (cls != null &amp;&amp; cls != Object.class) {</span>
<span class="nc" id="L266">                    Field[] fields = cls.getDeclaredFields();</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">                    for (Field field : fields) {</span>
<span class="nc" id="L268">                        Object property = getEmptyObject(field.getType(), emptyInstances, level + 1);</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">                        if (property != null) {</span>
                            try {
<span class="nc bnc" id="L271" title="All 2 branches missed.">                                if (!field.isAccessible()) {</span>
<span class="nc" id="L272">                                    field.setAccessible(true);</span>
                                }
<span class="nc" id="L274">                                field.set(value, property);</span>
<span class="nc" id="L275">                            } catch (Throwable e) {}</span>
                        }
                    }
<span class="nc" id="L278">                    cls = cls.getSuperclass();</span>
<span class="nc" id="L279">                }</span>
<span class="nc" id="L280">                return value;</span>
<span class="nc" id="L281">            } catch (Throwable e) {</span>
<span class="nc" id="L282">                return null;</span>
            }
        } else {
<span class="nc" id="L285">            return null;</span>
        }
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>