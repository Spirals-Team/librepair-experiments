<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ImportJob.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">data-import</a> &gt; <a href="index.source.html" class="el_package">org.molgenis.data.importer</a> &gt; <span class="el_source">ImportJob.java</span></div><h1>ImportJob.java</h1><pre class="source lang-java linenums">package org.molgenis.data.importer;

import org.apache.commons.lang3.StringUtils;
import org.molgenis.data.DatabaseAction;
import org.molgenis.data.RepositoryCollection;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.security.core.context.SecurityContext;
import org.springframework.security.core.context.SecurityContextHolder;

import javax.servlet.http.HttpSession;

public class ImportJob implements Runnable
{
<span class="nc" id="L15">	private static final Logger LOG = LoggerFactory.getLogger(ImportJob.class);</span>

	private final ImportService importService;
	private final SecurityContext securityContext;
	private final RepositoryCollection source;
	private final DatabaseAction databaseAction;
	private final String importRunId;
	private final ImportRunService importRunService;
	private final HttpSession session;
	private final String packageId;

	public ImportJob(ImportService importService, SecurityContext securityContext, RepositoryCollection source,
			DatabaseAction databaseAction, String importRunId, ImportRunService importRunService, HttpSession session,
			String packageId)
<span class="nc" id="L29">	{</span>
<span class="nc" id="L30">		this.importService = importService;</span>
<span class="nc" id="L31">		this.securityContext = securityContext;</span>
<span class="nc" id="L32">		this.source = source;</span>
<span class="nc" id="L33">		this.databaseAction = databaseAction;</span>
<span class="nc" id="L34">		this.importRunId = importRunId;</span>
<span class="nc" id="L35">		this.importRunService = importRunService;</span>
<span class="nc" id="L36">		this.session = session;</span>
<span class="nc" id="L37">		this.packageId = packageId;</span>
<span class="nc" id="L38">	}</span>

	@Override
	public void run()
	{
		try
		{
<span class="nc" id="L45">			long t0 = System.currentTimeMillis();</span>
<span class="nc" id="L46">			LOG.info(&quot;Import started&quot;);</span>

<span class="nc" id="L48">			SecurityContextHolder.setContext(securityContext);</span>

<span class="nc" id="L50">			EntityImportReport importReport = importService.doImport(source, databaseAction, packageId);</span>

<span class="nc" id="L52">			session.setAttribute(&quot;SPRING_SECURITY_CONTEXT&quot;, securityContext);</span>

			try
			{
<span class="nc" id="L56">				session.setAttribute(&quot;SPRING_SECURITY_CONTEXT&quot;, securityContext);</span>
			}
<span class="nc" id="L58">			catch (IllegalStateException e)</span>
			{
				// session invalidated
<span class="nc" id="L61">			}</span>

<span class="nc" id="L63">			importRunService.finishImportRun(importRunId, importReport.toString(),</span>
<span class="nc" id="L64">					StringUtils.join(importReport.getNewEntities(), ','));</span>

<span class="nc" id="L66">			long t = System.currentTimeMillis();</span>
<span class="nc" id="L67">			LOG.info(&quot;Import finished in &quot; + (t - t0) + &quot; msec.&quot;);</span>
		}
<span class="nc" id="L69">		catch (Exception e)</span>
		{
<span class="nc" id="L71">			LOG.info(&quot;Import failed.&quot;, e);</span>
<span class="nc" id="L72">			importRunService.failImportRun(importRunId, e.getLocalizedMessage());</span>
<span class="nc" id="L73">		}</span>
<span class="nc" id="L74">	}</span>

	@Override
	public boolean equals(Object o)
	{
<span class="nc bnc" id="L79" title="All 2 branches missed.">		if (this == o) return true;</span>
<span class="nc bnc" id="L80" title="All 4 branches missed.">		if (o == null || getClass() != o.getClass()) return false;</span>

<span class="nc" id="L82">		ImportJob importJob = (ImportJob) o;</span>

<span class="nc bnc" id="L84" title="All 6 branches missed.">		if (importService != null ? !importService.equals(importJob.importService) : importJob.importService != null)</span>
<span class="nc" id="L85">			return false;</span>
<span class="nc bnc" id="L86" title="All 6 branches missed.">		if (securityContext != null ? !securityContext.equals(importJob.securityContext) :</span>
<span class="nc" id="L87">				importJob.securityContext != null) return false;</span>
<span class="nc bnc" id="L88" title="All 6 branches missed.">		if (source != null ? !source.equals(importJob.source) : importJob.source != null) return false;</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">		if (databaseAction != importJob.databaseAction) return false;</span>
<span class="nc bnc" id="L90" title="All 6 branches missed.">		if (importRunId != null ? !importRunId.equals(importJob.importRunId) : importJob.importRunId != null)</span>
<span class="nc" id="L91">			return false;</span>
<span class="nc bnc" id="L92" title="All 6 branches missed.">		if (importRunService != null ? !importRunService.equals(importJob.importRunService) :</span>
<span class="nc" id="L93">				importJob.importRunService != null) return false;</span>
<span class="nc bnc" id="L94" title="All 6 branches missed.">		if (session != null ? !session.equals(importJob.session) : importJob.session != null) return false;</span>
<span class="nc bnc" id="L95" title="All 4 branches missed.">		return packageId != null ? packageId.equals(importJob.packageId) : importJob.packageId == null;</span>
	}

	@Override
	public int hashCode()
	{
<span class="nc bnc" id="L101" title="All 2 branches missed.">		int result = importService != null ? importService.hashCode() : 0;</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">		result = 31 * result + (securityContext != null ? securityContext.hashCode() : 0);</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">		result = 31 * result + (source != null ? source.hashCode() : 0);</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">		result = 31 * result + (databaseAction != null ? databaseAction.hashCode() : 0);</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">		result = 31 * result + (importRunId != null ? importRunId.hashCode() : 0);</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">		result = 31 * result + (importRunService != null ? importRunService.hashCode() : 0);</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">		result = 31 * result + (session != null ? session.hashCode() : 0);</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">		result = 31 * result + (packageId != null ? packageId.hashCode() : 0);</span>
<span class="nc" id="L109">		return result;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>