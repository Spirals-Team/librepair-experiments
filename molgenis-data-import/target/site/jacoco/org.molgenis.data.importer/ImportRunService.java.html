<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ImportRunService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">data-import</a> &gt; <a href="index.source.html" class="el_package">org.molgenis.data.importer</a> &gt; <span class="el_source">ImportRunService.java</span></div><h1>ImportRunService.java</h1><pre class="source lang-java linenums">package org.molgenis.data.importer;

import org.molgenis.data.DataService;
import org.molgenis.data.MolgenisDataException;
import org.molgenis.data.security.user.UserService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.mail.MailException;
import org.springframework.mail.MailSender;
import org.springframework.mail.SimpleMailMessage;
import org.springframework.stereotype.Component;

import java.time.ZoneId;
import java.time.ZonedDateTime;

import static java.time.Instant.now;
import static java.time.format.DateTimeFormatter.ofLocalizedDateTime;
import static java.time.format.DateTimeFormatter.ofLocalizedTime;
import static java.time.format.FormatStyle.FULL;
import static java.time.format.FormatStyle.MEDIUM;
import static java.util.Locale.ENGLISH;
import static java.util.Objects.requireNonNull;
import static org.molgenis.data.importer.ImportRunMetaData.IMPORT_RUN;

@Component
public class ImportRunService
{
<span class="fc" id="L28">	private static final Logger LOG = LoggerFactory.getLogger(ImportRunService.class);</span>

	private final DataService dataService;
	private final MailSender mailSender;
	private final UserService userService;
	private final ImportRunFactory importRunFactory;

	public ImportRunService(DataService dataService, MailSender mailSender, UserService userService,
			ImportRunFactory importRunFactory)
<span class="fc" id="L37">	{</span>
<span class="fc" id="L38">		this.dataService = requireNonNull(dataService);</span>
<span class="fc" id="L39">		this.mailSender = requireNonNull(mailSender);</span>
<span class="fc" id="L40">		this.userService = requireNonNull(userService);</span>
<span class="fc" id="L41">		this.importRunFactory = requireNonNull(importRunFactory);</span>
<span class="fc" id="L42">	}</span>

	public ImportRun addImportRun(String userName, boolean notify)
	{
<span class="nc" id="L46">		ImportRun importRun = importRunFactory.create();</span>
<span class="nc" id="L47">		importRun.setStartDate(now());</span>
<span class="nc" id="L48">		importRun.setProgress(0);</span>
<span class="nc" id="L49">		importRun.setStatus(ImportStatus.RUNNING.toString());</span>
<span class="nc" id="L50">		importRun.setUsername(userName); // required and visible</span>
<span class="nc" id="L51">		importRun.setNotify(notify);</span>
<span class="nc" id="L52">		dataService.add(IMPORT_RUN, importRun);</span>

<span class="nc" id="L54">		return importRun;</span>
	}

	public void finishImportRun(String importRunId, String message, String importedEntities)
	{
<span class="nc" id="L59">		ImportRun importRun = dataService.findOneById(IMPORT_RUN, importRunId, ImportRun.class);</span>
		try
		{
<span class="nc" id="L62">			importRun.setStatus(ImportStatus.FINISHED.toString());</span>
<span class="nc" id="L63">			importRun.setEndDate(now());</span>
<span class="nc" id="L64">			importRun.setMessage(message);</span>
<span class="nc" id="L65">			importRun.setImportedEntities(importedEntities);</span>
<span class="nc" id="L66">			dataService.update(IMPORT_RUN, importRun);</span>
		}
<span class="nc" id="L68">		catch (Exception e)</span>
		{
<span class="nc" id="L70">			LOG.error(&quot;Error updating run status&quot;, e);</span>
<span class="nc" id="L71">		}</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">		if (importRun.getNotify()) createAndSendStatusMail(importRun);</span>
<span class="nc" id="L73">	}</span>

	private void createAndSendStatusMail(ImportRun importRun)
	{
		try
		{
<span class="nc" id="L79">			SimpleMailMessage mailMessage = new SimpleMailMessage();</span>
<span class="nc" id="L80">			mailMessage.setTo(userService.getUser(importRun.getUsername()).getEmail());</span>
<span class="nc" id="L81">			mailMessage.setSubject(createMailTitle(importRun));</span>
<span class="nc" id="L82">			mailMessage.setText(createEnglishMailText(importRun, ZoneId.systemDefault()));</span>
<span class="nc" id="L83">			mailSender.send(mailMessage);</span>
		}
<span class="nc" id="L85">		catch (MailException mce)</span>
		{
<span class="nc" id="L87">			LOG.error(&quot;Could not send import status mail&quot;, mce);</span>
<span class="nc" id="L88">			throw new MolgenisDataException(&quot;An error occurred. Please contact the administrator.&quot;);</span>
<span class="nc" id="L89">		}</span>
<span class="nc" id="L90">	}</span>

	/**
	 * Creates an English mail message describing a finished {@link ImportRun}.
	 * Formats the run's start and end times using {@link ZoneId#systemDefault()}.
	 *
	 * @param importRun the ImportRun to describe, it should have non-null start and end dates.
	 * @return String containing the mail message.
	 */
	String createEnglishMailText(ImportRun importRun, ZoneId zone)
	{
<span class="fc" id="L101">		ZonedDateTime start = importRun.getStartDate().atZone(zone);</span>
<span class="fc" id="L102">		ZonedDateTime end = importRun.getEndDate().atZone(zone);</span>
<span class="fc" id="L103">		String startDateTimeString = ofLocalizedDateTime(FULL).withLocale(ENGLISH).format(start);</span>
<span class="fc" id="L104">		String endTimeString = ofLocalizedTime(MEDIUM).withLocale(ENGLISH).format(end);</span>

<span class="fc" id="L106">		return String.format(&quot;The import started by you on %1s finished on %2s with status: %3s\nMessage:\n%4s&quot;,</span>
<span class="fc" id="L107">				startDateTimeString, endTimeString, importRun.getStatus(), importRun.getMessage());</span>
	}

	private String createMailTitle(ImportRun importRun)
	{
<span class="nc" id="L112">		return &quot;importRun &quot; + importRun.getStatus();</span>
	}

	public void failImportRun(String importRunId, String message)
	{
<span class="nc" id="L117">		ImportRun importRun = dataService.findOneById(IMPORT_RUN, importRunId, ImportRun.class);</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">		if (importRun != null)</span>
		{
			try
			{
<span class="nc" id="L122">				importRun.setStatus(ImportStatus.FAILED.toString());</span>
<span class="nc" id="L123">				importRun.setEndDate(now());</span>
<span class="nc" id="L124">				importRun.setMessage(message);</span>
<span class="nc" id="L125">				dataService.update(IMPORT_RUN, importRun);</span>

			}
<span class="nc" id="L128">			catch (Exception e)</span>
			{
<span class="nc" id="L130">				LOG.error(&quot;Error updating run status&quot;, e);</span>
<span class="nc" id="L131">			}</span>

<span class="nc bnc" id="L133" title="All 2 branches missed.">			if (importRun.getNotify())</span>
			{
<span class="nc" id="L135">				createAndSendStatusMail(importRun);</span>
			}
		}
<span class="nc" id="L138">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>