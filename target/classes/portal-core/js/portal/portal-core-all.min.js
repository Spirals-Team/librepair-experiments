Ext.define("portal.charts.3DScatterPlot",{extend:"Ext.panel.Panel",alias:"widget.threedscatterplot",data:null,d3:null,threeJs:null,innerId:null,useCanvasRenderer:!1,constructor:function(a){this.threeJs=this.d3=null;this.innerId=Ext.id();this.data=a.data?a.data:null;this.pointSize=a.pointSize?a.pointSize:10;this.allowSelection=a.allowSelection?!0:!1;this.xAttr=a.xAttr?a.xAttr:"x";this.xLabel=a.xLabel?a.xLabel:"X";this.xDomain=a.xDomain?a.xDomain:null;this.xHideValueLabel=a.xHideValueLabel?!0:!1;this.yAttr=
a.yAttr?a.yAttr:"y";this.yLabel=a.yLabel?a.yLabel:"Y";this.yDomain=a.yDomain?a.yDomain:null;this.yHideValueLabel=a.xHideValueLabel?!0:!1;this.zAttr=a.zAttr?a.zAttr:"z";this.zLabel=a.zLabel?a.zLabel:"Z";this.zDomain=a.zDomain?a.zDomain:null;this.zHideValueLabel=a.xHideValueLabel?!0:!1;this.valueAttr=a.valueAttr?a.valueAttr:"value";this.valueLabel=a.valueLabel?a.valueLabel:"Value";this.valueDomain=a.valueDomain?a.valueDomain:null;this.valueScale=a.valueScale?a.valueScale:"linear";this.valueRenderer=
a.valueRenderer?a.valueRenderer:null;Ext.apply(a,{html:Ext.util.Format.format('\x3cdiv id\x3d"{0}" style\x3d"width:100%;height:100%;"\x3e\x3c/div\x3e',this.innerId)});this.callParent(arguments);Ext.isIE10m&&(this.useCanvasRenderer=!0,this.loadingDeps=!1,this.loadingDepsCallback=null,THREE.CanvasRenderer||(this.loadingDeps=!0,Ext.Loader.loadScript({url:"portal-core/js/threejs/renderers/CanvasRenderer.js",scope:this,onLoad:function(){Ext.Loader.loadScript({url:"portal-core/js/threejs/renderers/Projector.js",
scope:this,onLoad:function(){this.loadingDeps=!1;Ext.isFunction(this.loadingDepsCallback)&&this.loadingDepsCallback()}})}})));this.on("render",this._afterRender,this);this.on("resize",this._onResize,this)},_afterRender:function(){if(this.loadingDeps)this.loadingDepsCallback=this._afterRender;else{this.threeJs={camera:null,controls:null,scene:null,renderer:null,width:null,height:null};this.threeJs.scene=new THREE.Scene;var a=this.getEl();this.threeJs.width=a.getWidth();this.threeJs.height=a.getHeight();
this.allowSelection&&(a.on("mousedown",this._handleMouseDown,this),a.on("mouseup",this._handleMouseUp,this),this.threeJs.raycaster=new THREE.Raycaster,this.threeJs.raycaster.params.PointCloud.threshold=this.pointSize/3);a=document.getElementById(this.innerId);this.threeJs.camera=new THREE.PerspectiveCamera(60,this.threeJs.width/this.threeJs.height,1,1E4);this.threeJs.camera.position.z=180;this.threeJs.camera.position.y=18;this.threeJs.scene.add(this.threeJs.camera);this.threeJs.controls=new THREE.OrbitControls(this.threeJs.camera,
a);this.threeJs.controls.damping=.2;this.threeJs.controls.target=new THREE.Vector3(0,0,0);this.threeJs.controls.addEventListener("change",Ext.bind(this._renderThreeJs,this));this.threeJs.renderer=Ext.isIE10m?new THREE.CanvasRenderer({antialias:!1}):new THREE.WebGLRenderer({antialias:!1});this.threeJs.renderer.setClearColor(16777215,1);this.threeJs.renderer.setSize(this.threeJs.width,this.threeJs.height);a.appendChild(this.threeJs.renderer.domElement);var b=this,c=function(){requestAnimationFrame(c);
b.threeJs.controls.update()};c();this.data&&this.plot(this.data);this._renderThreeJs()}},_renderThreeJs:function(){this.threeJs.renderer.render(this.threeJs.scene,this.threeJs.camera)},_onResize:function(a,b,c){this.threeJs&&(a=this.getEl(),this.threeJs.width=a.getWidth(),this.threeJs.height=a.getHeight(),this.threeJs.camera.aspect=this.threeJs.width/this.threeJs.height,this.threeJs.camera.updateProjectionMatrix(),this.threeJs.renderer.setSize(this.threeJs.width,this.threeJs.height),this._renderThreeJs())},
_relMouseCoords:function(a,b){var c=0,d=0,e=0,f=0,e=b;do c+=e.offsetLeft-e.scrollLeft,d+=e.offsetTop-e.scrollTop;while(e=e.offsetParent);e=a.pageX-c;f=a.pageY-d;return{x:e,y:f}},_handleMouseDown:function(a,b){this._md=this._relMouseCoords(a.browserEvent,b)},_handleMouseUp:function(a,b){var c=this._relMouseCoords(a.browserEvent,b),d=c.x,c=c.y;10<Math.abs(this._md.x-d)+Math.abs(this._md.y-c)||(d=(new THREE.Vector3(d/this.threeJs.width*2-1,2*-(c/this.threeJs.height)+1,.5)).unproject(this.threeJs.camera).clone().sub(this.threeJs.camera.position).normalize(),
this.threeJs.raycaster.ray.set(this.threeJs.camera.position,d),d=this.threeJs.raycaster.intersectObject(this.threeJs.pointCloud),0<d.length?this._handlePointSelect(d[0].index,d[0].point):this._clearPointSelect())},_handlePointSelect:function(a,b){var c=this.data[a],d=this.threeJs.pointCloud.geometry.colors[a];if(this.threeJs.selectionMesh)this.threeJs.selectionMesh.material.color=d;else{var e=new THREE.SphereGeometry(.8*this.pointSize,8,8),d=new THREE.MeshBasicMaterial({color:d,opacity:1,transparent:!1});
this.threeJs.selectionMesh=new THREE.Mesh(e,d)}this.threeJs.selectionMesh.position.set(this.d3.xScale(c[this.xAttr]),this.d3.yScale(c[this.yAttr]),this.d3.zScale(c[this.zAttr]));this.threeJs.scene.add(this.threeJs.selectionMesh);this._renderThreeJs();this.fireEvent("select",this,c)},_clearPointSelect:function(){this.threeJs.selectionMesh&&(this.threeJs.scene.remove(this.threeJs.selectionMesh),this.threeJs.selectionMesh=null,this._renderThreeJs());this.fireEvent("deselect",this)},clearPlot:function(){if(this.threeJs){for(var a=
this.threeJs.scene.children.length-1;0<=a;a--)this.threeJs.scene.remove(this.threeJs.scene.children[a]);this.d3={};this.data=null}},plot:function(a){function b(a,b,c){return new THREE.Vector3(a,b,c)}function c(a,b,c,d,e,f){var g;g=d||16;d=document.createElement("canvas");var h=d.getContext("2d");c=g+"px "+(c||"Arial");h.font=c;var k=h.measureText(a).width,l=Math.ceil(g);d.width=k;d.height=l;h.font=c;h.fillStyle=b||"black";h.fillText(a,0,Math.ceil(.8*g));a=new THREE.PlaneGeometry(d.width,d.height,
e,f);b=new THREE.Texture(d);b.needsUpdate=!0;b=new THREE.MeshBasicMaterial({map:b,color:16777215,transparent:!0});e=a.clone();a.merge(e,(new THREE.Matrix4).makeRotationY(Math.PI),1);a=new THREE.Mesh(a,b);a.scale.set(.5,.5,.5);a.material.side=THREE.FrontSide;return a}var d=this;this.clearPlot();this.data=a;this.d3.xExtent=this.xDomain?this.xDomain:d3.extent(a,function(a){return a[d.xAttr]});this.d3.yExtent=this.yDomain?this.yDomain:d3.extent(a,function(a){return a[d.yAttr]});this.d3.zExtent=this.zDomain?
this.zDomain:d3.extent(a,function(a){return a[d.zAttr]});this.d3.valueExtent=this.valueDomain?this.valueDomain:d3.extent(a,function(a){return a[d.valueAttr]});var e=d3.format("+.3f"),f=this.d3.xExtent[1],g=(this.d3.xExtent[1]+this.d3.xExtent[0])/2,h=this.d3.xExtent[0],k=this.d3.yExtent[1],l=(this.d3.yExtent[1]+this.d3.yExtent[0])/2,m=this.d3.yExtent[0],n=this.d3.zExtent[1],t=(this.d3.zExtent[1]+this.d3.zExtent[0])/2,q=this.d3.zExtent[0],p,r,s,v;p=this.d3.xScale=d3.scale.linear().domain(this.d3.xExtent).range([-50,
50]);r=this.d3.yScale=d3.scale.linear().domain(this.d3.yExtent).range([-50,50]);s=this.d3.zScale=d3.scale.linear().domain(this.d3.zExtent).range([-50,50]);if("linear"===this.valueScale)v=this.d3.valueScale=d3.scale.linear();else if("log"===this.valueScale)v=this.d3.valueScale=d3.scale.log();else throw"Invalid valueScale: "+this.valueScale;v.domain(this.d3.valueExtent).range([0,1]);var u=new THREE.Geometry;u.vertices.push(b(p(h),r(m),s(q)),b(p(f),r(m),s(q)),b(p(f),r(k),s(q)),b(p(h),r(k),s(q)),b(p(h),
r(m),s(q)),b(p(h),r(m),s(t)),b(p(f),r(m),s(t)),b(p(f),r(k),s(t)),b(p(h),r(k),s(t)),b(p(h),r(m),s(t)),b(p(h),r(m),s(n)),b(p(f),r(m),s(n)),b(p(f),r(k),s(n)),b(p(h),r(k),s(n)),b(p(h),r(m),s(n)),b(p(h),r(m),s(q)),b(p(h),r(k),s(q)),b(p(h),r(k),s(n)),b(p(h),r(m),s(n)),b(p(h),r(m),s(n)),b(p(g),r(m),s(n)),b(p(g),r(m),s(q)),b(p(g),r(k),s(q)),b(p(g),r(k),s(n)),b(p(g),r(m),s(n)),b(p(g),r(m),s(n)),b(p(f),r(m),s(n)),b(p(f),r(m),s(q)),b(p(f),r(k),s(q)),b(p(f),r(k),s(n)),b(p(f),r(m),s(n)),b(p(f),r(m),s(n)),b(p(f),
r(l),s(n)),b(p(f),r(l),s(q)),b(p(h),r(l),s(q)),b(p(h),r(l),s(n)),b(p(f),r(l),s(n)),b(p(g),r(l),s(n)),b(p(g),r(l),s(q)),b(p(g),r(m),s(q)),b(p(g),r(m),s(t)),b(p(g),r(k),s(t)),b(p(f),r(k),s(t)),b(p(f),r(l),s(t)),b(p(h),r(l),s(t)));g=new THREE.LineBasicMaterial({color:0,lineWidth:1});u=new THREE.Line(u,g);u.type=THREE.Lines;this.threeJs.scene.add(u);u=c("-"+this.xLabel);u.position.x=p(h)-12;u.position.y=5;this.threeJs.scene.add(u);this.xHideValueLabel||(u=c(e(this.d3.xExtent[0])),u.position.x=p(h)-12,
u.position.y=-5,this.threeJs.scene.add(u));u=c((this.xHideValueLabel?"+":"")+this.xLabel);u.position.x=p(f)+12;u.position.y=5;this.threeJs.scene.add(u);this.xHideValueLabel||(u=c(e(this.d3.xExtent[1])),u.position.x=p(f)+12,u.position.y=-5,this.threeJs.scene.add(u));f=c("-"+this.yLabel);f.position.y=r(m)-5;this.threeJs.scene.add(f);this.yHideValueLabel||(f=c(e(this.d3.yExtent[0])),f.position.y=r(m)-15,this.threeJs.scene.add(f));f=c((this.yHideValueLabel?"+":"")+this.yLabel);f.position.y=r(k)+(this.yHideValueLabel?
7:15);this.threeJs.scene.add(f);this.yHideValueLabel||(f=c(e(this.d3.yExtent[1])),f.position.y=r(k)+5,this.threeJs.scene.add(f));k=c("-"+this.zLabel+(this.zHideValueLabel?"":" "+e(this.d3.zExtent[0])));k.position.z=s(q)+2;this.threeJs.scene.add(k);k=c((this.zHideValueLabel?"+":"")+this.zLabel+" "+(this.zHideValueLabel?"":" "+e(this.d3.zExtent[1])));k.position.z=s(n)+2;this.threeJs.scene.add(k);this.useCanvasRenderer&&(e=c("IE 10 and below currently not supported...","#ff0000"),e.position.z=60,e.position.y=
20,this.threeJs.scene.add(e));e=new THREE.PointCloudMaterial({vertexColors:!0,size:this.pointSize});n=a.length;q=new THREE.Geometry;for(k=0;k<n;k++)m=p(a[k][this.xAttr]),f=r(a[k][this.yAttr]),h=s(a[k][this.zAttr]),u=a[k][this.valueAttr],this.valueRenderer?u=new THREE.Color(this.valueRenderer(u)):(u=180*(1-v(u))/255,u=(new THREE.Color).setHSL(u,1,.5)),q.vertices.push(b(m,f,h)),q.colors.push(u);this.threeJs.pointCloud=new THREE.PointCloud(q,e);this.threeJs.scene.add(this.threeJs.pointCloud);this._renderThreeJs()}});
Ext.define("portal.widgets.panel.recordpanel.AbstractChild",{extend:"Ext.panel.Panel",config:{groupMode:!1},onChildExpand:function(a,b){a.getGroupMode()&&(a.ownerCt.suspendLayouts(),a.ownerCt.items.each(function(b){b instanceof portal.widgets.panel.recordpanel.AbstractChild&&b.getId()!==a.getId()&&b.collapseChildren()}),a.ownerCt.resumeLayouts())},collapseChildren:function(){this.items.each(function(a){a instanceof portal.widgets.panel.recordpanel.AbstractChild&&!1===a.getCollapsed()&&a.collapse()},
this)},initComponent:function(){this.callParent(arguments);this.items.each(function(a){if(a instanceof portal.widgets.panel.recordpanel.AbstractChild)a.on("beforeexpand",function(a){this.fireEvent("childexpand",this,a)},this)},this);this.on({childexpand:this.onChildExpand,scope:this})}});
Ext.define("portal.widgets.layout.AccordianDefault",{extend:"Ext.layout.container.Accordion",alias:"layout.accordiondefault",type:"accordiondefault",defaultQuery:null,constructor:function(a){this.defaultQuery="#"+a.defaultId;this.callParent(arguments)},suspendAnimations:function(){this.animate=!1;this.originalAnimatePolicy=this.animatePolicy;this.animatePolicy=null},resumeAnimations:function(){Ext.isObject(this.originalAnimatePolicy)&&(this.animate=!0,this.animatePolicy=this.originalAnimatePolicy,
this.originalAnimatePolicy=null)},onBeforeComponentCollapse:function(a){var b=this.owner,c,d;if(1===this.owner.items.getCount())return!1;this.processing||(this.processing=!0,d=b.deferLayouts,b.deferLayouts=!0,a=a.previousSibling(this.defaultQuery)||a.nextSibling(this.defaultQuery),this.multi?(c=this.getExpanded(),1===c.length&&a.expand()):a&&a.expand(),b.deferLayouts=d,this.processing=!1)}});
Ext.define("portal.map.openlayers.ActiveLayerManager",{singleton:!0,alternateClassName:["ActiveLayerManager"],constructor:function(a){this.initConfig(a)},addLayer:function(a){if(a){var b=a.get("renderer").map,c=ActiveLayerManager.getActiveLayerStore(b);c.suspendEvents(!0);0<c.getCount()&&(c.addingLayer=!0);c.insert(0,a);c.resumeEvents();this.saveApplicationState(b)}},addLayers:function(a){if(a&&0<a.length)for(var b=a[0].get("renderer").map,b=ActiveLayerManager.getActiveLayerStore(b),c=0;c<a.length;c++)b.suspendEvents(!0),
b.add(a[c]),b.resumeEvents()},removeLayer:function(a){if(a){var b=a.get("renderer").map,c=ActiveLayerManager.getActiveLayerStore(b);c.suspendEvents(!0);c.remove(a);a.removeDataFromMap();c.resumeEvents();this.saveApplicationState(b)}},removeAllLayers:function(a){var b=ActiveLayerManager.getActiveLayerStore(a);b.suspendEvents(!0);b.each(function(a){a.removeDataFromMap()});b.removeAll();b.resumeEvents();this.saveApplicationState(a)},updateLayerOrder:function(a,b){b.reRenderLayerDisplay();this.saveApplicationState(a)},
getActiveLayerStore:function(a){var b=Ext.StoreMgr.lookup("activeLayerStore");!b&&a&&(b=a.layerStore);return b},saveApplicationState:function(a){if(a&&"undefined"!==typeof Storage){var b=Ext.create("portal.util.permalink.MapStateSerializer");b.addMapState(a);b.addLayers(a);b.serialize(function(b,d){localStorage.setItem("portalStorageApplicationState",b);localStorage.setItem("portalStorageDefaultBaseLayer",a.map.baseLayer.name)})}}});
Ext.define("portal.widgets.tab.ActivePreRenderTabPanel",{extend:"Ext.tab.Panel",alias:"widget.activeprerendertabpanel",beforeRenderedTabs:[],beforeRenderedActiveTab:"",constructor:function(a){this.callParent(arguments);this.on("render",function(a){a.loadBeforeRenderedTabs()})},loadBeforeRenderedTabs:function(){this.removeAll(!0);this.add(this.beforeRenderedTabs);this.beforeRenderedTabs=[];this.beforeRenderedActiveTab&&this.setActiveTab(this.beforeRenderedActiveTab)},add:function(a){if(this.rendered)return this.callParent(arguments);
Ext.isArray(a)?this.beforeRenderedTabs=this.beforeRenderedTabs.concat(a):this.beforeRenderedTabs.push(a);return a},getComponent:function(a){if(this.rendered)return this.callParent(arguments);for(var b=null,b=Ext.isString(a)?a:Ext.isObject(a)&&a.getItemId?a.getItemId():a.itemId,c=0;c<this.beforeRenderedTabs.length;c++)if(b===this.beforeRenderedTabs[c].itemId)return this.beforeRenderedTabs[c];return null},remove:function(a,b){if(this.rendered)return this.callParent(arguments);var c=this.getComponent(a);
c&&(this.beforeRenderedTabs=Ext.Array.remove(this.beforeRenderedTabs,a),(b||this.autoDestroy||c.autoDestroy)&&c.rendered&&c.destroy());return c},removeAll:function(a){if(this.rendered)return this.callParent(arguments);for(var b=this.beforeRenderedTabs.length-1;0<=b;b--)this.remove(this.beforeRenderedTabs[b],a);return[]},setActiveTab:function(a){return this.rendered?this.callParent(arguments):this.getComponent(a)?(this.beforeRenderedActiveTab=a,!0):!1}});
Ext.define("portal.util.Ajax",{singleton:!0,parseResponse:function(a,b,c){if(a){a=null;try{a=Ext.JSON.decode(b.responseText)}catch(d){console.log("ERROR parsing Ajax response:",d);c(!1,void 0,void 0,void 0,b);return}try{c(!0===a.success,a.data,a.msg,a.debugInfo,b)}catch(e){console.log("ERROR calling user callback:",e)}}else c(!1,void 0,b.status?b.status+": "+b.statusText:"Network Error: Cannot connect to server.",void 0,b)},request:function(a){var b={success:a.success?Ext.bind(a.success,a.scope):
void 0,failure:a.failure?Ext.bind(a.failure,a.scope):void 0,callback:a.callback?Ext.bind(a.callback,a.scope):void 0};delete a.failure;delete a.success;delete a.scope;a.callback=Ext.bind(function(a,b,e,f){portal.util.Ajax.parseResponse(b,e,Ext.bind(function(a,b,c,d,e,f){f.callback&&f.callback(a,b,c,d,e);a?f.success&&f.success(b,c,d,e):f.failure&&f.failure(c,d,e)},void 0,[f],!0))},void 0,[b],!0);return Ext.Ajax.request(a)}});
Ext.define("portal.util.Base64",{statics:{_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/\x3d",encode:function(a){var b="",c,d,e,f,g,h,k=0;for(a=portal.util.Base64._utf8_encode(a);k<a.length;)c=a.charCodeAt(k++),d=a.charCodeAt(k++),e=a.charCodeAt(k++),f=c>>2,c=(c&3)<<4|d>>4,g=(d&15)<<2|e>>6,h=e&63,isNaN(d)?g=h=64:isNaN(e)&&(h=64),b=b+portal.util.Base64._keyStr.charAt(f)+portal.util.Base64._keyStr.charAt(c)+portal.util.Base64._keyStr.charAt(g)+portal.util.Base64._keyStr.charAt(h);
return b},decode:function(a){var b="",c,d,e,f,g,h=0;for(a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");h<a.length;)c=portal.util.Base64._keyStr.indexOf(a.charAt(h++)),d=portal.util.Base64._keyStr.indexOf(a.charAt(h++)),f=portal.util.Base64._keyStr.indexOf(a.charAt(h++)),g=portal.util.Base64._keyStr.indexOf(a.charAt(h++)),c=c<<2|d>>4,d=(d&15)<<4|f>>2,e=(f&3)<<6|g,b+=String.fromCharCode(c),64!=f&&(b+=String.fromCharCode(d)),64!=g&&(b+=String.fromCharCode(e));return b=portal.util.Base64._utf8_decode(b)},_utf8_encode:function(a){a=
a.replace(/\r\n/g,"\n");for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);128>d?b+=String.fromCharCode(d):(127<d&&2048>d?b+=String.fromCharCode(d>>6|192):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128)),b+=String.fromCharCode(d&63|128))}return b},_utf8_decode:function(a){for(var b="",c=0,d=c1=c2=0;c<a.length;)d=a.charCodeAt(c),128>d?(b+=String.fromCharCode(d),c++):191<d&&224>d?(c2=a.charCodeAt(c+1),b+=String.fromCharCode((d&31)<<6|c2&63),c+=2):(c2=a.charCodeAt(c+1),c3=
a.charCodeAt(c+2),b+=String.fromCharCode((d&15)<<12|(c2&63)<<6|c3&63),c+=3);return b}}});Ext.define("portal.layer.legend.BaseComponent",{extend:"Ext.Panel",alias:"widget.legendbasecomponent"});Ext.define("portal.layer.querier.BaseComponent",{extend:"Ext.panel.Panel",alias:"widget.querierbasecomponent",tabTitle:"Summary",constructor:function(a){a.tabTitle&&(this.tabTitle=a.tabTitle);this.callParent(arguments)}});
Ext.define("portal.charts.BaseD3Chart",{extend:"Ext.panel.Panel",d3svg:null,d3:null,targetWidth:null,targetHeight:null,constructor:function(a){this.initialPlotData=a.initialPlotData?a.initialPlotData:null;this.d3=this.d3svg=null;this.preserveAspectRatio=a.preserveAspectRatio?!0:!1;this.targetWidth=a.targetWidth?a.targetWidth:800;this.targetHeight=a.targetHeight?a.targetHeight:400;this.innerId=Ext.id();Ext.apply(a,{html:Ext.util.Format.format('\x3cdiv id\x3d"{0}" style\x3d"width:100%;height:100%;"\x3e\x3c/div\x3e',
this.innerId)});this.callParent(arguments);this.on("render",this._afterRender,this);this.on("resize",this._onResize,this)},clearPlot:function(a){this.d3svg&&(this.d3svg.select("*").remove(),this.d3svg.select(".title").remove(),this.d3=null,this.maskClear(),a&&this.d3svg.append("text").attr("x",this.targetWidth/2).attr("y",this.targetHeight/2-20).attr("width",this.targetWidth).attr("class","error-text").style("text-anchor","middle").style("font-size","32px").text(a))},mask:function(a){this._loadMask&&
this.maskClear();this._loadMask=new Ext.LoadMask({msg:a,target:this});this._loadMask.show()},maskClear:function(){this.d3svg.select(".error-text").remove();this._loadMask&&(this._loadMask.hide(),this._loadMask=null)},plot:Ext.util.UnimplementedFunction,_afterRender:function(){var a=d3.select("#"+this.innerId);this.d3svg=a.append("svg").attr("preserveAspectRatio",this.preserveAspectRatio?"xMidYMid":"none").attr("viewBox",Ext.util.Format.format("0 0 {0} {1}",this.targetWidth,this.targetHeight));this.svgClass&&
this.d3svg.attr("class",this.svgClass);this._onResize(a.node().offsetWidth,a.node().offsetHeight);this.initialPlotData&&this.plot(this.initialPlotData)},_onResize:function(a,b,c){this.d3svg.attr("width",b).attr("height",c)}});
Ext.define("portal.layer.querier.wfs.factories.BaseFactory",{extend:"Ext.util.Observable",XMLNS_ER:"urn:cgi:xmlns:GGIC:EarthResource:1.1",XMLNS_ER_2:"http://xmlns.earthresourceml.org/EarthResource/2.0",XMLNS_ERL:"http://xmlns.earthresourceml.org/earthresourceml-lite/1.0",XMLNS_GSML_2:"urn:cgi:xmlns:CGI:GeoSciML:2.0",XMLNS_GSML_32:"http://xmlns.geosciml.org/GeoSciML-Core/3.2",XMLNS_GML:"http://www.opengis.net/gml",XMLNS_GML_32:"http://www.opengis.net/gml/3.2",XMLNS_SA:"http://www.opengis.net/sampling/1.0",
XMLNS_OM:"http://www.opengis.net/om/1.0",XMLNS_SWE:"http://www.opengis.net/swe/1.0.1",XMLNS_GSMLP:"http://xmlns.geosciml.org/geosciml-portrayal/2.0",XMLNS_GSMLP_4:"http://xmlns.geosciml.org/geosciml-portrayal/4.0",XMLNS_MT:"http://xmlns.geoscience.gov.au/mineraltenementml/1.0",XMLNS_MO:"http://xmlns.geoscience.gov.au/minoccml/1.0",XMLNS_RA:"http://remanentanomalies.csiro.au",XMLNS_CAPDF:"http://capdf.csiro.au/",XMLNS_TIMA:"https://ogc-jdlc.curtin.edu.au/ns/tima",config:{parser:null},constructor:function(a){this.listeners=
a.listeners;this.callParent(arguments)},supportsNode:portal.util.UnimplementedFunction,parseNode:portal.util.UnimplementedFunction,_filterNodesWithXPath:function(a,b,c){for(var d=[],e=0;e<a.length;e++)portal.util.xml.SimpleXPath.evaluateXPathString(a[e],b)===c&&d.push(a[e]);return d},_makeWfsUriPopupHtml:function(a,b,c){return Ext.util.Format.format("\x3ca href\x3d\"#\" qtip\x3d\"{2}\" onclick\x3d\"var w\x3dwindow.open('wfsFeaturePopup.do?url\x3d{0}','AboutWin','toolbar\x3dno, menubar\x3dno,location\x3dno,resizable\x3dyes,scrollbars\x3dyes,statusbar\x3dno,height\x3d450,width\x3d820');w.focus();return false;\"\x3e{1}\x3c/a\x3e",
a,b,c?c:"")},_makeWFSPopupHtml:function(a,b,c,d,e){a=Ext.util.Format.format("{0}\x26typeName\x3d{1}\x26featureId\x3d{2}",a,b,c);return this._makeWfsUriPopupHtml(a,d,e)},_makeGeneralPopupHtml:function(a,b,c){return Ext.util.Format.format("\x3ca href\x3d\"#\" qtip\x3d\"{2}\" onclick\x3d\"var w\x3dwindow.open('{0}','AboutWin','toolbar\x3dno, menubar\x3dno,location\x3dno,resizable\x3dyes,scrollbars\x3dyes,statusbar\x3dno,height\x3d450,width\x3d820');w.focus();return false;\"\x3e{1}\x3c/a\x3e",a,b,c?c:
"")},_makeVocabPopupHtml:function(a,b,c){var d=VOCAB_SERVICE_URL;"/"!==d[d.length-1]&&(d+="/");return Ext.util.Format.format("\x3ca href\x3d\"#\" qtip\x3d\"{3}\" onclick\x3d\"var w\x3dwindow.open('{0}{1}','AboutWin','toolbar\x3dno, menubar\x3dno,location\x3dno,resizable\x3dyes,scrollbars\x3dyes,statusbar\x3dno,height\x3d450,width\x3d820');w.focus();return false;\"\x3e{2}\x3c/a\x3e",d+"getConceptByURI?",a,b,c?c:"")},_makeFeatureRequestUrl:function(a,b,c,d){a=portal.util.URL.base+"requestFeature.do?serviceUrl\x3d"+
a+"\x26typeName\x3d"+b+"\x26featureId\x3d"+c;if(d)for(b=0;b<d.length;b++)a=a+"\x26"+d[b].key+"\x3d"+d[b].value;return a},_makeWFSFeatureRequestUrl:function(a,b,c,d){a=a.substring(0,a.indexOf("?"));"wms"==a.substring(a.length-3,a.length).toLowerCase()&&(a=a.substring(0,a.length-3));a=a+"wfs?service\x3dWFS\x26version\x3d1.1.0\x26request\x3dGetFeature\x26typeName\x3d"+b+"\x26featureId\x3d"+c;if(d)for(b=0;b<d.length;b++)a=a+"\x26"+d[b].key+"\x3d"+d[b].value;return a},_getBaseUrl:function(a){a=a.split("://");
return a[0]+"://"+a[1].slice(0,a[1].indexOf("/"))}});Ext.define("portal.layer.querier.wfs.knownlayerfactories.BaseFactory",{extend:"Ext.util.Observable",constructor:function(a){this.listeners=a.listeners;this.callParent(arguments)},supportsKnownLayer:portal.util.UnimplementedFunction,parseKnownLayerFeature:portal.util.UnimplementedFunction,getBaseUrl:function(a){a=a.split("://");return a[0]+"://"+a[1].slice(0,a[1].indexOf("/"))}});
Ext.define("portal.layer.filterer.BaseFilterForm",{extend:"Ext.form.Panel",config:{isFormLoaded:!1},map:null,layer:null,delayedFormLoading:!1,constructor:function(a){this.map=a.map;this.layer=a.layer;this.setIsFormLoaded(!1);this.delayedFormLoading=a.delayedFormLoading;Ext.apply(a,{cls:"filter-panel-color"});this.callParent(arguments);this.delayedFormLoading||(this.setIsFormLoaded(!0),this.fireEvent("formloaded",this))},onDestroy:function(){this.callParent()},setLayer:function(a){this.layer=a},writeToFilterer:function(a){var b=
this.getForm().getValues(),c=a.getSpatialParam();b[portal.layer.filterer.Filterer.BBOX_FIELD]=c;a.setParameters(b,!0)},readFromFilterer:function(a){a=a.getParameters();this.getForm().setValues(a)}});
Ext.define("portal.map.BaseMap",{extend:"Ext.util.Observable",layerStore:null,openedInfoLayerId:null,highlightPrimitiveManager:null,rendered:!1,allowDataSelection:!1,constructor:function(a){this.container=a.container;this.layerStore=a.layerStore?a.layerStore:null;this.callParent(arguments);this.container&&this.renderToContainer(this.container);this.layerStore&&(this.layerStore.on("add",this._onLayerStoreAdd,this),this.layerStore.on("remove",this._onLayerStoreRemove,this),this.layerStore.storeId="activeLayerStore")},
makeMarker:Ext.util.UnimplementedFunction,makePolygon:Ext.util.UnimplementedFunction,makePolyline:Ext.util.UnimplementedFunction,makeWms:Ext.util.UnimplementedFunction,renderToContainer:Ext.util.UnimplementedFunction,getVisibleMapBounds:Ext.util.UnimplementedFunction,makePrimitiveManager:Ext.util.UnimplementedFunction,openInfoWindow:Ext.util.UnimplementedFunction,scrollToBounds:Ext.util.UnimplementedFunction,getZoom:Ext.util.UnimplementedFunction,setZoom:Ext.util.UnimplementedFunction,setCenter:Ext.util.UnimplementedFunction,
getCenter:Ext.util.UnimplementedFunction,getTileInformationForPoint:Ext.util.UnimplementedFunction,getMapSizeInPixels:Ext.util.UnimplementedFunction,getPixelFromLatLng:Ext.util.UnimplementedFunction,closeInfoWindow:Ext.util.UnimplementedFunction,highlightBounds:function(a,b){b=b?b:2E3;Ext.isArray(a)||(a=[a]);for(var c=0;c<a.length;c++){var d=a[c].toPolygon(this,"00FF00",0,.7,"#00FF00",.6);this.highlightPrimitiveManager.addPrimitives(d)}(new Ext.util.DelayedTask(Ext.bind(function(){this.highlightPrimitiveManager.clearPrimitives()},
this))).delay(b)},showContextMenuAtLatLng:function(a,b){var c=this.getPixelFromLatLng(a);b.showAt(this.container.x+c.x,this.container.y+c.y)},getLayersInBBox:function(a){var b=[];if(!this.layerStore)return b;for(var c=0;c<this.layerStore.getCount();c++)for(var d=this.layerStore.getAt(c).get("cswRecords"),e=0;e<d.length;e++)for(var f=d[e],g=f.get("geographicElements"),h=0;h<g.length;h++)if(a.intersects(g[h])){b.push(f);break}return b},_onLayerStoreAdd:function(a,b){for(var c=0;c<b.length;c++){var d=
b[c];if(d.get("deserialized"))d=d.get("filterer"),d.setParameters({});else if(d.get("renderOnAdd")){var e=d.get("filterForm"),d=d.get("filterer");d.setSpatialParam(this.getVisibleMapBounds(),!0);e.writeToFilterer(d)}}},_onLayerStoreRemove:function(a,b){var c=b[0].get("renderer");c&&(a.addingLayer?a.addingLayer=!1:c.abortDisplay(),c.removeData(),this.closeInfoWindow(b[0].get("id")))},getFeaturesFromKMLString:function(a){return(new OpenLayers.Format.KML({extractStyles:!0,extractAttributes:!0,internalProjection:new OpenLayers.Projection("EPSG:3857"),
externalProjection:new OpenLayers.Projection("EPSG:4326")})).read(a)}});Ext.define("portal.map.primitives.BasePrimitive",{config:{id:"",layer:null,onlineResource:null,cswRecord:null},constructor:function(a){this.callParent(arguments);this.setId(a.id);this.setLayer(a.layer);this.setOnlineResource(a.onlineResource);this.setCswRecord(a.cswRecord)}});
Ext.define("portal.map.BasePrimitiveManager",{extend:"Ext.util.Observable",baseMap:null,constructor:function(a){this.baseMap=a.baseMap;this.callParent(arguments)},clearPrimitives:Ext.util.UnimplementedFunction,addPrimitives:Ext.util.UnimplementedFunction});
Ext.define("portal.widgets.panel.BaseRecordPanel",{extend:"portal.widgets.panel.CommonBaseRecordPanel",alias:"widget.baserecordpanel",constructor:function(a){var b=this;b.listeners=Object.extend(b.listenersHere,a.listeners);var c=[b._getVisibleBoundFilterAction(),b._getActivelayerFilterAction(),b._getDataLayerFilterAction(),b._getImageLayerFilterAction()],d=null;!0!==a.hideSearch&&(d=[{xtype:"toolbar",dock:"top",portalName:"search-bar",items:[{xtype:"label",text:"Search: "},{xtype:"clientsearchfield",
id:"hh-searchfield-"+a.title.replace(" ",""),width:200,fieldName:"name",store:a.store},{xtype:"button",id:"hh-filterDisplayedLayer-"+a.title.replace(" ",""),text:"View by",iconCls:"filter",tooltip:"Provide more options for filtering layer's view",arrowAlign:"right",menu:c}]}]);Ext.applyIf(a,{cls:"auscope-dark-grid",emptyText:'\x3cp class\x3d"centeredlabel"\x3eNo records match the current filter.\x3c/p\x3e',dockedItems:d,titleField:"name",titleIndex:2,tools:[{field:"active",clickHandler:Ext.bind(b._deleteClickHandler,
b),stopEvent:!1,tipRenderer:function(a,b,c){return a?"Click to remove layer from map":"Click to anywhere on this row to select drop down menu"},iconRenderer:b._deleteRenderer},{field:["loading","active"],stopEvent:!0,clickHandler:Ext.bind(b._loadingClickHandler,b),tipRenderer:Ext.bind(b._loadingTipRenderer,b),iconRenderer:Ext.bind(b._loadingRenderer,this)},{field:"serviceInformation",stopEvent:!0,clickHandler:Ext.bind(b._serviceInformationClickHandler,b),tipRenderer:function(a,b,c){return b instanceof
portal.knownlayer.KnownLayer&&b.containsNagiosFailures()?"One or more of the services used by this layer are reported to be experiencing issues at the moment. Some aspects of this layer may not load/work.":"Click for detailed information about the web services this layer utilises."},iconRenderer:Ext.bind(b._serviceInformationRenderer,b)},{field:"spatialBoundsRenderer",stopEvent:!0,clickHandler:Ext.bind(b._spatialBoundsClickHandler,b),doubleClickHandler:Ext.bind(b._spatialBoundsDoubleClickHandler,
b),tipRenderer:function(a,b){return"Click to see the bounds of this layer, double click to pan the map to those bounds"},iconRenderer:Ext.bind(b._spatialBoundsRenderer,b)}],lazyLoadChildPanel:!0,childPanelGenerator:function(c){var d=null,d=c instanceof portal.csw.CSWRecord?a.layerFactory.generateLayerFromCSWRecord(c):a.layerFactory.generateLayerFromKnownLayer(c);c.set("layer",d);return b._getInlineLayerPanel(d.get("filterForm"))}});b.callParent(arguments)},onDestroy:function(){me.callParent()},_getInlineLayerPanel:function(a){return Ext.create("portal.widgets.panel.FilterPanel",
{menuFactory:this.menuFactory,filterForm:a,detachOnRemove:!1,map:this.map,menuItems:[]})},_getVisibleBoundFilterAction:function(){return new Ext.Action({text:"Visible Bound",iconCls:"visible_eye",tooltip:"Filter the layers based on its bounding box and the map's visible bound",handler:Ext.bind(this._handleVisibleFilterClick,this)})},_getActivelayerFilterAction:function(){return new Ext.Action({text:"Active Layer",iconCls:"tick",tooltip:"Display only active layer",handler:function(){var a=this.findParentByType("toolbar").getComponent(1);
a.clearCustomFilter();a.runCustomFilter("\x3cactive layers\x3e",Ext.bind(function(a){return a.get("active")},this))}})},_getDataLayerFilterAction:function(){var a=this;return new Ext.Action({text:"Data Layer",iconCls:"data",tooltip:"Display layer with data service",handler:function(){var b=this.findParentByType("toolbar").getComponent(1);b.clearCustomFilter();b.runCustomFilter("\x3cData Layers\x3e",Ext.bind(function(b){b=a.getOnlineResourcesForRecord(b);return a._getServiceType(b).containsDataService?
!0:!1},this))}})},_getImageLayerFilterAction:function(){var a=this;return new Ext.Action({text:"Portrayal Layer",iconCls:"portrayal",tooltip:"Display layers with image service",handler:function(){var b=this.findParentByType("toolbar").getComponent(1);b.clearCustomFilter();b.runCustomFilter("\x3cPortrayal layers\x3e",Ext.bind(function(b){b=a.getOnlineResourcesForRecord(b);b=a._getServiceType(b);return b.containsDataService?!1:b.containsImageService?!0:!1},this))}})},_handleVisibleFilterClick:function(a){var b=
this.map.getVisibleMapBounds();a=a.findParentByType("toolbar").getComponent(1);a.clearCustomFilter();a.runCustomFilter("\x3cvisible layers\x3e",Ext.bind(function(a){a=this.getSpatialBoundsForRecord(a);for(var d=0;d<a.length;d++)if(a[d].intersects(b))return!0;return!1},this))},handleFilterSelectComplete:function(a){var b=this;(new CSWSelectionWindow({title:"CSW Record Selection",resultpanels:a,listeners:{selectioncomplete:function(a){var d=Ext.getCmp("auscope-tabs-panel"),e=b.ownerCt.getComponent("org-auscope-custom-record-panel");
d.setActiveTab(e);a instanceof Array||(a=[a]);for(d=a.length-1;0<=d;d--)a[d].set("customlayer",!0),e.getStore().insert(0,a[d]),e.ensureVisible(0)}}})).show()},_updateSearchBar:function(a){for(var b=this.getDockedItems(),c=null,d=0;d<b.length;d++)"search-bar"===b[d].initialConfig.portalName&&(c=b[d]);c&&(a?c.show():c.hide())},_deleteRenderer:function(a,b){return a?"portal-core/img/trash.png":"portal-core/img/play_blue.png"},_deleteClickHandler:function(a,b){var c=b.get("layer");c&&b.get("active")&&
(ActiveLayerManager.removeLayer(c),this.menuFactory.layerRemoveHandler(c),this.fireEvent("cellclick",this,void 0,void 0,c,void 0,void 0))},_loadingRenderer:function(a,b){if(a)return"portal-core/img/loading.gif";if(b.get("active")){var c=b.get("layer").get("renderer").renderStatus.getParameters(),d=this._statusListErrorCount(c),c=Ext.Object.getSize(c);return 0<d&&d==c?"portal-core/img/warning.png":0<d&&d<c?"portal-core/img/exclamation.png":"portal-core/img/tick.png"}return"portal-core/img/notloading.gif"},
_statusListErrorCount:function(a){var b=["reached","error","did not complete","AJAX","Unable"],c=0;for(key in a)for(var d=0;d<b.length;d++)if(-1<a[key].indexOf(b[d])){c++;break}return c},_loadingTipRenderer:function(a,b,c){a=b.get("layer");if(!a)return"No status has been recorded";var d=a.get("renderer"),e=function(a,b){c.update(a.renderHtml())};d.renderStatus.on("change",e,this);c.on("hide",function(){d.renderStatus.un("change",e)});return d.renderStatus.renderHtml()},_loadingClickHandler:function(a,
b){var c=b.get("layer"),d="\x3cp\x3eNo Service recorded, Click on Add layer to map\x3c/p\x3e";c&&(d=c.get("renderer").renderStatus.renderHtml());Ext.create("Ext.window.Window",{title:"Service Loading Status",height:200,width:500,layout:"fit",modal:!0,items:{xtype:"panel",autoScroll:!0,html:d}}).show()}});
Ext.define("portal.util.permalink.serializers.BaseSerializer",{constructor:function(){this.callParent(arguments)},getVersion:function(){return this.$className},serialize:portal.util.UnimplementedFunction,deserialize:portal.util.UnimplementedFunction,createSerializedObject:portal.util.UnimplementedFunction,createDeSerializedObject:portal.util.UnimplementedFunction});
Ext.define("portal.map.primitives.BaseWMSPrimitive",{extend:"portal.map.primitives.BasePrimitive",statics:{getWmsUrl:function(a,b,c,d,e,f){c=c.transform(c,"EPSG:3857");var g=Ext.util.Format.format("{0},{1},{2},{3}",c.westBoundLongitude,c.southBoundLatitude,c.eastBoundLongitude,c.northBoundLatitude);b=Ext.Object.toQueryString({REQUEST:"GetMap",SERVICE:"WMS",VERSION:"1.1.1",FORMAT:f?f:"image/png",BGCOLOR:"0xFFFFFF",TRANSPARENT:"TRUE",LAYERS:b,SRS:c.crs,BBOX:g,WIDTH:d,HEIGHT:e,STYLES:""});return Ext.urlAppend(a,
b)},getWms_130_Url:function(a,b,c,d,e,f){c=c.transform(c,"EPSG:3857");var g=Ext.util.Format.format("{0},{1},{2},{3}",c.southBoundLatitude,c.westBoundLongitude,c.northBoundLatitude,c.eastBoundLongitude);b=Ext.Object.toQueryString({REQUEST:"GetMap",SERVICE:"WMS",VERSION:"1.3.0",FORMAT:f?f:"image/png",BGCOLOR:"0xFFFFFF",TRANSPARENT:"TRUE",LAYERS:b,CRS:c.crs,BBOX:g,WIDTH:d,HEIGHT:e,STYLES:""});return Ext.urlAppend(a,b)}},config:{wmsUrl:"",wmsLayer:"",opacity:1,sld_body:""},constructor:function(a){this.callParent(arguments);
this.setWmsUrl(a.wmsUrl);this.setWmsLayer(a.wmsLayer);this.setOpacity(a.opacity);this.setSld_body(a.sld_body)}});
Ext.define("portal.util.BBox",{constructor:function(a){Ext.apply(this,a);this.crs||(this.crs="EPSG:4326");this.callParent(arguments)},statics:{datelineCorrection:function(a,b){a=parseInt(a);-120>a&&"EPSG:4326"==b&&(a=180+(180+a));return a}},isGlobal:function(){return 180===this.eastBoundLongitude&&90===this.northBoundLatitude&&-90===this.southBoundLatitude&&-180===this.westBoundLongitude},clone:function(){return Ext.create("portal.util.BBox",{northBoundLatitude:this.northBoundLatitude,southBoundLatitude:this.southBoundLatitude,
eastBoundLongitude:this.eastBoundLongitude,westBoundLongitude:this.westBoundLongitude,crs:this.crs})},combine:function(a){return Ext.create("portal.util.BBox",{northBoundLatitude:Math.max(this.northBoundLatitude,a.northBoundLatitude),southBoundLatitude:Math.min(this.southBoundLatitude,a.southBoundLatitude),eastBoundLongitude:Math.max(this.eastBoundLongitude,a.eastBoundLongitude),westBoundLongitude:Math.min(this.westBoundLongitude,a.westBoundLongitude),crs:this.crs})},splitAt:function(a,b){var c=function(a,
b,c,d){for(var k=[],l=0;l<d.length;l++){for(var m=d[l],n=m.clone(),t=m.clone(),q=c;0>q&&0<n[a];)q+=360;for(;0<q&&0>n[a];)q-=360;for(var p=c;0>p&&0<t[b];)p+=360;for(;0<p&&0>t[b];)p-=360;n[a]=m[a];n[b]=q;t[a]=p;t[b]=m[b];k.push(n);k.push(t)}return k},d=[this];void 0!==a&&(d=c("westBoundLongitude","eastBoundLongitude",a,d));void 0!==b&&(d=c("northBoundLatitude","southBoundLatitude",b,d));return d},_splitBboxes:function(a,b){if(0>a.westBoundLongitude&&0<a.eastBoundLongitude){for(var c=a.splitAt(0),d=
0;d<c.length;d++)this._splitBboxes(c[d],b);return b}if(0<a.westBoundLongitude&&0>a.eastBoundLongitude){c=a.splitAt(-180);for(d=0;d<c.length;d++)this._splitBboxes(c[d],b);return b}b.push(a);return b},toPolygon:function(a,b,c,d,e,f,g,h,k,l,m){for(var n=this._splitBboxes(this,[]),t=[],q=0;q<n.length;q++){var p=n[q],r=Ext.create("portal.map.Point",{latitude:p.northBoundLatitude,longitude:p.eastBoundLongitude}),s=Ext.create("portal.map.Point",{latitude:p.southBoundLatitude,longitude:p.eastBoundLongitude}),
v=Ext.create("portal.map.Point",{latitude:p.southBoundLatitude,longitude:p.westBoundLongitude}),p=Ext.create("portal.map.Point",{latitude:p.northBoundLatitude,longitude:p.westBoundLongitude});t.push(a.makePolygon(h,k,l,m,[v,p,r,s,v],b,c,d,e,f,g))}return t},intersects:function(a){if(this.crs!==a.crs)return!1;var b=a.eastBoundLongitude,c=a.westBoundLongitude,d=this.eastBoundLongitude,e=this.westBoundLongitude;return b<c?(c=Ext.create("portal.util.BBox",{westBoundLongitude:c,eastBoundLongitude:180,southBoundLatitude:a.southBoundLatitude,
northBoundLatitude:a.northBoundLatitude}),b=Ext.create("portal.util.BBox",{westBoundLongitude:-180,eastBoundLongitude:b,southBoundLatitude:a.southBoundLatitude,northBoundLatitude:a.northBoundLatitude}),this.intersects(c)||this.intersects(b)):d<e?(c=Ext.create("portal.util.BBox",{westBoundLongitude:e,eastBoundLongitude:180,southBoundLatitude:this.southBoundLatitude,northBoundLatitude:this.northBoundLatitude}),b=Ext.create("portal.util.BBox",{westBoundLongitude:-180,eastBoundLongitude:d,southBoundLatitude:this.southBoundLatitude,
northBoundLatitude:this.northBoundLatitude}),c.intersects(a)||b.intersects(a)):!(c>d||b<e||a.southBoundLatitude>this.northBoundLatitude||a.northBoundLatitude<this.southBoundLatitude)},contains:function(a,b){return this.westBoundLongitude<=b&&this.eastBoundLongitude>=b&&this.southBoundLatitude<=a&&this.northBoundLatitude>=a},containsBbox:function(a){return this.crs!==a.crs?!1:this.contains(a.northBoundLatitude,a.westBoundLongitude)&&this.contains(a.southBoundLatitude,a.eastBoundLongitude)},equals:function(a){return this.eastBoundLongitude===
a.eastBoundLongitude&&this.westBoundLongitude===a.westBoundLongitude&&this.southBoundLatitude===a.southBoundLatitude&&this.northBoundLatitude===a.northBoundLatitude&&this.crs===a.crs},transform:function(a,b){var c=new OpenLayers.Bounds(a.westBoundLongitude,a.southBoundLatitude,a.eastBoundLongitude,a.northBoundLatitude);c.transform(this.crs,b);c=Ext.create("portal.util.BBox",{eastBoundLongitude:c.right,westBoundLongitude:c.left,northBoundLatitude:c.top,southBoundLatitude:c.bottom});c.crs=b;return c}});
Ext.define("portal.util.BBoxType",{singleton:!0,requires:["Ext.data.SortTypes","Ext.data.Types"]},function(){Ext.apply(portal.util.BBoxType,{convert:function(a,b){if(Ext.isArray(a)){for(var c=[],d=0;d<a.length;d++)c.push(this.convert(a[d]));return c}return a instanceof portal.util.BBox?a:Ext.isObject(a)?Ext.create("portal.util.BBox",a):null},sortType:Ext.data.SortTypes.none,type:"portal.util.BBox"})});
Ext.define("portal.util.misc.BrowserWindowWithWarning",{statics:{windowsId:[]},message:"",constructor:function(a){"undefined"==typeof portal.util.misc.BrowserWindowWithWarning.windowsId[a.id]&&(portal.util.misc.BrowserWindowWithWarning.windowsId[a.id]=!0);this.id=a.id;this.message=a.message},open:function(a){this._warningMessageBox(this.id,a)},_warningMessageBox:function(a,b){var c="BrowserWindowWithWarning_"+a;1==portal.util.misc.BrowserWindowWithWarning.windowsId[a]?Ext.MessageBox.show({title:"Browse Catalogue",
msg:this.message+'\x3cbr\x3e\x3cbr\x3e\x3cinput type\x3d"checkbox" id\x3d"'+c+'" value\x3d"true" checked/\x3eDo not show this message again',buttons:Ext.MessageBox.OK,fn:function(d){"ok"==d&&(1==Ext.get(c).dom.checked&&(portal.util.misc.BrowserWindowWithWarning.windowsId[a]=!1),b())}}):b()}});
Ext.define("portal.widgets.grid.plugin.CellTips",{alias:"plugin.celltips",_grid:null,_rowSelector:"tr."+Ext.baseCSSPrefix+"grid-row",constructor:function(a){this.callParent(arguments)},init:function(a){this._grid=a;a.getView().on("render",this._registerTips,this)},_registerTips:function(a){a.tip=Ext.create("Ext.tip.ToolTip",{target:a.el,delegate:a.cellSelector,trackMouse:!0,renderTo:Ext.getBody(),maxWidth:500,listeners:{beforeshow:Ext.bind(this._tipRenderer,this,[a],!0)}})},_tipRenderer:function(a,
b,c){b=c.getGridColumns()[a.triggerElement.cellIndex];if(!b||!b.hasTip)return!1;var d=Ext.fly(a.triggerElement).findParentNode(this._rowSelector,20,!0);if(!d)return!1;c=c.getRecord(d);d=c.get(b.dataIndex);b.tipRenderer?a.update(b.tipRenderer(d,c,b,a)):a.update(d);return!0}});
Ext.define("portal.widgets.field.ClearableComboBox",{extend:"Ext.form.field.ComboBox",alias:"widget.xcombo",triggerTip:"Click to clear selection.",spObj:"",spForm:"",spExtraParam:"",qtip:"Clearable Combo Box",trigger1Class:"x-form-select-trigger",trigger2Class:"x-form-clear-trigger",onRender:function(a,b){this.callParent(arguments);var c=this.getId();this.triggerConfig={tag:"div",cls:"x-form-twin-triggers",style:"display:block;width:46px;",cn:[{tag:"img",style:Ext.isIE?"margin-left:-3;height:19px":
"",src:Ext.BLANK_IMAGE_URL,id:"trigger1"+c,name:"trigger1"+c,cls:"x-form-trigger "+this.trigger1Class},{tag:"img",style:Ext.isIE?"margin-left:-6;height:19px":"",src:Ext.BLANK_IMAGE_URL,id:"trigger2"+c,name:"trigger2"+c,cls:"x-form-trigger "+this.trigger2Class}]};this.triggerEl.replaceWith(this.triggerConfig);this.triggerEl.on("mouseup",function(a){if(a.target.name==="trigger1"+c)this.onTriggerClick();else a.target.name==="trigger2"+c&&(this.reset(),""!==this.spObj&&""!==this.spExtraParam&&(Ext.getCmp(this.spObj).store.setExtraParam(this.spExtraParam,
""),Ext.getCmp(this.spObj).store.load()),""!==this.spForm&&Ext.getCmp(this.spForm).getForm().reset(),this.fireEvent("select",this,[]))},this);var d=Ext.get("trigger1"+c),e=Ext.get("trigger2"+c);d.addClsOnOver("x-form-trigger-over");e.addClsOnOver("x-form-trigger-over")},getSubmitData:function(a){var b=null;this.disabled||!this.submitValue||this.isFileUpload()||(a=this.getSubmitValue(a),null!==a&&(b={},b[this.getName()]=a));return b},getSubmitValue:function(a){var b=this.callParent(arguments);return null===
b&&a&&this.emptyText?this.emptyText:b}});Ext.define("portal.widgets.field.clearabletextfield",{extend:"Ext.form.field.Text",alias:"widget.clearabletextfield",initComponent:function(){this.setTriggers({clearKey:{cls:"x-form-clear-trigger",handler:function(){this.setRawValue("")}}});this.callParent()}});
Ext.define("portal.widgets.plugins.ClickableImage",{extend:"Ext.plugin.Abstract",alias:"plugin.clickableimage",stopEvent:!1,constructor:function(a){this.stopEvent=!!a.stopEvent},init:function(a){if(a.rendered)this.installEvents(a);else a.on("afterrender",this.installEvents,this)},installEvents:function(a){var b=a.getEl();b.on("click",function(b,d,e){this.stopEvent&&b.stopEvent();a.fireEvent("click",a,b)},this);b.on("dblclick",function(b,d,e){this.stopEvent&&b.stopEvent();a.fireEvent("dblclick",a,
b)},this)}});Ext.define("portal.widgets.grid.column.ClickColumn",{extend:"Ext.grid.column.Column",alias:"widget.clickcolumn",constructor:function(){this.callParent(arguments)},processEvent:function(a,b,c,d,e,f){var g=f.record,h=b.store.indexOf(g);return"click"==a||"keydown"==a&&(f.getKey()===f.ENTER||f.getKey()===f.SPACE)?(this.fireEvent("columnclick",this,g,h,e,f),this.callParent(arguments)):"dblclick"===a?this.fireEvent("columndblclick",this,g,h,e):this.callParent(arguments)}});Ext.ns("portal.map.openlayers");
portal.map.openlayers.ClickControl=OpenLayers.Class(OpenLayers.Control,{defaultHandlerOptions:{single:!0,"double":!1,pixelTolerance:0,stopSingle:!1,stopDouble:!1},scope:null,geometryTypes:null,layer:null,layers:null,initialize:function(a,b){this.handlerOptions=OpenLayers.Util.extend({},this.defaultHandlerOptions);OpenLayers.Control.prototype.initialize.apply(this,[b]);null===this.scope&&(this.scope=this);this.initLayer(a);this.callbacks=OpenLayers.Util.extend({click:b.trigger},this.callbacks);this.handlers=
{feature:new portal.map.openlayers.FeatureWithLocationHandler(this,this.layer,this.callbacks,{geometryTypes:this.geometryTypes})}},initLayer:function(a){OpenLayers.Util.isArray(a)?(this.layers=a,this.layer=new OpenLayers.Layer.Vector.RootContainer(this.id+"_container",{layers:a})):this.layer=a},activate:function(){this.active||(this.layers&&this.map.addLayer(this.layer),this.handlers.feature.activate(),this.box&&this.handlers.box&&this.handlers.box.activate());return OpenLayers.Control.prototype.activate.apply(this,
arguments)}});
Ext.define("portal.map.gmap.ClickController",{statics:{_marker:function(a,b){var c=a._portalBasePrimitive;if(!c)return[];var d=c.getId(),e=c.getOnlineResource(),f=c.getLayer(),c=c.getCswRecord();return[Ext.create("portal.layer.querier.QueryTarget",{id:d,lat:b.lat(),lng:b.lng(),onlineResource:e,layer:f,cswRecord:c,explicit:!0})]},_polygon:function(a,b,c,d){a=[];b=c?c:b;for(c=0;c<d.getCount();c++)for(var e=d.getAt(c),f=e.data.renderer.primitiveManager,g=0;g<f.primitiveList.length;g++)if(e=f.primitiveList[g],
e instanceof GPolygon&&e.Contains(b)){var h=e._portalBasePrimitive,k=h.getId(),l=h.getOnlineResource(),e=h.getLayer(),h=h.getCswRecord();a.push(Ext.create("portal.layer.querier.QueryTarget",{id:k,lat:b.lat(),lng:b.lng(),onlineResource:l,layer:e,cswRecord:h,explicit:!0}))}return a},_nonExplicit:function(a,b){for(var c=[],d=0;d<b.getCount();d++)for(var e=b.getAt(d),f=e.get("cswRecords"),g=0;g<f.length;g++){for(var h=f[g],k=!1,l=h.get("geographicElements"),m=0;m<l.length;m++)if(l[m]instanceof portal.util.BBox&&
l[m].contains(a.lat(),a.lng())){k=!0;break}if(k)for(k=h.get("onlineResources"),m=portal.csw.OnlineResource.getFilteredFromArray(k,portal.csw.OnlineResource.WMS),l=portal.csw.OnlineResource.getFilteredFromArray(k,portal.csw.OnlineResource.WCS),k=[],k=0<l.length?l:m,m=0;m<k.length;m++)l=k[m].get("type"),l!==portal.csw.OnlineResource.WMS&&l!==portal.csw.OnlineResource.WCS||c.push(Ext.create("portal.layer.querier.QueryTarget",{id:"",lat:a.lat(),lng:a.lng(),cswRecord:h,onlineResource:k[m],layer:e,explicit:!0}))}return c},
generateQueryTargets:function(a,b,c,d){return a?a instanceof GMarker?portal.map.gmap.ClickController._marker(a,c):a instanceof GPolygon?portal.map.gmap.ClickController._polygon(a,b,c,d):[]:portal.map.gmap.ClickController._nonExplicit(b,d)}}});
Ext.define("portal.widgets.field.ClientSearchField",{extend:"Ext.ux.form.SearchField",alias:"widget.clientsearchfield",wordListSplitString:" ",initComponent:function(){this.callParent(arguments);this.store.setRemoteFilter(!1)},_setTextFieldDisabled:function(a){var b=Ext.get(this.getInputId());(b.dom.disabled=a)?(b.setStyle("background","#E5E5E5"),b.setStyle("color","#666666")):(b.setStyle("background","#FFFFFF"),b.setStyle("color","#000000"))},onClearClick:function(){this.store.getProxy();this.hasSearch&&
(this.setValue(""),this.store.clearFilter(!1),this.hasSearch=!1,this.triggerCell.item(0).setDisplayed(!1),this.triggerCell.item(1).setDisplayed(!0),this._setTextFieldDisabled(!1),this.updateLayout())},onSearchClick:function(){var a=this.getRawValue();if(1>a.length)this.onClearClick();else this.store.clearFilter(!1),this.store.filterBy(Ext.bind(this.filterByWord,this,[a.split(this.wordListSplitString)],!0)),portal.util.PiwikAnalytic.siteSearch(a,this.getId(),this.store.count()),this.hasSearch=!0,this.triggerCell.item(0).setDisplayed(!0),
this.updateLayout()},filterByWord:function(a,b){for(var c=a.get(this.fieldName).split(this.wordListSplitString),d=0;d<b.length;d++){var e;a:{e=c;for(var f=b[d],g=0;g<e.length;g++){var h=Ext.String.trim(e[g].toLowerCase()),k=Ext.String.trim(f.toLowerCase());if(h===k||0===h.indexOf(k)){e=!0;break a}}e=!1}if(!e)return!1}return!0},runCustomFilter:function(a,b){this.onClearClick();this.hasSearch=!0;this.setValue(a);this.store.filterBy(b);this.triggerCell.item(0).setDisplayed(!0);this.triggerCell.item(1).setDisplayed(!1);
this._setTextFieldDisabled(!0);portal.util.PiwikAnalytic.siteSearch(a,this.getId(),this.store.count());this.updateLayout()},clearCustomFilter:function(){this.onClearClick();this.hasSearch=!1;this.setValue("");this.triggerCell.item(0).setDisplayed(!1);this.triggerCell.item(1).setDisplayed(!0);this._setTextFieldDisabled(!1);this.updateLayout()}});
Ext.define("portal.widgets.plugins.CollapsedAccordian",{extend:"Ext.plugin.Abstract",alias:"plugin.collapsedaccordian",statics:{HIDDEN_ID:"collapsedtarget"},init:function(a){a.insert(0,{xtype:"panel",hidden:!0,itemId:portal.widgets.plugins.CollapsedAccordian.HIDDEN_ID,collapsed:!1});var b=Ext.apply({},a.initialConfig).layout;Ext.isString(b)&&(b={});b.type="accordiondefault";b.defaultId=portal.widgets.plugins.CollapsedAccordian.HIDDEN_ID;a.setLayout(b)}});
Ext.define("portal.widgets.panel.CommonBaseRecordPanel",{extend:"portal.widgets.panel.recordpanel.RecordPanel",alias:"widget.commonbaserecordpanel",browseCatalogueDNSMessage:!1,map:null,menuFactory:null,onlineResourcePanelType:null,serviceInformationIcon:null,nagiosErrorIcon:null,mapExtentIcon:null,listenersHere:{},constructor:function(a){this.map=a.map;this.menuFactory=a.menuFactory;this.onlineResourcePanelType=a.onlineResourcePanelType;this.serviceInformationIcon=a.serviceInformationIcon;this.nagiosErrorIcon=
Ext.isEmpty(a.nagiosErrorIcon)?"portal-core/img/warning.png":a.nagiosErrorIcon;this.mapExtentIcon=a.mapExtentIcon;this.listeners=Object.extend(this.listenersHere,a.listeners);this.callParent(arguments)},onDestroy:function(){me.callParent()},getTitleForRecord:portal.util.UnimplementedFunction,getOnlineResourcesForRecord:portal.util.UnimplementedFunction,getSpatialBoundsForRecord:portal.util.UnimplementedFunction,getCSWRecordsForRecord:portal.util.UnimplementedFunction,_generateHTMLIconMarkup:function(a){return Ext.DomHelper.markup({tag:"div",
style:"text-align:center;",children:[{tag:"img",width:16,height:16,align:"CENTER",src:a}]})},_titleRenderer:function(a,b,c,d,e,f,g){return this.getTitleForRecord(c)},_serviceInformationRenderer:function(a,b){if("kml"==b.get("resourceProvider"))return"portal-core/img/kml.png";var c=this.getOnlineResourcesForRecord(b),d=this._getServiceType(c),c=d.containsDataService,d=d.containsImageService,e="portal-core/img/exclamation.png";(c||d)&&b instanceof portal.knownlayer.KnownLayer&&b.containsNagiosFailures()?
e=this.nagiosErrorIcon:this.serviceInformationIcon&&(c||d)?e=this.serviceInformationIcon:c?e="portal-core/img/binary.png":d&&(e="portal-core/img/picture.png");return e},_getServiceType:function(a){for(var b=!1,c=!1,d=0;d<a.length;d++)switch(a[d].get("type")){case portal.csw.OnlineResource.WFS:case portal.csw.OnlineResource.WCS:case portal.csw.OnlineResource.SOS:case portal.csw.OnlineResource.OPeNDAP:case portal.csw.OnlineResource.CSWService:case portal.csw.OnlineResource.IRIS:case portal.csw.OnlineResource.NCSS:b=
!0;break;case portal.csw.OnlineResource.WMS:case portal.csw.OnlineResource.WWW:case portal.csw.OnlineResource.FTP:case portal.csw.OnlineResource.CSW:case portal.csw.OnlineResource.UNSUPPORTED:c=!0}return result={containsDataService:b,containsImageService:c}},_spatialBoundsRenderer:function(a,b){if(0<this.getSpatialBoundsForRecord(b).length||"portal-InSar-reports"==b.internalId){var c=null;return c=this.mapExtentIcon?this.mapExtentIcon:"portal-core/img/magglass.gif"}return""},_serviceInformationClickHandler:function(a,
b){var c=this.getCSWRecordsForRecord(b);c&&0!==c.length&&Ext.create("portal.widgets.window.CSWRecordDescriptionWindow",{cswRecords:c,parentRecord:b,onlineResourcePanelType:this.onlineResourcePanelType}).show()},_spatialBoundsClickHandler:function(a,b){var c;c="portal-InSar-reports"==b.internalId?this.getWholeGlobeBounds():this.getSpatialBoundsForRecord(b);for(var d=[],e=0;e<c.length;e++){var f=c[e];if(f.southBoundLatitude!==f.northBoundLatitude||f.eastBoundLongitude!==f.westBoundLongitude)85<f.northBoundLatitude&&
(f.northBoundLatitude=85),-85>f.southBoundLatitude&&(f.southBoundLatitude=-85),d.push(f)}this.map.highlightBounds(d)},getWholeGlobeBounds:function(){var a=[];a[0]=Ext.create("portal.util.BBox",{northBoundLatitude:85,southBoundLatitude:-85,eastBoundLongitude:180,westBoundLongitude:-180});return a},_spatialBoundsDoubleClickHandler:function(a,b){var c;c="portal-InSar-reports"==b.internalId?this.getWholeGlobeBounds():this.getSpatialBoundsForRecord(b);if(0<c.length){for(var d=c[0],e=1;e<c.length;e++)d=
d.combine(c[e]);this.map.scrollToBounds(d)}},_loadingTipRenderer:function(a,b,c){a=b.get("layer");if(!a)return"No status has been recorded";var d=a.get("renderer"),e=function(a,b){c.update(a.renderHtml())};d.renderStatus.on("change",e,this);c.on("hide",function(){d.renderStatus.un("change",e)});return d.renderStatus.renderHtml()},_loadingClickHandler:function(a,b){var c=b.get("layer"),d="\x3cp\x3eNo Service recorded, Click on Add layer to map\x3c/p\x3e";c&&(d=c.get("renderer").renderStatus.renderHtml());
Ext.create("Ext.window.Window",{title:"Service Loading Status",height:200,width:500,layout:"fit",modal:!0,items:{xtype:"panel",autoScroll:!0,html:d}}).show()}});window.console||(window.console={log:function(){},warn:function(){}});String.prototype.endsWith||(String.prototype.endsWith=function(a){return-1!==this.indexOf(a,this.length-a.length)});
Ext.define("portal.widgets.panel.CSWConstraintsPanel",{extend:"Ext.tab.Panel",alias:"widget.cswconstraintspanel",constructor:function(a){var b=a.cswRecords;Ext.isArray(b)||(b=[b]);for(var c=[],d=0;d<b.length;d++)if(b[d].hasConstraints()){for(var e=b[d].get("constraints"),f=0,g='\x3ctable style\x3d"border:0px;"\x3e',h=0;h<e.length;h++){var k=e[h],k=k.replace(/^\s\s*/,"").replace(/\s\s*$/,"");0!==k.length&&(f++,g=/^http:\/\//.test(k)?g+('\x3ctr\x3e\x3ctd style\x3d"padding:5px;font-size:11px;"\x3e\x3ca href\x3d"'+
k+'" target\x3d"_blank"\x3e'+k+"\x3c/a\x3e\x3c/td\x3e\x3c/tr\x3e"):g+('\x3ctr\x3e\x3ctd style\x3d"padding:5px;font-size:11px;"\x3e'+k+"\x3c/td\x3e\x3c/tr\x3e"))}g+="\x3c/table\x3e";0<f&&c.push({title:b[d].get("name"),items:[{xtype:"panel",html:g}]})}0===c.length&&c.push({title:"No constraints",items:[{xtype:"label",text:"There have been no access constraints specified at the registry where this layer was sourced from. However, there may still be access constraints that this portal isn't aware of."}]});
Ext.apply(a,{items:c});this.callParent(arguments);this.on("afterrender",function(a){1>=c.length&&a.getTabBar().hide()})}});
Ext.define("portal.widgets.panel.CSWFilterFormPanel",{extend:"Ext.form.Panel",alias:"widget.cswfilterformpanel",keywordStore:null,keywordIDCounter:0,spacerHeight:22,keywordMatchTypeStore:null,miniMap:null,boxLayer:null,constructor:function(a){this.keywordStore=new Ext.data.Store({autoload:!0,fields:["keyword","count"],proxy:{type:"ajax",url:"getFilteredCSWKeywords.do",extraParams:{cswServiceIds:[]},reader:{type:"json",rootProperty:"data"}}});this.keywordMatchTypeStore=Ext.create("Ext.data.Store",
{fields:["display","value"],data:[{display:"Any",value:"Any"},{display:"All",value:"All"}]});Ext.apply(a,{xtype:"form",id:"personalpanelcswfilterform",width:500,autoScroll:!0,border:!1,height:520,items:[{xtype:"tabpanel",layout:"fit",items:[this.getRegistryTab(),this.getGeneralTab(),this.getSpatialTab()]}]});this.callParent(arguments)},getGeneralTab:function(){var a=this;return{title:"General filter",layout:"anchor",items:[{xtype:"fieldset",title:"Match Type",items:[{xtype:"combobox",name:"keywordMatchType",
queryMode:"local",valueField:"value",displayField:"display",fieldLabel:"Match Type",store:this.keywordMatchTypeStore},{xtype:"label",html:'\x3cfont size\x3d"0.7" color\x3d"red"\x3eThe keywords here are generated dynamically based on the NON CUSTOM registries that are ticked on the Registries Filter Tab\x3c/font\x3e'},{xtype:"fieldset",itemId:"cswfilterkeywordfieldsetitemid",layout:"column",anchor:"100%",border:!1,style:"padding:5px 10px 0px 10px",items:[{columnWidth:1,border:!1,layout:"anchor",bodyStyle:"padding:0px 0 0px 2px",
items:[]},{width:25,border:!1,bodyStyle:"padding:0px 0 0px 0px",items:[]},{width:25,border:!1,bodyStyle:"padding:0px 0 0px 0px",items:[]}]}],listeners:{afterrender:function(){a.handlerNewKeywordField()}}},{xtype:"fieldset",title:"Match Text",items:[{xtype:"textfield",name:"anyText",fieldLabel:"Match Any Text"}]},{xtype:"fieldset",title:"Text Search",items:[{xtype:"textfield",name:"title",fieldLabel:"Search Title"},{xtype:"textfield",name:"abstract",fieldLabel:"Search abstract"}]}]}},getSpatialTab:function(){var a=
this;return{title:"Spatial filter",layout:"fit",autoScroll:!1,items:[{xtype:"fieldset",itemId:"cswspatialfiltercoordfieldset",title:"Coordinates",items:[{xtype:"textfield",name:"north",itemId:"north",fieldLabel:"North"},{xtype:"textfield",name:"south",itemId:"south",fieldLabel:"South"},{xtype:"textfield",name:"east",itemId:"east",fieldLabel:"East"},{xtype:"textfield",name:"west",itemId:"west",fieldLabel:"West"},{xtype:"button",toggle:!0,text:"Draw Bounds",handler:function(){var b=a.miniMap,c;for(c in b.controls)b.controls[c]instanceof
OpenLayers.Control.DrawFeature&&(1==this.toggle?(this.toggle=!1,this.setText("Clear bounds"),b.controls[c].activate()):(this.toggle=!0,this.setText("Draw Bounds"),a.boxLayer.removeAllFeatures(),this.ownerCt.getComponent("north").setValue(""),this.ownerCt.getComponent("south").setValue(""),this.ownerCt.getComponent("east").setValue(""),this.ownerCt.getComponent("west").setValue(""),b.controls[c].deactivate()))}}]},{xtype:"panel",id:"cswminimapselection",width:500,height:800,html:"\x3cdiv style\x3d'width:100%; height:100%' id\x3d'cswselection-mini-map'\x3e\x3c/div\x3e",
listeners:{afterrender:function(){a._getMap(this,"cswselection-mini-map")}}}]}},getRegistryTab:function(){var a=this,b={title:"Registries Filter",xtype:"panel",type:"vbox",items:[{xtype:"fieldset",title:"Default Registries",flex:1,items:[{xtype:"checkboxgroup",name:"cswServiceId",id:"registryTabCheckboxGroup",fieldLabel:"Registries",columns:1,vertical:!0,listeners:{change:function(b,c,f,g){a.keywordStore.getProxy().extraParams={cswServiceIds:b.getValue().cswServiceId}},beforeadd:function(a,b,c,g){var h=
!0;a.items.each(function(a,c,d){if(this.inputValue.serviceUrl&&this.inputValue.serviceUrl===b.inputValue.serviceUrl)return Ext.MessageBox.alert("Status","You are attempting to add a duplicated service URL"),h=!1});return h}}}]},{xtype:"fieldset",title:"Add custom registry",collapsible:!0,items:[{xtype:"form",itemId:"customRegistryFormID",border:!1,flex:1,buttonAlign:"left",buttons:[{xtype:"button",text:"Manage Saved Registries",handler:function(){var a=new portal.widgets.panel.CustomRegistryTreeGrid;
Ext.create("Ext.window.Window",{title:"Manage Saved Registries",height:200,width:600,layout:"fit",modal:!0,items:[a]}).show()}},{xtype:"button",text:"Save Registry",disabled:!0,itemId:"cswFilterFormSaveRegistryButton",tooltip:"Add custom registry and save it to the cookies for future use.",scope:this,handler:function(){this._addFormToRegistry(!0,!1)}},{xtype:"tbfill"},{xtype:"button",text:"Add Registry",tooltip:"Add custom registry to the registry list",scope:this,handler:function(){this._addFormToRegistry(!1,
!0)}}],items:[{xtype:"textfield",anchor:"100%",itemId:"cswFilterFormServiceURLTextField",name:"DNA_serviceUrl",allowBlank:!0,fieldLabel:"Service Url",emptyText:"CSW url in the format: http://test/gn/srv/eng/csw",triggers:{foo:{cls:"x-form-clear-trigger",handler:function(){this.setRawValue("");a._setAllowRegistryAdd()}}}}]}]}]},c=[];(new Ext.data.Store({model:"portal.widgets.model.CSWServices",proxy:{type:"ajax",url:"getCSWServices.do",reader:{type:"json",rootProperty:"data"}},listeners:{load:function(b,
e,f,g){for(b=0;b<e.length;b++)f=e[b],c.push({boxLabel:f.get("title"),name:"cswServiceId",inputValue:f.get("id"),checked:f.get("selectedByDefault")});e=Ext.getCmp("registryTabCheckboxGroup");e.add(c);b=a._getCustomRegistriesCookies();a._addCookieToRegistry(b);a.keywordStore.getProxy().extraParams={cswServiceIds:e.getValue().cswServiceId}}}})).load();return b},updateAddRemoveButtons:function(){for(var a=Ext.getCmp("personalpanelcswfilterform").query("fieldset[itemId\x3dcswfilterkeywordfieldsetitemid]")[0],
b=a.items.items[1],a=a.items.items[0].items.getCount(),c=0;c<a;c++){var d=b.items.items[c];1>=a?d.hide():d.show()}},handlerRemoveKeywordField:function(a,b){var c=Ext.getCmp("personalpanelcswfilterform").query("fieldset[itemId\x3dcswfilterkeywordfieldsetitemid]")[0],d=c.items.items[0],e=c.items.items[1],f=c.items.items[2],g=e.items.findIndexBy(function(b){return b===a});d.remove(d.getComponent(g));e.remove(e.getComponent(g));f.remove(f.getComponent(0));this.updateAddRemoveButtons();c.doLayout()},handlerNewKeywordField:function(a,
b){var c=Ext.getCmp("personalpanelcswfilterform").query("fieldset[itemId\x3dcswfilterkeywordfieldsetitemid]")[0],d=c.items.items[1],e=c.items.items[2];c.items.items[0].add({xtype:"combo",width:380,name:"keywords",queryMode:"remote",typeAhead:!0,style:{marginBottom:"0px"},typeAheadDelay:500,forceSelection:!1,queryParam:"keyword",valueField:"keyword",fieldLabel:"keyword",store:this.keywordStore,listeners:{beforequery:function(a){delete a.combo.lastQuery}},tpl:Ext.create("Ext.XTemplate",'\x3ctpl for\x3d"."\x3e',
'\x3cdiv class\x3d"x-boundlist-item"\x3e{keyword} - \x3cb\x3e({count})\x3c/b\x3e\x3c/div\x3e',"\x3c/tpl\x3e"),displayTpl:Ext.create("Ext.XTemplate",'\x3ctpl for\x3d"."\x3e',"{keyword}","\x3c/tpl\x3e")});d.add({xtype:"button",iconCls:"remove",width:22,height:this.spacerHeight,scope:this,keywordIDCounter:this.keywordIDCounter,handler:this.handlerRemoveKeywordField});0===e.items.getCount()?e.add({xtype:"button",iconCls:"add",width:22,height:this.spacerHeight,scope:this,handler:this.handlerNewKeywordField}):
e.insert(0,{xtype:"box",width:22,height:this.spacerHeight});this.keywordIDCounter++;this.updateAddRemoveButtons();c.doLayout()},_getMap:function(a,b){var c=new OpenLayers.Map(b,{projection:"EPSG:3857",controls:[new OpenLayers.Control.Navigation,new OpenLayers.Control.PanZoomBar({zoomStopHeight:8})],layers:[new OpenLayers.Layer.Google("Google Hybrid",{type:google.maps.MapTypeId.HYBRID,numZoomLevels:20}),new OpenLayers.Layer.Google("Google Physical",{type:google.maps.MapTypeId.TERRAIN}),new OpenLayers.Layer.Google("Google Streets",
{numZoomLevels:20}),new OpenLayers.Layer.Google("Google Satellite",{type:google.maps.MapTypeId.SATELLITE,numZoomLevels:22})],center:(new OpenLayers.LonLat(133.3,-61)).transform("EPSG:4326","EPSG:3857"),zoom:3});this.boxLayer=new OpenLayers.Layer.Vector("Box layer");c.addLayer(this.boxLayer);var d=new OpenLayers.Control.DrawFeature(this.boxLayer,OpenLayers.Handler.RegularPolygon,{handlerOptions:{sides:4,irregular:!0}});c.addControl(d);d.events.register("featureadded",{},Ext.bind(function(a,b){var c=
a.object,d=a.feature.geometry.getBounds().transform("EPSG:3857","EPSG:4326").toArray(),k=b.ownerLayout.owner.getComponent("cswspatialfiltercoordfieldset");k.getComponent("north").setValue(d[3]);k.getComponent("south").setValue(d[1]);k.getComponent("east").setValue(d[2]);k.getComponent("west").setValue(d[0]);(new Ext.util.DelayedTask(Ext.bind(function(a){a.deactivate()},this,[c]))).delay(50)},this,a,!0));a.on("resize",function(){c.updateSize()},this);this.miniMap=c},_addFormToRegistry:function(a,b){var c=
this.query("form[itemId\x3dcustomRegistryFormID]")[0];portal.util.Ajax.request({url:"getCSWGetCapabilities.do",scope:this,params:{cswServiceUrl:c.getValues().DNA_serviceUrl},callback:function(d,e){if(d){var f=e.title,g=Ext.getCmp("registryTabCheckboxGroup"),h=[],k=c.getValues().DNA_serviceUrl,k={id:"randomIdGen_"+Ext.id(),title:f,serviceUrl:k,recordInformationUrl:this._covertCSWtoRecordInfoUrl(k)};h.push({boxLabel:f,name:"cswServiceId",inputValue:{id:k.id,title:k.title,serviceUrl:k.serviceUrl,recordInformationUrl:k.recordInformationUrl},
checked:!0});b&&b&&(g.add(h),this._setAllowRegistryAdd(!0));a&&1==a&&(this._saveToCookie(k)?Ext.Msg.alert("Status",'Registry saved locally. Click on "Manage Saved Registries" to delete'):Ext.Msg.alert("WARNING",'Only a maximum of 3 registry are allowed to be store locally due to space limitation. This record is not saved but will be added to the registries above. Click on "Manage Saved Registries" to delete'))}else Ext.Msg.alert("WARNING","Failure to connect to the registry. Check your URL and ensure it is in the right format e.g http://test/gn/srv/eng/csw")}})},
_setAllowRegistryAdd:function(a){var b=this.query('[itemId\x3d"cswFilterFormServiceURLTextField"]')[0],c=this.query('[itemId\x3d"cswFilterFormSaveRegistryButton"]')[0];a?(c.enable(),b.setEditable(!1),b.addCls("portal-ux-textfield-disabled")):(c.disable(),b.setEditable(!0),b.removeCls("portal-ux-textfield-disabled"))},_covertCSWtoRecordInfoUrl:function(a){return"csw"==a.substring(a.length-3,a.length).toLowerCase()?a.slice(0,a.length-3)+"main.home":a},_addCookieToRegistry:function(a){a instanceof Array||
(a=[a]);for(var b=Ext.getCmp("registryTabCheckboxGroup"),c=[],d=0;d<a.length;d++)c.push({boxLabel:a[d].title,name:"cswServiceId",inputValue:{id:a[d].id,title:a[d].title,serviceUrl:a[d].serviceUrl,recordInformationUrl:a[d].recordInformationUrl},checked:!1});b.add(c)},_saveToCookie:function(a){return null==Ext.util.Cookies.get("Registries1")||"null"==Ext.util.Cookies.get("Registries1")?(Ext.util.Cookies.set("Registries1",Ext.encode(a)),!0):null==Ext.util.Cookies.get("Registries2")||"null"==Ext.util.Cookies.get("Registries2")?
(Ext.util.Cookies.set("Registries2",Ext.encode(a)),!0):null==Ext.util.Cookies.get("Registries3")||"null"==Ext.util.Cookies.get("Registries3")?(Ext.util.Cookies.set("Registries3",Ext.encode(a)),!0):!1},_getCustomRegistriesCookies:function(){for(var a=[],b=1;4>b;b++){var c=Ext.decode(Ext.util.Cookies.get("Registries"+b));null!=c&&a.push({id:c.id,title:c.title,serviceUrl:c.serviceUrl,recordInformation:c.recordInformationUrl})}return a}});
Ext.define("portal.widgets.window.CSWFilterWindow",{extend:"Ext.window.Window",cswFilterFormPanel:null,constructor:function(a){var b=this,c=[];b.cswFilterFormPanel=a.cswFilterFormPanel||new portal.widgets.panel.CSWFilterFormPanel({name:"Filter Form"});b.cswFilterFormPanel.resetForm&&c.push({xtype:"button",text:"Reset Form",handler:function(a){b.cswFilterFormPanel.resetForm()}});c.push({xtype:"button",text:"Search",scope:b,iconCls:"add",handler:function(a){a=a.findParentByType("window");var b=a.getComponent(0);
if(b.getForm().isValid()){var b=b.getForm().getValues(!1,!1,!1,!1),c=[];for(additionalParamKey in b)if("cswServiceId"==additionalParamKey){b[additionalParamKey]instanceof Array||(b[additionalParamKey]=[b[additionalParamKey]]);for(var g=0;g<b[additionalParamKey].length;g++)c.push(this._getTabPanels(b,b[additionalParamKey][g]))}a.fireEvent("filterselectcomplete",c);a.hide()}else Ext.Msg.alert("Invalid Data","Please correct form errors.")}});Ext.apply(a,{title:"Enter Parameters",layout:"fit",modal:!0,
width:500,items:[b.cswFilterFormPanel],buttons:c});this.callParent(arguments)},_getTabPanels:function(a,b){var c=[],d=[];if(a)for(key in a)if(a[key]){var e=a[key].toString();0<e.length&&"cswServiceId"!=key&&"DNA_"!=key.slice(0,4)&&(c.push(key),d.push(e))}"undefined"==typeof b.id&&(c.push("cswServiceId"),d.push(b));for(var c=Ext.create("Ext.data.Store",{model:"portal.csw.CSWRecord",pageSize:35,autoLoad:!1,headers:{"Content-Type":"application/x-www-form-urlencoded"},proxy:{type:"ajax",url:"getFilteredCSWRecords.do",
reader:{type:"json",rootProperty:"data",successProperty:"success",totalProperty:"totalResults"},extraParams:{key:c,value:d,customregistries:{id:b.id,title:b.title,serviceUrl:b.serviceUrl,recordInformationUrl:b.recordInformationUrl}}}}),d=Ext.getCmp("registryTabCheckboxGroup").getChecked(),e="Error retrieving title",f=0;f<d.length;f++)if(d[f].inputValue===b){e=d[f].boxLabel;break}return{title:e,xtype:"cswrecordpagingpanel",layout:"fit",store:c}},close:function(){this.hide()}});
Ext.define("portal.layer.legend.csw.CSWLegend",{extend:"portal.layer.legend.Legend",iconUrl:"",polygonColorArr:[],constructor:function(a){this.iconUrl=a.iconUrl;a.polygonColor&&(this.polygonColorArr=a.polygonColor.split(","));this.callParent(arguments)},getLegendComponent:function(a,b,c,d,e){c='\x3ctable\x3e\x3ctr\x3e\x3ctd\x3e\x3cimg height\x3d"25" width\x3d"25" src\x3d"'+this.iconUrl+'"\x3e\x3c/td\x3e\x3ctd\x3e Point\x3c/td\x3e\x3c/tr\x3e';1<this.polygonColorArr.length&&(c+='\x3ctr\x3e\x3ctd\x3e\x3csvg width\x3d"20" height\x3d"20"\x3e\x3crect width\x3d"20" height\x3d"20" style\x3d"fill:'+
this.polygonColorArr[1]+";stroke-width:8;stroke:"+this.polygonColorArr[0]+';opacity:0.8;"/\x3e\x3c/svg\x3e\x3c/td\x3e\x3ctd\x3e Geographical Bounding Box\x3c/td\x3e\x3c/tr\x3e');c=Ext.create("Ext.form.Panel",{title:"CSW Resources",layout:"fit",width:250,html:c+"\x3c/table\x3e"});e(this,a,b,!0,c)},getLegendIconHtml:function(a,b){return this.iconUrl&&0<this.iconUrl.length?Ext.DomHelper.markup({tag:"div",style:"text-align:center;",children:[{tag:"img",width:16,height:16,align:"CENTER",src:this.iconUrl}]}):
""}});
Ext.define("portal.widgets.panel.CSWMetadataPanel",{extend:"Ext.form.Panel",alias:"widget.cswmetadatapanel",cswRecord:null,extraItems:null,constructor:function(a){this.cswRecord=a.cswRecord;for(var b=this.cswRecord.get("recordInfoUrl"),c="",d=this.cswRecord.get("descriptiveKeywords"),e=0;e<d.length;e++)c+=d[e],e<d.length-1&&(c+=", ");Ext.apply(a,{layout:"fit",items:[{xtype:"fieldset",items:this._getMetadataItems(b,c)}]});this.callParent(arguments)},_getMetadataItems:function(a,b){var c=[{xtype:"displayfield",fieldLabel:"Source",
value:Ext.util.Format.format('\x3ca target\x3d"_blank" href\x3d"{0}"\x3eFull metadata and downloads\x3c/a\x3e',a)},{xtype:"displayfield",fieldLabel:"Title",anchor:"100%",value:this.cswRecord.get("name")},{xtype:"textarea",fieldLabel:"Abstract",anchor:"100%",value:this.cswRecord.get("description"),readOnly:!0},{xtype:"displayfield",fieldLabel:"Keywords",anchor:"100%",value:b},{xtype:"displayfield",fieldLabel:"Contact Org",anchor:"100%",value:this.cswRecord.get("contactOrg")}];null!=this.cswRecord.get("constraints")&&
0<this.cswRecord.get("constraints").length&&c.push({xtype:"textarea",fieldLabel:"Constraints",anchor:"100%",value:this.cswRecord.get("constraints"),readOnly:!0});c=c.concat(this.extraItems);null!=this.cswRecord&&(c=c.concat({fieldLabel:"Resources",xtype:"onlineresourcepanel",cswRecords:this.cswRecord}));return c}});
Ext.define("portal.layer.querier.csw.CSWQuerier",{extend:"portal.layer.querier.Querier",constructor:function(a){this.callParent(arguments)},query:function(a,b){var c=a.get("cswRecord");c?(c=Ext.create("portal.layer.querier.BaseComponent",{border:!1,autoScroll:!0,items:[{xtype:"cswmetadatapanel",border:!1,cswRecord:c}]}),b(this,[c],a)):b(this,[],a)}});Ext.require(["portal.csw.OnlineResourceType","portal.util.BBoxType","portal.csw.CSWRecordType"]);
Ext.define("portal.csw.CSWRecord",{extend:"Ext.data.Model",requires:["portal.csw.OnlineResourceType","portal.util.BBoxType","portal.csw.CSWRecordType"],fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"description",type:"string"},{name:"adminArea",type:"string"},{name:"contactOrg",type:"string"},{name:"descriptiveKeywords",type:"auto"},{name:"dataSetURIs",type:"auto"},{name:"geographicElements",convert:portal.util.BBoxType.convert},{name:"onlineResources",convert:portal.csw.OnlineResourceType.convert},
{name:"childRecords",convert:portal.csw.CSWRecordType.convert},{name:"resourceProvider",type:"string"},{name:"recordInfoUrl",type:"string"},{name:"noCache",type:"boolean"},{name:"extensions",type:"auto"},{name:"constraints",type:"auto"},{name:"date",type:"date",convert:function(a){return a?new Date(Date.parse(a.replace(" UTC",""))):a}},{name:"loading",type:"boolean",defaultValue:!1},{name:"layer",type:"auto"},{name:"active",type:"boolean",defaultValue:!1},{name:"customlayer",type:"boolean",defaultValue:!1},
{name:"service",type:"boolean",defaultValue:!1}],hasConstraints:function(){for(var a=this.get("constraints"),b=0;b<a.length;b++)if(0<a[b].replace(/^\s\s*/,"").replace(/\s\s*$/,"").length)return!0;return!1},containsKeywords:function(a){var b=a;Ext.isArray(a)||(b=[a]);for(a=0;a<b.length;a++)for(var c=this.get("descriptiveKeywords"),d=0;d<c.length;d++)if(c[d]==b[a])return!0;return!1},containsOnlineResource:function(a){for(var b=this.get("onlineResources"),c=0;c<b.length;c++){var d=b[c],e=a;if(d.get("url")===
e.get("url")&&d.get("type")===e.get("type")&&d.get("name")===e.get("name")&&d.get("description")===e.get("description"))return!0}return!1},containsOnlineResourceUrl:function(a){for(var b=this.getAllChildOnlineResources(),c=0;c<b.length;c++)if(b[c].get("url").toLowerCase()===a.toLowerCase())return!0;return!1},getAllChildOnlineResources:function(){var a=this.get("onlineResources"),b=this.get("childRecords");a||(a=[]);if(b)for(var c=0;c<b.length;c++)a=a.concat(b[c].getAllChildOnlineResources());return a},
getOnlineResourceById:function(a,b){var c=this.get("onlineResources"),d=this.get("childRecords");if(c)for(var e=0;e<c.length;e++)if(c[e].get("id")===a)return c[e];if(b&&d)for(e=0;e<d.length;e++)if(c=d[e].getOnlineResourceById(a,b))return c;return null}});
Ext.define("portal.widgets.window.CSWRecordConstraintsWindow",{extend:"Ext.window.Window",constructor:function(a){var b=a.cswRecords;Ext.applyIf(a,{title:"Copyright Information",autoDestroy:!0,width:500,autoHeight:!0,modal:!0});Ext.apply(a,{autoScroll:!0,layout:"fit",items:[{xtype:"cswconstraintspanel",autoScroll:!0,cswRecords:b}]});this.callParent(arguments)}});
Ext.define("portal.widgets.window.CSWRecordDescriptionWindow",{extend:"Ext.window.Window",constructor:function(a){var b=a.cswRecords,c=a.parentRecord,d=a.onlineResourcePanelType||"onlineresourcepanel";Ext.applyIf(a,{title:"Service Information",autoDestroy:!0,width:830,maxHeight:400,minHeight:100,modal:!0});"kml"==b[0].get("resourceProvider")?Ext.apply(a,{autoScroll:!0,html:"\x3cp\x3eThis layer have been generated from a custom KML file\x3c/p\x3e",listeners:{resize:function(a,b,c){a.setSize(b,c)}}}):
Ext.apply(a,{autoScroll:!0,items:[{xtype:d,cswRecords:b,parentRecord:c}],listeners:{resize:function(a,b,c){a.setSize(b,c)}}});this.callParent(arguments)}});
CSWRecordMetadataWindow=Ext.extend(Ext.Window,{cswRecord:null,constructor:function(a){this.cswRecord=a.cswRecord;var b=void 0,c=!0;4<this.cswRecord.getOnlineResources().length&&(b=400,c=!1);Ext.apply(a,{layout:"auto",modal:!0,height:b,autoScroll:!0,autoHeight:c,items:[{xtype:"cswmetadatapanel",cswRecord:this.cswRecord,bodyStyle:{"background-color":"#ffffff"},hideBorders:!0}]},{width:800,title:this.cswRecord.getServiceName()});CSWRecordMetadataWindow.superclass.constructor.call(this,a)}});
Ext.define("portal.widgets.panel.CSWRecordPagingPanel",{extend:"Ext.grid.Panel",alias:"widget.cswrecordpagingpanel",cswRecordStore:null,pageSize:15,constructor:function(a){this.cswRecordStore=a.store;Ext.apply(a,{hideHeaders:!1,height:200,layout:"fit",width:400,columns:[{header:"Name",dataIndex:"name",width:390},{header:"Administrative Area",dataIndex:"adminArea",width:110},{header:"Type",dataIndex:"onlineResources",width:100,renderer:function(a){return this._serviceInformationRenderer(a)}}],store:this.cswRecordStore,
viewConfig:{forceFit:!0,enableRowBody:!0},loadMask:{msg:"Performing CSW Filter..."},multiSelect:!0,dockedItems:[{xtype:"pagingtoolbar",pageSize:this.pageSize,store:this.cswRecordStore,dock:"bottom",displayInfo:!0}],listeners:{afterrender:function(a,c){a.cswRecordStore.load()},itemdblclick:function(a,c,d,e,f,g){this._callBackDisplayInfo(c)}}});this.callParent(arguments)},_callBackDisplayInfo:function(a){Ext.create("Ext.window.Window",{title:"CSW Record Information",modal:!0,items:[{xtype:"cswmetadatapanel",
width:500,border:!1,cswRecord:a}]}).show()},_serviceInformationRenderer:function(a){for(var b=!1,c=!1,d=0;d<a.length;d++)switch(a[d].get("type")){case portal.csw.OnlineResource.WFS:case portal.csw.OnlineResource.WCS:case portal.csw.OnlineResource.SOS:case portal.csw.OnlineResource.OPeNDAP:case portal.csw.OnlineResource.CSWService:case portal.csw.OnlineResource.IRIS:b=!0;break;case portal.csw.OnlineResource.WMS:case portal.csw.OnlineResource.WWW:case portal.csw.OnlineResource.FTP:case portal.csw.OnlineResource.CSW:case portal.csw.OnlineResource.UNSUPPORTED:c=
!0}return this._generateHTMLIconMarkup(b?"portal-core/img/binary.png":c?"portal-core/img/picture.png":"portal-core/img/cross.png")},_generateHTMLIconMarkup:function(a){return Ext.DomHelper.markup({tag:"div",style:"text-align:center;",children:[{tag:"img",width:16,height:16,align:"CENTER",src:a}]})}});
Ext.define("portal.widgets.panel.CSWRecordPanel",{alias:"widget.cswrecordpanel",extend:"portal.widgets.panel.BaseRecordPanel",constructor:function(a){this.callParent(arguments)},getTitleForRecord:function(a){return a.data.name},getOnlineResourcesForRecord:function(a){return a.getAllChildOnlineResources()},getSpatialBoundsForRecord:function(a){return a.data.geographicElements},getCSWRecordsForRecord:function(a){return[a]}});
Ext.define("portal.csw.CSWRecordType",{singleton:!0,requires:["Ext.data.SortTypes","Ext.data.Types"]},function(){Ext.apply(portal.csw.CSWRecordType,{convert:function(a,b){if(Ext.isArray(a)){for(var c=[],d=0;d<a.length;d++)c.push(this.convert(a[d]));return c}return a instanceof portal.csw.CSWRecord?a:Ext.isObject(a)?Ext.create("portal.csw.CSWRecord",a):null},sortType:Ext.data.SortTypes.none,type:"portal.csw.OnlineResource"})});
Ext.define("portal.layer.renderer.csw.CSWRenderer",{extend:"portal.layer.renderer.Renderer",config:{icon:null},polygonColor:null,constructor:function(a){this.legend=Ext.create("portal.layer.legend.csw.CSWLegend",{iconUrl:a.icon?a.icon.getUrl():"",polygonColor:a.polygonColor?a.polygonColor:this._getPolygonColor(null).join()});this.callParent(arguments)},displayData:function(a,b,c){this.removeData();var d=c="",e="",f=null;b.getParameters()&&(f=b.getParameters());var g=/\*/;f&&(c=f.title,""!==c&&/^\w+/.test(c)&&
(g=new RegExp(c,"i")));f&&f.keyword&&(d=f.keyword);f&&f.resourceProvider&&(e=f.resourceProvider);this.fireEvent("renderstarted",this,a,b);a=this.parentLayer.get("cswRecords");b=0;for(var f=[],h=0;h<a.length;h++)if(!(""!==c&&!g.test(a[h].get("name"))||""!==d&&!a[h].containsKeywords(d)||""!==e&&a[h].get("resourceProvider")!==e)){b++;for(var k=a[h].get("geographicElements"),l=0;l<k.length;l++){var m=k[l];if(m instanceof portal.util.BBox)if(m.eastBoundLongitude===m.westBoundLongitude&&m.southBoundLatitude===
m.northBoundLatitude)m=Ext.create("portal.map.Point",{latitude:m.southBoundLatitude,longitude:m.eastBoundLongitude}),f.push(this.map.makeMarker(a[h].get("id"),a[h].get("name"),a[h],void 0,this.parentLayer,m,this.icon));else for(var m=m.toPolygon(this.map,this._getPolygonColor(this.polygonColor)[0],4,.75,this._getPolygonColor(this.polygonColor)[1],.4,void 0,a[h].get("id"),a[h],void 0,this.parentLayer),n=0;n<m.length;n++)f.push(m[n])}}this.primitiveManager.addPrimitives(f);this.fireEvent("renderfinished",
this)},_getPolygonColor:function(a){return a&&0<a.length?a.split(","):["#0003F9","#0055FE"]},getLegend:function(a,b){return this.legend},removeData:function(){this.primitiveManager.clearPrimitives()},abortDisplay:Ext.emptyFn});
Ext.define("portal.widgets.panel.CSWReportPagingPanel",{extend:"Ext.grid.Panel",alias:"widget.cswpagingpanel",map:null,cswRecordStore:null,pageSize:20,constructor:function(a){this.cswRecordStore=Ext.create("Ext.data.Store",{id:"CSWPagingStore",autoLoad:!1,model:"portal.csw.CSWRecord",pageSize:this.pageSize,proxy:{type:"ajax",url:"getUncachedCSWRecords.do",extraParams:a.cswConfig.extraParams,reader:{type:"json",rootProperty:"data",successProperty:"success",totalProperty:"totalResults"}}});Ext.apply(a,
{hideHeaders:!1,height:200,layout:"fit",width:400,columns:[{header:"Name",dataIndex:"name",width:390},{header:"Administrative Area",dataIndex:"adminArea",width:110},{header:"Type",dataIndex:"onlineResources",width:100,renderer:function(a){return'\x3cdiv style\x3d"text-align:center"\x3e\x3cimg src\x3d"portal-core/img/picture.png" width\x3d"16" height\x3d"16" align\x3d"CENTER"/\x3e\x3c/div\x3e'}}],store:this.cswRecordStore,viewConfig:{forceFit:!0,enableRowBody:!0},loadMask:{msg:"Performing CSW Filter..."},
multiSelect:!0,dockedItems:[{xtype:"pagingtoolbar",pageSize:this.pageSize,store:this.cswRecordStore,dock:"bottom",displayInfo:!0}],listeners:{afterrender:function(b,c){b.cswRecordStore.load({params:a.cswConfig.pagingConfig})},itemdblclick:function(b,c,d,e,f,g){a.cswConfig.callback(c)}}});this.callParent(arguments)}});
CSWSelectionWindow=Ext.extend(Ext.Window,{store:null,pageSize:20,buttons:[{xtype:"button",text:"Add Selected Records",iconCls:"add",scope:this,handler:function(a,b){var c=a.findParentByType("window"),d=c.getComponent("pagingRecordtabPanel").getActiveTab().getSelectionModel().getSelection();c.fireEvent("selectioncomplete",d)}},{xtype:"button",text:"Add All Current Page Records",iconCls:"addall",scope:this,handler:function(a,b){var c=a.findParentByType("window"),d=c.getComponent("pagingRecordtabPanel").getActiveTab().getStore().getRange();
c.fireEvent("selectioncomplete",d)}}],constructor:function(a){Ext.apply(a,{title:a.title,height:500,width:650,layout:"fit",items:[{xtype:"tabpanel",itemId:"pagingRecordtabPanel",layout:"fit",items:a.resultpanels}],buttonAlign:"right",modal:!0});CSWSelectionWindow.superclass.constructor.call(this,a)}});Ext.define("portal.widgets.model.CSWServices",{extend:"Ext.data.Model",fields:[{name:"id",type:"string"},{name:"title",type:"string"},{name:"url",type:"string"},{name:"selectedByDefault",type:"string"}]});
Ext.define("portal.widgets.model.CustomRegistryModel",{extend:"Ext.data.Model",fields:[{name:"id",type:"string"},{name:"title",type:"string"},{name:"serviceUrl",type:"string"},{name:"recordInformationUrl",type:"string"},{name:"active",type:"boolean"}]});
Ext.define("portal.widgets.panel.CustomRegistryTreeGrid",{extend:"Ext.tree.Panel",requires:["Ext.data.*","Ext.grid.*","Ext.tree.*","Ext.ux.CheckColumn","portal.widgets.model.CustomRegistryModel"],xtype:"tree-grid",title:"Saved Registries",layout:"fit",useArrows:!0,rootVisible:!1,multiSelect:!0,singleExpand:!0,constructor:function(a){Ext.apply(this,{itemId:"customRegistryNavTree",store:new Ext.data.TreeStore({model:portal.widgets.model.CustomRegistryModel,proxy:{type:"memory"}}),selModel:Ext.create("Ext.selection.CheckboxModel",
{}),columns:[{xtype:"treecolumn",text:"Title",flex:1,sortable:!0,dataIndex:"title"},{text:"CSW Endpoint",flex:3,dataIndex:"serviceUrl",sortable:!0}],dockedItems:[{xtype:"toolbar",dock:"bottom",items:[{xtype:"button",align:"right",text:"Delete Selected",scope:this,handler:function(a,c){for(var d=this.getSelectionModel().getSelection(),e=Ext.getCmp("registryTabCheckboxGroup"),f=0;f<d.length;f++){var g=d[f].get("id");this._deleteFromCookie(g);this.getStore().remove(d[f]);for(var h=e.items.items,k=0;k<
h.length;k++)if(h[k].inputValue.id&&h[k].inputValue.id===g){e.remove(h[k]);break}}}}]}]});this.setRootNode(this._getRegistryFromCookie());this.callParent()},_getRegistryFromCookie:function(){for(var a=[],b=1;4>b;b++){var c=Ext.decode(Ext.util.Cookies.get("Registries"+b));null!=c&&a.push({id:c.id,title:c.title,serviceUrl:c.serviceUrl,recordInformation:c.recordInformation,active:!1,leaf:!0,expanded:!1})}return{success:!0,children:[{id:"localRegistry",title:"Registries",serviceUrl:"",recordInformation:"",
active:!1,leaf:!1,expanded:!0,children:a}]}},_deleteFromCookie:function(a){for(var b=1;4>b;b++){var c="Registries"+b,d=Ext.decode(Ext.util.Cookies.get("Registries"+b));null!=d&&d.id==a&&Ext.util.Cookies.clear(c)}}});
Ext.define("portal.widgets.field.DataDisplayField",{alias:"widget.datadisplayfield",extend:"Ext.form.field.Display",hideLabel:!0,labelStyle:"display:none;",fieldCls:Ext.baseCSSPrefix+"form-value-field",labelCls:Ext.baseCSSPrefix+"form-value-field-label",uomCls:Ext.baseCSSPrefix+"form-value-field-uom",uom:null,uomTip:null,uomStyle:null,fieldSubTpl:null,constructor:function(a){this.uom=a.uom?a.uom:"";this.uomStyle=a.uomStyle?a.uomStyle:{};this.uomCls=a.uomCls?a.uomCls:this.uomCls;this.uomTip=a.uomTip?
a.uomTip:"";this.fieldLabel=a.fieldLabel?a.fieldLabel:"";this.fieldSubTpl=['\x3cdiv id\x3d"{id}"','\x3ctpl if\x3d"fieldStyle"\x3e style\x3d"{fieldStyle}"\x3c/tpl\x3e',' class\x3d"{fieldCls}"\x3e{value}','\x3ctpl if\x3d"[uom]"\x3e \x3cspan title\x3d"{[uomTip]}" class\x3d"{[uomCls]}" style\x3d"{[uomStyle]}"\x3e{[uom]}\x3c/span\x3e\x3c/tpl\x3e',"\x3c/div\x3e",'\x3cdiv class\x3d"x-form-value-field-label"\x3e',"{[fieldLabel]}","\x3c/div\x3e",{compiled:!0,disableFormats:!0,definitions:[this.createDefinition("uom",
this.uom),this.createDefinition("uomStyle",this.uomStyle),this.createDefinition("uomCls",this.uomCls),this.createDefinition("uomTip",this.uomTip),this.createDefinition("fieldLabel",this.fieldLabel)]}];this.callParent(arguments)},createDefinition:function(a,b){return Ext.isString(b)?Ext.util.Format.format('var {0} \x3d "{1}";',a,b):Ext.isObject(b)?this.createDefinition(a,Ext.DomHelper.generateStyles(b)):Ext.util.Format.format("var {0} \x3d {1};",a,b)}});
Ext.define("portal.util.permalink.DeserializationHandler",{extend:"Ext.util.Observable",mapStateSerializer:null,knownLayerStore:null,layerFactory:null,cswRecordStore:null,map:null,stateString:null,stateVersion:null,constructor:function(a){Ext.apply(this,a);this.callParent(arguments);if(this.knownLayerStore)this.knownLayerStore.on("load",this._deserializeIfReady,this,{single:!0});if(this.cswRecordStore)this.cswRecordStore.on("load",this._deserializeIfReady,this,{single:!0});this._deserializeIfReady()},
_deserializeIfReady:function(){if(!(this.knownLayerStore&&0===this.knownLayerStore.getCount()||this.cswRecordStore&&0===this.cswRecordStore.getCount())){if(!this.mapStateSerializer)if(this.stateString)Ext.isIE&&2047===window.location.href.length&&Ext.MessageBox.show({title:"Mangled Permanent Link",icon:Ext.window.MessageBox.WARNING,msg:"The web browser you are using (Internet Explorer) has likely truncated the permanent link you are using which will probably render it unuseable. This portal will attempt to restore the saved state anyway.",
buttons:Ext.window.MessageBox.OK,multiline:!1}),this.mapStateSerializer=Ext.create("portal.util.permalink.MapStateSerializer");else return;this.mapStateSerializer.deserialize(this.stateString,this.stateVersion,Ext.bind(function(){this._deserialize()},this))}},_configureLayer:function(a,b,c){c=a.get("renderer");var d=a.get("filterer"),e=a.get("filterForm");c.suspendEvents(!1);d.suspendEvents(!1);a.set("deserialized",!0);b&&d.setParameters(b);c.resumeEvents();d.resumeEvents();b&&(e.on("formloaded",
Ext.bind(function(a,b){a.readFromFilterer(b)},this,[e,d],!1)),e.getIsFormLoaded()&&e.readFromFilterer(d))},_findCSWRecordsByOnlineResources:function(a){for(var b=0;b<this.cswRecordStore.getCount();b++){for(var c=this.cswRecordStore.getAt(b),d=!1,e=0;e<a.length&&!d;e++)d=c.containsOnlineResource(a[e]);if(d)return c}return null},_deserialize:function(){var a=this._getLayersToAdd();a.length<this.mapStateSerializer.serializedLayers.length&&Ext.MessageBox.show({title:"Missing Layers",icon:Ext.MessageBox.WARNING,
buttons:Ext.MessageBox.OK,msg:"Some of the saved layers no longer exist and will be ignored. The remaining layers will load normally.",multiline:!1});ActiveLayerManager.addLayers(a)},_getLayersToAdd:function(){var a=this.mapStateSerializer;this.map.setZoom(a.mapState.zoom);var b=Ext.create("portal.map.Point",{latitude:a.mapState.center.lat,longitude:a.mapState.center.lng});this.map.setCenter(b);for(var b=[],c=0;c<a.serializedLayers.length;c++){var d=a.serializedLayers[c];if(d.source===portal.layer.Layer.KNOWN_LAYER){var e=
d.id;if(e&&(e=this.knownLayerStore.getById(e))){var f=this.layerFactory.generateLayerFromKnownLayer(e);e.set("layer",f);this._configureLayer(f,d.filter,d.visible);b.push(f)}}else if(d.source===portal.layer.Layer.CSW_RECORD){for(var e=[],g=0;g<d.onlineResources.length;g++)e.push(Ext.create("portal.csw.OnlineResource",{name:d.onlineResources[g].name,type:d.onlineResources[g].type,description:d.onlineResources[g].description,url:d.onlineResources[g].url}));if(e=this._findCSWRecordsByOnlineResources(e))f=
this.layerFactory.generateLayerFromCSWRecord(e),e.set("layer",f),this._configureLayer(f,d.filter,d.visible),b.push(f),d.customlayer&&(e.set("customlayer",!0),d=Ext.getCmp("auscope-tabs-panel"),g=d.getComponent("org-auscope-custom-record-panel"),d.setActiveTab(g),g.getStore().insert(0,e))}else"search"===d.source&&(this._configureLayer(d,d.filter,d.visible),b.push(f))}return b}});
Ext.define("portal.layer.renderer.wms.DisjunctionLayerRenderer",{extend:"portal.layer.renderer.Renderer",constructor:function(a){this.legend=Ext.create("portal.layer.legend.wms.WMSLegend",{iconUrl:a.iconCfg?a.iconCfg.url:"portal-core/img/key.png"});this.callParent(arguments)},displayData:function(a,b,c){this.removeData();var d=portal.csw.OnlineResource.getFilteredFromArray(a,portal.csw.OnlineResource.WMS),e=b.getParameter("serviceFilter");a=b.getParameter("name");c=b.getParameter("opacity");this.renderStatus.initialiseResponses([e],
"Loading...");for(var f=[],g=0;g<d.length;g++){var h=d[g].get("name");h===a&&(h=this.map.makeWms(void 0,void 0,d[g],this.parentLayer,e,h,c),h.getWmsLayer().events.register("loadstart",this,function(){this.currentRequestCount++;this.renderStatus.getParameters();this.fireEvent("renderstarted",this,d,b);this.renderStatus.updateResponse(e,"Loading WMS")}),h.getWmsLayer().events.register("loadend",this,function(a){this.currentRequestCount--;this.renderStatus.getParameters();this.renderStatus.updateResponse(e,
"WMS Loaded");this.fireEvent("renderfinished",this)}),f.push(h))}this.primitiveManager.addPrimitives(f);this.hasData=!0},getLegend:function(a,b){return this.legend},removeData:function(){this.primitiveManager.clearPrimitives()},abortDisplay:Ext.emptyFn});Ext.define("portal.layer.downloader.Downloader",{extend:"Ext.util.Observable",requires:["portal.util.UnimplementedFunction"],map:null,constructor:function(a){this.map=a.map;this.callParent(arguments)},downloadData:portal.util.UnimplementedFunction});
Ext.define("portal.layer.downloader.DownloaderFactory",{map:null,constructor:function(a){this.map=a.map;this.callParent(arguments)},buildFromKnownLayer:portal.util.UnimplementedFunction,buildFromCswRecord:portal.util.UnimplementedFunction});Ext.define("portal.layer.filterer.forms.EmptyFilterForm",{extend:"portal.layer.filterer.BaseFilterForm",constructor:function(a){Ext.apply(a,{html:'\x3cp class\x3d"centeredlabel"\x3e Filter options will be shown here for special services.\x3c/p\x3e'});this.callParent(arguments)}});
Ext.define("portal.widgets.window.ErrorWindow",{extend:"Ext.window.Window",statics:{showText:function(a,b,c){Ext.create("portal.widgets.window.ErrorWindow",{title:a,message:b,info:c}).show()},show:function(a){Ext.create("portal.widgets.window.ErrorWindow",{errorObj:a}).show()}},constructor:function(a){var b=a.errorObj,c=b?b.title:a.title,d=b?b.message:a.message,b=b?b.info:a.info,e=this;c&&c.length||(c="Error");Ext.apply(a,{title:c,layout:"anchor",defaults:{anchor:"100%"},modal:!0,resizable:!1,width:400,
buttonAlign:"center",items:[{xtype:"container",autoScroll:!0,border:!1,height:50,html:Ext.htmlEncode(d)}],buttons:[{text:"OK",handler:function(){e.destroy()}}],listeners:{afterrender:{single:!0,buffer:10,fn:function(){}}}});b&&a.items.push({xtype:"panel",title:"Details",collapsible:!0,collapsed:!1,titleCollapse:!0,layout:"fit",listeners:{collapse:function(){e.doLayout()},expand:function(){e.doLayout()}},items:{xtype:"container",height:50,html:b}});this.callParent(arguments)}});
Ext.define("portal.layer.renderer.wfs.FeatureDownloadManager",{extend:"Ext.util.Observable",proxyFetchUrl:null,proxyCountUrl:null,visibleMapBounds:null,featureSetSizeThreshold:200,timeout:12E5,filterParams:{},currentRequest:null,constructor:function(a){this.proxyFetchUrl=a.proxyFetchUrl;this.proxyCountUrl=a.proxyCountUrl;a.featureSetSizeThreshold&&(this.featureSetSizeThreshold=a.featureSetSizeThreshold);a.filterParams&&(this.filterParams=a.filterParams);this.visibleMapBounds=a.visibleMapBounds;a.timeout&&
(this.timeout=a.timeout);this.listeners=a.listeners;this.callParent(arguments)},_buildRequestParams:function(a,b){var c={};Ext.apply(c,this.filterParams);a&&(c.bbox=Ext.JSON.encode(a));c.maxFeatures=b?b:0;return c},_doDownload:function(a,b){var c=this._buildRequestParams(a,b);this.currentRequest=portal.util.Ajax.request({url:this.proxyFetchUrl,params:c,callback:function(a,b,f,g){a?this.fireEvent("success",this,c,b,g):this.fireEvent("error",this,f,g)},timeout:this.timeout,scope:this})},_doCount:function(a,
b,c,d){if(a)if(b>this.featureSetSizeThreshold){var e=this;Ext.create("Ext.window.Window",{width:600,height:150,closable:!1,modal:!0,title:"Warning: Large feature set",layout:"fit",items:[{xtype:"component",autoEl:{tag:"span",html:Ext.util.Format.format("\x3cp\x3eYou are about to display \x3cb\x3e{0}\x3c/b\x3e features, doing so could make the portal run extremely slowly. Would you still like to continue?\x3c/p\x3e\x3cbr/\x3e\x3cp\x3eAlternatively you can abort this operation, adjust your zoom/filter and then try again.\x3c/p\x3e",
b)},cls:"ext-mb-text"}],dockedItems:[{xtype:"toolbar",dock:"bottom",ui:"footer",layout:{type:"hbox",pack:"center"},items:[{xtype:"button",text:Ext.util.Format.format("Display {0} features",b),handler:function(a){e._doDownload(e._visibleMapBounds);a.ownerCt.ownerCt.close()}},{xtype:"button",text:"Abort operation",handler:function(a){e.fireEvent("cancelled",e);a.ownerCt.ownerCt.close()}}]}]}).show()}else this._doDownload(this.visibleMapBounds);else this.fireEvent("error",this,c,d)},startDownload:function(){this.proxyCountUrl&&
0<this.proxyCountUrl.length?this.currentRequest=portal.util.Ajax.request({url:this.proxyCountUrl,params:this._buildRequestParams(this.visibleMapBounds),scope:this,timeout:this.timeout,callback:this._doCount}):this._doDownload(this.visibleMapBounds,this.featureSetSizeThreshold)},abortDownload:function(){this.currentRequest&&Ext.Ajax.abort(this.currentRequest)}});
Ext.define("portal.layer.renderer.wfs.FeatureRenderer",{extend:"portal.layer.renderer.Renderer",config:{icon:null},legend:null,allDownloadManagers:null,constructor:function(a){this.currentRequestCount=0;this.legend=Ext.create("portal.layer.legend.wfs.WFSLegend",{iconUrl:a.icon?a.icon.getUrl():""});this.allDownloadManagers=[];this.callParent(arguments)},_finishDownloadManagerResponse:function(a){a&&(this.hasData=0<a.length);this.currentRequestCount--;0===this.currentRequestCount&&this.fireEvent("renderfinished",
this)},_handleDownloadManagerError:function(a,b,c,d,e){this.renderStatus.updateResponse(d.get("url"),b);c?this.renderDebuggerData.updateResponse(d.get("url"),b+c.info):this.renderDebuggerData.updateResponse(d.get("url"),b);this._finishDownloadManagerResponse()},_handleDownloadManagerCancelled:function(a,b,c){this.renderStatus.updateResponse(b.get("url"),"Request cancelled by user.");this._finishDownloadManagerResponse()},_handleDownloadManagerSuccess:function(a,b,c,d,e,f,g){a=Ext.create("portal.layer.renderer.wfs.GMLParser",
{gml:c.gml,map:this.map});f=a.makePrimitives(g,e,f);g=a.getFeatureCount();this.primitiveManager.addPrimitives(f);d&&this.renderDebuggerData.updateResponse(d.url,d.info);this.renderStatus.updateResponse(e.get("url"),null==g?"Unknown number of features retrieved.":g+" feature(s) retrieved.");this._finishDownloadManagerResponse(f)},displayData:function(a,b,c){this.abortDisplay();this.removeData();a=portal.csw.OnlineResource.getFilteredFromArray(a,portal.csw.OnlineResource.WFS);var d=[];for(c=0;c<a.length;c++)d.push(a[c].get("url"));
this.renderStatus.initialiseResponses(d,"Loading...");this.fireEvent("renderstarted",this,a,b);this.currentRequestCount=a.length;for(c=0;c<a.length;c++){var d=b.getParameters(),e=a[c];d.serviceUrl=e.data.url;d.typeName=e.data.name;d.maxFeatures=200;d=Ext.create("portal.layer.renderer.wfs.FeatureDownloadManager",{visibleMapBounds:b.getSpatialParam(),proxyFetchUrl:this.proxyUrl,proxyCountUrl:this.proxyCountUrl,filterParams:d,listeners:{success:Ext.bind(this._handleDownloadManagerSuccess,this,[e,this.parentLayer,
this.icon],4),error:Ext.bind(this._handleDownloadManagerError,this,[e,this.parentLayer],3),cancelled:Ext.bind(this._handleDownloadManagerCancelled,this,[e,this.parentLayer],1)}});d.startDownload();this.allDownloadManagers.push(d)}},getLegend:function(a,b){return this.legend},removeData:function(){this.primitiveManager.clearPrimitives()},abortDisplay:function(){for(var a=0;a<this.allDownloadManagers.length;a++)this.allDownloadManagers[a].abortDownload()}});
Ext.define("portal.layer.querier.wfs.FeatureSource",{getFeature:portal.util.UnimplementedFunction});Ext.ns("portal.map.openlayers");
portal.map.openlayers.FeatureWithLocationHandler=OpenLayers.Class(OpenLayers.Handler.Feature,{lastHandledEvent:null,mouseDragFlag:!1,downX:0,downY:0,handle:function(a){var b=OpenLayers.Handler.Feature.prototype.handle.apply(this,arguments);if(!b){var c=a.type;if("click"===c&&!this.mouseDragFlag)b=!0,this.callback("click",[null,a]);else if("mousedown"===c)this.downX=a.xy.x,this.downY=a.xy.y,this.mouseDragFlag=!0;else if("mouseup"===c&&null!=this.lastHandledEvent&&"mousedown"==this.lastHandledEvent.type){var c=
Math.abs(a.xy.x-this.downX),d=Math.abs(a.xy.y-this.downY);5>c&&5>d&&(this.mouseDragFlag=!1)}}this.lastHandledEvent=a;return b},triggerCallback:function(a,b,c){c.push(this.lastHandledEvent);return OpenLayers.Handler.Feature.prototype.triggerCallback.apply(this,arguments)}});
Ext.define("portal.layer.renderer.wfs.FeatureWithMapRenderer",{extend:"portal.layer.renderer.Renderer",config:{icon:null},legend:null,allDownloadManagers:null,sld_body:null,constructor:function(a){this.currentRequestCount=0;!0===a.icon.getIsDefault()?this.legend=Ext.create("portal.layer.legend.wms.WMSLegend",{iconUrl:a.iconCfg?a.iconCfg.url:"portal-core/img/key.png"}):this.legend=Ext.create("portal.layer.legend.wfs.WFSLegend",{iconUrl:a.icon?a.icon.getUrl():""});this.allDownloadManagers=[];this.currentRequestCount=
0;this.callParent(arguments);this.on("renderfinished",this._cleanupAbort,this)},_finishDownloadManagerResponse:function(a){a&&(this.hasData=0<a.length);this.currentRequestCount--;0===this.currentRequestCount&&this.fireEvent("renderfinished",this)},_handleDownloadManagerError:function(a,b,c,d,e){this.renderStatus.updateResponse(d.get("url"),b);c?this.renderDebuggerData.updateResponse(d.get("url"),b+c.info):this.renderDebuggerData.updateResponse(d.get("url"),b);this._finishDownloadManagerResponse()},
_handleDownloadManagerCancelled:function(a,b,c){this.renderStatus.updateResponse(b.get("url"),"Request cancelled by user.");this._finishDownloadManagerResponse()},_handleDownloadManagerSuccess:function(a,b,c,d,e,f,g){a=Ext.create("portal.layer.renderer.wfs.GMLParser",{gml:c.gml,map:this.map});f=a.makePrimitives(g,e,f);g=a.getFeatureCount();this.primitiveManager.addPrimitives(f);d&&this.renderDebuggerData.updateResponse(d.url,d.info);this.renderStatus.updateResponse(e.get("url"),null==g?"Unknown number of features retrieved.":
g+" feature(s) retrieved.");this._finishDownloadManagerResponse(f)},displayData:function(a,b,c){this.abortDisplay();this.removeData();this.aborted=!1;c=portal.csw.OnlineResource.getFilteredFromArray(a,portal.csw.OnlineResource.WFS);var d=portal.csw.OnlineResource.getFilteredFromArray(a,portal.csw.OnlineResource.WMS),e=[];a=[];var f=portal.util.URL.base;-1!=f.indexOf("localhost")&&(f=f.replace("localhost",LOCALHOST));for(f=0;f<d.length;f++){for(var g=d[f].get("url"),h=d[f].get("name"),k=b.getParameter("opacity"),
l=0;l<c.length;l++){var m=this._getDomain(c[l].get("url")),n=this._getDomain(g);m==n&&(serviceUrl=c[l].get("url"))}b.getParameters().serviceFilter&&this._getDomain(d[f].get("url"))!=this._getDomain(b.getParameters().serviceFilter[0])||(n=portal.map.Icon.mapIconColor(this.parentLayer.get("source").get("iconUrl")),m=this.parentLayer.get("source").get("proxyStyleUrl"),l=Ext.Object.toQueryString(b.getMercatorCompatibleParameters()),"undefined"!=typeof n&&(l+="\x26color\x3d"+escape(n)),l+="\x26serviceUrl\x3d"+
escape(serviceUrl),n="",m?(n=Ext.urlAppend(m,l),n=Ext.urlAppend(n,"layerName\x3d"+h)):n=Ext.urlAppend("getDefaultStyle.do","layerName\x3d"+h),a[this._getDomain(g)]=1,Ext.Ajax.request({url:n,timeout:18E4,scope:this,success:Ext.bind(this._getRenderLayer,this,[d[f],g,h,k,c,b],!0),failure:function(a,b){0>=this.currentRequestCount&&this.fireEvent("renderfinished",this);console.log("server-side failure with status code "+a.status)}}))}this.hasData=!0;h=[];for(f=0;f<c.length;f++)d=c[f].get("url"),g=c[f].get("name"),
e.push(d),a[this._getDomain(d)]&&(h.push(d),this.renderStatus.updateResponse(d,"Loading WMS"));this.renderStatus.initialiseResponses(e,"Loading...");this.fireEvent("renderstarted",this,c,b);for(f=0;f<c.length;f++)d=c[f].get("url"),g=c[f].get("name"),a[this._getDomain(d)]||(this.currentRequestCount++,l=b.getParameters(),e=c[f],l.serviceUrl=d,l.typeName=g,l.maxFeatures=200,b.getParameters().serviceFilter&&l.serviceUrl!=b.getParameters().serviceFilter[0]?(this.currentRequestCount--,this.renderStatus.updateResponse(l.serviceUrl,
"Not Queried")):(e=Ext.create("portal.layer.renderer.wfs.FeatureDownloadManager",{visibleMapBounds:b.getSpatialParam(),proxyFetchUrl:this.proxyUrl,proxyCountUrl:this.proxyCountUrl,filterParams:l,listeners:{success:Ext.bind(this._handleDownloadManagerSuccess,this,[e,this.parentLayer,this.icon],4),error:Ext.bind(this._handleDownloadManagerError,this,[e,this.parentLayer],3),cancelled:Ext.bind(this._handleDownloadManagerCancelled,this,[e,this.parentLayer],1)}}),e.startDownload(),this.allDownloadManagers.push(e)));
0===this.currentRequestCount&&this.fireEvent("renderfinished",this)},_getRenderLayer:function(a,b,c,d,e,f,g,h){this.aborted||(void 0===f&&(f=h.parameters.opacity),this.sld_body=a=a.responseText,0!=a.indexOf("\x3c?xml version\x3d")?this._updateStatusforWFSWMS(d,"error: invalid SLD response"):(this._updateStatusforWFSWMS(d,"Testing Connection"),this.fireEvent("renderstarted",this,g,h),this.currentRequestCount++,Ext.Ajax.request({url:"testServiceGetCap.do",timeout:18E4,params:{serviceUrl:d},scope:this,
success:Ext.bind(this._addWMSLayer,this,[c,d,e,f,g,h,a],!0),failure:function(a,b){this.currentRequestCount--;this._updateStatusforWFSWMS(d,"Address cannot be reached");0===this.currentRequestCount&&this.fireEvent("renderfinished",this)}})))},_addWMSLayer:function(a,b,c,d,e,f,g,h,k){this.currentRequestCount--;if(!this.aborted){var l=this.map.makeWms(void 0,void 0,c,this.parentLayer,d,e,f,k);l.getWmsLayer().events.register("loadstart",this,function(){this.currentRequestCount++;var a=this.renderStatus.getParameters();
for(key in a)if(this._getDomain(key)==this._getDomain(l.getWmsUrl())){this.renderStatus.updateResponse(key,"Loading WMS");this.fireEvent("renderstarted",this,g,h);break}});l.getWmsLayer().events.register("loadend",this,function(a){this.currentRequestCount--;0===this.currentRequestCount&&this.fireEvent("renderfinished",this);this.renderStatus.getParameters();this._updateStatusforWFSWMS(l.getWmsUrl(),"WMS Loaded")});a=[];a.push(l);this.primitiveManager.addPrimitives(a)}},_updateStatusforWFSWMS:function(a,
b){for(key in this.renderStatus.getParameters())if(this._getDomain(key)==this._getDomain(a)){this.renderStatus.updateResponse(key,b);break}},_getDomain:function(a){return portal.util.URL.extractHostNSubDir(a,1)},getLegend:function(a,b){return this.legend},removeData:function(){this.abortDisplay();this.primitiveManager.clearPrimitives();this.fireEvent("renderfinished",this)},abortDisplay:function(){this.aborted=!0;for(var a=0;a<this.allDownloadManagers.length;a++)this.allDownloadManagers[a].abortDownload()},
_cleanupAbort:function(){this.aborted=!1}});
Ext.define("portal.util.FileDownloader",{singleton:!0},function(){portal.util.FileDownloader.downloadFile=function(a,b,c){var d=[];"undefined"===typeof c&&(c="POST");"GET"==c&&Ext.apply(b,Ext.urlDecode(a.split("?")[1]));if(b)for(var e in b)if(e){var f=b[e];Ext.isArray(f)||(f=[f]);for(var g=0;g<f.length;g++)d.push({tag:"input",id:Ext.util.Format.format("portal-input-{0}-{1}",e,g),type:"hidden",name:e,value:f[g]})}e=Ext.id();f=Ext.getBody();f.createChild({tag:"iframe",id:e,name:"iframe"});c=f.createChild({tag:"form",
target:e,method:c,children:d});portal.util.GoogleAnalytic.trackevent("FileDownloader","Download",a);portal.util.PiwikAnalytic.trackevent("FileDownloader","Url:"+a,"parameters:"+Ext.encode(b));c.dom.action=a;c.dom.submit()}});
Ext.define("portal.layer.filterer.Filterer",{extend:"portal.util.ObservableMap",statics:{BBOX_FIELD:"bbox"},config:{spatialParam:null},constructor:function(a){this.callParent(arguments)},getParameters:function(){var a=this.callParent(arguments),b=this.getSpatialParam();b&&(a[portal.layer.filterer.Filterer.BBOX_FIELD]=Ext.JSON.encode(b));return a},getMercatorCompatibleParameters:function(){var a=this.getParameters(),b=this.getSpatialParam();b&&("EPSG:4326"==b.crs&&(b=new OpenLayers.Bounds(b.westBoundLongitude,
b.southBoundLatitude,b.eastBoundLongitude,b.northBoundLatitude),b=b.transform("EPSG:4326","EPSG:3857"),b=Ext.create("portal.util.BBox",{northBoundLatitude:b.top,southBoundLatitude:b.bottom,eastBoundLongitude:b.right,westBoundLongitude:b.left,crs:"EPSG:3857"})),a[portal.layer.filterer.Filterer.BBOX_FIELD]=Ext.JSON.encode(b));return a},applySpatialParam:function(a){if(!a||a instanceof portal.util.BBox)return a;Ext.isString(a)&&(a=Ext.JSON.decode(a));if(Ext.isObject(a))return Ext.create("portal.util.BBox",
a);throw"unable to parse value";},setParameters:function(a,b){var c=Ext.apply({},a),d=a.bbox;c[portal.layer.filterer.Filterer.BBOX_FIELD]=void 0;(portal.layer.filterer.Filterer.BBOX_FIELD in a||b)&&this.setSpatialParam(d,!0);this.callParent([c,b])},setParameter:function(a,b,c){a===portal.layer.filterer.Filterer.BBOX_FIELD?(this._setBboxField(b),this.fireEvent("change",this,[a])):this.callParent(arguments)},getParameter:function(a){if(a===portal.layer.filterer.Filterer.BBOX_FIELD){if(this.bbox)return Ext.JSON.encode(this.getSpatialParam())}else return this.callParent(arguments)},
setSpatialParam:function(a,b){this.spatialParam=this.applySpatialParam(a);b||this.fireEvent("change",this,[portal.layer.filterer.Filterer.BBOX_FIELD])},getSpatialParam:function(){return this.spatialParam},clone:function(){var a=Ext.create("portal.layer.filterer.Filterer",{}),b=this.getSpatialParam();Ext.apply(a.parameters,this.parameters);a.setSpatialParam(b?b.clone():b,!0);return a}});
Ext.define("portal.widgets.panel.FilterPanel",{extend:"Ext.panel.Panel",_addOrUpdateLayerButton:null,filterForm:null,constraintShown:!1,nagiosAlertShown:!1,optionsButtonIsHidden:!1,layerStore:null,menuFactory:null,constructor:function(a){this._map=a.map;this.layerStore=a.layerStore;var b=a.menuItems?a.menuItems:[this._getResetFormAction(),this._getDeleteAction(),this._setVisibilityAction()];Ext.isIE?(this.filterForm=a.filterForm.cloneConfig(),this.filterForm.getForm().setValues(a.filterForm.getForm().getValues()),
a.filterForm=this.filterForm,a.filterForm.layer.set("filterForm",this.filterForm)):this.filterForm=a.filterForm;"undefined"===typeof a.wantAddLayerButton||a.wantAddLayerButton?this._addOrUpdateLayerButton=Ext.create("Ext.button.Button",{xtype:"button",text:"Add layer to Map",iconCls:"add",handler:Ext.bind(this._onAddLayer,this)}):a.wantUpdateLayerButton&&(this._addOrUpdateLayerButton=Ext.create("Ext.button.Button",{xtype:"button",text:"Update Layer on Map",iconCls:"edit",handler:Ext.bind(this._onAddLayer,
this)}));this.optionsButtonIsHidden="undefined"===typeof a.wantOptionsButton||a.wantOptionsButton?!1:!0;if(a.menuFactory){var c=this.menuFactory=a.menuFactory;c.addResetFormActionForWMS&&b.push(this._getResetFormAction());c.appendAdditionalActions(b,this.filterForm.layer,this.filterForm.layer.get("source").get("group"),this._map)}a.menuItems&&this.filterForm.layer.get("renderer").getLegend()&&b.push(this._getLegendAction(this.filterForm.layer));a.menuFactory||0<this.filterForm.layer.get("cswRecords").length&&
0==this.filterForm.layer.get("cswRecords")[0].get("noCache")&&b.push(this._getDownloadAction());c=Ext.create("Ext.button.Button",{xtype:"button",text:"Options",iconCls:"setting",arrowAlign:"right"});0===b.length?this.optionsButtonIsHidden=!0:1===b.length?c=Ext.create("Ext.button.Button",b[0]):c.setMenu(b);c.setHidden(this.optionsButtonIsHidden);Ext.apply(a,{items:[this.filterForm],buttons:[this._addOrUpdateLayerButton,{xtype:"tbfill"},c]});this.callParent(arguments)},_getResetFormAction:function(){var a=
this.filterForm;return new Ext.Action({text:"Reset Form",iconCls:"refresh",handler:function(){a.getForm().reset()}})},_getLegendAction:function(a){var b=a.get("renderer").getLegend(),c=this;return new Ext.Action({text:"Get Legend",icon:b.iconUrl,iconCls:"portal-ux-menu-icon-size",itemId:"LegendAction",handler:function(){var b=function(a,b,c,d,e,f){if(d&&e)return a="legend-"+f.get("id"),Ext.getCmp(a)&&Ext.getCmp(a).close(),Ext.create("Ext.window.Window",{id:a,title:"Legend: "+f.get("name"),layout:"fit",
width:200,height:300,modal:!0,items:e}).show()},e=a.getAllOnlineResources(),f=a.get("filterer"),g=a.get("renderer").getLegend(e,f),h=a.get("renderer").parentLayer.get("source").get("proxyStyleUrl");h&&0<h.length?(h=c.menuFactory.appendAdditionalLegendParams(a,f,h),!1===h.isSld_body?g.getLegendComponent(e,f,h.sldUrl,!1,Ext.bind(b,this,[a],!0)):Ext.Ajax.request({url:h.sldUrl,timeout:18E4,scope:this,success:function(c,h){g.getLegendComponent(e,f,c.responseText,!0,Ext.bind(b,this,[a],!0))},failure:function(c,
h){g.getLegendComponent(e,f,"",!0,Ext.bind(b,this,[a],!0))}})):g.getLegendComponent(e,f,"",!0,Ext.bind(b,this,[a],!0))}})},_getDownloadAction:function(){var a=this;return new Ext.Action({text:"Download Layer",iconCls:"download",handler:function(){var b=a.filterForm.layer,c=b.get("downloader");b.get("renderer");if(c){var d=b.get("filterer").clone(),e=Ext.create("portal.layer.filterer.Filterer",{}),f=b.get("filterForm");e.setSpatialParam(a._map.getVisibleMapBounds(),!0);f.writeToFilterer(e);f=b.getAllOnlineResources();
c.downloadData(b,f,d,e)}}})},_getDeleteAction:function(){var a=this;return new Ext.Action({text:"Remove Layer",iconCls:"trash",handler:function(){var b=a.filterForm.layer;ActiveLayerManager.removeLayer(b);a.menuFactory.layerRemoveHandler(b)}})},_setVisibilityAction:function(){var a=this;return new Ext.Action({text:"Toggle Layer Visibility OFF",iconCls:"visible_eye",handler:function(){var b=a.filterForm.layer;b.setLayerVisibility(!b.visible);b.visible?this.setText("Toggle Layer Visibility OFF"):this.setText("Toggle Layer Visibility ON")}})},
_onAddLayer:function(){var a=this.filterForm.layer,b=a.get("filterer");try{b.setSpatialParam(this._map.getVisibleMapBounds(),!0),this.filterForm.writeToFilterer(b)}catch(c){console.log(c)}ActiveLayerManager.addLayer(a);this._showConstraintWindow(a);this._showNagiosAlerts(a);this.menuFactory.layerAddHandler(a);portal.util.GoogleAnalytic.trackevent("Add:"+a.get("sourceType"),"Layer:"+a.get("name"),"Filter:"+Ext.encode(b.getParameters()))},_showNagiosAlerts:function(a){if(!this.nagiosAlertShown){if(a.get("sourceType")===
portal.layer.Layer.KNOWN_LAYER&&a.get("source").containsNagiosFailures()){a=a.get("source").get("nagiosFailingHosts");var b="Please be aware that some of the services underpinning this layer have recently been reported as being unstable. The unstable hosts will be not be queried. The hosts reported to be experiencing problems are:\x3cbr\x3e\x3cul\x3e";Ext.each(a,function(a){b+="\x3cli\x3e\x3cb\x3e"+a+"\x3c/b\x3e\x3c/li\x3e"});b+="\x3c/ul\x3e";Ext.MessageBox.show({title:"Service Problems",message:b,
icon:Ext.Msg.WARNING})}this.nagiosAlertShown=!0}},_showConstraintWindow:function(a){if(!this.constraintShown){a=a.get("cswRecords");for(var b=0;b<a.length;b++)if(a[b].hasConstraints()){var c=Ext.create("portal.widgets.window.CSWRecordConstraintsWindow",{width:625,cswRecords:a});c.show();(new Ext.util.DelayedTask(function(){c.doLayout()})).delay(1E3);break}this.constraintShown=!0}},_onResetFilter:function(){this.getLayout().getActiveItem().getForm().reset()},clearFilter:function(){var a=this.getLayout(),
b=a.getActiveItem();b&&b.close();a.setActiveItem(this._emptyCard)}});Ext.define("portal.widgets.FilterPanelMenuFactory",{extend:"Ext.util.Observable",constructor:function(a){this.callParent(arguments)},appendAdditionalActions:portal.util.UnimplementedFunction,appendAdditionalLegendParams:portal.util.UnimplementedFunction});
Ext.define("portal.layer.filterer.FormFactory",{extend:"Ext.util.Observable",map:null,constructor:function(a){this.map=a.map;this.callParent(arguments)},_generateResult:function(a,b){return{form:a,supportsFiltering:b}},getFilterForm:portal.util.UnimplementedFunction});
function GmapSubsetControl(a){this.globals={buttonStyle:{width:"80px",border:"1px solid black",padding:"1px",borderWidth:"1px",fontFamily:"Arial,sans-serif",fontSize:"12px",textAlign:"center",background:"#A0D4FF"},buttonSubsetStyle:{background:"#FF0"},buttonHtml:"Select Data",buttonId:"gmap-subset-control",buttonSubsetHtml:"Click and drag a region of interest",boxStyle:{outlineWidth:2,opacity:.2,fillColor:"#000",border:"2px solid blue",outlineColor:"blue",alphaIE:"alpha(opacity\x3d20)"},minDragSize:0,
overlayRemoveTime:6E3,dragEndCallback:a}}GmapSubsetControl.prototype=new GControl;GmapSubsetControl.prototype.setButtonMode_=function(a){var b=this.globals;"subset"==a?(b.buttonDiv.innerHTML=b.buttonSubsetHtml,GmapSubsetUtil.style([b.buttonDiv],b.buttonStyle),GmapSubsetUtil.style([b.buttonDiv],b.buttonSubsetStyle)):(b.buttonDiv.innerHTML=b.buttonHtml,GmapSubsetUtil.style([b.buttonDiv],b.buttonStyle))};
GmapSubsetControl.prototype.initButton_=function(a){var b=this.globals,c=document.createElement("div");c.innerHTML=b.buttonHtml;c.id=b.buttonId;GmapSubsetUtil.style([c],{cursor:"pointer",zIndex:200});GmapSubsetUtil.style([c],b.buttonStyle);a.appendChild(c);return c};
GmapSubsetControl.prototype.initialize=function(a){var b=this.globals,c=this,d=a.getContainer(),e=document.createElement("div");GmapSubsetUtil.style([e],{cursor:"pointer",zIndex:150});var f=this.initButton_(e);d.appendChild(e);for(var g=document.createElement("div"),h=["outlineDiv","cornerTopDiv","cornerLeftDiv","cornerRightDiv","cornerBottomDiv"],k=0;k<h.length;k++){var l=h[k],m=document.createElement("div");GmapSubsetUtil.style([m],{position:"absolute",display:"none"});g.appendChild(m);b[l]=m}GmapSubsetUtil.style([g],
{position:"absolute",display:"none",overflow:"hidden",cursor:"crosshair",zIndex:101});d.appendChild(g);GEvent.addDomListener(f,"click",function(a){c.buttonclick_(a)});GEvent.addDomListener(g,"mousedown",function(a){c.coverMousedown_(a)});GEvent.addDomListener(document,"mousemove",function(a){c.drag_(a)});GEvent.addDomListener(document,"mouseup",function(a){c.mouseup_(a)});b.mapPosition=GmapSubsetUtil.getElementPosition(d);b.buttonDiv=f;b.mapCover=g;b.map=a;b.borderCorrection=2*b.boxStyle.outlineWidth;
this.setDimensions_();this.initStyles_();b.mapCover.onselectstart=function(){return!1};return e};GmapSubsetControl.prototype.getDefaultPosition=function(){return new GControlPosition(G_ANCHOR_TOP_LEFT,new GSize(3,120))};
GmapSubsetControl.prototype.coverMousedown_=function(a){var b=this.globals;a=this.getRelPos_(a);b.startX=a.left;b.startY=a.top;GmapSubsetUtil.style([b.mapCover],{background:"transparent",opacity:1,filter:"alpha(opacity\x3d100)"});GmapSubsetUtil.style([b.outlineDiv],{left:b.startX+"px",top:b.startY+"px",display:"block",width:"1px",height:"1px"});b.draggingOn=!0;b.cornerTopDiv.style.top=b.startY-b.mapHeight+"px";b.cornerTopDiv.style.display="block";b.cornerLeftDiv.style.left=b.startX-b.mapWidth+"px";
b.cornerLeftDiv.style.top=b.startY+"px";b.cornerLeftDiv.style.display="block";b.cornerRightDiv.style.left=b.startX+"px";b.cornerRightDiv.style.top=b.startY+"px";b.cornerRightDiv.style.display="block";b.cornerBottomDiv.style.left=b.startX+"px";b.cornerBottomDiv.style.top=b.startY+"px";b.cornerBottomDiv.style.width="0px";b.cornerBottomDiv.style.display="block";return!1};
GmapSubsetControl.prototype.drag_=function(a){var b=this.globals;if(b.draggingOn)return a=this.getRelPos_(a),a=this.getRectangle_(b.startX,b.startY,a,b.mapRatio),addX=a.left?-a.width:0,addY=a.top?-a.height:0,GmapSubsetUtil.style([b.outlineDiv],{left:b.startX+addX+"px",top:b.startY+addY+"px",display:"block",width:"1px",height:"1px"}),b.outlineDiv.style.width=a.width+"px",b.outlineDiv.style.height=a.height+"px",b.cornerTopDiv.style.height=b.startY+addY-(b.startY-b.mapHeight)+"px",b.cornerLeftDiv.style.top=
b.startY+addY+"px",b.cornerLeftDiv.style.width=b.startX+addX-(b.startX-b.mapWidth)+"px",b.cornerRightDiv.style.top=b.cornerLeftDiv.style.top,b.cornerRightDiv.style.left=b.startX+addX+a.width+b.borderCorrection+"px",b.cornerBottomDiv.style.top=b.startY+addY+a.height+b.borderCorrection+"px",b.cornerBottomDiv.style.left=b.startX-b.mapWidth+(b.startX+addX-(b.startX-b.mapWidth))+"px",b.cornerBottomDiv.style.width=a.width+b.borderCorrection+"px",!1};
GmapSubsetControl.prototype.mouseup_=function(a){var b=this.globals;if(b.draggingOn){a=this.getRelPos_(a);b.draggingOn=!1;var c=this.getRectangle_(b.startX,b.startY,a,b.mapRatio);c.left&&(c.endX=c.startX-c.width);c.top&&(c.endY=c.startY-c.height);this.resetDragZoom_();if(c.width>=b.minDragSize&&c.height>=b.minDragSize){a=new GPoint(c.startX,c.startY);var d=new GPoint(c.endX,c.startY),e=new GPoint(c.endX,c.endY),c=new GPoint(c.startX,c.endY),f=b.map.fromContainerPixelToLatLng(a),g=b.map.fromContainerPixelToLatLng(d),
h=b.map.fromContainerPixelToLatLng(e),k=b.map.fromContainerPixelToLatLng(c),l=new GPolyline([f,g,h,k,f],b.boxStyle.outlineColor,b.boxStyle.outlineWidth+1,.4);try{b.map.addOverlay(l),setTimeout(function(){b.map.removeOverlay(l)},b.overlayRemoveTime)}catch(m){}f=l.getBounds();g=f.getNorthEast();k=f.getSouthWest();h=new GLatLng(k.lat(),g.lng());f=new GLatLng(g.lat(),k.lng());b.dragEndCallback&&b.dragEndCallback(f,g,h,k,a,d,e,c)}}};
GmapSubsetControl.prototype.setDimensions_=function(){var a=this.globals,b=a.map.getSize();a.mapWidth=b.width;a.mapHeight=b.height;a.mapRatio=a.mapHeight/a.mapWidth;GmapSubsetUtil.style([a.mapCover,a.cornerTopDiv,a.cornerRightDiv,a.cornerBottomDiv,a.cornerLeftDiv],{top:"0px",left:"0px",width:a.mapWidth+"px",height:a.mapHeight+"px"})};
GmapSubsetControl.prototype.initStyles_=function(){var a=this.globals;GmapSubsetUtil.style([a.mapCover,a.cornerTopDiv,a.cornerRightDiv,a.cornerBottomDiv,a.cornerLeftDiv],{filter:a.boxStyle.alphaIE,opacity:a.boxStyle.opacity,background:a.boxStyle.fillColor});a.outlineDiv.style.border=a.boxStyle.border};GmapSubsetControl.prototype.buttonclick_=function(){"block"==this.globals.mapCover.style.display?this.resetDragZoom_():this.initCover_()};
GmapSubsetControl.prototype.initCover_=function(){var a=this.globals;a.mapPosition=GmapSubsetUtil.getElementPosition(a.map.getContainer());this.setDimensions_();this.setButtonMode_("subset");GmapSubsetUtil.style([a.mapCover],{display:"block",background:a.boxStyle.fillColor});GmapSubsetUtil.style([a.outlineDiv],{width:"0px",height:"0px"})};GmapSubsetControl.prototype.getRelPos_=function(a){a=GmapSubsetUtil.getMousePosition(a);var b=this.globals;return{top:a.top-b.mapPosition.top,left:a.left-b.mapPosition.left}};
GmapSubsetControl.prototype.getRectangle_=function(a,b,c,d){a={startX:Math.min(a,c.left),startY:Math.min(b,c.top),endX:Math.max(a,c.left),endY:Math.max(b,c.top),left:!1,top:!1};a.width=a.endX-a.startX;a.height=a.endY-a.startY;return a};
GmapSubsetControl.prototype.resetDragZoom_=function(){var a=this.globals;GmapSubsetUtil.style([a.mapCover,a.cornerTopDiv,a.cornerRightDiv,a.cornerBottomDiv,a.cornerLeftDiv],{display:"none",opacity:a.boxStyle.opacity,filter:a.boxStyle.alphaIE});a.outlineDiv.style.display="none";this.setButtonMode_("normal")};
var GmapSubsetUtil={gE:function(a){return document.getElementById(a)},getMousePosition:function(a){var b=0,c=0;a||(a=window.event);if(a.pageX||a.pageY)b=a.pageX,c=a.pageY;else if(a.clientX||a.clientY)b=a.clientX+(document.documentElement.scrollLeft?document.documentElement.scrollLeft:document.body.scrollLeft),c=a.clientY+(document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop);return{left:b,top:c}},getElementPosition:function(a){var b=a.offsetLeft,c=a.offsetTop;
for(a=a.offsetParent;null!=a;)b+=a.offsetLeft,c+=a.offsetTop,a=a.offsetParent;return{left:b,top:c}},style:function(a,b){"string"==typeof a&&(a=GmapSubsetUtil.getManyElements(a));for(var c=0;c<a.length;c++)for(var d in b)a[c].style[d]=b[d]},getManyElements:function(a){a=a.split(",");for(var b=[],c=0;c<a.length;c++)b[b.length]=GmapSubsetUtil.gE(a[c]);return b}};
Ext.define("portal.layer.renderer.wfs.GMLParser",{map:null,constructor:function(a){this.rootNode=portal.util.xml.SimpleDOM.parseStringToDOM(a.gml);this.map=a.map;this.callParent(arguments)},generateCoordList:function(a,b){for(var c=a.split(" "),d=[],e=0;e<c.length;e+=2)this.forceLonLat(c,b,e),d.push(Ext.create("portal.map.Point",{latitude:parseFloat(c[e+1]),longitude:parseFloat(c[e])}));return d},getSrsName:function(a){var b=a.getAttribute("srsName");Ext.isEmpty(b)&&(b=a.getAttribute("srs"));return b?
b:""},forceLonLat:function(a,b,c){c||(c=0);0==b.indexOf("http://www.opengis.net/gml/srs/epsg.xml#4283")||0==b.indexOf("urn:x-ogc:def:crs:EPSG")?(b=a[c],a[c]=a[c+1],a[c+1]=b):0==b.indexOf("EPSG")||b.indexOf("http://www.opengis.net/gml/srs/epsg.xml")},parseLineString:function(a,b,c,d,e){d=this.getSrsName(e);e=this.generateCoordList(portal.util.xml.SimpleDOM.getNodeTextContent(e.getElementsByTagNameNS("*","posList")[0]),d);return 0===e.length||2===e.length&&e[0].getLongitude()===e[1].getLongitude()&&
e[0].getLatitude()===e[1].getLatitude()?null:this.map.makePolyline(c,void 0,a,b,e,"#FF0000",3,1)},parsePolygon:function(a,b,c,d,e){d=this.getSrsName(e);e=this.generateCoordList(portal.util.xml.SimpleDOM.getNodeTextContent(e.getElementsByTagNameNS("*","posList")[0]),d);return 0===e.length||2===e.length&&e[0].getLongitude()===e[1].getLongitude()&&e[0].getLatitude()===e[1].getLatitude()?null:this.map.makePolygon(c,void 0,a,b,e,void 0,void 0,.7,void 0,.6)},parsePoint:function(a,b,c,d,e,f){var g=portal.util.xml.SimpleDOM.getNodeTextContent(f.getElementsByTagNameNS("*",
"pos")[0]).split(" ");if(!g||2>g.length)return null;f=this.getSrsName(f);this.forceLonLat(g,f);f=g[0];g=Ext.create("portal.map.Point",{latitude:parseFloat(g[1]),longitude:parseFloat(f)});return this.map.makeMarker(c,d,void 0,a,b,g,e)},getFeatureCount:function(){var a=portal.util.xml.SimpleDOM.getMatchingChildNodes(this.rootNode,null,"FeatureCollection");if(Ext.isEmpty(a))return null;a=parseInt(a[0].getAttribute("numberOfFeatures"));return Ext.isNumber(a)?a:null},makePrimitives:function(a,b,c){var d=
[],e=portal.util.xml.SimpleDOM.getMatchingChildNodes(this.rootNode,null,"FeatureCollection");if(Ext.isEmpty(e))return d;var f=portal.util.xml.SimpleDOM.getMatchingChildNodes(e[0],null,"featureMembers"),g=[];if(Ext.isEmpty(f))for(f=portal.util.xml.SimpleDOM.getMatchingChildNodes(e[0],null,"featureMember"),e=0;e<f.length;e++)g.push(f[e].firstElementChild);else g=f[0].childNodes;for(e=0;e<g.length;e++){var h=g[e],f=h.getAttribute("gml:id"),k=portal.util.xml.SimpleXPath.evaluateXPath(this.rootNode,h,
"gml:description",portal.util.xml.SimpleXPath.XPATH_STRING_TYPE).stringValue;Ext.isEmpty(k)&&(k=portal.util.xml.SimpleXPath.evaluateXPath(this.rootNode,h,"gml:name",portal.util.xml.SimpleXPath.XPATH_STRING_TYPE).stringValue,Ext.isEmpty(k)&&(k=f));for(var l=h.getElementsByTagNameNS("*","Point"),m=h.getElementsByTagNameNS("*","Polygon"),h=h.getElementsByTagNameNS("*","LineString"),n=0;n<m.length;n++)mapItem=this.parsePolygon(b,c,f,k,m[n]),null!==mapItem&&d.push(mapItem);for(n=0;n<l.length;n++)mapItem=
this.parsePoint(b,c,f,k,a,l[n]),null!==mapItem&&d.push(mapItem);for(n=0;n<h.length;n++)mapItem=this.parseLineString(b,c,f,k,h[n]),null!==mapItem&&d.push(mapItem)}return d}});Ext.define("portal.util.GoogleAnalytic",{singleton:!0},function(){portal.util.GoogleAnalytic.trackevent=function(a,b,c,d){"undefined"!=typeof _gaq&&(d?_gaq.push(["_trackEvent",a,b,c,d]):_gaq.push(["_trackEvent",a,b,c]))};portal.util.GoogleAnalytic.trackpage=function(a){"undefined"!=typeof _gaq&&_gaq.push(["_trackPageview",a])}});
Ext.define("portal.map.gmap.GoogleMap",{extend:"portal.map.BaseMap",constructor:function(a){this.callParent(arguments)},makeMarker:function(a,b,c,d,e,f,g){return Ext.create("portal.map.gmap.primitives.Marker",{id:a,tooltip:b,layer:e,onlineResource:d,cswRecord:c,point:f,icon:g})},makePolygon:function(a,b,c,d,e,f,g,h,k,l){return Ext.create("portal.map.gmap.primitives.Polygon",{id:a,layer:d,onlineResource:c,cswRecord:b,points:e,strokeColor:f,strokeWeight:g,strokeOpacity:h,fillColor:k,fillOpacity:l})},
makePolyline:function(a,b,c,d,e,f,g,h){return Ext.create("portal.map.gmap.primitives.Polyline",{id:a,layer:d,onlineResource:c,cswRecord:b,points:e,strokeColor:f,strokeWeight:g,strokeOpacity:h})},makeWms:function(a,b,c,d,e,f,g){return Ext.create("portal.map.gmap.primitives.WMSOverlay",{id:a,layer:d,onlineResource:c,cswRecord:b,wmsUrl:e,wmsLayer:f,opacity:g,map:this.map})},renderToContainer:function(a){if(!GBrowserIsCompatible())throw alert("Your browser isn't compatible with the Google Map API V2. This portal will not be functional as a result."),
"IncompatibleBrowser";this.container=a;this.map=new GMap2(this.container.body.dom);this.map.enableGoogleBar();this.map.setUIToDefault();this.map.addMapType(G_SATELLITE_3D_MAP);this.map.addControl(new GMapTypeControl);this.map.setCenter(new google.maps.LatLng(-26,133.3),4);this.map.setMapType(G_SATELLITE_MAP);var b=new GSize(150,150);this.map.addControl(new GOverviewMapControl(b));this.map.addControl(new DragZoomControl,new GControlPosition(G_ANCHOR_TOP_RIGHT,new GSize(345,7)));this.map.checkResize();
a.on("resize",this._onContainerResize,this);GEvent.addListener(this.map,"mousemove",Ext.bind(this._onMouseMove,this));GEvent.addListener(this.map,"mouseout",Ext.bind(this._onMouseOut,this));GEvent.addListener(this.map,"click",Ext.bind(this._onClick,this));this.highlightPrimitiveManager=this.makePrimitiveManager();this.allowDataSelection&&this.map.addControl(new GmapSubsetControl(Ext.bind(function(a,b,e,f){a=Ext.create("portal.util.BBox",{northBoundLatitude:a.lat(),southBoundLatitude:f.lat(),eastBoundLongitude:b.lng(),
westBoundLongitude:f.lng()});b=this.getLayersInBBox(a);this.fireEvent("dataSelect",this,a,b)},this)),new GControlPosition(G_ANCHOR_TOP_RIGHT,new GSize(405,7)));this.rendered=!0},getVisibleMapBounds:function(){var a=this.map.getBounds(),b=a.getSouthWest(),a=a.getNorthEast();return Ext.create("portal.util.BBox",{eastBoundLongitude:a.lng(),westBoundLongitude:b.lng(),southBoundLatitude:b.lat(),northBoundLatitude:a.lat()})},makePrimitiveManager:function(){return Ext.create("portal.map.gmap.PrimitiveManager",
{baseMap:this})},openInfoWindow:function(a,b,c,d,e){Ext.isArray(d)||(d=[d]);for(var f=[],g=[],h=0;h<d.length;h++){var k=null,l="HTML";f.push(Ext.id());Ext.isString(d[h])?k=d[h]:(l=d[h].tabTitle,k=Ext.util.Format.format('\x3chtml\x3e\x3cbody\x3e\x3cdiv id\x3d"{0}" style\x3d"width: {1}px; height: {2}px;"\x3e\x3c/div\x3e\x3c/body\x3e\x3c/html\x3e',f[h],b,c));g.push(new GInfoWindowTab(l,k))}this._openInfoWindowTabs(a,g,void 0,{width:b,height:c,infoWindowIds:f,content:d},function(a,b,c){for(a=0;a<c.content.length;a++)Ext.isString(c.content[a])||
Ext.create("Ext.container.Container",{renderTo:c.infoWindowIds[a],border:0,width:c.width,height:c.height,layout:"fit",items:[c.content[a]],listeners:{afterrender:function(a){a=a.getEl().findParentNode("div.gmnoprint",10,!0);var b=a.findParentNode("div.gmnoprint",10,!0),d=[];a.select("\x3e div").each(function(a){d.push(a.dom)});var e=[];b.select("\x3e div").each(function(a){e.push(a.dom)});a=e.slice(e.length-d.length);for(b=1;b<a.length;b++){var f=new Ext.Element(a[b]),g=new Ext.Element(d[b]);f.on("click",
Ext.bind(function(a,b,d,e,f){for(a=0;a<c.content.length;a++)b=c.content[a],d=b.getEl().id,0<f.select(Ext.util.Format.format(":has(#{0})",d)).getCount()&&!b._portalTabLayout&&(b._portalTabLayout=!0,b.doLayout())},this,[f,g],!0))}}}})});this.openedInfoLayerId=e.get("id")},scrollToBounds:function(a){var b=new GLatLng(a.southBoundLatitude,a.westBoundLongitude);a=new GLatLng(a.northBoundLatitude,a.eastBoundLongitude);b=new GLatLngBounds(b,a);this.map.getBounds();this.map.setZoom(this.map.getBoundsZoomLevel(b));
b=b.getCenter();this.map.panTo(b)},getZoom:function(){return this.map.getZoom()},setZoom:function(a){return this.map.setZoom(a)},setCenter:function(a){this.map.panTo(new GLatLng(a.getLatitude(),a.getLongitude()))},getCenter:function(){var a=this.map.getCenter();return Ext.create("portal.map.Point",{latitude:a.lat(),longitude:a.lng()})},getTileInformationForPoint:function(a){var b=a.getLatitude();a=a.getLongitude();var c=Ext.create("portal.map.TileInformation",{}),d=this.map.getZoom(),e=this.map.getCurrentMapType(),
f=e.getTileSize();c.setWidth(f);c.setHeight(f);e=e.getProjection();a=e.fromLatLngToPixel(new GLatLng(b,a),d);var g=Math.floor(a.x/f),h=Math.floor(a.y/f),b=e.fromPixelToLatLng(new GPoint(g*f,(h+1)*f),d),d=e.fromPixelToLatLng(new GPoint((g+1)*f,h*f),d);c.setTileBounds(Ext.create("portal.util.BBox",{northBoundLatitude:d.lat(),southBoundLatitude:b.lat(),eastBoundLongitude:d.lng(),westBoundLongitude:b.lng()}));c.setOffset({x:a.x%f,y:a.y%f});return c},getMapSizeInPixels:function(){var a=this.map.getSize();
return Ext.create("portal.map.Size",{width:a.width,height:a.height})},getPixelFromLatLng:function(a){a=new GLatLng(a.getLatitude(),a.getLongitude());return this.map.fromLatLngToContainerPixel(a)},_onMouseMove:function(a){a="\x3cb\x3eLong:\x3c/b\x3e "+a.lng().toFixed(6)+"\x26nbsp\x26nbsp\x26nbsp\x26nbsp\x3cb\x3eLat:\x3c/b\x3e "+a.lat().toFixed(6);document.getElementById("latlng").innerHTML=a},_onMouseOut:function(a){document.getElementById("latlng").innerHTML=""},_onContainerResize:function(){this.map.checkResize()},
_onClick:function(a,b,c){a=portal.map.gmap.ClickController.generateQueryTargets(a,b,c,this.layerStore);this.fireEvent("query",this,a)},closeInfoWindow:function(a){a===this.openedInfoLayerId&&this.map.closeInfoWindow()},_openInfoWindowTabs:function(a,b,c,d,e){var f=this,g=null,h=function(){GEvent.removeListener(g);e&&e(f,b,d)};a instanceof portal.map.Point?(a=new GLatLng(a.getLatitude(),a.getLongitude()),g=GEvent.addListener(this.map,"infowindowopen",h),b instanceof Array?this.map.openInfoWindowTabs(a,
b,c):"string"===typeof b&&this.map.openInfoWindowHtml(a,b,c)):a instanceof portal.map.gmap.primitives.Marker&&(a=a.getMarker(),g=GEvent.addListener(a,"infowindowopen",h),b instanceof Array?a.openInfoWindowTabs(b,c):"string"===typeof b&&a.openInfoWindowHtml(b,c))}});
Ext.define("portal.widgets.panel.recordpanel.GroupPanel",{extend:"portal.widgets.panel.recordpanel.AbstractChild",xtype:"recordgrouppanel",constructor:function(a){var b=Ext.isEmpty(a.plugins)?[]:a.plugins;b.push("collapsedaccordian");Ext.apply(a,{collapsed:!0,groupMode:!0,bodyPadding:"0 0 0 0",header:{style:"cursor: pointer;",padding:"8 4 8 4"},layout:{type:"accordion",hideCollapseTool:!0,fill:!1},plugins:b});this.callParent(arguments)},refreshTitleCount:function(){this.setTitle(this.rawTitle)},setTitle:function(a){var b=
0;this.items instanceof Ext.util.AbstractMixedCollection?this.items.each(function(a){a.isHidden()||b++}):Ext.each(this.items,function(a){if(Ext.isBoolean(a.hidden)){if(a.hidden)return}else if(Ext.isBoolean(a.visible)&&!a.visible)return;b++});this.rawTitle=a;this.visibleItemCount=b;a=Ext.util.Format.format("{0} ({1} item{2})",a,b,1!=b?"s":"");return this.callParent([a])}});
function GWMSTileLayer(a,b,c,d){GTileLayer.call(this,b,c,d);this.map=a;this.format="image/png";this.opacity=1;this.mercZoomLevel=4}GWMSTileLayer.prototype=new GTileLayer(new GCopyrightCollection,0,0);GWMSTileLayer.prototype.MAGIC_NUMBER=6356752.3142;GWMSTileLayer.prototype.WGS84_SEMI_MAJOR_AXIS=6378137;GWMSTileLayer.prototype.WGS84_ECCENTRICITY=.08181919131087181;GWMSTileLayer.prototype.dd2MercMetersLng=function(a){return a*Math.PI/180*this.WGS84_SEMI_MAJOR_AXIS};
GWMSTileLayer.prototype.dd2MercMetersLat=function(a){a=a*Math.PI/180;return this.WGS84_SEMI_MAJOR_AXIS*Math.log(Math.tan((a+Math.PI/2)/2)*Math.pow((1-this.WGS84_ECCENTRICITY*Math.sin(a))/(1+this.WGS84_ECCENTRICITY*Math.sin(a)),this.WGS84_ECCENTRICITY/2))};GWMSTileLayer.prototype.isPng=function(){return"image/png"===this.format};GWMSTileLayer.prototype.getOpacity=function(){return this.opacity};
GWMSTileLayer.prototype.getTileUrl=function(a,b){var c=this.map.getCurrentMapType(),d=c.getProjection(),c=c.getTileSize(),e=new GPoint(a.x*c,(a.y+1)*c),f=new GPoint((a.x+1)*c,a.y*c),f=d.fromPixelToLatLng(f,b),d=d.fromPixelToLatLng(e,b),e=null,e=0!==this.mercZoomLevel&&b<this.mercZoomLevel?Ext.create("portal.util.BBox",{crs:"EPSG:41001",westBoundLongitude:this.dd2MercMetersLng(d.lng()),southBoundLatitude:this.dd2MercMetersLat(d.lat()),eastBoundLongitude:this.dd2MercMetersLng(f.lng()),northBoundLatitude:this.dd2MercMetersLat(f.lat())}):
Ext.create("portal.util.BBox",{crs:"EPSG:4326",westBoundLongitude:d.lng(),southBoundLatitude:d.lat(),eastBoundLongitude:f.lng(),northBoundLatitude:f.lat()});return portal.map.primitives.BaseWMSPrimitive.getWmsUrl(this.baseURL,this.layers,e,c,c,this.format)};
Ext.define("portal.widgets.plugins.HeaderIcons",{alias:"plugin.headericons",panel:null,header:null,iconsLeft:null,iconsText:null,constructor:function(a){var b=this;this.iconsLeft=[];this.iconsText=[];a.icons&&Ext.each(a.icons,function(a){"left"===a.location?b.iconsLeft.push(a):b.iconsText.push(a)});this.callParent(arguments)},_iconCfgToMarkup:function(a,b,c){c={"vertical-align":"middle","margin-top":"-2px",display:"inline-block"};b?c["margin-right"]=Math.floor(a.width/2)+"px":c["margin-left"]=Math.floor(a.width/
2)+"px";return{tag:"div",style:c,children:[{tag:"img",width:a.width,height:a.height,style:a.style?a.style:"",src:a.src}]}},init:function(a){if(a.rendered)this.afterRender(a);else a.on("afterrender",this.afterRender,this,{single:!0})},afterRender:function(a){var b=this;b.panel=a;b.header=a.getHeader();a=b.header.getEl();var c=a.down(".x-panel-header-title"),d=a.down(".x-title-text"),e=c.getHeight();c.setStyle("overflow","visible");c.setStyle("height",e);var f={showDelay:200,dismissDelay:1E4};Ext.each(b.iconsLeft,
function(a){var c=Ext.DomHelper.insertFirst(d,b._iconCfgToMarkup(a,!0,e),!0);if(a.handler)c.on("click",a.handler);a.tip&&(f.text=a.tip,f.target=c,Ext.tip.QuickTipManager.register(f))});Ext.each(b.iconsText,function(a){var c=d.appendChild(b._iconCfgToMarkup(a,!1,e),!1);if(a.handler)c.on("click",a.handler);a.tip&&(f.text=a.tip,f.target=c,Ext.tip.QuickTipManager.register(f))})}});
Ext.define("portal.map.Icon",{statics:{markerOrder:0,genericMarkers:"http://maps.google.com/mapfiles/ms/micons/ylw-pushpin.png http://maps.google.com/mapfiles/ms/micons/blue-pushpin.png http://maps.google.com/mapfiles/ms/micons/grn-pushpin.png http://maps.google.com/mapfiles/ms/micons/ltblu-pushpin.png http://maps.google.com/mapfiles/ms/micons/pink-pushpin.png http://maps.google.com/mapfiles/ms/micons/purple-pushpin.png http://maps.google.com/mapfiles/ms/micons/red-pushpin.png".split(" "),colorMap:{purple:"#9C16F0",
orange:"#F59B0A",wht:"#E8DECF",red:"#CF082D",pink:"#F249A9",grn:"#65ED4A",blu:"#442BE3",ltblu:"#66EDD4",ylw:"#E8E527",defaultColor:"#78686C"},mapIconColor:function(a){for(var b in portal.map.Icon.colorMap)if(-1!==a.indexOf(b))return portal.map.Icon.colorMap[b]}},config:{url:"",isDefault:!1,width:0,height:0,anchorOffsetX:0,anchorOffsetY:0},constructor:function(a){this.callParent(arguments);if(a.url&&0<a.url.length)this.setUrl(a.url);else{var b=this.self.markerOrder;this.setUrl(this.self.genericMarkers[b]);
6==b?this.self.markerOrder=0:this.self.markerOrder++;this.setIsDefault(!0)}this.setWidth(a.width);this.setHeight(a.height);this.setAnchorOffsetX(a.anchorOffsetX);this.setAnchorOffsetY(a.anchorOffsetY)}});
Ext.define("portal.widgets.field.ImageDisplayField",{alias:"widget.imagedisplayfield",extend:"Ext.form.field.Display",hideLabel:!0,fieldCls:Ext.baseCSSPrefix+"form-image-field",labelCls:Ext.baseCSSPrefix+"form-image-field-label",imgHref:null,imgWidth:null,imgHeight:null,fieldSubTpl:null,constructor:function(a){this.imgHref=a.imgHref;this.imgWidth=a.imgWidth;this.imgHeight=a.imgHeight;this.fieldLabel=a.fieldLabel?a.fieldLabel:"";this.fieldSubTpl=['\x3cdiv id\x3d"{id}"','\x3ctpl if\x3d"fieldStyle"\x3e style\x3d"{fieldStyle}"\x3c/tpl\x3e',
' class\x3d"{fieldCls}"\x3e','\x3cimg style\x3d"margin: auto;" width\x3d"{[imgWidth]}" height\x3d"{[imgHeight]}" src\x3d"{[imgHref]}" alt\x3d"Loading..."/\x3e',"\x3c/div\x3e",'\x3cdiv class\x3d"x-form-value-field-label"\x3e',"{[fieldLabel]}","\x3c/div\x3e",{compiled:!0,disableFormats:!0,definitions:[this.createDefinition("imgHref",this.imgHref),this.createDefinition("imgHeight",this.imgHeight),this.createDefinition("imgWidth",this.imgWidth),this.createDefinition("fieldLabel",this.fieldLabel)]}];this.callParent(arguments)},
createDefinition:function(a,b){return Ext.isString(b)?Ext.util.Format.format('var {0} \x3d "{1}";',a,b):Ext.isObject(b)?this.createDefinition(a,Ext.DomHelper.generateStyles(b)):Ext.util.Format.format("var {0} \x3d {1};",a,b)}});
Ext.define("portal.widgets.grid.plugin.InlineContextMenu",{extend:"portal.widgets.grid.plugin.RowExpanderContainer",alias:"plugin.inlinecontextmenu",actions:null,align:null,constructor:function(a){a.generateContainer=this.generateToolbar;a.allowMultipleOpen=!1;this.align=a.align?a.align:"right";this.callParent(arguments)},generateToolbar:function(a,b,c){var d=[];Ext.each(this.actions,function(a){d.push(Ext.create("Ext.button.Button",a))});return Ext.create("Ext.container.Container",{renderTo:b,items:d,
defaults:{margin:"0 0 0 5"},padding:"5 10 5 0",layout:{type:"anchor"},style:{"text-align":this.align}})}});Ext.define("portal.util.help.Instruction",{extend:"Ext.data.Model",fields:[{name:"highlightEl",type:"auto"},{name:"anchor",defaultValue:"left",type:"string"},{name:"title",type:"string"},{name:"description",type:"string"}]});Ext.require(["Ext.ux.Spotlight"]);
Ext.define("portal.util.help.InstructionManager",{spot:null,tip:null,currentInstruction:0,constructor:function(a){this.spot=Ext.create("Ext.ux.Spotlight",a.spotCfg?a.spotCfg:{});this.callParent(arguments)},_showInstruction:function(a,b){a<b.length&&0<=a&&portal.util.GoogleAnalytic.trackevent("HelpHandlerClick","Step:"+a,"HelpTitle:"+b[a].get("title"));var c=a>=b.length||0>a?null:b[a];this.tip&&this.tip.hide();c?this.spot.show(c.get("highlightEl")):this.spot.hide();if(c){var d="Next \x3e\x3e";a===
b.length-1&&(d="Finish");this.tip=Ext.create("Ext.tip.ToolTip",{target:c.get("highlightEl"),anchor:c.get("anchor"),closable:!0,autoHide:!1,title:c.get("title"),html:c.get("description"),buttons:[{text:d,scope:this,index:a,instructions:b,handler:function(a){this._showInstruction(a.index+1,a.instructions)}}],listeners:{scope:this,destroy:function(){this.tip=null},close:function(){this.spot.hide()},hide:function(){this.tip.destroy()}}});this.tip.show()}},showInstructions:function(a){this.currentInstruction=
0;this._showInstruction(this.currentInstruction,a)}});
Ext.define("portal.layer.downloader.wfs.KLWFSDownloader",{extend:"portal.layer.downloader.Downloader",currentTooltip:null,featureCountUrl:null,enableFeatureCounts:!1,constructor:function(a){this.featureCountUrl=a.featureCountUrl?a.featureCountUrl:null;this.enableFeatureCounts=a.enableFeatureCounts?!0:!1;this.callParent(arguments)},downloadData:function(a,b,c,d){var e=this,f=null,f=d.getSpatialParam(),g=Ext.create("portal.layer.filterer.Filterer",{});g.setSpatialParam(f,!0);g.setParameters(c.getParameters(),
!0);d=a.get("cswRecords");Ext.create("Ext.Window",{title:"Download Options",buttonAlign:"right",modal:!0,border:"1 1 0 1",width:400,layout:{type:"anchor"},items:[{xtype:"fieldset",anchor:"100%",layout:"fit",padding:"10 10 0 10",border:!1,items:[{xtype:"label",style:"font-size: 12px;",itemId:"klwfs-htmllabel",html:this._parseNotifcationString(d)}]},{xtype:"fieldset",anchor:"100%",layout:"fit",border:!1,items:[{xtype:"fieldcontainer",defaultType:"checkboxfield",items:[{boxLabel:"Filter my download using the current visible map bounds.",
itemId:"klwfs-checkbox",checked:!0,listeners:{change:Ext.bind(this._handleRadioChange,this,[f,b,a],!0)}}]},{xtype:"fieldset",anchor:"100%",layout:"fit",border:!1,margin:"0 0 50 0",items:[{xtype:"textfield",itemId:"downloadToken",fieldLabel:"Email Address*",emptyText:"Enter your email address",name:"email",selectOnFocus:!0,allowBlank:!1,blankText:"This field is required",anchor:"-50"}]}]}],dockedItems:[{xtype:"toolbar",dock:"bottom",anchor:"100%",border:"0 1 1 1",margin:"-1 0 0 0",layout:{type:"hbox",
pack:"end"},items:[{xtype:"button",text:"Check Status",iconCls:"info",handler:function(a){a=a.up("window");var b=a.down("#downloadToken").getValue();""===b?(Ext.MessageBox.alert("Unable to submit request...","Please enter a valid email address"),a.down("#downloadToken").markInvalid()):e._doCheckRequest(b)}},{xtype:"button",text:"Download",iconCls:"download",handler:function(d){var f=d.up("window"),l=f.down("#downloadToken").getValue();""===l&&4>l.length?(Ext.MessageBox.alert("Unable to submit request...",
"Please enter a valid email address"),f.down("#downloadToken").markInvalid()):(f=d.ownerCt.ownerCt,f.down("#klwfs-checkbox").getValue()?e._doDownload(a,g,b,l,"csv"):e._doDownload(a,c,b,l,"csv"))}}]}],listeners:{afterrender:function(c){e.enableFeatureCounts&&(c.down("#klwfs-checkbox").getValue()?e._updateFeatureCounts(a,c,b,f):e._updateFeatureCounts(a,c,b,null))}}}).show()},_configureImageClickHandlers:function(a,b,c){a.getEl().on("click",Ext.bind(function(a){this.map.highlightBounds(a)},this,[c],
!1),a);a.getEl().on("dblclick",Ext.bind(function(a){this.map.scrollToBounds(a)},this,[c],!1),a)},_handleRadioChange:function(a,b,c,d,e,f,g){a=a.up("window");b?(this.map.scrollToBounds(e),this._updateFeatureCounts(g,a,f,e)):this._updateFeatureCounts(g,a,f,null)},_doCheckRequest:function(a){var b;b='\x3ciframe id\x3d"nav1" style\x3d"overflow:auto;width:100%;height:100%;" frameborder\x3d"0" src\x3d"checkGMLDownloadStatus.do?email\x3d';b+=a;b+='"\x3e\x3c/iframe\x3e';var c=new Ext.Window({autoScroll:!0,
border:!0,html:b,id:"dwldWindow",layout:"fit",maximizable:!0,modal:!0,plain:!1,title:"Check Status: ",height:120,width:500});c.on("show",function(){c.center()});c.show()},_updateFeatureCount:function(a,b,c,d,e){var f=this.featureCountUrl;if(a.get("sourceType")===portal.layer.Layer.KNOWN_LAYER){var g=a.get("source").get("proxyCountUrl");Ext.isEmpty(g)||(f=g)}a=a.get("filterer").getParameters();a.serviceUrl=b;a.typeName=c;a.bbox=e?Ext.JSON.encode(e):"";d.setHtml('\x3cimg src\x3d"portal-core/img/dotdotdot.gif" width\x3d"16" height\x3d"16"\x3e');
portal.util.Ajax.request({url:f,params:a,timeout:3E5,callback:function(a,b){a?d.setHtml(b):d.setHtml("Error")}})},_updateFeatureCounts:function(a,b,c,d){b=b.down("#klwfs-htmllabel").getEl().query(".klwfs-featurecount",!1);c=portal.csw.OnlineResource.getFilteredFromArray(c,portal.csw.OnlineResource.WFS);for(var e=0;e<b.length;e++){var f=c[e].get("url"),g=b[e];this._updateFeatureCount(a,f,c[e].get("name"),g,d)}},_parseNotifcationString:function(a){var b;b='\x3cp\x3eThe portal will make a download request on your behalf and return the results as a zipped CSV file. To check the progress of your download and retrieve the file, click the "Check Status" button, using the email address that you used to start the download.\x3c/p\x3e\x3cp\x3eWe limit the results to 5000 features per access point. ';
b+="If you need more than 5000 features from any one data provider, you can download directly from the WFS service points below, or contact the data provider directly.\x3c/p\x3e";b+="\x3cp\x3eNote: The links below are WFS service endpoints. Read \x3ca href\x3d'http://docs.geoserver.org/latest/en/user/services/wfs/reference.html'\x3ehere\x3c/a\x3e for more information \x3c/p\x3e";b+='\x3cdiv style\x3d"display:block;"\x3e';this.enableFeatureCounts&&(b+='\x3cdiv style\x3d"text-align:right;text-decoration:underline;"\x3eTotal Features\x3c/div\x3e');
for(var c=0;c<a.length;c++){for(var d=a[c],e=d.get("onlineResources"),e=portal.csw.OnlineResource.getFilteredFromArray(e,portal.csw.OnlineResource.WFS),f=0;f<e.length;f++){var g=e[f];b+='\x3cdiv style\x3d"display:block; height:25px;"\x3e';b+='\x3cdiv style\x3d"display:inline-block;width:78%;"\x3e';b+=this._generateWFSGetCapabilititesUrl(g.get("url"),d.get("adminArea"),d.get("contactOrg"));b+="\x3c/div\x3e";this.enableFeatureCounts&&(b+='\x3cdiv class\x3d"klwfs-featurecount" style\x3d"display:inline-block; text-align:center;width:80px;"\x3e\x3c/div\x3e')}b+=
"\x3c/div\x3e"}return b+="\x3c/div\x3e"},_doDownload:function(a,b,c,d,e){var f=a.get("renderer");a=a.get("source").get("proxyDownloadUrl");f=f.getProxyUrl();f=a&&0<a.length?a:f&&0<f.length?f:"getAllFeatures.do";f=portal.util.URL.base+f+"?";a='\x3ciframe id\x3d"nav1" style\x3d"overflow:auto;width:100%;height:100%;" frameborder\x3d"0" src\x3d"downloadGMLAsZip.do?outputFormat\x3d';a+=escape(e);a+="\x26email\x3d";a+=escape(d);c=portal.csw.OnlineResource.getFilteredFromArray(c,portal.csw.OnlineResource.WFS);
for(d=0;d<c.length;d++)if(!(b.parameters.serviceFilter&&0<b.parameters.serviceFilter.length&&c[d].get("url")!=b.parameters.serviceFilter[0])){var g=c[d].get("url"),h=c[d].get("name"),k=b.getParameters();k.serviceUrl=g;k.typeName=h;k.maxFeatures=5E3;k.outputFormat=e;portal.util.GoogleAnalytic.trackevent("KLWFSDownloader","Url:"+g,"parameters:"+Ext.encode(b.getParameters()));a+="\x26serviceUrls\x3d"+escape(Ext.urlEncode(k,f))}a+='"\x3e\x3c/iframe\x3e';var l=new Ext.Window({autoScroll:!0,border:!0,html:a,
id:"dwldWindow",layout:"fit",maximizable:!0,modal:!0,plain:!1,title:"Download confirmation: ",height:200,width:840});l.on("show",function(){l.center()});l.show()},_generateWFSGetCapabilititesUrl:function(a,b,c){var d=b;"ACT"==b&&(d=c);a=Ext.urlAppend(a,Ext.Object.toQueryString({request:"GetCapabilities",version:"1.1.0",service:"WFS"}));return'\x3ca href\x3d"'+a+'"\x3e'+d+"\x3c/a\x3e"}});
Ext.define("portal.layer.renderer.wfs.KMLParser",{map:null,constructor:function(a){this.rootNode=portal.util.xml.SimpleDOM.parseStringToDOM(a.kml);this.map=a.map;this.callParent(arguments)},descriptionToGmlId:function(a){return 0===a.indexOf("GENERIC_PARSER:")?a.substring(15):""},generateCoordList:function(a){a=a.split(" ");for(var b=[],c=0;c<a.length;c++)if(0!==a[c].length){var d=a[c].split(",");0!==d.length&&b.push(Ext.create("portal.map.Point",{latitude:parseFloat(d[1]),longitude:parseFloat(d[0])}))}return b},
parseLineString:function(a,b,c,d,e){c=this.generateCoordList(portal.util.xml.SimpleDOM.getNodeTextContent(e.getElementsByTagName("coordinates")[0]));if(0===c.length)return null;d=this.descriptionToGmlId(d);return this.map.makePolyline(d,void 0,a,b,c,"#FF0000",3,1)},parsePolygon:function(a,b,c,d,e){c=this.generateCoordList(portal.util.xml.SimpleDOM.getNodeTextContent(e.getElementsByTagName("coordinates")[0]));if(0===c.length)return null;d=this.descriptionToGmlId(d);return this.map.makePolygon(d,void 0,
a,b,c,void 0,void 0,.7,void 0,.6)},parsePoint:function(a,b,c,d,e,f){f=portal.util.xml.SimpleDOM.getNodeTextContent(f.getElementsByTagName("coordinates")[0]).split(",");if(!f||2>f.length)return null;var g=f[0];f=Ext.create("portal.map.Point",{latitude:parseFloat(f[1]),longitude:parseFloat(g)});d=this.descriptionToGmlId(d);return this.map.makeMarker(d,c,void 0,a,b,f,e)},makePrimitives:function(a,b,c){var d=[],e=this.rootNode.getElementsByTagName("Placemark");for(i=0;i<e.length;i++){for(var f=e[i],g=
null,h=portal.util.xml.SimpleDOM.getNodeTextContent(f.getElementsByTagName("name")[0]),k=portal.util.xml.SimpleDOM.getNodeTextContent(f.getElementsByTagName("description")[0]),l=f.getElementsByTagName("Polygon"),m=f.getElementsByTagName("LineString"),f=f.getElementsByTagName("Point"),n=0;n<l.length;n++){g=this.parsePolygon(b,c,h,k,l[n]);if(null===g)return;d.push(g)}for(n=0;n<m.length;n++){g=this.parseLineString(b,c,h,k,m[n]);if(null===g)return;d.push(g)}for(n=0;n<f.length;n++){g=this.parsePoint(b,
c,h,k,a,f[n]);if(null===g)return;d.push(g)}}return d}});
Ext.define("portal.layer.renderer.csw.KMLRenderer",{extend:"portal.layer.renderer.Renderer",vectorLayer:null,renderedId:null,constructor:function(a){this.callParent(arguments)},displayData:function(a,b,c){this.removeData();this.fireEvent("renderstarted",this,a,b);this.renderStatus.initialiseResponses("KML Layer","Rendering...");this.renderedId=this.parentLayer.get("id");var d=this;(new Ext.util.DelayedTask(function(){d.vectorLayer=d.map.addKMLFromString(d.renderedId,d.parentLayer.get("name"),d.parentLayer.get("source").get("extensions"));
d.renderStatus.updateResponse("KML Layer","Complete");d.fireEvent("renderfinished",d)})).delay(500)},getLegend:function(a,b){return null},removeData:function(){this.vectorLayer&&(this.map.removeKMLLayer(this.vectorLayer),this.vectorLayer=null)},setVisibility:function(a){return this.vectorLayer.setVisibility(a)},abortDisplay:Ext.emptyFn});Ext.require("portal.csw.CSWRecordType");
Ext.define("portal.knownlayer.KnownLayer",{extend:"Ext.data.Model",requires:["portal.csw.CSWRecordType"],fields:[{name:"id",type:"string"},{name:"name",type:"string"},{name:"description",type:"string"},{name:"group",type:"string"},{name:"proxyUrl",type:"string"},{name:"proxyGetFeatureInfoUrl",type:"string"},{name:"proxyCountUrl",type:"string"},{name:"proxyStyleUrl",type:"string"},{name:"proxyDownloadUrl",type:"string"},{name:"iconUrl",type:"string"},{name:"polygonColor",type:"string"},{name:"iconAnchor",
type:"auto"},{name:"iconSize",type:"auto"},{name:"cswRecords",convert:portal.csw.CSWRecordType.convert},{name:"relatedRecords",convert:portal.csw.CSWRecordType.convert},{name:"loading",type:"boolean",defaultValue:!1},{name:"layer",type:"auto"},{name:"active",type:"boolean",defaultValue:!1},{name:"feature_count",type:"string"},{name:"order",type:"string"},{name:"singleTile",type:"boolean"},{name:"nagiosFailingHosts",type:"auto"},{name:"staticLegendUrl",type:"string"}],getAllOnlineResources:function(){for(var a=
[],b=0;b<this.data.cswRecords.length;b++)a=a.concat(this.data.cswRecords[b].get("onlineResources"));return a},getCSWRecordsByKeywords:function(a){for(var b=[],c=this.get("cswRecords"),d=0;d<c.length;d++)c[d].containsKeywords(a)&&b.push(c[d]);return b},getRelatedCSWRecordsByKeywords:function(a){for(var b=[],c=this.get("relatedRecords"),d=0;d<c.length;d++)c[d].containsKeywords(a)&&b.push(c[d]);return b},containsCSWService:function(){var a=this.get("cswRecords");return 1==a.length&&(a=a[0].get("onlineResources"),
1==a.length)?a[0].get("type")==portal.csw.OnlineResource.CSWService:!1},containsNagiosFailures:function(){return!Ext.isEmpty(this.get("nagiosFailingHosts"))}});
Ext.define("portal.widgets.panel.KnownLayerPanel",{extend:"portal.widgets.panel.BaseRecordPanel",constructor:function(a){this.callParent(arguments)},getTitleForRecord:function(a){return a.get("name")},getCSWRecordsForRecord:function(a){return a.get("cswRecords")},getOnlineResourcesForRecord:function(a){var b=[];a=a.get("cswRecords");for(var c=0;c<a.length;c++)b=b.concat(a[c].getAllChildOnlineResources());return b},getSpatialBoundsForRecord:function(a){var b=[];a=a.data.cswRecords;for(var c=0;c<a.length;c++)b=
1==a[c].get("noCache")?b.concat(this.getWholeGlobeBounds()):b.concat(a[c].get("geographicElements"));return b}});
Ext.define("portal.layer.querier.wfs.KnownLayerParser",{extend:"Ext.util.Observable",constructor:function(a){this.factoryList=Ext.isArray(a.factoryList)?a.factoryList:[];if(Ext.isArray(a.factoryNames))for(var b=0;b<a.factoryNames.length;b++)this.factoryList.push(Ext.create(a.factoryNames[b],a));this.callParent(arguments)},_getSupportingFactory:function(a,b,c,d){if(!b)return null;for(a=0;a<this.factoryList.length;a++)if(this.factoryList[a].supportsKnownLayer(b))return this.factoryList[a];return null},
canParseKnownLayerFeature:function(a,b,c,d){a=this._getSupportingFactory(a,b,c,d);return null!==a&&void 0!==a},parseKnownLayerFeature:function(a,b,c,d){var e=this._getSupportingFactory(a,b,c,d);return e?e.parseKnownLayerFeature(a,b,c,d):Ext.create("portal.layer.querier.BaseComponent",{})}});
Ext.define("portal.layer.Layer",{extend:"Ext.data.Model",statics:{KNOWN_LAYER:"KnownLayer",CSW_RECORD:"CSWRecord",KML_RECORD:"KMLRecord"},visible:!0,fields:[{name:"id",type:"string"},{name:"sourceType",type:"string"},{name:"source",type:"auto"},{name:"name",type:"string"},{name:"description",type:"string"},{name:"renderer",type:"auto"},{name:"filterer",type:"auto"},{name:"downloader",type:"auto"},{name:"querier",type:"auto"},{name:"cswRecords",type:"auto"},{name:"loading",type:"boolean",defaultValue:!1},
{name:"active",type:"boolean",defaultValue:!1},{name:"visible",type:"boolean",defaultValue:!0},{name:"filterForm",type:"auto"},{name:"renderOnAdd",type:"boolean",defaultValue:!1},{name:"deserialized",type:"boolean",defaultValue:!1},{name:"singleTile",type:"boolean",defaultValue:!1},{name:"staticLegendUrl",type:"string"}],getAllOnlineResources:function(a){var b=null;a||this.get("sourceType")===portal.layer.Layer.KNOWN_LAYER&&(b=this.get("source").get("nagiosFailingHosts"));for(var c=[],d=this.get("cswRecords"),
e=0;e<d.length;e++)a||Ext.isEmpty(b)?c=c.concat(d[e].get("onlineResources")):Ext.each(d[e].get("onlineResources"),function(a){var d=!1;Ext.each(b,function(b){if(0<=a.get("url").indexOf(b))return d=!0,!1});d||c.push(a)});return c},setLayerVisibility:function(a){this.get("renderer").setVisibility(a);this.visible=a;this.set("visible",a)},onRenderStarted:function(a,b,c){this.set("loading",!0);this.set("active",!0);this.get("source").set("loading",!0);this.get("source").set("active",!0)},onRenderFinished:function(a){this.get("source").set("loading",
!1);this.set("loading",!1);a=a.map;for(var b=a.layerStore,c=0,d=b.data.items.length-1;0<=d;--d){for(var e=[],f=b.data.items[d].data.cswRecords,g=0;g<f.length;g++)f[g].data.onlineResources&&(e=e.concat(f[g].data.onlineResources));f=[];for(g=0;g<e.length;g++){var h=e[g].data.name,k=a.map.getLayersByName(h);if(0>f.indexOf(h)&&(f.push(h),k&&0<k.length))for(h=0;h<k.length;h++)c+=1,a.map.setLayerZIndex(k[h],c)}}for(d=0;d<a.map.layers.length;d++)b=a.map.layers[d],-1!=b.id.indexOf("OpenLayers_Layer_Vector_RootContainer")&&
a.map.setLayerZIndex(b,2E4+d)},onFilterChanged:function(a,b){this.reRenderLayerDisplay(a,b)},reRenderLayerDisplay:function(a,b){var c=this.get("renderer");this.removeDataFromMap();c.displayData(this.getAllOnlineResources(),this.get("filterer"),Ext.emptyFn)},removeDataFromMap:function(){var a=this.get("renderer");a.removeData();a.map.closeInfoWindow(this.get("id"));this.get("source").set("active",!1)},getCSWRecordsByKeywords:function(a){for(var b=[],c=this.get("cswRecords"),d=0;d<c.length;d++)c[d].containsKeywords(a)&&
b.push(c[d]);return b},getCSWRecordsByResourceURL:function(a){for(var b=[],c=this.get("cswRecords"),d=0;d<c.length;d++)c[d].containsOnlineResourceUrl(a)&&b.push(c[d]);return b},containsCSWService:function(){return this.get("sourceType")==portal.layer.Layer.KNOWN_LAYER?this.get("source").containsCSWService():!1}});
Ext.define("portal.layer.LayerFactory",{map:null,formFactory:null,downloaderFactory:null,querierFactory:null,rendererFactory:null,constructor:function(a){this.map=a.map;this.formFactory=a.formFactory;this.downloaderFactory=a.downloaderFactory;this.querierFactory=a.querierFactory;this.rendererFactory=a.rendererFactory;this.callParent(arguments)},generateLayer:function(a,b,c,d,e,f,g,h,k){var l=null,l=b instanceof portal.knownlayer.KnownLayer?portal.layer.Layer.KNOWN_LAYER:portal.layer.Layer.CSW_RECORD;
Ext.isArray(k)||(k=[k]);a=Ext.create("portal.layer.Layer",{id:a,sourceType:l,source:b,name:c,description:d,renderer:e,filterer:f,downloader:g,querier:h,cswRecords:k,loading:!1});e.parentLayer=a;e.on("renderstarted",Ext.bind(a.onRenderStarted,a));e.on("renderfinished",Ext.bind(a.onRenderFinished,a));e.on("visibilitychanged",Ext.bind(a.onVisibilityChanged,a));f.on("change",Ext.bind(a.onFilterChanged,a));(e=this.formFactory.getFilterForm(a))&&a.set("filterForm",e.form);a.set("renderOnAdd",!1);return a},
generateLayerFromKnownLayer:function(a){var b=a.get("id"),c=a.get("description"),d=a.get("name"),e=a.get("cswRecords"),f=this.rendererFactory.buildFromKnownLayer(a),g=this.querierFactory.buildFromKnownLayer(a),h=Ext.create("portal.layer.filterer.Filterer",{}),k=this.downloaderFactory.buildFromKnownLayer(a);return this.generateLayer(b,a,d,c,f,h,k,g,e)},generateLayerFromCSWRecord:function(a){if("kml"==a.get("resourceProvider"))return this.generateLayerFromKMLSource(a);var b=a.get("id"),c=a.get("description"),
d=a.get("name"),e=this.rendererFactory.buildFromCswRecord(a),f=this.querierFactory.buildFromCswRecord(a),g=Ext.create("portal.layer.filterer.Filterer",{}),h=this.downloaderFactory.buildFromCswRecord(a);return this.generateLayer(b,a,d,c,e,g,h,f,a)},generateLayerFromKMLSource:function(a){var b=a.get("id"),c=a.get("name"),d=a;Ext.isArray(d)||(d=[d]);var e=Ext.create("portal.layer.filterer.Filterer",{}),f=this.rendererFactory.buildFromKMLRecord(a),g=Ext.create("portal.layer.querier.csw.CSWQuerier",{map:this.map});
a=Ext.create("portal.layer.Layer",{id:b,sourceType:portal.layer.Layer.KML_RECORD,source:a,name:c,description:"A layer generated from a EPSG:4326 KML file",renderer:f,filterer:e,querier:g,cswRecords:d,loading:!1});f.parentLayer=a;f.on("renderstarted",Ext.bind(a.onRenderStarted,a));f.on("renderfinished",Ext.bind(a.onRenderFinished,a));f.on("visibilitychanged",Ext.bind(a.onVisibilityChanged,a));e.on("change",Ext.bind(a.onFilterChanged,a));e=this.formFactory.getFilterForm(a);a.set("filterForm",e.form);
a.set("renderOnAdd",!0);return a}});
Ext.define("portal.widgets.panel.LayerPanel",{extend:"Ext.grid.Panel",alias:"widget.layerpanel",map:null,allowDebugWindow:!1,constructor:function(a){var b=this;this.map=a.map;this.allowDebugWindow=a.allowDebugWindow?!0:!1;this.removeAction=new Ext.Action({text:"Remove Layer",iconCls:"remove",handler:Ext.bind(function(a){(a=this.getSelectionModel().getSelection())&&0<a.length&&(this.getStore().remove(a),this.fireEvent("removelayerrequest",this,a[0]))},this)});this.downloadLayerAction=new Ext.Action({text:"Download Layer",
iconCls:"download",handler:Ext.bind(this._downloadClickHandler,this)});Ext.apply(a,{columns:[{xtype:"clickcolumn",dataIndex:"renderer",renderer:this._legendIconRenderer,width:32,listeners:{columnclick:Ext.bind(this._legendClickHandler,this)}},{xtype:"clickcolumn",dataIndex:"loading",renderer:this._loadingRenderer,hasTip:!0,tipRenderer:Ext.bind(this._loadingTipRenderer,this),width:32,listeners:{columnclick:Ext.bind(this._serviceInformationClickHandler,this)}},{xtype:"clickcolumn",text:"Layer Name",
dataIndex:"name",flex:1,listeners:{columnclick:Ext.bind(this._nameClickHandler,this)}},{xtype:"renderablecheckcolumn",text:"Visible",dataIndex:"renderer",getCustomValueBool:function(a,b,e){return b.getVisible()},setCustomValueBool:function(a,d,e,f){e&&f.get("filterer").setSpatialParam(b.map.getVisibleMapBounds(),!0);return d.setVisible(e)},width:40},{xtype:"clickcolumn",dataIndex:"renderer",width:32,renderer:this._downloadRenderer,listeners:{columnclick:function(a,d,e,f,g){Ext.create("Ext.menu.Menu",
{items:[b.removeAction,b.downloadLayerAction]}).showAt(g.getXY())}}}],plugins:[{ptype:"rowexpander",rowBodyTpl:["\x3cp\x3e{description}\x3c/p\x3e\x3cbr\x3e"]},{ptype:"celltips"},{ptype:"rowcontextmenu",contextMenu:Ext.create("Ext.menu.Menu",{items:[this.removeAction,this.downloadLayerAction]})}],viewConfig:{plugins:[{ptype:"gridviewdragdrop",dragText:"Drag and drop to re-order"}],listeners:{beforedrop:function(a,b,e,f,g,h){if(b.records[0].data.renderer instanceof portal.layer.renderer.wms.LayerRenderer)return!0;
alert("Only wms layers can be reordered");return!1}}}});this.callParent(arguments)},_legendIconRenderer:function(a,b,c,d,e,f,g){return a?(a=a.getLegend())?a.getLegendIconHtml(c.getAllOnlineResources(),c.data.filterer):"":""},_loadingRenderer:function(a,b,c,d,e,f,g){return a?Ext.DomHelper.markup({tag:"img",width:16,height:16,src:"portal-core/img/loading.gif"}):Ext.DomHelper.markup({tag:"img",width:16,height:16,src:"portal-core/img/notloading.gif"})},_downloadRenderer:function(a,b,c,d,e,f,g){return Ext.DomHelper.markup({tag:"a",
href:"javascript: void(0)",children:[{tag:"img",width:16,height:16,src:"portal-core/img/setting.png"}]})},_loadingTipRenderer:function(a,b,c,d){var e=b.get("renderer"),f=function(a,b){d.update(a.renderHtml())};e.renderStatus.on("change",f,this);d.on("hide",function(){e.renderStatus.un("change",f)});return e.renderStatus.renderHtml()},_nameClickHandler:function(a,b,c,d){if(this.allowDebugWindow){var e=b.get("renderer").getRendererDebuggerData();if(e){var f=function(a,b,c){c.win.body.update(a.renderHtml());
c.win.doLayout()};a=Ext.create("Ext.window.Window",{title:"Renderer Debug Information",autoScroll:!0,width:500,height:300,modal:!0,html:e.renderHtml()});e.on("change",f,this,{win:a});a.on("beforeclose",function(a,b){e.un("change",f,this)},this);a.show()}}},_downloadClickHandler:function(){var a=this.getSelectionModel().getSelection()[0],b=a.get("downloader"),c=a.get("renderer");if(b&&c.getHasData()){var c=a.get("filterer").clone(),d=Ext.create("portal.layer.filterer.Filterer",{}),e=a.get("filterForm");
d.setSpatialParam(this.map.getVisibleMapBounds(),!0);e.writeToFilterer(d);e=a.getAllOnlineResources();b.downloadData(a,e,c,d)}},_serviceInformationClickHandler:function(a,b,c,d){(a=b.get("cswRecords"))&&0!==a.length&&Ext.create("portal.widgets.window.CSWRecordDescriptionWindow",{cswRecords:a,parentRecord:b}).show()},_legendClickHandler:function(a,b,c,d){var e=function(a,b,c,d,e,f){if(d&&e)return Ext.create("Ext.window.Window",{title:"Legend: "+f.get("name"),layout:"fit",modal:!0,items:e}).show()},
f=b.getAllOnlineResources(),g=b.get("filterer"),h=b.get("renderer").getLegend(f,g);a=b.get("renderer").parentLayer.get("source").get("proxyStyleUrl");Ext.Ajax.request({url:a,timeout:18E4,scope:this,success:function(a,c){h.getLegendComponent(f,g,a.responseText,!0,Ext.bind(e,this,[b],!0))},failure:function(a,c){h.getLegendComponent(f,g,"",!0,Ext.bind(e,this,[b],!0))}})}});
Ext.define("portal.layer.renderer.wms.LayerRenderer",{extend:"portal.layer.renderer.Renderer",constructor:function(a){this.legend=Ext.create("portal.layer.legend.wms.WMSLegend",{iconUrl:a.iconCfg?a.iconCfg.url:"portal-core/img/key.png",tryGetCapabilitiesFirst:a.tryGetCapabilitiesFirst});this.callParent(arguments)},displayData:function(a,b,c){this.removeData();a=portal.csw.OnlineResource.getFilteredFromArray(a,portal.csw.OnlineResource.WMS);var d=[];for(c=0;c<a.length;c++)d.push(a[c].get("url"));this.renderStatus.initialiseResponses(d,
"Loading...");for(c=0;c<a.length;c++){var d=a[c].get("url"),e=a[c].get("name"),f=b.getParameter("opacity"),g=Ext.Object.toQueryString(b.getMercatorCompatibleParameters()),h=this.parentLayer.get("source").get("proxyStyleUrl");h?(g=h=Ext.urlAppend(h,g),Ext.Ajax.request({url:Ext.urlAppend(g),timeout:18E4,scope:this,success:Ext.bind(this._getRenderLayer,this,[a[c],d,e,f,b],!0),failure:function(a,b){this.fireEvent("renderfinished",this);console.log("server-side failure with status code "+a.status)}})):
this._getRenderLayer(null,null,a[c],d,e,f,b)}this.hasData=!0},_getRenderLayer:function(a,b,c,d,e,f,g){void 0===f&&(f=g.parameters.opacity);b="";null!==a&&(this.sld_body=b=a.responseText,0!=b.indexOf("\x3c?xml version\x3d")&&(this.sld_body=b=null));var h=this.map.makeWms(void 0,void 0,c,this.parentLayer,d,e,f,b);h.getWmsLayer().events.register("loadstart",this,function(){var a=this.renderStatus.getParameters();for(key in a)if(this._getDomain(key)==this._getDomain(h.getWmsUrl())){this.renderStatus.updateResponse(key,
"Loading WMS");this.fireEvent("renderstarted",this,c,g);break}});h.getWmsLayer().events.register("loadend",this,function(a){this.fireEvent("renderfinished",this);this.renderStatus.getParameters();this._updateStatusforWMS(h.getWmsUrl(),"WMS Loaded")});a=[];a.push(h);this.primitiveManager.addPrimitives(a)},_updateStatusforWMS:function(a,b){for(key in this.renderStatus.getParameters())if(this._getDomain(key)==this._getDomain(a)){this.renderStatus.updateResponse(key,b);break}},_getDomain:function(a){return portal.util.URL.extractHostNSubDir(a,
1)},getLegend:function(a,b){return this.legend},removeData:function(){this.primitiveManager.clearPrimitives()},abortDisplay:Ext.emptyFn});Ext.define("portal.layer.LayerStore",{extend:"Ext.data.Store",addingLayer:!1,constructor:function(a){this.callParent([{model:"portal.layer.Layer",data:[]}])}});
Ext.define("portal.layer.legend.Legend",{extend:"Ext.util.Observable",requires:["portal.util.UnimplementedFunction"],constructor:function(a){this.listeners=a.listeners;this.callParent(arguments)},getLegendComponent:portal.util.UnimplementedFunction,getLegendIconHtml:portal.util.UnimplementedFunction});
Ext.define("portal.util.permalink.MapStateSerializer",{mapState:null,serializedLayers:null,serializer:null,baseSerializers:null,constructor:function(){this.mapState={};this.serializedLayers=[];this.baseSerializers={};var a=Ext.create("portal.util.permalink.serializers.SerializerV0");this.baseSerializers[a.getVersion()]=a;a=Ext.create("portal.util.permalink.serializers.SerializerV1");this.baseSerializers[a.getVersion()]=a;a=Ext.create("portal.util.permalink.serializers.SerializerV2");this.baseSerializers[a.getVersion()]=
a;a=Ext.create("portal.util.permalink.serializers.SerializerV3");this.baseSerializers[a.getVersion()]=a;a=Ext.create("portal.util.permalink.serializers.SerializerV4");this.serializer=this.baseSerializers[a.getVersion()]=a;this.callParent(arguments)},addMapState:function(a){this.mapState={center:{lat:a.getCenter().getLatitude(),lng:a.getCenter().getLongitude()},zoom:a.getZoom()}},_serializeOnlineResources:function(a){for(var b=[],c=0;c<a.length;c++)b.push({url:a[c].get("url"),type:a[c].get("type"),
name:a[c].get("name"),description:a[c].get("description")});return b},_serializeLayer:function(a){var b=a.get("sourceType"),c=a.get("filterer");a.get("renderer");return b===portal.layer.Layer.KNOWN_LAYER?{id:a.get("id"),filter:c.getParameters(),source:b}:b===portal.layer.Layer.CSW_RECORD||"search"===b?(a=a.get("cswRecords")[0],{filter:c.getParameters(),source:b,customlayer:a.get("customlayer"),onlineResources:this._serializeOnlineResources(a.get("onlineResources"))}):null},addLayers:function(a){if(a=
ActiveLayerManager.getActiveLayerStore(a))for(var b=0;b<a.getCount();b++){var c=a.getAt(b);c&&c.get("sourceType")!==portal.layer.Layer.KML_RECORD&&(c=this._serializeLayer(c),this.serializedLayers.push(c))}},serialize:function(a){this.serializer.serialize(this.mapState,this.serializedLayers,Ext.bind(function(b){a(portal.util.Base64.encode(b),this.serializer.getVersion())},this))},_guessSerializationVersion:function(a){return a&&"{"===a.charAt(0)&&"}"===a.charAt(a.length-1)?(a=Ext.JSON.decode(a),Ext.isNumber(a.v)?
a.v:0):3},deserialize:function(a,b,c){a=portal.util.Base64.decode(a);b||(b=this._guessSerializationVersion(a));(b=this.baseSerializers[b])?b.deserialize(a,Ext.bind(function(a){this.mapState=a.mapState;this.serializedLayers=a.serializedLayers;c(!0)},this)):c(!1,"Unsupported serialization version")}});
Ext.define("portal.map.openlayers.primitives.Marker",{extend:"portal.map.primitives.Marker",config:{vector:null},constructor:function(a){this.callParent(arguments);var b=this.getPoint(),c=this.getIcon(),d=void 0,e=void 0,f=void 0,g=void 0;c&&Ext.isNumber(c.getWidth())&&Ext.isNumber(c.getHeight())&&(d=c.getWidth(),e=c.getHeight());c&&Ext.isNumber(c.getAnchorOffsetX())&&Ext.isNumber(c.getAnchorOffsetY())&&(f=0-c.getAnchorOffsetX(),g=0-c.getAnchorOffsetY());b=new OpenLayers.Geometry.Point(b.getLongitude(),
b.getLatitude());c=new OpenLayers.Feature.Vector(b,{portalBasePrimitive:this},{externalGraphic:c.getUrl(),graphicWidth:d,graphicHeight:e,graphicXOffset:f,graphicYOffset:g,cursor:"pointer",graphicTitle:a.tooltip});this.setVector(c)}});
Ext.define("portal.map.gmap.primitives.Marker",{extend:"portal.map.primitives.Marker",config:{marker:null},constructor:function(a){this.callParent(arguments);var b=this.getPoint(),c=this.getIcon(),b=new GLatLng(b.getLatitude(),b.getLongitude()),d=new GIcon(G_DEFAULT_ICON,c.getUrl());d.shadow=null;Ext.isNumber(c.getWidth())&&Ext.isNumber(c.getHeight())&&(d.iconSize=new GSize(c.getWidth(),c.getHeight()));Ext.isNumber(c.getAnchorOffsetX())&&Ext.isNumber(c.getAnchorOffsetY())&&(d.iconAnchor=new GPoint(c.getAnchorOffsetX(),
c.getAnchorOffsetY()),d.infoWindowAnchor=new GPoint(c.getAnchorOffsetX(),c.getAnchorOffsetY()));c=new GMarker(b,{icon:d,title:a.tooltip});c._portalBasePrimitive=this;this.setMarker(c)}});Ext.define("portal.map.primitives.Marker",{extend:"portal.map.primitives.BasePrimitive",config:{tooltip:"",point:null,icon:null},constructor:function(a){this.callParent(arguments);this.setTooltip(a.tooltip);this.setPoint(a.point);this.setIcon(a.icon)}});
Ext.define("portal.util.ObservableMap",{extend:"Ext.util.Observable",parameters:null,constructor:function(a){this.listeners=a.listeners;this.parameters={};this.callParent(arguments)},getParameters:function(){return Ext.apply({},this.parameters)},setParameters:function(a,b){var c=Ext.apply({},a);b&&(c=Ext.apply(c,this.parameters),this.parameters={});this.parameters=Ext.apply(this.parameters,a);var d,e=[];for(d in c)e.push(d);this.fireEvent("change",this,e)},setParameter:function(a,b,c){this.parameters[a]=
b;c||this.fireEvent("change",this,[a])},getParameter:function(a){return this.parameters[a]},clone:function(){var a=Ext.create("portal.util.ObservableMap",{});Ext.apply(a.parameters,this.parameters);return a}});
Ext.define("portal.csw.OnlineResource",{extend:"Ext.data.Model",statics:{WMS:"WMS",WFS:"WFS",WCS:"WCS",WWW:"WWW",OPeNDAP:"OPeNDAP",FTP:"FTP",SOS:"SOS",UNSUPPORTED:"Unsupported",IRIS:"IRIS",CSWService:"CSWService",NCSS:"NCSS",typeToString:function(a,b){switch(a){case portal.csw.OnlineResource.WWW:case portal.csw.OnlineResource.FTP:return"Web Link";case portal.csw.OnlineResource.WFS:return"OGC Web Feature Service 1.1.0";case portal.csw.OnlineResource.WMS:return"1.3.0"==b?"OGC Web Map Service 1.3.0":
"OGC Web Map Service 1.1.1";case portal.csw.OnlineResource.WCS:return"OGC Web Coverage Service 1.0.0";case portal.csw.OnlineResource.OPeNDAP:return"OPeNDAP Service";case portal.csw.OnlineResource.SOS:return"Sensor Observation Service 2.0.0";case portal.csw.OnlineResource.IRIS:return"IRIS Web Service";case portal.csw.OnlineResource.CSWService:return"CSW Service";case portal.csw.OnlineResource.NCSS:return"NetCDF Subset Service";default:return null}},getFilteredFromArray:function(a,b,c,d,e,f){var g=
[];if(!a)return g;for(var h=0;h<a.length;h++){var k=a[h];if(void 0===b||k.get("type")===b)if(void 0===c||k.get("name")===c)if(void 0===d||k.get("description")===d)if(void 0===e||!0!==f&&void 0!==f||k.get("url")===e){if(void 0!==e&&!1===f&&this.getHostname(k.url)!==this.getHostname(e)){var l=k.get("url").match(/^(?:f|ht)tp(?:s)?:\/\/([^/]+)/im)[1].toString();if(e!==l)continue}g.push(k)}}return g}},fields:[{name:"url",type:"string"},{name:"name",type:"string"},{name:"description",type:"string"},{name:"type",
type:"string"},{name:"version",type:"string"}]});
Ext.define("portal.widgets.panel.OnlineResourcePanel",{extend:"Ext.grid.Panel",alias:"widget.onlineresourcepanel",cswRecords:null,constructor:function(a){this.cswRecords=[].concat(a.cswRecords);this.nagiosErrorIcon=Ext.isEmpty(a.nagiosErrorIcon)?"portal-core/img/warning.png":a.nagiosErrorIcon;var b=portal.widgets.panel.OnlineResourcePanelRow.parseCswRecords(this.cswRecords),c=Ext.create("Ext.grid.feature.Grouping",{groupHeaderTpl:'{name} ({[values.rows.length]} {[values.rows.length \x3e 1 ? "Items" : "Item"]})'}),d=
!0,e=!0;"undefined"!==typeof a.hideHeaders&&null!=a.hideHeaders&&(e=a.hideHeaders);"undefined"!==typeof a.sortable&&null!=a.sortable&&(d=a.sortable);this.problemHosts=[];a.parentRecord&&a.parentRecord instanceof portal.knownlayer.KnownLayer&&a.parentRecord.containsNagiosFailures()&&(this.problemHosts=a.parentRecord.get("nagiosFailingHosts"));d=[{dataIndex:"onlineResource",menuDisabled:!0,sortable:d,flex:1,renderer:Ext.bind(this._titleRenderer,this)},{width:55,dataIndex:"onlineResource",menuDisabled:!0,
renderer:Ext.bind(this._errorRenderer,this)},{dataIndex:"onlineResource",width:140,renderer:Ext.bind(this._previewRenderer,this)}];a.columns&&(d=d.concat(a.columns));Ext.apply(a,{selModel:a.selModel,features:[c],store:Ext.create("Ext.data.Store",{groupField:"group",model:"portal.widgets.panel.OnlineResourcePanelRow",data:b}),plugins:[{ptype:"selectablegrid"}],hideHeaders:e,columns:d,viewConfig:{enableTextSelection:!0}});this.callParent(arguments)},_errorRenderer:function(a,b,c,d,e,f,g){var h=c.get("onlineResource").get("url"),
k=!1;Ext.each(this.problemHosts,function(a){if(0<=h.indexOf(a))return k=!0,!1});return k?Ext.DomHelper.markup({tag:"img",src:this.nagiosErrorIcon,width:32,height:32,style:"margin-top:6px;",title:"This service is reported to be experiencing issues at the moment. Some aspects of this layer may not load/work."}):""},_titleRenderer:function(a,b,c,d,e,f,g){a=c.get("onlineResource");c.get("cswRecord");c=a.get("name");b=a.get("url");d=a.get("description");c&&0!==c.length||(c="\x26gt;Untitled\x26lt;");190<
d.length&&(d=d.substring(0,190)+"...");switch(a.get("type")){case portal.csw.OnlineResource.WWW:case portal.csw.OnlineResource.FTP:case portal.csw.OnlineResource.IRIS:case portal.csw.OnlineResource.UNSUPPORTED:return Ext.DomHelper.markup({tag:"div",children:[{tag:"a",target:"_blank",href:b,children:[{tag:"b",html:c}]},{tag:"br"},{tag:"span",style:{color:"#555"},html:d}]});default:return Ext.DomHelper.markup({tag:"div",children:[{tag:"b",html:c},{tag:"br"},{tag:"span",style:{color:"#555"},children:[{html:b},
{html:d}]}]})}},_previewRenderer:function(a,b,c,d,e,f,g){d=c.get("onlineResource");c=c.get("cswRecord");a=d.get("url");b=d.get("name");e=d.get("description");switch(d.get("type")){case portal.csw.OnlineResource.WFS:return c=a+this.internalURLSeperator(a)+"SERVICE\x3dWFS\x26REQUEST\x3dGetFeature\x26VERSION\x3d1.1.0\x26maxFeatures\x3d5\x26typeName\x3d"+b,Ext.DomHelper.markup({tag:"a",target:"_blank",href:c,html:"First 5 features"});case portal.csw.OnlineResource.WCS:return c=a+this.internalURLSeperator(a)+
"SERVICE\x3dWCS\x26REQUEST\x3dDescribeCoverage\x26VERSION\x3d1.0.0\x26coverage\x3d"+b,Ext.DomHelper.markup({tag:"a",target:"_blank",href:c,html:"DescribeCoverage response"});case portal.csw.OnlineResource.OPeNDAP:return Ext.DomHelper.markup({tag:"a",target:"_blank",href:a+".html",html:"OPeNDAP Data access form"});case portal.csw.OnlineResource.SOS:return c=a+this.internalURLSeperator(a)+"SERVICE\x3dSOS\x26REQUEST\x3dGetObservation\x26VERSION\x3d2.0.0\x26OFFERING\x3d"+escape(b)+"\x26OBSERVEDPROPERTY\x3d"+
escape(e)+"\x26RESPONSEFORMAT\x3d"+escape("http://www.opengis.net/om/2.0"),Ext.DomHelper.markup({tag:"a",target:"_blank",href:c,html:"Observations for "+e});case portal.csw.OnlineResource.WMS:if((e=c.get("geographicElements"))&&0<e.length){d=e[0];for(f=1;f<e.length;f++)d=d.combine(e[f]);var h=(d.northBoundLatitude-d.southBoundLatitude)/(d.eastBoundLongitude-d.westBoundLongitude);e=Math.floor(512*h);f=512;g=e;128<f&&(f=128,g=f*h);h="";"1.3.0"==c.get("version")?(h=portal.map.primitives.BaseWMSPrimitive.getWms_130_Url(a,
b,d,512,e),console.log("1.1.1:"+portal.map.primitives.BaseWMSPrimitive.getWmsUrl(a,b,d,512,e)),console.log("1.3.0:"+portal.map.primitives.BaseWMSPrimitive.getWms_130_Url(a,b,d,512,e))):h=portal.map.primitives.BaseWMSPrimitive.getWmsUrl(a,b,d,512,e);return Ext.DomHelper.markup({tag:"a",target:"_blank",href:h,children:[{tag:"img",width:f,height:g,alt:"Loading preview...",src:h}]})}return"Unable to preview WMS";default:return""}},internalURLSeperator:function(a){var b=a[a.length-1];return"?"==b?"":"\x26"===
b?"":0<=a.indexOf("?")?"\x26":"?"}});
Ext.define("portal.widgets.panel.OnlineResourcePanelRow",{extend:"Ext.data.Model",statics:{parseCswRecords:function(a){for(var b=[],c=0;c<a.length;c++)for(var d=a[c].getAllChildOnlineResources(),e=0;e<d.length;e++){var f=portal.csw.OnlineResource.typeToString(d[e].get("type"),d[e].get("version"));f&&b.push(Ext.create("portal.widgets.panel.OnlineResourcePanelRow",{group:f,onlineResource:d[e],cswRecord:a[c]}))}return b}},fields:[{name:"group",type:"string"},{name:"onlineResource",type:"auto"},{name:"cswRecord",
type:"auto"}]});Ext.define("portal.csw.OnlineResourceType",{singleton:!0,requires:["Ext.data.SortTypes","Ext.data.Types"]},function(){Ext.apply(portal.csw.OnlineResourceType,{convert:function(a,b){if(Ext.isArray(a)){for(var c=[],d=0;d<a.length;d++)c.push(this.convert(a[d]));return c}return a instanceof portal.csw.OnlineResource?a:Ext.isObject(a)?Ext.create("portal.csw.OnlineResource",a):null},sortType:Ext.data.SortTypes.none,type:"portal.csw.OnlineResource"})});
Ext.define("portal.layer.downloader.coverage.OPeNDAPDownloader",{extend:"portal.layer.downloader.Downloader",map:null,_getOPeNDAPParameters:function(a){var b=function(a){if(!a)return null;if("axis"===a.initialConfig.variableType){var d=a.getComponent(0),e=a.getComponent(1),f={type:a.initialConfig.variableType,name:a.initialConfig.name};a.initialConfig.usingDimensionBounds?f.dimensionBounds={from:parseFloat(d.getValue()),to:parseFloat(e.getValue())}:f.valueBounds={from:parseFloat(d.getValue()),to:parseFloat(e.getValue())};
return f}if("grid"===a.initialConfig.variableType){d=[];for(e=0;e<c.items.getCount();e++)(f=b(a.items.get(e)))&&d.push(f);return{type:a.initialConfig.variableType,name:a.initialConfig.name,axes:d}}return null},c=a.getComponent("bounding-form");a=c.getComponent("bounding-fieldset");a={opendapUrl:a.getComponent("url").getValue(),downloadFormat:a.getComponent("format").getValue()};for(var d=[],e=0;e<c.items.getCount();e++){var f=c.items.get(e);!f||f.disabled||!0===f.checkboxToggle&&!1!==f.collapsed||
(f=b(f))&&d.push(f)}a.constraints=Ext.JSON.encode({constraints:d});return a},_updateLoadingStatus:function(a,b){var c=a.getComponent("bounding-form").getComponent("bounding-fieldset").getComponent("loading");b?(c.setText(b),c.show()):(c.hide(),c.setText(""))},_generateVariableFieldSet:function(a){if("axis"===a.type){var b,c,d;a.valueBounds?(b=a.valueBounds,c=a.name+"["+b.from+", "+b.to+"] - "+a.units,"lat"===a.name?(d=this.map.getVisibleMapBounds(),b.fromValue=d.southBoundLatitude>b.from?d.southBoundLatitude:
b.from,b.toValue=d.northBoundLatitude<b.to?d.northBoundLatitude:b.to):"lon"===a.name&&(d=this.map.getVisibleMapBounds(),d.eastBoundLongitude=portal.util.BBox.datelineCorrection(d.eastBoundLongitude,"EPSG:4326"),b.fromValue=d.westBoundLongitude>b.from?d.westBoundLongitude:b.from,b.toValue=d.eastBoundLongitude<b.to?d.eastBoundLongitude:b.to),d=!1):(b=a.dimensionBounds,c=a.name+"["+b.from+", "+b.to+"]",d=!0);return{xtype:"fieldset",name:a.name,variableType:a.type,title:c,usingDimensionBounds:d,items:[{xtype:"numberfield",
fieldLabel:"From",allowBlank:!1,value:b.fromValue,minValue:b.from,maxValue:b.to,allowDecimals:!d,decimalPrecision:15,anchor:"-50"},{xtype:"numberfield",fieldLabel:"To",allowBlank:!1,value:b.toValue,minValue:b.from,maxValue:b.to,allowDecimals:!d,decimalPrecision:15,anchor:"-50"}]}}if("grid"===a.type){b=[];for(c=0;c<a.axes.length;c++)b.push(this._generateVariableFieldSet(a.axes[c]));return{xtype:"fieldset",title:a.name+" - "+a.units,name:a.name,variableType:a.type,checkboxToggle:!0,items:b}}throw"Unable to parse type\x3d"+
a.type;},_variableListToWindow:function(a,b){for(var c=a.getComponent("bounding-form"),d=0;d<b.length;d++){var e=this._generateVariableFieldSet(b[d]);c.add(e)}a.doLayout()},_onWindowOpen:function(a,b,c,d){portal.util.Ajax.request({url:"opendapGetVariables.do",scope:this,params:{opendapUrl:c,variableName:d},callback:function(b,c,d){b?(this._updateLoadingStatus(a,null),this._variableListToWindow(a,c)):this._updateLoadingStatus(a,"Error: "+d)}})},downloadData:function(a,b,c,d){this.map=a.get("renderer").map;
a=portal.csw.OnlineResource.getFilteredFromArray(b,portal.csw.OnlineResource.OPeNDAP);if(0!==a.length){c=a[0];a=c.get("url");c=c.get("name");b=portal.csw.OnlineResource.getFilteredFromArray(b,portal.csw.OnlineResource.FTP);var e=0<b.length?b[0].get("url"):"";b=Ext.create("Ext.data.Store",{fields:["format"],proxy:{type:"ajax",url:"opendapGetSupportedFormats.do",reader:{type:"array"}},autoLoad:!0});Ext.create("Ext.window.Window",{layout:"fit",modal:!0,buttonAlign:"right",title:"OPeNDAP Download",height:600,
width:500,items:[{xtype:"form",itemId:"bounding-form",items:[{xtype:"fieldset",itemId:"bounding-fieldset",title:"Required Information",items:[{xtype:"textfield",itemId:"url",fieldLabel:"URL",value:a,name:"opendapUrl",readOnly:!0,anchor:"-50"},{xtype:"combo",itemId:"format",name:"format",fieldLabel:"Format",emptyText:"",forceSelection:!0,allowBlank:!1,mode:"local",store:b,typeAhead:!0,triggerAction:"all",displayField:"format",anchor:"-50",valueField:"format"},{xtype:"label",itemId:"loading",text:"Loading..."}]}]}],
buttons:[{xtype:"button",text:"Download",iconCls:"download",scope:this,handler:function(a){a=a.ownerCt.ownerCt;var b=a.getComponent("bounding-form"),c=b.getComponent("bounding-fieldset").getComponent("loading");b.getForm().isValid()&&c.isHidden()?(a=this._getOPeNDAPParameters(a),b="opendapMakeRequest.do?constraints\x3d"+escape(a.constraints)+(e?"\x26"+Ext.Object.toQueryString({ftpURL:e}):""),delete a.constraints,portal.util.FileDownloader.downloadFile(b,a)):Ext.Msg.alert("Invalid Fields","One or more fields are invalid")}}],
listeners:{afterrender:Ext.bind(this._onWindowOpen,this,[a,c],!0)}}).show()}}});
Ext.define("portal.map.openlayers.OpenLayersMap",{extend:"portal.map.BaseMap",map:null,vectorLayers:[],selectControl:null,layerSwitcher:null,constructor:function(a){this.callParent(arguments);a.portalIsHandlingLayerSwitcher||Ext.defer(this._callDrawOpenLayerSwitcher,2E3,this)},_callDrawOpenLayerSwitcher:function(){var a=this._callDrawOpenLayerSwitcher;this.map?this._drawOpenLayerSwitcher():Ext.defer(a,250,this)},makeMarker:function(a,b,c,d,e,f,g){return Ext.create("portal.map.openlayers.primitives.Marker",
{id:a,tooltip:b,layer:e,onlineResource:d,cswRecord:c,point:f,icon:g})},makePolygon:function(a,b,c,d,e,f,g,h,k,l){return Ext.create("portal.map.openlayers.primitives.Polygon",{id:a,layer:d,onlineResource:c,cswRecord:b,points:e,strokeColor:f,strokeWeight:g,strokeOpacity:h,fillColor:k,fillOpacity:l})},makePolyline:function(a,b,c,d,e,f,g,h){return Ext.create("portal.map.openlayers.primitives.Polyline",{id:a,layer:d,onlineResource:c,cswRecord:b,points:e,strokeColor:f,strokeWeight:g,strokeOpacity:h})},
makeWms:function(a,b,c,d,e,f,g,h){return Ext.create("portal.map.openlayers.primitives.WMSOverlay",{id:a,layer:d,onlineResource:c,cswRecord:b,wmsUrl:e,wmsLayer:f,opacity:g,map:this.map,sld_body:h})},_makeQueryTargetsPolygon:function(a,b,c,d){a=[];b=new OpenLayers.LonLat(c,d);b=b.transform("EPSG:4326","EPSG:3857");for(var e=0;e<this.vectorLayers.length;e++)for(var f=this.vectorLayers[e],g=0;g<f.features.length;g++){var h=f.features[g];if(h.geometry.atPoint(b)){var k=h.attributes.portalBasePrimitive;
if(k){var h=k.getId(),l=k.getOnlineResource(),m=k.getLayer(),k=k.getCswRecord();a.push(Ext.create("portal.layer.querier.QueryTarget",{id:h,lat:d,lng:c,onlineResource:l,layer:m,cswRecord:k,explicit:!0}))}}}return a},_makeQueryTargetsVector:function(a,b,c){var d=a.getId(),e=a.getOnlineResource(),f=a.getLayer();a=a.getCswRecord();return[Ext.create("portal.layer.querier.QueryTarget",{id:d,lat:c,lng:b,onlineResource:e,layer:f,cswRecord:a,explicit:!0})]},_makeQueryTargetsMap:function(a,b,c){var d=[];if(!a)return d;
for(var e=0;e<a.getCount();e++)for(var f=a.getAt(e),g=f.get("cswRecords"),h=0;h<g.length;h++){for(var k=g[h],l=!1,m=k.get("geographicElements"),n=0;n<m.length;n++)if(m[n]instanceof portal.util.BBox&&m[n].contains(c,b)){l=!0;break}if(l&&0!=f.visible){l=k.get("onlineResources");n=portal.csw.OnlineResource.getFilteredFromArray(l,portal.csw.OnlineResource.WMS);l=portal.csw.OnlineResource.getFilteredFromArray(l,portal.csw.OnlineResource.WCS);if(n[0]){for(var m=!0,t=n[0].get("name"),q=null,p=0;p<this.map.controls.length;p++)if(this.map.controls[p]instanceof
OpenLayers.Control.LayerSwitcher){q=this.map.controls[p];break}q=q.layerStates;for(p=0;p<q.length;p++)if(q[p].name===t){m=q[p].visibility;break}if(!m)continue}m=[];m=0<l.length?l:n;for(n=0;n<m.length;n++)if(l=m[n].get("type"),l===portal.csw.OnlineResource.WMS||l===portal.csw.OnlineResource.WCS){if(l=f.get("filterer").getParameters().serviceFilter)if(Ext.isArray(l)&&(l=l[0]),m[n].get("name")!=l&&this._getDomain(m[n].get("url"))!=this._getDomain(l))continue;d.push(Ext.create("portal.layer.querier.QueryTarget",
{id:"",lat:c,lng:b,cswRecord:k,onlineResource:m[n],layer:f,explicit:!0}))}}}return d},_onClick:function(a,b){var c=a?a.attributes.portalBasePrimitive:null,d=this.map.getLonLatFromViewPortPx(b.xy),d=d.transform("EPSG:3857","EPSG:4326"),e=d.lon,d=d.lat,f=c?c.getLayer():null,g=[],g=c&&f&&c instanceof portal.map.openlayers.primitives.Polygon?this._makeQueryTargetsPolygon(c,this.layerStore,e,d):c&&f?this._makeQueryTargetsVector(c,e,d):this._makeQueryTargetsMap(this.layerStore,e,d);this.fireEvent("query",
this,g)},closeInfoWindow:function(a){a===this.openedInfoLayerId&&this.map.popups[0]&&this.map.removePopup(this.map.popups[0])},_onPrimitivesAdded:function(a){this.selectControl.setLayer(a.allLayers)},_handleDrawCtrlAddFeature:function(a){var b=a.object;a=a.feature;var c=new Ext.util.DelayedTask(Ext.bind(function(a){this._drawCtrlVectorLayer.removeFeatures([a])},this,[a]));c.delay(3E3);a=a.geometry.getBounds().transform("EPSG:3857","EPSG:4326").toArray();a=Ext.create("portal.util.BBox",{northBoundLatitude:a[3],
southBoundLatitude:a[1],eastBoundLongitude:a[2],westBoundLongitude:a[0]});c=this.getLayersInBBox(a);this.fireEvent("dataSelect",this,a,c);c=new Ext.util.DelayedTask(Ext.bind(function(a){a.deactivate()},this,[b]));c.delay(50)},renderToContainer:function(a,b){var c=this;this.map=new OpenLayers.Map({div:b,projection:"EPSG:3857",controls:[new OpenLayers.Control.Navigation,new OpenLayers.Control.PanZoomBar({zoomStopHeight:8}),new OpenLayers.Control.MousePosition({numDigits:2,displayProjection:new OpenLayers.Projection("EPSG:4326"),
prefix:'\x3ca target\x3d"_blank" href\x3d"http://spatialreference.org/ref/epsg/4326/"\x3eMap coordinates (WGS84 decimal degrees)\x3c/a\x3e: ',suffix:" / lat lng",emptyString:'\x3ca target\x3d"_blank" href\x3d"http://spatialreference.org/ref/epsg/4326/"\x3eMap coordinates (WGS84 decimal degrees): \x3c/a\x3e Out of bound',element:Ext.get("latlng").dom,formatOutput:function(a){var b=parseInt(this.numDigits);return this.prefix+a.lat.toFixed(b)+this.separator+a.lon.toFixed(b)+this.suffix}})],layers:[new OpenLayers.Layer.WMS("World Political Boundaries",
"http://services.ga.gov.au/site_1/services/World_Political_Boundaries_WM/MapServer/WMSServer",{layers:"Countries"}),new OpenLayers.Layer.Google("Google Hybrid",{type:google.maps.MapTypeId.HYBRID,numZoomLevels:20}),new OpenLayers.Layer.Google("Google Physical",{type:google.maps.MapTypeId.TERRAIN}),new OpenLayers.Layer.Google("Google Streets",{numZoomLevels:20}),new OpenLayers.Layer.Google("Google Satellite",{type:google.maps.MapTypeId.SATELLITE,numZoomLevels:22})],center:(new OpenLayers.LonLat(133.3,
-26)).transform("EPSG:4326","EPSG:3857"),zoom:4});var d=this.map.getLayersByName("Google Satellite");null!==d&&this.map.setBaseLayer(d[0]);this.highlightPrimitiveManager=this.makePrimitiveManager(!0);this.container=a;this.rendered=!0;var e=new OpenLayers.Control.ZoomBox({alwaysZoom:!0,zoomOnClick:!1}),f=new OpenLayers.Control.Navigation,g=new (OpenLayers.Class(OpenLayers.Control.NavToolbar,{initialize:function(a){OpenLayers.Control.Panel.prototype.initialize.apply(this,[a]);this.addControls([f,e])}}));
g.controls[1].events.on({afterZoom:function(){c.fireEvent("afterZoom",this);g.defaultControl=g.controls[0];g.activateControl(g.controls[0]);c._activateClickControl()}});this.map.addControl(g);if(this.allowDataSelection){d=new OpenLayers.Control.Panel({createControlMarkup:function(a){var b=document.createElement("button"),c=document.createElement("span"),d=document.createElement("span");inactiveTextSpan=document.createElement("span");c.innerHTML="\x26nbsp;";b.appendChild(c);d.innerHTML=a.activeText;
Ext.get(d).addCls("active-text");b.appendChild(d);inactiveTextSpan.innerHTML=a.inactiveText;Ext.get(inactiveTextSpan).addCls("inactive-text");b.appendChild(inactiveTextSpan);b.setAttribute("id",a.buttonId);return b}});this._drawCtrlVectorLayer=this._getNewVectorLayer();var h=new OpenLayers.Control.DrawFeature(this._drawCtrlVectorLayer,OpenLayers.Handler.RegularPolygon,{handlerOptions:{sides:4,irregular:!0},title:"Draw a bounding box to select data in a region.",activeText:"Click and drag a region of interest",
buttonId:"gmap-subset-control",inactiveText:"Select Data"});d.addControls([h]);h.events.register("activate",{},function(){c._deactivateClickControl();Ext.each(g.controls,function(a){a.deactivate()})});h.events.register("deactivate",{},function(){c._activateClickControl()});Ext.each(g.controls,function(a){a.events.register("activate",{},function(){h.deactivate()})});h.events.register("featureadded",{},Ext.bind(function(a){this._handleDrawCtrlAddFeature(a)},this));this.map.addControl(d)}a.on("resize",
function(){this.map.updateSize()},this);a.on("boxready",function(){this.map.updateSize()},this)},renderBaseMap:function(a){this.map?this._drawOpenLayerSwitcher(a):portal.events.AppEvents.addListener(this,{callback:this.renderBaseMap,divId:a})},listeners:{mapcreated:function(a){a.callback.apply(this,[a.divId])}},_drawOpenLayerSwitcher:function(a){this.layerSwitcher||(this.layerSwitcher=a?new OpenLayers.Control.LayerSwitcher({div:OpenLayers.Util.getElement(a),ascending:!1}):new OpenLayers.Control.LayerSwitcher({ascending:!1}),
this.map.addControl(this.layerSwitcher),this.layerSwitcher.maximizeControl())},_getNewVectorLayer:function(){var a=new OpenLayers.Layer.Vector("Vectors",{preFeatureInsert:function(a){var c=a.geometry.getBounds();90>=c.top&&-90<=c.top&&a.geometry.transform("EPSG:4326","EPSG:3857")},displayInLayerSwitcher:!1});this.map.addLayer(a);return a},getVisibleMapBounds:function(){var a=this.map.getExtent().transform("EPSG:3857","EPSG:4326").toArray();180<a[2]&&(a[2]=-1*(180-(a[2]-180)));eastWestDelta=Math.abs(Math.max(a[0],
a[2])-Math.min(a[0],a[2]));northSouthDelta=Math.abs(Math.max(a[1],a[3])-Math.min(a[1],a[3]));calcEWprecis=Math.floor(1/Math.pow(eastWestDelta,.16));calcNSprecis=Math.floor(1/Math.pow(northSouthDelta,.16));0>calcEWprecis&&(calcEWprecis=0);0>calcNSprecis&&(calcNSprecis=0);north=a[3].toFixed(calcNSprecis);south=a[1].toFixed(calcNSprecis);east=a[2].toFixed(calcEWprecis);west=a[0].toFixed(calcEWprecis);return Ext.create("portal.util.BBox",{westBoundLongitude:west,southBoundLatitude:south,eastBoundLongitude:east,
northBoundLatitude:north})},makePrimitiveManager:function(a){for(var b=new portal.map.openlayers.ClickControl(this.vectorLayers,{map:this.map,trigger:Ext.bind(this._onClick,this)}),c=this.map.getControlsByClass("portal.map.openlayers.ClickControl"),d=0;d<c.length;d++)this.map.removeControl(c[d]);this.map.addControl(b);b.activate();return Ext.create("portal.map.openlayers.PrimitiveManager",{baseMap:this,vectorLayerGenerator:Ext.bind(function(){var a=this._getNewVectorLayer();this.vectorLayers.push(a);
return a},this),noLazyGeneration:a,listeners:{addprimitives:Ext.bind(function(){var a=this.highlightPrimitiveManager.vectorLayer;a&&this.map.setLayerIndex(a,this.map.layers.length);a=this.map.getControlsByClass("OpenLayers.Control.DrawFeature");Ext.isEmpty(a)||this.map.setLayerIndex(a[0].layer,this.map.layers.length)},this)}})},openInfoWindow:function(a,b,c,d,e){var f=Ext.id();a=new OpenLayers.LonLat(a.getLongitude(),a.getLatitude());a=a.transform("EPSG:4326","EPSG:3857");b=new OpenLayers.Size(b+
0,c+(1>=d.length?0:32));c=Ext.id();var g=Ext.util.Format.format('\x3chtml\x3e\x3cbody\x3e\x3cdiv id\x3d"{0}" style\x3d"width: {1}px; height: {2}px;"\x3e\x3c/div\x3e\x3c/body\x3e\x3c/html\x3e',c,b.w,b.h),f=new OpenLayers.Popup.FramedCloud(f,a,b,g,null,!0,null);this.map.addPopup(f,!0);f=Ext.get(c).dom;a=function(a){Ext.event.publisher.Dom.instance.onDelegatedEvent(a);if("click"!==a.type)Ext.event.publisher.Gesture.instance.onDelegatedEvent(a);return!1};f.addEventListener("mousedown",a);f.addEventListener("mouseup",
a);f.addEventListener("mousemove",a);f.addEventListener("click",a);this.openedInfoLayerId=e.get("id");Ext.isArray(d)||(d=[d]);if(1===d.length)Ext.create("Ext.panel.Panel",{width:b.w,height:b.h,autoScroll:!0,layout:"fit",renderTo:c,border:!1,items:d}),portal.util.PiwikAnalytic.trackevent("Query","layer:"+e.get("name"),"id:"+d[0].tabTitle);else{f=[];for(a=0;a<d.length;a++)Ext.isString(d[a])?(f.push({title:"",border:!1,layout:"fit",autoScroll:!0,html:d[a]}),portal.util.PiwikAnalytic.trackevent("Query",
"layer:"+e.get("name"),"id:Unknown")):(f.push({title:d[a].tabTitle,border:!1,layout:"fit",autoScroll:!0,items:[d[a]]}),portal.util.PiwikAnalytic.trackevent("Query","layer:"+e.get("name"),"id:"+d[a].tabTitle));Ext.create("Ext.tab.Panel",{width:b.w,height:b.h,renderTo:c,layout:"fit",border:!1,activeTab:0,items:f})}},scrollToBounds:function(a){a=new OpenLayers.Bounds(a.westBoundLongitude,a.southBoundLatitude,a.eastBoundLongitude,a.northBoundLatitude);a.transform("EPSG:4326","EPSG:3857");this.map.zoomToExtent(a,
!0)},getZoom:function(){return this.map.getZoom()},setZoom:function(a){this.map.zoomTo(a)},setCenter:function(a,b){b&&"EPSG:3857"==b?this.map.panTo(new OpenLayers.LonLat(a.getLongitude(),a.getLatitude())):this.map.panTo((new OpenLayers.LonLat(a.getLongitude(),a.getLatitude())).transform("EPSG:4326","EPSG:3857"))},getCenter:function(){var a=this.map.getCenter(),a=a.transform("EPSG:3857","EPSG:4326");return Ext.create("portal.map.Point",{longitude:a.lon,latitude:a.lat})},getTileInformationForPoint:function(a){this.map.getTileSize();
a=new OpenLayers.LonLat(a.getLongitude(),a.getLatitude());a=a.transform("EPSG:4326","EPSG:3857");a=this.map.getViewPortPxFromLonLat(a);var b=this.map.getExtent();return Ext.create("portal.map.TileInformation",{width:this.map.size.w,height:this.map.size.h,offset:{x:a.x,y:a.y},tileBounds:Ext.create("portal.util.BBox",{eastBoundLongitude:b.right,westBoundLongitude:b.left,northBoundLatitude:b.top,southBoundLatitude:b.bottom})})},getMapSizeInPixels:function(){var a=this.map.getCurrentSize();return Ext.create("portal.map.Size",
{width:a.w,height:a.h})},getPixelFromLatLng:function(a){a=new OpenLayers.LonLat(a.getLongitude(),a.getLatitude());a=a.transform("EPSG:4326","EPSG:3857");a=this.map.getLayerPxFromLonLat(a);a=this.map.getViewPortPxFromLayerPx(a);return{x:a.x,y:a.y}},showContextMenuAtLatLng:function(a,b){var c=this.getPixelFromLatLng(a);b.showAt(this.container.x+c.x,this.container.y+c.y)},addKMLFromString:function(a,b,c){a=this.getFeaturesFromKMLString(c);b=new OpenLayers.Layer.Vector(b,{projection:"EPSG:4326"});b.addFeatures(a);
this.map.addLayer(b);this.map.zoomToExtent(b.getDataExtent());return b},removeKMLLayer:function(a){this.map.removeLayer(a)},_onLayerStoreAdd:function(a,b){for(var c=0;c<b.length;c++){var d=b[c];if(d.get("deserialized"))d=d.get("filterer"),d.setParameters({});else if(d.get("renderOnAdd")){var e=d.get("filterForm"),d=d.get("filterer");d.setSpatialParam(this.getVisibleMapBounds(),!0);e.writeToFilterer(d)}}},_getDomain:function(a){return portal.util.URL.extractHostNSubDir(a,1)},_activateClickControl:function(){for(var a=
this.map.getControlsByClass("portal.map.openlayers.ClickControl"),b=0;b<a.length;b++)a[b].activate()},_deactivateClickControl:function(){for(var a=this.map.getControlsByClass("portal.map.openlayers.ClickControl"),b=0;b<a.length;b++)a[b].deactivate()}});
Ext.define("portal.layer.querier.wfs.Parser",{extend:"Ext.util.Observable",constructor:function(a){this.factoryList=Ext.isArray(a.factoryList)?a.factoryList:[];if(Ext.isArray(a.factoryNames))for(var b={parser:this},c=0;c<a.factoryNames.length;c++)this.factoryList.push(Ext.create(a.factoryNames[c],b));this.callParent(arguments)},parseNode:function(a,b,c){if(!a)return Ext.create("portal.layer.querier.BaseComponent",{});for(var d=0;d<this.factoryList.length;d++)if(this.factoryList[d].supportsNode(a))return this.factoryList[d].parseNode(a,
b,c);throw"Unsupported node type";}});
Ext.define("portal.widgets.window.PermanentLinkWindow",{extend:"Ext.window.Window",constructor:function(a){var b=Ext.Object.fromQueryString(location.search.substring(1));b.s=a.state;a.version&&(b.v=a.version);var c=location.href.split("?")[0],b=Ext.Object.toQueryString(b),c=Ext.urlAppend(c,decodeURIComponent(b)),b="\x3cb\x3eWarning:\x3c/b\x3e\x3cbr\x3eThis link will only save your selected layers and queries. The actual data received and displayed may be subject to change\x3cbr\x3e\x3cbr\x3e";8192<
c.length?b+="\x3cp\x3e\x3cb\x3eNote: \x3c/b\x3eThis permanent link is very long and will be unuseable with the Internet Explorer web browser. It may also cause problems for various web servers so it is recommended you test your permanent link before saving/sharing it.\x3c/p\x3e":2047<c.length&&(b+="\x3cp\x3e\x3cb\x3eNote: \x3c/b\x3eThis permanent link is rather long and will be unuseable with the Internet Explorer web browser.\x3c/p\x3e");Ext.apply(a,{title:"Permanent Link",autoDestroy:!0,modal:!0,
width:500,autoHeight:!0,items:[{xtype:"panel",style:{font:"12px tahoma,arial,helvetica,sans-serif"},html:b},{xtype:"form",layout:"form",autoHeight:!0,items:[{xtype:"textfield",id:"linkField",anchor:"100%",fieldLabel:"Paste this link",labelStyle:"font-weight:bold;",value:c,readOnly:!0,listeners:{afterrender:function(a){Ext.defer(function(){a.focus(!0,100)},1)}}}]}],buttons:[{xtype:"button",text:"Copy to clipboard",handler:function(a){if(window.clipboardData&&window.clipboardData.setData)return clipboardData.setData("Text",
Ext.getCmp("linkField").value);document.getElementById("linkField-inputEl").focus();document.getElementById("linkField-inputEl").select();document.execCommand("copy")}}]});this.callParent(arguments)}});
Ext.define("portal.util.PiwikAnalytic",{singleton:!0},function(){portal.util.PiwikAnalytic.trackevent=function(a,b,c,d){"undefined"!=typeof _paq&&(d?_paq.push(["trackEvent",a,b,c,d]):_paq.push(["trackEvent",a,b,c]))};portal.util.PiwikAnalytic.siteSearch=function(a,b,c){"undefined"!=typeof _paq&&_paq.push(["trackSiteSearch",a,b,c])}});
Ext.define("portal.map.Point",{config:{srs:"WGS:84",latitude:0,longitude:0},constructor:function(a){this.callParent(arguments);this.setSrs(a.srs);this.setLatitude(a.latitude);this.setLongitude(a.longitude)}});
Ext.define("portal.map.openlayers.primitives.Polygon",{extend:"portal.map.primitives.Polygon",config:{vector:null},constructor:function(a){this.callParent(arguments);for(var b=[],c=0;c<a.points.length;c++)b.push(new OpenLayers.Geometry.Point(a.points[c].getLongitude(),a.points[c].getLatitude()));b=new OpenLayers.Geometry.LinearRing(b);b=new OpenLayers.Geometry.Polygon(b);b=new OpenLayers.Feature.Vector(b,{portalBasePrimitive:this},{fill:!0,fillColor:this.getFillColor(),fillOpacity:this.getFillOpacity(),
stroke:!0,strokeColor:this.getStrokeColor(),strokeOpacity:this.getStrokeOpacity(),strokeWidth:this.getStrokeWeight()});this.setVector(b)}});
Ext.define("portal.map.gmap.primitives.Polygon",{extend:"portal.map.primitives.Polygon",config:{polygon:null},constructor:function(a){this.callParent(arguments);for(var b=[],c=0;c<a.points.length;c++)b.push(new GLatLng(a.points[c].getLatitude(),a.points[c].getLongitude()));b=new GPolygon(b,this.getStrokeColor(),this.getStrokeWeight(),this.getStrokeOpacity(),this.getFillColor(),this.getFillOpacity());b._portalBasePrimitive=this;this.setPolygon(b)}});
Ext.define("portal.map.primitives.Polygon",{extend:"portal.map.primitives.BasePrimitive",config:{points:null,strokeColor:"#00FF00",strokeWeight:1,strokeOpacity:.7,fillColor:"#00FF00",fillOpacity:.6},constructor:function(a){this.callParent(arguments);this.setPoints(a.points);this.setStrokeColor(a.strokeColor);this.setStrokeWeight(a.strokeWeight);this.setStrokeOpacity(a.strokeOpacity);this.setFillColor(a.fillColor);this.setFillOpacity(a.fillOpacity)}});
Ext.define("portal.map.openlayers.primitives.Polyline",{extend:"portal.map.primitives.Polyline",config:{vector:null},constructor:function(a){this.callParent(arguments);for(var b=[],c=0;c<a.points.length;c++)b.push(new OpenLayers.Geometry.Point(a.points[c].getLongitude(),a.points[c].getLatitude()));b=new OpenLayers.Geometry.LineString(b);b=new OpenLayers.Feature.Vector(b,void 0,{stroke:!0,strokeColor:this.getStrokeColor(),strokeOpacity:this.getStrokeOpacity(),strokeWidth:this.getStrokeWeight()});this.setVector(b)}});
Ext.define("portal.map.gmap.primitives.Polyline",{extend:"portal.map.primitives.Polyline",config:{polyline:null},constructor:function(a){this.callParent(arguments);for(var b=[],c=0;c<a.points.length;c++)b.push(new GLatLng(a.points[c].getLatitude(),a.points[c].getLongitude()));b=new GPolyline(b,this.getStrokeColor(),this.getStrokeWeight(),this.getStrokeOpacity());b._portalBasePrimitive=this;this.setPolyline(b)}});
Ext.define("portal.map.primitives.Polyline",{extend:"portal.map.primitives.BasePrimitive",config:{points:null,strokeColor:"#00FF00",strokeWeight:1,strokeOpacity:.7},constructor:function(a){this.callParent(arguments);this.setPoints(a.points);this.setStrokeColor(a.strokeColor);this.setStrokeWeight(a.strokeWeight);this.setStrokeOpacity(a.strokeOpacity)}});
Ext.define("portal.map.openlayers.PrimitiveManager",{extend:"portal.map.BasePrimitiveManager",vectorLayer:null,vectorLayerGenerator:null,layers:null,vectors:null,constructor:function(a){this.callParent(arguments);this.vectorLayer=null;this.vectorLayerGenerator=a.vectorLayerGenerator;this.layers=[];this.vectors=[];a.noLazyGeneration&&this.getVectorLayer()},getVectorLayer:function(){return this.vectorLayer?this.vectorLayer:this.vectorLayer=this.vectorLayerGenerator(this)},setVisibility:function(a){this.getVectorLayer().setVisibility(a);
for(var b=0;b<this.layers.length;b++)this.layers[b].setVisibility(a)},clearPrimitives:function(){for(var a=0;a<this.layers.length;a++)this.layers[a].destroy();this.layers=[];this.getVectorLayer().removeFeatures(this.vectors);for(a=0;a<this.vectors.length;a++)this.vectors[a].destroy();this.vectors=[];this.fireEvent("clearprimitives",this)},addPrimitives:function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c];if(d instanceof portal.map.openlayers.primitives.Marker||d instanceof portal.map.openlayers.primitives.Polygon||
d instanceof portal.map.openlayers.primitives.Polyline)b.push(d.getVector());else if(d instanceof portal.map.openlayers.primitives.WMSOverlay){for(var e=d.getLayer().data.id,f=this.baseMap.layerStore.data.items,g=0,g=0;g<f.length&&e!=f[g].data.id;g++);d=d.getWmsLayer();this.layers.push(d);this.baseMap.map.addLayer(d);g=this.baseMap.map.layers.length-1-g;this.baseMap.map.setLayerIndex(d,g)}}if(0<b.length)for(this.getVectorLayer().addFeatures(b),c=0;c<b.length;c++)this.vectors.push(b[c]);this.fireEvent("addprimitives",
this,a)}});
Ext.define("portal.map.gmap.PrimitiveManager",{extend:"portal.map.BasePrimitiveManager",constructor:function(a){this.callParent(arguments);this.markerManager=new MarkerManager(this.baseMap.map);this.primitiveList=[]},clearPrimitives:function(){for(var a=0;a<this.primitiveList.length;a++)this.baseMap.map.removeOverlay(this.primitiveList[a]);this.primitiveList=[];this.markerManager.clearMarkers();this.fireEvent("clearprimitives",this)},addPrimitives:function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c];
d instanceof portal.map.gmap.primitives.Marker?b.push(d.getMarker()):d instanceof portal.map.gmap.primitives.Polygon?(d=d.getPolygon(),this.baseMap.map.addOverlay(d),this.primitiveList.push(d)):d instanceof portal.map.gmap.primitives.Polyline?(d=d.getPolyline(),this.baseMap.map.addOverlay(d),this.primitiveList.push(d)):d instanceof portal.map.gmap.primitives.WMSOverlay&&(d=d.getTileLayerOverlay(),this.baseMap.map.addOverlay(d),this.primitiveList.push(d))}0<b.length&&(this.markerManager.addMarkers(b,
0),this.markerManager.refresh());this.fireEvent("addprimitives",this,a)}});
Ext.define("portal.util.ProviderNameTransformer",{statics:{abbreviateName:function(a){for(var b="CSIRO;Geoscience Australia;Northern Territory;Queensland;South Australia;Tasmania;Victoria;Western Australia".split(";"),c=0;c<b.length;c++)if(-1!=a.indexOf("DSD")){a="South Australia";break}else if(-1!=a.indexOf("NSW")){a="New South Wales";break}else if(-1!=a.indexOf("Department of Mines and Energy")){a="Northern Territory";break}else if(-1!=a.indexOf(b[c])){a=b[c];break}return a}}});
Ext.define("portal.layer.querier.Querier",{extend:"Ext.util.Observable",map:null,constructor:function(a){this.map=a.map;this.callParent(arguments)},generateWmsProxyQuery:function(a,b){var c=Ext.create("portal.map.Point",{latitude:a.get("lat"),longitude:a.get("lng")}),d=new OpenLayers.LonLat(c.getLongitude(),c.getLatitude()),d=d.transform("EPSG:4326","EPSG:3857"),c=this.map.getTileInformationForPoint(c),e=a.get("layer"),f=0;e.get("sourceType")==portal.layer.Layer.KNOWN_LAYER&&(f=e.get("source").get("feature_count"));
var e=a.get("onlineResource"),g=e.get("name"),h=e.get("url"),k=c.getTileBounds(),k=Ext.util.Format.format("{0},{1},{2},{3}",k.eastBoundLongitude,k.northBoundLatitude,k.westBoundLongitude,k.southBoundLatitude),l=this.generateSLDParams(a,b),d=Ext.Object.merge({serviceUrl:h,lat:d.lat,lng:d.lon,QUERY_LAYERS:g,x:c.getOffset().x,y:c.getOffset().y,BBOX:k,WIDTH:c.getWidth(),HEIGHT:c.getHeight(),INFO_FORMAT:b,version:e.get("version"),feature_count:f},l),d=Ext.Object.toQueryString(d);return Ext.urlAppend("wmsMarkerPopup.do",
d)},generateSLDParams:function(a,b){var c=!1,d=null;a.get("layer").get("filterer").getParameters().postMethod&&(c=a.get("layer").get("filterer").getParameters().postMethod);var e=a.get("onlineResource").get("applicationProfile");e&&-1<e.indexOf("Esri:ArcGIS Server")?(c=!1,b=b?b:"text/xml"):a.get("layer").get("renderer").sld_body&&(d=a.get("layer").get("renderer").sld_body,1200<d.length&&(c=!0,console.log("You really should not be using this method if the queryis going be long as it generates a GET spring request to and there are limitation to the lenght of a URI in GET method")),
b=b?b:"application/vnd.ogc.gml/3.1.1");return{postMethod:c,SLD_BODY:d,INFO_FORMAT:b}},query:portal.util.UnimplementedFunction});Ext.define("portal.layer.querier.QuerierFactory",{map:null,constructor:function(a){this.map=a.map;this.callParent(arguments)},buildFromKnownLayer:portal.util.UnimplementedFunction,buildFromCswRecord:portal.util.UnimplementedFunction});
Ext.define("portal.layer.querier.QueryTarget",{extend:"Ext.data.Model",fields:[{name:"id",type:"string"},{name:"lat",type:"float"},{name:"lng",type:"float"},{name:"onlineResource",type:"auto"},{name:"layer",type:"auto"},{name:"explicit",type:"boolean"},{name:"cswRecord",type:"auto"}]});
Ext.define("portal.layer.querier.QueryTargetHandler",{_infoWindowHeight:350,_infoWindowWidth:600,constructor:function(a){a.infoWindowHeight&&(this._infoWindowHeight=a.infoWindowHeight);a.infoWindowWidth&&(this._infoWindowWidth=a.infoWindowWidth);this.callParent(arguments)},_showLoadMask:function(a){a&&(a._showCount||(a._showCount=0),0===a._showCount++&&a.show())},_hideLoadMask:function(a){a&&0===--a._showCount&&a.hide()},_queryCallback:function(a,b,c,d,e){this._hideLoadMask(e);if(b&&0!==b.length){a=
this._infoWindowWidth;e=this._infoWindowHeight;for(var f=0;f<b.length;f++)if(b[f].overrideInfoWindowSize){a=b[f].overrideInfoWindowSize.width;e=b[f].overrideInfoWindowSize.height;break}f=Ext.create("portal.map.Point",{latitude:c.get("lat"),longitude:c.get("lng")});d.openInfoWindow(f,a,e,b,c.get("layer"))}},_handleWithQuery:function(a,b){for(var c=new Ext.LoadMask({msg:"Loading...",target:b.container}),d=0;d<a.length;d++){var e=a[d],f=e.get("layer").get("querier");this._showLoadMask(c);f.query(e,Ext.bind(this._queryCallback,
this,[b,c],!0))}},_handleWithSelection:function(a,b){for(var c=[],d=null,e=0;e<a.length;e++){var f=a[e].get("cswRecord"),g=a[e].get("onlineResource");if(f){var d=Ext.create("portal.map.Point",{latitude:a[e].get("lat"),longitude:a[e].get("lng")}),h=f.get("name"),f=portal.util.ProviderNameTransformer.abbreviateName(f.get("contactOrg")),h=h+(" - "+f);120<h.length&&(h=h.substr(0,120)+"...");f=void 0;switch(g?g.get("type"):""){case portal.csw.OnlineResource.WFS:case portal.csw.OnlineResource.WCS:case portal.csw.OnlineResource.OPeNDAP:f=
"data";break;default:f="portrayal"}c.push({text:h,queryTarget:a[e],iconCls:f,listeners:{click:Ext.bind(function(a,b){this._handleWithQuery([a],b)},this,[a[e],b])}})}}0!==c.length&&null!==d&&(c=Ext.create("Ext.menu.Menu",{id:"querytargethandler-selection-menu",header:{xtype:"header",titlePosition:0,title:"Please select a query source",cls:"x-panel-header-light"},autoWidth:!0,closable:!0,margin:"0 0 10 0",enableScrolling:!0,items:c}),b.showContextMenuAtLatLng(d,c))},handleQueryTargets:function(a,b){var c=
Ext.getCmp("querytargethandler-selection-menu");c&&c.destroy();if(b&&0!==b.length){for(var c=[],d=0;d<b.length;d++)b[d].get("explicit")&&c.push(b[d]);1<c.length?this._handleWithSelection(c,a):1===c.length?this._handleWithQuery(c,a):this._handleWithQuery(b,a)}}});
Ext.define("portal.widgets.panel.recordpanel.RecordPanel",{extend:"Ext.panel.Panel",xtype:"recordpanel",statics:{LAZY_LOAD_ID:"lazy-load"},config:{allowReordering:!1,store:null,titleField:"name",titleIndex:0,tools:null,childPanelGenerator:Ext.emptyFn,lazyLoadChildPanel:!1},toolFieldMap:null,recordRowMap:null,recordGroupMap:null,constructor:function(a){var b=a.store.isGrouped();this.recordRowMap={};this.recordGroupMap={};Ext.apply(a,{layout:{type:"accordion",hideCollapseTool:!b,collapseFirst:!0,fill:!1,
multi:b},items:[{xtype:"panel",itemId:"emptytext",collapsed:!1,header:{hidden:!0},html:a.emptyText}],autoScroll:!0,plugins:["collapsedaccordian"]});this.callParent(arguments);this._generateToolFieldMap();this.store.on({update:this.onStoreUpdate,load:this.onStoreLoad,clear:this.onStoreLoad,beforeload:this.onStoreBeforeLoad,filterchange:this.onStoreFilterChange,add:this.onStoreAdd,remove:this.onStoreRemove,scope:this});if(this.rendered)this._initDDZones();else this.on({afterrender:{fn:this._initDDZones,
scope:this,options:{single:!0}}});this.on({show:this.onComponentShow,scope:this});this.store.getCount()&&(b=null,b=this.store.isFiltered()?this.store.getData().getSource().getRange():this.store.getData().getRange(),this.onStoreLoad(this.store,b,!0))},_getPrimaryField:function(a){return Ext.isArray(a.field)?a.field[0]:a.field},_initDDZones:function(){var a=this;if(a.allowReordering&&!a.store.isGrouped()){var b=this.getEl();a.ddGroup=Ext.id(void 0,"recordpanel-dd-");a.dragZone=new Ext.dd.DragZone(b,
{ddGroup:this.ddGroup,getDragData:function(b){var d=Ext.fly(b.target);d.hasCls("recordrowpanel")||(d=d.up(".recordrowpanel"));if(d){b=d.getXY();var e=Ext.getCmp(d.dom.id),e=a.store.getById(e.recordId),d=d.down(".x-panel-header"),d=d.dom,f=d.cloneNode(!0);f.id=Ext.id();return{ddel:f,sourceEl:d,repairXY:b,source:a,draggedRecord:e}}},getRepairXY:function(){return this.dragData.repairXY}});this.dropTarget=new Ext.dd.DropTarget(b,{ddGroup:a.ddGroup,notifyDrop:function(b,d,e){b=!1;Ext.isNumber(a.lastDDInsertionIdx)&&
(e=e.draggedRecord,b=a.store.indexOf(e),d=a.lastDDInsertionIdx,b<d&&d--,b!==d&&(a.store.remove(e,!0),a.store.insert(d,e),a.fireEvent("reorder",a,e,d,b)),b=!0);a._clearDropTarget();return b},notifyOver:function(b,d,e){var f=d.getX(),g=d.getY();b=e.source.getEl().query(".recordrowpanel",!1);var h=!1;a._clearDropTarget();Ext.each(b,function(b,c){var d=b.getBox(),e=0;d=f<d.x||f>=d.x+d.width||g<d.y||g>=d.y+d.height?0:g<d.y+d.height/2?-1:1;if(e=d)return 0>e?b.addCls("recordpanel-insertabove"):b.addCls("recordpanel-insertbelow"),
h=!0,a.lastDDHighlight=b,a.lastDDInsertionIdx=0>e?c:c+1,!1});return h?Ext.dd.DropZone.prototype.dropAllowed:!1},notifyOut:function(b,d,e){a._clearDropTarget()}})}},_clearDropTarget:function(){this.lastDDHighlight&&(this.lastDDHighlight.removeCls("recordpanel-insertabove"),this.lastDDHighlight.removeCls("recordpanel-insertbelow"),this.lastDDInsertionIdx=this.lastDDHighlight=null)},_generateToolFieldMap:function(){this.toolFieldMap={};Ext.each(this.tools,function(a){a.toolId=Ext.id(null,"recordpanel-tool-");
var b=a.field;Ext.isArray(b)||(b=[b]);Ext.each(b,function(b){Ext.isEmpty(this.toolFieldMap[b])?this.toolFieldMap[b]=[a]:this.toolFieldMap[b].push(a)},this)},this)},_eachGroup:function(a,b){this.items.each(function(c){c instanceof portal.widgets.panel.recordpanel.GroupPanel&&a.call(b,c)})},_eachRow:function(a,b){this.store.isGrouped()?this._eachGroup(function(c){c.items.each(function(c){c instanceof portal.widgets.panel.recordpanel.RowPanel&&a.call(b,c)})}):this.items.each(function(c){c instanceof
portal.widgets.panel.recordpanel.RowPanel&&a.call(b,c)})},_clickMarshaller:function(a,b,c){b=a.get(b);c.call(this,b,a)},_installToolTips:function(a){var b=this.store.getById(a.recordId);a.tipMap={};Ext.each(this.tools,function(c){var d=this._getPrimaryField(c);a.tipMap[c.toolId]=Ext.create("Ext.tip.ToolTip",{target:a.getHeader().down("#"+c.toolId).getEl(),trackMouse:!0,listeners:{beforeshow:function(a){var f=c.tipRenderer(b.get(d),b,a);a.update(f)}}})},this);a.on("destroy",function(a){for(var b in a.tipMap)a.tipMap[b].destroy();
a.tipMap={}})},_generateRecordRowConfig:function(a,b){var c=[];Ext.each(this.tools,function(b){var d=this._getPrimaryField(b),e=a.get(d),f=Ext.isEmpty(b.clickHandler)?null:Ext.bind(this._clickMarshaller,this,[a,d,b.clickHandler],!1),d=Ext.isEmpty(b.doubleClickHandler)?null:Ext.bind(this._clickMarshaller,this,[a,d,b.doubleClickHandler],!1);c.push({itemId:b.toolId,stopEvent:b.stopEvent,clickHandler:f,doubleClickHandler:d,icon:b.iconRenderer(e,a)})},this);var d=a.getId(),e=Ext.id(null,"record-row-");
this.recordRowMap[d]=e;var f=null,f=this.lazyLoadChildPanel?{xtype:"container",itemId:portal.widgets.panel.recordpanel.RecordPanel.LAZY_LOAD_ID}:this.childPanelGenerator?this.childPanelGenerator(a):null;return{xtype:"recordrowpanel",recordId:d,itemId:e,title:a.get(this.titleField),titleIndex:this.titleIndex,groupMode:b,tools:c,record:a,items:f?[f]:null,listeners:{scope:this,afterrender:this._installToolTips,beforeexpand:function(a){if(this.lazyLoadChildPanel){var b=a.down("#"+portal.widgets.panel.recordpanel.RecordPanel.LAZY_LOAD_ID);
b&&(a.remove(b),this.childPanelGenerator&&a.add(this.childPanelGenerator(a.record)))}}}}},_generateGrouped:function(a){var b=[];this.store.getGroups().each(function(c){var d=[];Ext.each(c.items,function(b){var c=null===a||void 0===a;c||Ext.each(a,function(a){if(a.getId()===b.getId())return c=!0,!1});c&&d.push(this._generateRecordRowConfig(b,!1))},this);if(!Ext.isEmpty(d))if(c=c.getConfig().groupKey,Ext.isEmpty(this.recordGroupMap[c])){var e=Ext.id(null,"record-group-");this.recordGroupMap[c]=e;b.push({xtype:"recordgrouppanel",
title:c,itemId:e,items:d,groupKey:c})}else c=this.queryById(this.recordGroupMap[c]),c.add(d),c.refreshTitleCount()},this);this.add(b)},_generateUnGrouped:function(a,b){var c=[],d=function(a){c.push(this._generateRecordRowConfig(a,!0))};null===a||void 0===a?this.store.each(d,this):Ext.each(a,d,this);Ext.isNumber(b)?this.insert(b,c):this.add(c)},_updateEmptyText:function(){var a=0;this.store.isGrouped()?this._eachGroup(function(b){b.isVisible()&&a++}):this._eachRow(function(b){b.isVisible()&&a++});
this.down("#emptytext").setHidden(0!==a)},onComponentShow:function(a){this._updateEmptyText()},onStoreUpdate:function(a,b,c,d,e){if(this.items.getCount()){var f={},g=!1;Ext.each(d,function(a){Ext.isEmpty(this.toolFieldMap[a])||Ext.each(this.toolFieldMap[a],function(a){f[a.toolId]=a;g=!0},this)},this);if(g&&(a=this.recordRowMap[b.getId()],a=this.down("#"+a)))for(var h in f)d=f[h],e=this._getPrimaryField(d),c=a.down("#"+h),d=d.iconRenderer(b.get(e),b),c.setSrc(d)}},onStoreBeforeLoad:function(a,b){this.rendered&&
(this.loadMask||(this.loadMask=new Ext.LoadMask({msg:"Loading...",target:this})),this.loadMask.show())},onStoreFilterChange:function(a,b){this.getLayout().suspendAnimations();Ext.suspendLayouts();this._eachRow(function(b){var d=0>a.find("id",b.recordId);b.setHidden(d)},this);this._eachGroup(function(a){a.refreshTitleCount();a.visibleItemCount?a.setHidden(!1):a.setHidden(!0)});Ext.resumeLayouts();this.getLayout().resumeAnimations();this._updateEmptyText()},onStoreLoad:function(a){this.loadMask&&this.loadMask.hide();
for(var b=this.items.getCount()-1;0<=b;b--){var c=this.items.getAt(b);c instanceof portal.widgets.panel.recordpanel.AbstractChild&&this.remove(c)}this.recordRowMap={};this.recordGroupMap={};a.isGrouped()?this._generateGrouped():this._generateUnGrouped();this._updateEmptyText()},onStoreAdd:function(a,b,c){this.getLayout().suspendAnimations();Ext.suspendLayouts();a.isGrouped()?this._generateGrouped(b):this._generateUnGrouped(b,c+1);Ext.resumeLayouts();this.getLayout().resumeAnimations();this.doLayout();
this._updateEmptyText()},onStoreRemove:function(a,b,c,d){this.getLayout().suspendAnimations();Ext.suspendLayouts();Ext.each(b,function(b){b=b.getId();var c=this.queryById(this.recordRowMap[b]);if(a.isGrouped()){var d=c.ownerCt;d.getItemId();delete this.recordRowMap[b];d.remove(c);1>=d.items.getCount()?(delete this.recordGroupMap[d.groupKey],this.remove(d)):d.refreshTitleCount()}else delete this.recordRowMap[b],this.remove(c)},this);Ext.resumeLayouts();this.getLayout().resumeAnimations();this.doLayout();
this._updateEmptyText()},expandRecordById:function(a){this._eachRow(function(b){b.recordId===a&&(this.store.isGrouped()&&b.ownerCt.expand(),b.expand())})}});
Ext.define("portal.widgets.grid.column.RenderableCheckColumn",{extend:"Ext.ux.CheckColumn",alias:"widget.renderablecheckcolumn",getCustomValueBool:portal.util.UnimplementedFunction,setCustomValueBool:portal.util.UnimplementedFunction,constructor:function(a){a.getCustomValueBool&&(this.getCustomValueBool=a.getCustomValueBool);a.setCustomValueBool&&(this.setCustomValueBool=a.setCustomValueBool);this.callParent(arguments)},processEvent:function(a,b,c,d,e,f){if("mousedown"===a||"keydown"===a&&(f.getKey()===
f.ENTER||f.getKey()===f.SPACE)){var g=b.panel.store.getAt(d),h=this.dataIndex,k=g.get(h);checked=!this.getCustomValueBool(this,k,g);this.setCustomValueBool(this,checked,g);g.afterEdit(h);this.fireEvent("checkchange",this,d,checked);return!1}return this.callParent(arguments)},renderer:function(a,b,c,d,e,f,g){b=g.getHeaderAtIndex(e);return this.callParent([b.getCustomValueBool(b,a,c)])}});
Ext.define("portal.layer.renderer.RenderDebuggerData",{extend:"portal.util.ObservableMap",constructor:function(a){this.callParent(arguments)},updateResponse:function(a,b){this.setParameter(a,b)},renderHtml:function(){var a="\x3cbr/\x3e",b=0;for(i in this.parameters){var c=this.parameters[i];Ext.isString(c)||(c="");c=c.replace(/</g,"\x26lt;");b+=1;a+="\x3cb\x3e"+i+"\x3c/b\x3e\x3cbr/\x3e "+c+"\x3cbr/\x3e\x3cbr/\x3e"}0===b&&(a+="No information has yet been recorded...");return a+"\x3cbr/\x3e"}});
Ext.define("portal.layer.renderer.Renderer",{extend:"Ext.util.Observable",map:null,visible:!1,hasData:!1,proxyUrl:"",proxyCountUrl:"",parentLayer:null,renderDebuggerData:null,renderStatus:null,primitiveManager:null,constructor:function(a){this.listeners=a.listeners;this.map=a.map;this.parentLayer=a.parentLayer;this.primitiveManager=this.map.makePrimitiveManager();this.renderStatus=Ext.create("portal.layer.renderer.RenderStatus",{});this.renderDebuggerData=Ext.create("portal.layer.renderer.RenderDebuggerData",
{});this.callParent(arguments)},displayData:portal.util.UnimplementedFunction,abortDisplay:portal.util.UnimplementedFunction,getLegend:portal.util.UnimplementedFunction,removeData:portal.util.UnimplementedFunction,getVisible:function(){return this.visible},setVisible:function(a){this.visible=a;this.fireEvent("visibilitychanged",this,a)},getHasData:function(){return this.hasData},setHasData:function(a){this.hasData=a},getProxyUrl:function(){return this.proxyUrl},getProxyCountUrl:function(){return this.proxyCountUrl},
getRendererDebuggerData:function(){return this.renderDebuggerData},setVisibility:function(a){this.primitiveManager.setVisibility(a)}});Ext.define("portal.layer.renderer.RendererFactory",{map:null,constructor:function(a){this.map=a.map;this.callParent(arguments)},buildFromKnownLayer:portal.util.UnimplementedFunction,buildFromCswRecord:portal.util.UnimplementedFunction,buildFromKMLRecord:portal.util.UnimplementedFunction});
Ext.define("portal.layer.renderer.RenderStatus",{extend:"portal.util.ObservableMap",constructor:function(a){this.callParent(arguments)},updateResponse:function(a,b){this.setParameter(a,b)},initialiseResponses:function(a,b){for(var c={},d=0;d<a.length;d++)c[a[d]]=b;this.setParameters(c,!0)},renderHtml:function(){var a=0,b='\x3cdiv class\x3d"auscope-servicestatus-grid"\x3e\x3ctable\x3e\x3ctr\x3e\x3ctd\x3eRequest Status\x3c/td\x3e\x3c/tr\x3e';for(i in this.parameters)this.parameters[i].toString().match("function")||
(a++,b=1<=i.length?b+("\x3ctr\x3e\x3ctd\x3e"+i+" - "+this.parameters[i]+"\x3c/td\x3e\x3c/tr\x3e"):b+("\x3ctr\x3e\x3ctd\x3e"+this.parameters[i]+"\x3c/td\x3e\x3c/tr\x3e"));return 0===a?"No status has been recorded":b+"\x3c/table\x3e\x3c/div\x3e"}});
Ext.define("portal.widgets.grid.plugin.RowContextMenu",{alias:"plugin.rowcontextmenu",_grid:null,_contextMenu:null,constructor:function(a){this._contextMenu=a.contextMenu;this.callParent(arguments)},init:function(a){this._grid=a;a.getView().on("itemcontextmenu",this._onContextMenu,this)},_onContextMenu:function(a,b,c,d,e,f){e.stopEvent();this._grid.getSelectionModel().isSelected(b)||this._grid.getSelectionModel().select([b]);this._contextMenu.showAt(e.getXY());return!1}});
Ext.define("portal.widgets.grid.plugin.RowExpanderContainer",{extend:"Ext.grid.plugin.RowExpander",alias:"plugin.rowexpandercontainer",generateContainer:portal.util.UnimplementedFunction,allowMultipleOpen:!1,recordIdProperty:null,rowBodyTpl:null,storedHtml:null,recordStatus:null,generationRunning:!1,toggleColIndexes:null,baseId:"RowExpanderContainer",expandOnEnter:!1,constructor:function(a){this.callParent(arguments);this.toggleColIndexes=Ext.isArray(a.toggleColIndexes)?a.toggleColIndexes:null;this.allowMultipleOpen=
a.allowMultipleOpen?!0:!1;this.storedHtml={};this.recordStatus={};a.recordIdProperty&&(this.recordIdProperty=a.recordIdProperty);a.baseId&&(this.baseId=a.baseId);this.rowBodyTpl='\x3cdiv id\x3d"'+this.baseId+"-{[values."+(this.recordIdProperty?this.recordIdProperty:"id")+".toString().replace(/[^0-9A-Za-z\\-]/g,'-')]}\"\x3e\x3c/div\x3e"},addExpander:function(a){},init:function(a){this.callParent(arguments);var b=a.getView();this.view=b;this.grid=a;b.on("expandbody",this.onExpandBody,this);b.on("collapsebody",
this.onCollapseBody,this);b.on("cellclick",this.onCellClick,this);b.on("groupexpand",this.onGroupExpand,this);b.on("groupcollapse",this.onGroupExpand,this);b.on("refresh",this.onRefresh,this);b.on("itemupdate",this.restoreRowContainer,this);b.on("resize",this.onResize,this);a.getStore().on("clear",function(a){this._hardReset()},this)},_hardReset:function(){for(id in this.recordStatus){var a=this.recordStatus[id];a&&a.container&&a.container.destroy()}this.storedHtml={};this.recordStatus={}},_getId:function(a,
b){var c;c=this.recordIdProperty?a.get(this.recordIdProperty).toString():a.id.toString();b&&(c=c.replace(/[^0-9A-Za-z\\-]/g,"-"));return c},getStoreRecord:function(a){return this.grid.getStore().getById(a)},restorationRequired:function(a){var b=this._getId(a);if(!(b in this.recordStatus&&this.recordStatus[b].expanded))return!1;b=this.view.getRow(a);return!b||Ext.DomQuery.selectNode("#"+this.baseId+"-"+this._getId(a,!0),b.parentNode).hasChildNodes()?!1:!0},getRecordsForGroup:function(a){return(a=this.grid.getStore().getGroups()[a])?
a.children:[]},onExpandBody:function(a,b,c){if(!this.allowMultipleOpen)for(openId in this.recordStatus)this.recordStatus[openId].expanded&&(a=this.getStoreRecord(openId),c=this.view.getRow(a),null!==c&&this.toggleRow(c,a));this.recordStatus[this._getId(b)]={expanded:!0,container:null};this.restoreRowContainer(b)},onCollapseBody:function(a,b,c){this.recordStatus[this._getId(b)].expanded=!1},onCellClick:function(a,b,c,d,e,f){Ext.isArray(this.toggleColIndexes)&&!Ext.Array.contains(this.toggleColIndexes,
c)||this.toggleRow(f,d)},onResize:function(){for(openId in this.recordStatus)this.recordStatus[openId].expanded&&this.recordStatus[openId].container&&this.recordStatus[openId].container.updateLayout({defer:!1,isRoot:!1})},onGroupExpand:function(a,b,c,d){a=this.grid.getStore().getRange();var e=this;Ext.each(a,function(a){e.restoreRowContainer(a)})},onRefresh:function(a){var b=this.grid.getStore(),c,d;for(c=0;c<b.data.items.length;c++)if(d=a.getRow(c))d=b.getAt(c),this.restoreRowContainer(d)},restoreRowContainer:function(a){if(!0!==
this.generationRunning){this.generationRunning=!0;if(this.restorationRequired(a)){var b=this.baseId+"-"+this._getId(a,!0),b=this.generateContainer(a,b,this.grid);if(this.recordStatus[this._getId(a)].container)try{this.recordStatus[this._getId(a)].container.destroy()}catch(c){console.log("Error destroying parent container:",c)}this.recordStatus[this._getId(a)].container=b;this.recordStatus[this._getId(a)].container.updateLayout({defer:!1,isRoot:!1})}this.generationRunning=!1}}});
Ext.define("portal.widgets.panel.recordpanel.RowPanel",{extend:"portal.widgets.panel.recordpanel.AbstractChild",xtype:"recordrowpanel",config:{titleIndex:0,tools:null},constructor:function(a){var b=[];Ext.each(a.tools,function(c,e){var f="5",g="5";0==e&&(f="0");e==a.tools.length-1&&(g="0");b.push({xtype:"image",itemId:c.itemId,width:16,height:16,margin:Ext.util.Format.format("0 {0} 0 {1}",g,f),src:c.icon,plugins:[{ptype:"clickableimage",stopEvent:!!c.stopEvent}],listeners:{click:Ext.isEmpty(c.clickHandler)?
Ext.emptyFn:c.clickHandler,dblclick:Ext.isEmpty(c.doubleClickHandler)?Ext.emptyFn:c.doubleClickHandler}})});var c=a.title;delete a.tools;delete a.title;Ext.apply(a,{layout:"fit",border:!0,cls:"recordrowpanel",bodyStyle:{"border-color":"#ededed"},margin:"0 0 0 0",header:{titlePosition:Ext.isNumber(a.titleIndex)?a.titleIndex:0,border:!1,cls:"recordrowpanelheader",style:{"background-color":"white","border-color":"#ededed"},items:b,padding:"8 0 8 0",height:30,title:{text:c,margin:"0 0 0 10",style:{"font-size":"13px",
"font-weight":"normal",color:"#000000"}}}});this.callParent(arguments)}});
Ext.define("portal.widgets.grid.plugin.SelectableGrid",{alias:"plugin.selectablegrid",_grid:null,constructor:function(a){this.callParent(arguments)},init:function(a){this._grid=a;var b=a.getView();a.getStore();b.on("itemadd",this._makeRecordsSelectable,this);b.on("viewready",function(a){this._makeNodesSelectable(a.getNodes(),!0)},this);a.on("afterlayout",function(a){a.getView().viewReady&&this._makeRecordsSelectable(a.getStore().getRange())},this)},_makeRecordsSelectable:function(a){for(var b=this._grid.getView(),
c=0;c<a.length;c++){var d=b.getNode(a[c]);this._makeNodesSelectable(d,!0)}},_makeNodesSelectable:function(a,b){Ext.isArray(a)||(a=[a]);for(var c=0;c<a.length;c++)b?Ext.fly(a[c]).selectable():Ext.fly(a[c]).unselectable()}});
Ext.define("portal.util.permalink.serializers.SerializerV0",{extend:"portal.util.permalink.serializers.BaseSerializer",getVersion:function(){return 0},deserialize:function(a,b){Ext.JSON.decode(a);for(var c=serializationObj.mapState,d=serializationObj.activeLayers,e=0;e<d.length;e++)if(Ext.isDefined(d[e].opacity)&&(d[e].filter||(d[e].filter={}),d[e].filter.opacity=d[e].opacity,d[e].opacity=void 0),Ext.isArray(d[e].onlineResources))for(var f=0;f<d[e].onlineResources.length;f++)d[e].onlineResources[f].type=
d[e].onlineResources[f].onlineResourceType,d[e].onlineResources[f].onlineResourceType=void 0;b({mapState:c,serializedLayers:d})}});
Ext.define("portal.util.permalink.serializers.SerializerV1",{extend:"portal.util.permalink.serializers.BaseSerializer",getVersion:function(){return 1},deserialize:function(a,b){for(var c=Ext.JSON.decode(a),d=c.m,c=c.a,d={center:{lng:d.n,lat:d.a},zoom:d.z},e=0;e<c.length;e++){var f=void 0;if(Ext.isArray(c[e].r))for(var f=[],g=0;g<c[e].r.length;g++)f.push({url:c[e].r[g].u,type:c[e].r[g].o,name:c[e].r[g].n,description:c[e].r[g].d});(g=c[e].f)||(g={});Ext.isDefined(c[e].o)&&(g.opacity=c[e].o);this.serializedLayers.push({source:c[e].s,
filter:g,visible:c[e].v,id:c[e].i,onlineResources:f})}b({mapState:d,serializedLayers:[]})}});
Ext.define("portal.util.permalink.serializers.SerializerV2",{extend:"portal.util.permalink.serializers.BaseSerializer",getVersion:function(){return 2},serialize:function(a,b,c){a={m:{a:a.center.lat,n:a.center.lng,z:a.zoom},a:[]};for(var d=0;d<b.length;d++){var e=void 0;if(Ext.isArray(b[d].onlineResources))for(var f=b[d].onlineResources,e=[],g=0;g<f.length;g++)e.push({u:f[g].url,o:f[g].type,n:f[g].name,d:f[g].description});a.a.push(this.createSerializedObject(b[d],e))}c(Ext.JSON.encode(a))},deserialize:function(a,
b){for(var c=Ext.JSON.decode(a),d=c.m,c=c.a,d={center:{lng:d.n,lat:d.a},zoom:d.z},e=[],f=0;f<c.length;f++){var g=void 0;if(Ext.isArray(c[f].r))for(var g=[],h=0;h<c[f].r.length;h++)g.push({url:c[f].r[h].u,type:c[f].r[h].o,name:c[f].r[h].n,description:c[f].r[h].d});e.push(this.createDeSerializedObject(c[f],g))}b({mapState:d,serializedLayers:e})},createDeSerializedObject:function(a,b){return{source:a.s,filter:a.f,visible:a.v,id:a.i,onlineResources:b}},createSerializedObject:function(a,b){return{s:a.source,
f:a.filter,v:a.visible,i:a.id,r:b}}});
Ext.define("portal.util.permalink.serializers.SerializerV3",{extend:"portal.util.permalink.serializers.SerializerV2",getVersion:function(){return 3},serialize:function(a,b,c){this.callParent([a,b,function(a){LZMA.compress(a,"1",function(a){c(String.fromCharCode.apply(String,a))})}])},deserialize:function(a,b){for(var c=[],d=0;d<a.length;d++)c.push(a.charCodeAt(d));LZMA.decompress(c,Ext.bind(function(a,c){c.call(this,a,function(a){b(a)})},this,[portal.util.permalink.serializers.SerializerV2.prototype.deserialize],!0))}});
Ext.define("portal.util.permalink.serializers.SerializerV4",{extend:"portal.util.permalink.serializers.SerializerV3",getVersion:function(){return 4},createDeSerializedObject:function(a,b){return{source:a.s,filter:a.f,visible:a.v,id:a.i,customlayer:a.c,onlineResources:b}},createSerializedObject:function(a,b){return{s:a.source,f:a.filter,v:a.visible,i:a.id,c:a.customlayer,r:b}}});Ext.ns("portal.util.xml.SimpleDOM");portal.util.xml.SimpleDOM.XML_NODE_ELEMENT=1;
portal.util.xml.SimpleDOM.XML_NODE_ATTRIBUTE=2;portal.util.xml.SimpleDOM.XML_NODE_TEXT=3;portal.util.xml.SimpleDOM.getNodeLocalName=function(a){return a.localName?a.localName:a.baseName};portal.util.xml.SimpleDOM.getClassList=function(a){return a.classList?a.classList:a["class"]?a["class"].split(" "):a.className?a.className.split(" "):[]};
portal.util.xml.SimpleDOM.isLeafNode=function(a){for(var b=!0,c=0;c<a.childNodes.length&&b;c++)b=a.childNodes[c].nodeType!==portal.util.xml.SimpleDOM.XML_NODE_ELEMENT;return b};portal.util.xml.SimpleDOM.filterNodeArray=function(a,b,c,d){for(var e=[],f=0;f<a.length;f++){var g=a[f];b&&g.nodeType!==b||c&&c!==g.namespaceURI||d&&d!==portal.util.xml.SimpleDOM.getNodeLocalName(g)||e.push(g)}return e};
portal.util.xml.SimpleDOM.getMatchingChildNodes=function(a,b,c){return portal.util.xml.SimpleDOM.filterNodeArray(a.childNodes,portal.util.xml.SimpleDOM.XML_NODE_ELEMENT,b,c)};portal.util.xml.SimpleDOM.getMatchingAttributes=function(a,b,c){return portal.util.xml.SimpleDOM._filterNodeArray(a.attributes,portal.util.xml.SimpleDOM.XML_NODE_ATTRIBUTE,b,c)};portal.util.xml.SimpleDOM.getNodeTextContent=function(a){return a.textContent?a.textContent:a.text};
portal.util.xml.SimpleDOM.parseStringToDOM=function(a){navigator.userAgent.match(/Trident.*rv[ :]*11\./);var b=null;if(window.DOMParser)b=(new DOMParser).parseFromString(a,"text/xml");else if(window.ActiveXObject)b=new ActiveXObject("Microsoft.XMLDOM"),b.async="false",b.loadXML(a);else return null;return b};
Ext.define("portal.layer.querier.wfs.factories.SimpleFactory",{extend:"portal.layer.querier.wfs.factories.BaseFactory",constructor:function(a){this.callParent(arguments)},supportsNode:function(a){return!0},parseNode:function(a,b){var c=this._createTreeNode(a),d=portal.util.xml.SimpleXPath.evaluateXPathString(a,"@gml:id"),e=this;this._parseXmlTree(a,c);c.expanded=!0;if(1==c.children.length)for(var f=c.children[0];f&&!(f.expanded=!0,1<f.children.length);)f=f.children[0];return Ext.create("portal.layer.querier.BaseComponent",
{layout:"fit",tabTitle:d,height:300,items:[{xtype:"treepanel",autoScroll:!0,rootVisible:!0,root:c}],buttons:[{xtype:"button",text:"Download Feature",iconCls:"download",handler:function(){var c=e._makeFeatureRequestUrl(b,a.nodeName,d);portal.util.FileDownloader.downloadFile("downloadGMLAsZip.do",{serviceUrls:c})}}]})},_createTreeNode:function(a){var b=null;if(portal.util.xml.SimpleDOM.isLeafNode(a))b=portal.util.xml.SimpleDOM.getNodeTextContent(a),b={text:a.tagName+" \x3d "+b,children:[],leaf:!0};
else{b=a.tagName;if(0<a.attributes.length){for(var b=b+"(",c=0;c<a.attributes.length;c++)b+=" "+a.attributes[c].nodeName+"\x3d"+a.attributes[c].value;b+=")"}b={text:b,children:[],leaf:!0}}return b},_parseXmlTree:function(a,b){var c=[];Ext.each(a.childNodes,function(a){if(a.nodeType==portal.util.xml.SimpleDOM.XML_NODE_ELEMENT){var e=this._createTreeNode(a);b.leaf=!1;b.children.push(e);c.push(b);this._parseXmlTree(a,e)}},this);return c}});Ext.ns("portal.util.xml.SimpleXPath");
portal.util.xml.SimpleXPath.XPATH_STRING_TYPE=window.XPathResult?XPathResult.STRING_TYPE:0;portal.util.xml.SimpleXPath.XPATH_UNORDERED_NODE_ITERATOR_TYPE=window.XPathResult?XPathResult.UNORDERED_NODE_ITERATOR_TYPE:1;
portal.util.xml.SimpleXPath.evaluateXPath=function(a,b,c,d){if(a.evaluate)return a.evaluate(c,b,a.createNSResolver(b),d,null);(a=XPath.selectNodes(c,b))||(a=[]);switch(d){case portal.util.xml.SimpleXPath.XPATH_STRING_TYPE:return d=null,0<a.length&&(d=portal.util.xml.SimpleDOM.getNodeTextContent(a[0])),{stringValue:d};case portal.util.xml.SimpleXPath.XPATH_UNORDERED_NODE_ITERATOR_TYPE:return{_arr:a,_i:0,iterateNext:function(){return this._i>=this._arr.length?null:this._arr[this._i++]}}}throw"Unrecognised resultType";
};portal.util.xml.SimpleXPath.evaluateXPathNodeArray=function(a,b){var c=a.ownerDocument,d=null;try{d=portal.util.xml.SimpleXPath.evaluateXPath(c,a,b,portal.util.xml.SimpleXPath.XPATH_UNORDERED_NODE_ITERATOR_TYPE)}catch(e){return[]}for(var c=[],f=d.iterateNext();f;)c.push(f),f=d.iterateNext();return c};portal.util.xml.SimpleXPath.evaluateXPathString=function(a,b){return portal.util.xml.SimpleXPath.evaluateXPath(a.ownerDocument,a,b,portal.util.xml.SimpleXPath.XPATH_STRING_TYPE).stringValue};
Ext.define("portal.map.Size",{config:{width:0,height:0},constructor:function(a){this.callParent(arguments);this.setWidth(a.width);this.setHeight(a.height)}});Ext.define("portal.map.TileInformation",{config:{width:0,height:0,offset:{x:0,y:0},tileBounds:null},constructor:function(a){this.callParent(arguments);this.setWidth(a.width);this.setHeight(a.height);this.setOffset(a.offset);this.setTileBounds(a.tileBounds)}});
Ext.define("portal.util.UnimplementedFunction",{singleton:!0},function(){portal.util.UnimplementedFunction=function(){window.console&&(console.error("The following function is calling an Unimplemented function with Arguments: ",arguments),console.error(arguments.callee.caller.toString()));throw"NotImplemented";}});
Ext.define("portal.util.URL",{singleton:!0},function(){Ext.isString(window.WEB_CONTEXT)||(window.WEB_CONTEXT="/"+window.location.pathname.substring(1).split("/")[0]);portal.util.URL.base=window.location.protocol+"//"+window.location.host+WEB_CONTEXT+"/";portal.util.URL.extractHost=function(a){a=/^(?:ftp|https?):\/\/(?:[^@:\/]*@)?([^:\/]+)/.exec(a);return!a||2>a.length?"":a[1]};portal.util.URL.extractHostNSubDir=function(a,b){var c=document.createElement("a");c.href=a;var d=("/"==c.pathname.charAt(0)?
c.pathname:"/"+c.pathname).split("/"),e=c.hostname;if(b&&1<d.length){for(c=1;c<=b&&c<d.length;c++)e=e+"/"+d[c];return e}return c.hostname}});
Ext.define("portal.layer.downloader.coverage.WCSDownloader",{extend:"portal.layer.downloader.Downloader",constructor:function(a){this.callParent(arguments)},downloadData:function(a,b,c,d){c=portal.csw.OnlineResource.getFilteredFromArray(b,portal.csw.OnlineResource.WCS);b=portal.csw.OnlineResource.getFilteredFromArray(b,portal.csw.OnlineResource.FTP);b=0<b.length?b[0].get("url"):"";this.showWCSDownload(c[0].get("url"),c[0].get("name"),a.get("renderer").map,b)},showWCSDownload:function(a,b,c,d){var e=
c.getVisibleMapBounds();me=this;portal.util.Ajax.request({url:"describeCoverage.do",timeout:18E4,params:{serviceUrl:a,layerName:b},failure:function(a){Ext.Msg.alert("Error Describing Coverage","ERROR: "+a)},success:function(c,g){if(0===c.length)Ext.Msg.alert("Error Describing Coverage","The URL "+a+" returned no parsable DescribeCoverage records");else{var h=c[0];h.temporalDomain||(h.temporalDomain=[]);h.spatialDomain||(h.spatialDomain={envelopes:[],rectifiedGrid:null});for(var k=0;k<h.temporalDomain.length;k++)"timePosition"===
h.temporalDomain[k].type?h.temporalDomain[k].timePosition.time&&(h.temporalDomain[k].timePosition=new Date(h.temporalDomain[k].timePosition)):"timePeriod"===h.temporalDomain[k].type&&(h.temporalDomain[k].beginPosition.time&&(h.temporalDomain[k].beginPosition=new Date(h.temporalDomain[k].beginPosition)),h.temporalDomain[k].endPosition.time&&(h.temporalDomain[k].endPosition=new Date(h.temporalDomain[k].endPosition)));for(k=0;k<h.supportedRequestCRSs.length;k++)h.supportedRequestCRSs[k]=[h.supportedRequestCRSs[k]];
for(k=0;k<h.supportedResponseCRSs.length;k++)h.supportedResponseCRSs[k]=[h.supportedResponseCRSs[k]];for(k=0;k<h.supportedFormats.length;k++)h.supportedFormats[k]=[h.supportedFormats[k]];var l=[{xtype:"hidden",name:"layerName",value:b},{xtype:"hidden",name:"serviceUrl",value:a}],m=function(a,b,c){void 0===c&&(c=0);for(var d=0;d<a.items.length;d++){var e=a.items.get(d);"fieldset"==e.getXType()?m(e,b,c+1):e.setDisabled(b)}};e.eastBoundLongitude=portal.util.BBox.datelineCorrection(e.eastBoundLongitude,
"EPSG:4326");0<h.spatialDomain.envelopes.length&&l.push(new Ext.form.FieldSet({id:"bboxFldSet",title:"Bounding box constraint",checkboxToggle:!0,checkboxName:"usingBboxConstraint",defaultType:"textfield",bodyStyle:"padding: 0 0 0 50px",listeners:{expand:{scope:this,fn:function(a,b){m(a,!1)}},collapse:{scope:this,fn:function(a,b){m(a,!0)}}},items:[{id:"northBoundLatitude",xtype:"numberfield",fieldLabel:"Latitude (North)",value:e.northBoundLatitude,name:"northBoundLatitude",allowBlank:!1,anchor:"-50"},
{id:"southBoundLatitude",xtype:"numberfield",fieldLabel:"Latitude (South)",value:e.southBoundLatitude,name:"southBoundLatitude",allowBlank:!1,anchor:"-50"},{id:"eastBoundLongitude",xtype:"numberfield",fieldLabel:"Longitude (East)",value:e.eastBoundLongitude,name:"eastBoundLongitude",allowBlank:!1,anchor:"-50"},{id:"westBoundLongitude",xtype:"numberfield",fieldLabel:"Longitude (West)",value:e.westBoundLongitude,name:"westBoundLongitude",allowBlank:!1,anchor:"-50"}]}));if(0<h.temporalDomain.length&&
"timePosition"===h.temporalDomain[0].type){for(var n=[],k=0;k<h.temporalDomain.length;k++)n.push({boxLabel:h.temporalDomain[k].timePosition.format("Y-m-d H:i:s T"),name:"timePosition",inputValue:h.temporalDomain[k].timePosition.format("Y-m-d H:i:s T")+"GMT"});l.push(new Ext.form.FieldSet({id:"timePositionFldSet",title:"Time Position Constraints",checkboxToggle:!0,checkboxName:"usingTimePositionConstraint",defaultType:"textfield",bodyStyle:"padding: 0 0 0 50px",allowBlank:!1,listeners:{expand:{scope:this,
fn:function(a,b){m(a,!1)}},collapse:{scope:this,fn:function(a,b){m(a,!0)}}},items:{xtype:"radiogroup",fieldLabel:"Time Positions",columns:1,items:n}}))}0<h.temporalDomain.length&&"timePeriod"===h.temporalDomain[0].type&&l.push(new Ext.form.FieldSet({id:"timePeriodFldSet",title:"Time Period Constraints",checkboxToggle:!0,checkboxName:"usingTimePeriodConstraint",defaultType:"textfield",bodyStyle:"padding: 0 0 0 50px",listeners:{expand:{scope:this,fn:function(a,b){m(a,!1)}},collapse:{scope:this,fn:function(a,
b){m(a,!0)}}},items:[{id:"dateFrom",xtype:"datefield",fieldLabel:"Date From",name:"dateFrom",format:"Y-m-d",allowBlank:!1,value:h.temporalDomain[0].beginPosition,anchor:"-50",submitValue:!1},{id:"timeFrom",xtype:"timefield",fieldLabel:"Time From",name:"timeFrom",format:"H:i:s",allowBlank:!1,value:h.temporalDomain[0].beginPosition.format("H:i:s"),anchor:"-50",submitValue:!1},{id:"dateTo",xtype:"datefield",fieldLabel:"Date To",name:"dateTo",format:"Y-m-d",allowBlank:!1,value:h.temporalDomain[0].endPosition,
anchor:"-50",submitValue:!1},{id:"timeTo",xtype:"timefield",fieldLabel:"Time To",name:"timeTo",format:"H:i:s",allowBlank:!1,value:h.temporalDomain[0].endPosition.format("H:i:s"),anchor:"-50",submitValue:!1}]}));var t=[];if(h.rangeSet.axisDescriptions&&0<h.rangeSet.axisDescriptions.length)for(k=0;k<h.rangeSet.axisDescriptions.length;k++){var q=h.rangeSet.axisDescriptions[k];if(q.values&&0<q.values.length&&"singleValue"===q.values[0].type){q.componentId="axis-constraint-"+k;q.type="singleValue";q.checkBoxName=
"axis-constraint-"+k;q.checkBoxId="axis-constraint-"+k+"-chkboxgrp";for(var n=[],p=0;p<q.values.length;p++)n.push({id:q.checkBoxName+"-"+p,boxLabel:q.values[p].value,name:q.checkBoxName,inputValue:q.values[p].value});l.push(new Ext.form.FieldSet({id:q.componentId,title:"Parameter '"+q.label+"' Constraints",checkboxToggle:!0,defaultType:"textfield",bodyStyle:"padding: 0 0 0 50px",allowBlank:!1,listeners:{expand:{scope:this,fn:function(a,b){m(a,!1)}},collapse:{scope:this,fn:function(a,b){m(a,!0)}}},
items:{id:q.checkBoxId,xtype:"radiogroup",constraintName:q.name,fieldLabel:q.label,columns:3,items:n,submitValue:!1}}));t.push(q)}}l.push(new Ext.form.FieldSet({id:"outputDimSpec",title:"Output dimension specifications",items:[{id:"radiogroup-outputDimensionType",xtype:"radiogroup",columns:2,fieldLabel:"Type",items:[{id:"radioHeightWidth",boxLabel:"Width/Height",name:"outputDimensionsType",inputValue:"widthHeight",checked:!0,listeners:{check:function(a,b){var c=Ext.getCmp("widthHeightFieldSet");c.setVisible(b);
m(c,!b)}}},{id:"radioResolution",boxLabel:"Resolution",name:"outputDimensionsType",inputValue:"resolution",checked:!1,listeners:{check:function(a,b){var c=Ext.getCmp("resolutionFieldSet");c.setVisible(b);m(c,!b)}}}]},{id:"widthHeightFieldSet",xtype:"fieldset",hideLabel:!0,hideBorders:!0,items:[{id:"outputWidth",xtype:"numberfield",fieldLabel:"Width",value:"256",name:"outputWidth",anchor:"-50",allowBlank:!1,allowDecimals:!1,allowNegative:!1},{id:"outputHeight",xtype:"numberfield",fieldLabel:"Height",
value:"256",name:"outputHeight",anchor:"-50",allowBlank:!1,allowDecimals:!1,allowNegative:!1}]},{id:"resolutionFieldSet",xtype:"fieldset",hideLabel:!0,hideBorders:!0,disabled:!0,hidden:!0,items:[{id:"outputResX",xtype:"numberfield",fieldLabel:"X Resolution",value:"1",name:"outputResX",anchor:"-50",allowBlank:!1,disabled:!0,allowNegative:!1},{id:"outputResY",xtype:"numberfield",fieldLabel:"Y Resolution",value:"1",name:"outputResY",anchor:"-50",allowBlank:!1,disabled:!0,allowNegative:!1}]}]}));var r=
new Ext.data.ArrayStore({fields:["format"],data:h.supportedFormats}),n=new Ext.data.ArrayStore({fields:["crs"],data:h.supportedResponseCRSs}),s=new Ext.data.ArrayStore({fields:["crs"],data:h.supportedRequestCRSs}),q="";if(h.nativeCRSs&&0<h.nativeCRSs.length)for(k=0;k<h.nativeCRSs.length;k++)0<q.length&&(q+=","),q+=h.nativeCRSs[k];l.push(new Ext.form.FieldSet({id:"downloadOptsFldSet",title:"Download options",defaultType:"textfield",bodyStyle:"padding: 0 0 0 50px",items:[{xtype:"textfield",id:"nativeCrs",
name:"nativeCrs",fieldLabel:"Native CRS",emptyText:"Not specified",value:q,disabled:!0,anchor:"-50",submitValue:!1},{xtype:"combo",id:"inputCrs",name:"inputCrs",fieldLabel:"Reference System",labelAlign:"right",emptyText:"",forceSelection:!0,allowBlank:!1,mode:"local",store:s,typeAhead:!0,triggerAction:"all",displayField:"crs",anchor:"-50",valueField:"crs",listeners:{render:function(a){0<s.getTotalCount()&&a.setValue(s.getAt(0).get("crs"))}}},{xtype:"combo",id:"downloadFormat",name:"downloadFormat",
fieldLabel:"Format",labelAlign:"right",forceSelection:!0,mode:"local",triggerAction:"all",store:r,typeAhead:!0,allowBlank:!1,displayField:"format",anchor:"-50",valueField:"format",listeners:{render:function(a){for(k=0;k<r.getTotalCount();k++)"NetCDF3"===r.getAt(k).get("format")&&a.setValue(r.getAt(k).get("format"))}}},{xtype:"combo",id:"outputCrs",name:"outputCrs",fieldLabel:"Output CRS",labelAlign:"right",emptyText:"",forceSelection:!0,mode:"local",triggerAction:"all",store:n,typeAhead:!0,displayField:"crs",
anchor:"-50",valueField:"crs"}]}));(new Ext.Window({id:"wcsDownloadWindow",border:!0,layout:"fit",resizable:!0,modal:!0,plain:!1,buttonAlign:"right",title:"Layer: "+b,height:600,width:500,items:[{xtype:"panel",layout:"fit",autoScroll:!0,bodyStyle:"background-color: transparent;",items:[{id:"wcsDownloadFrm",xtype:"form",layout:"form",frame:!1,autoHeight:!0,autoWidth:!0,axisConstraints:t,defaults:{xtype:"fieldset",layout:"form"},items:l}],buttons:[{xtype:"button",text:"Download",handler:function(){if(me.validateWCSInfoWindow()){var a=
"./downloadWCSAsZip.do?"+me.getWCSInfoWindowDownloadParameters()+(d?"\x26"+Ext.Object.toQueryString({ftpURL:d}):"");portal.util.FileDownloader.downloadFile(a)}}}]}]})).show()}}})},getWCSInfoWindowDownloadParameters:function(){var a=Ext.getCmp("wcsDownloadFrm"),b=a.getForm().getValues(!0),c="",d=Ext.getCmp("dateFrom"),e=Ext.getCmp("dateTo"),f=Ext.getCmp("timeFrom"),g=Ext.getCmp("timeTo");d&&e&&f&&g&&!(d.disabled||e.disabled||f.disabled||g.disabled)&&(d=d.getValue().format("Y-m-d")+" "+f.getValue(),
e=e.getValue().format("Y-m-d")+" "+g.getValue(),c+="\x26timePeriodFrom\x3d"+escape(d),c+="\x26timePeriodTo"+escape(e));if((a=a.initialConfig.axisConstraints)&&0<a.length)for(e=0;e<a.length;e++)"singleValue"===a[e].type&&(g=Ext.getCmp(a[e].checkBoxId),(d=g.getValue())&&!d.disabled&&(c+="\x26customParamValue\x3d"+escape(g.initialConfig.constraintName+"\x3d"+d.initialConfig.inputValue)));return b+c},validateWCSInfoWindow:function(){var a=Ext.getCmp("wcsDownloadFrm").getForm(),b=Ext.getCmp("timePositionFldSet"),
c=Ext.getCmp("timePeriodFldSet"),d=Ext.getCmp("bboxFldSet");if(!a.isValid())return Ext.Msg.alert("Invalid Fields","One or more fields are invalid"),!1;a=b&&!b.collapsed;c=c&&!c.collapsed;return d&&!d.collapsed||a||c?a&&c?(Ext.Msg.alert("Too many temporal","You may only specify a single temporal constraint"),!1):!0:(Ext.Msg.alert("No Constraints","You must specify at least one spatial or temporal constraint"),!1)}});
Ext.define("portal.layer.querier.coverage.WCSQuerier",{extend:"portal.layer.querier.Querier",constructor:function(a){this.callParent(arguments)},_generateErrorComponent:function(a){return Ext.create("portal.layer.querier.BaseComponent",{html:Ext.util.Format.format('\x3cp class\x3d"centeredlabel"\x3e{0}\x3c/p\x3e',a)})},statics:{_parseArrayToString:function(a,b){if(!a||0===a.length)return"";b||(b=function(a){return a});for(var c="",d=0;d<a.length;d++)c+=b(a[d]),a[d+1]&&(c+="\x3cbr/\x3e");return c}},
query:function(a,b){var c=a.get("cswRecord").get("onlineResources"),d=portal.csw.OnlineResource.getFilteredFromArray(c,portal.csw.OnlineResource.OPeNDAP);portal.util.Ajax.request({url:"describeCoverage.do",timeout:18E4,params:{serviceUrl:a.get("onlineResource").get("url"),layerName:a.get("onlineResource").get("name")},scope:this,callback:function(e,f,g){e&&f?e&&(e=f[0],e=Ext.create("portal.layer.querier.BaseComponent",{overrideInfoWindowSize:{width:600,height:400},layout:"fit",items:[{xtype:"fieldset",
border:!1,autoScroll:!0,labelWidth:75,layout:"anchor",items:[{xtype:"displayfield",fieldLabel:"name",value:e.name},{xtype:"displayfield",fieldLabel:"Description",value:e.description},{xtype:"displayfield",fieldLabel:"Label",value:e.label},{xtype:"displayfield",fieldLabel:"Supported Request CRSs",value:portal.layer.querier.coverage.WCSQuerier._parseArrayToString(e.supportedRequestCRSs)},{xtype:"displayfield",fieldLabel:"Supported Response CRSs",value:portal.layer.querier.coverage.WCSQuerier._parseArrayToString(e.supportedResponseCRSs)},
{xtype:"displayfield",fieldLabel:"Supported Formats",value:portal.layer.querier.coverage.WCSQuerier._parseArrayToString(e.supportedFormats)},{xtype:"displayfield",fieldLabel:"Supported Interpolation",value:portal.layer.querier.coverage.WCSQuerier._parseArrayToString(e.supportedInterpolations)},{xtype:"displayfield",fieldLabel:"WMS URLs",value:a.get("onlineResource").get("name")+"-"+a.get("onlineResource").get("url")},{xtype:"displayfield",fieldLabel:"Spatial Domain",value:portal.layer.querier.coverage.WCSQuerier._parseArrayToString(e.spatialDomain.envelopes,
function(a){var b="";"Envelope"===a.type||"EnvelopeWithTimePeriod"===a.type?(b=b+"["+("E"+a.eastBoundLongitude+", "),b+="W"+a.westBoundLongitude+", ",b+="N"+a.northBoundLatitude+", ",b+="S"+a.southBoundLatitude,b+="]"):b+=a.type;return b})}]}],buttonAlign:"right",buttons:[{text:"Download WCS",iconCls:"download",handler:function(){var b=a.get("layer"),c=b.get("downloader"),d=b.get("filterer").clone();c.downloadData(b,b.getAllOnlineResources(),d,void 0)}},{text:"Download OPeNDAP",iconCls:"download",
hidden:0===d.length,handler:function(){Ext.create("portal.layer.downloader.coverage.OPeNDAPDownloader",{map:this.map}).downloadData(a.get("layer"),c,null,null)}}]}),b(this,[e],a)):b(this,[this._generateErrorComponent("There was a problem when looking up the coverage: "+g)],a)}})}});
Ext.define("portal.layer.downloader.wfs.WFSDownloader",{extend:"portal.layer.downloader.Downloader",statics:{DOWNLOAD_CURRENTLY_VISIBLE:1,DOWNLOAD_ORIGINALLY_VISIBLE:2,DOWNLOAD_ALL:3},currentTooltip:null,constructor:function(a){this.callParent(arguments)},downloadData:function(a,b,c,d){var e=this,f=!1,g=null,h=null,g=c.getSpatialParam(),h=d.getSpatialParam(),f=g&&h&&!g.equals(h);Ext.create("Ext.Window",{title:"Download Options",buttonAlign:"right",width:550,height:200,modal:!0,layout:{type:"anchor"},
buttons:[{text:"Download",iconCls:"download",handler:function(f){f=f.ownerCt.ownerCt;switch(f.items.getAt(1).items.getAt(0).getChecked()[0].inputValue){case portal.layer.downloader.wfs.WFSDownloader.DOWNLOAD_CURRENTLY_VISIBLE:e._doDownload(a,d,b);break;case portal.layer.downloader.wfs.WFSDownloader.DOWNLOAD_ORIGINALLY_VISIBLE:e._doDownload(a,c,b);break;default:Ext.Object.isEmpty(c.getParameters())?Ext.Object.isEmpty(d.getParameters())||e._doDownload(a,d,b):e._doDownload(a,c,b)}f.close()}}],items:[{xtype:"label",
anchor:"100%",style:"font-size: 12px;",text:"The portal will make a download request on your behalf and return the results in a ZIP archive. How would you like the portal to filter your download?"},{xtype:"fieldset",anchor:"100%",layout:"fit",border:0,items:[{xtype:"radiogroup",columns:[500,18],listeners:{change:Ext.bind(this._handleRadioChange,this,[h,g],!0)},items:[{boxLabel:"Filter my download using the current visible map bounds.",name:"wfs-download-radio",inputValue:portal.layer.downloader.wfs.WFSDownloader.DOWNLOAD_CURRENTLY_VISIBLE,
hidden:!f||Ext.Object.isEmpty(h),checked:f},{xtype:"box",autoEl:{tag:"img",src:"portal-core/img/magglass.gif",qtip:"Click to display the spatial bounds, double click to pan the map so they are visible."},width:18,height:21,hidden:!f||Ext.Object.isEmpty(h),style:"padding:3px 0px 0px 0px;",listeners:{render:Ext.bind(this._configureImageClickHandlers,this,[h],!0)}},{boxLabel:"Filter my download using the original bounds that were used to load the layer.",name:"wfs-download-radio",inputValue:portal.layer.downloader.wfs.WFSDownloader.DOWNLOAD_ORIGINALLY_VISIBLE,
checked:!f&&!Ext.Object.isEmpty(g),hidden:Ext.Object.isEmpty(g)},{xtype:"box",autoEl:{tag:"img",src:"portal-core/img/magglass.gif",qtip:"Click to display the spatial bounds, double click to pan the map so they are visible."},width:18,height:21,style:"padding:3px 0px 0px 0px;",hidden:Ext.Object.isEmpty(g),listeners:{render:Ext.bind(this._configureImageClickHandlers,this,[g],!0)}},{boxLabel:"Don't filter my download. Return all available data.",name:"wfs-download-radio",inputValue:portal.layer.downloader.wfs.WFSDownloader.DOWNLOAD_ALL,
checked:!f&&Ext.Object.isEmpty(g)}]}]}]}).show()},_configureImageClickHandlers:function(a,b,c){a.getEl().on("click",Ext.bind(function(a){this.map.highlightBounds(a)},this,[c],!1),a);a.getEl().on("dblclick",Ext.bind(function(a){this.map.scrollToBounds(a)},this,[c],!1),a)},_handleRadioChange:function(a,b,c,d,e,f){switch(b["wfs-download-radio"]){case portal.layer.downloader.wfs.WFSDownloader.DOWNLOAD_CURRENTLY_VISIBLE:this.map.scrollToBounds(e);break;case portal.layer.downloader.wfs.WFSDownloader.DOWNLOAD_ORIGINALLY_VISIBLE:this.map.scrollToBounds(f)}},
_doDownload:function(a,b,c){var d={serviceUrls:[]};a=(a=a.get("renderer").getProxyUrl())&&0<a.length?a:"getAllFeatures.do";a=portal.util.URL.base+a+"?";c=portal.csw.OnlineResource.getFilteredFromArray(c,portal.csw.OnlineResource.WFS);for(var e=0;e<c.length;e++)if(!(b.parameters.serviceFilter&&0<b.parameters.serviceFilter.length&&c[e].get("url")!=b.parameters.serviceFilter[0])){var f=c[e].get("url"),g=c[e].get("name"),h=b.getParameters();h.serviceUrl=f;h.typeName=g;h.maxFeatures=0;d.serviceUrls.push(Ext.urlEncode(h,
a))}portal.util.FileDownloader.downloadFile("downloadGMLAsZip.do",d)}});
Ext.define("portal.layer.querier.wfs.featuresources.WFSFeatureByPropertySource",{extend:"portal.layer.querier.wfs.FeatureSource",property:null,value:null,constructor:function(a){this.property=a.property;this.value=a.value;this.callParent(arguments)},getFeature:function(a,b,c,d){portal.util.Ajax.request({url:"requestFeatureByProperty.do",params:{serviceUrl:c,typeName:b,property:this.property,value:this.value?this.value:a},callback:function(e,f){if(e){var g=portal.util.xml.SimpleDOM.parseStringToDOM(f.gml);
if(g){var h=portal.util.xml.SimpleDOM.getMatchingChildNodes(g.documentElement,"http://www.opengis.net/gml","featureMember");0===h.length&&(h=portal.util.xml.SimpleDOM.getMatchingChildNodes(g.documentElement,"http://www.opengis.net/gml","featureMembers"));0===h.length||0===h[0].childNodes.length?d(null,a,b,c):d(h[0].childNodes[0],a,b,c)}else d(null,a,b,c)}else d(null,a,b,c)}})}});
Ext.define("portal.layer.querier.wfs.featuresources.WFSFeatureSource",{extend:"portal.layer.querier.wfs.FeatureSource",extraParams:null,constructor:function(a){this.extraParams=a.extraParams?a.extraParams:{};this.callParent(arguments)},getFeature:function(a,b,c,d){if(a&&b&&c){var e=Ext.apply({},this.extraParams);Ext.apply(e,{serviceUrl:c,typeName:b,featureId:a});portal.util.Ajax.request({url:"requestFeature.do",params:e,callback:function(e,g){if(e){var h=portal.util.xml.SimpleDOM.parseStringToDOM(g.gml);
if(h){var k=portal.util.xml.SimpleDOM.getMatchingChildNodes(h.documentElement,"http://www.opengis.net/gml","featureMember");0===k.length&&(k=portal.util.xml.SimpleDOM.getMatchingChildNodes(h.documentElement,"http://www.opengis.net/gml","featureMembers"));0===k.length||0===k[0].childNodes.length?d(null,a,b,c):d(k[0].childNodes[0],a,b,c)}else d(null,a,b,c)}else d(null,a,b,c)}})}else d(null,a,b,c)}});
Ext.define("portal.layer.legend.wfs.WFSLegend",{extend:"portal.layer.legend.Legend",iconUrl:"",constructor:function(a){this.iconUrl=a.iconUrl;this.callParent(arguments)},getLegendComponent:function(a,b,c,d,e){c="\x3ctable\x3e";d=portal.csw.OnlineResource.getFilteredFromArray(a,portal.csw.OnlineResource.WFS);c+='\x3ctr\x3e\x3ctd\x3e\x3cimg height\x3d"16" width\x3d"16" src\x3d"'+this.iconUrl+'"\x3e\x3ctd\x3e\x3ctd\x3e'+d[0].get("name")+"\x3ctd\x3e\x3ctr\x3e";c=Ext.create("Ext.form.Panel",{title:"WFS Feature",
layout:"fit",width:250,html:c+"\x3c/table"});e(this,a,b,!0,c)},getLegendIconHtml:function(a,b){return this.iconUrl&&0<this.iconUrl.length?Ext.DomHelper.markup({tag:"div",style:"text-align:center;",children:[{tag:"img",width:16,height:16,align:"CENTER",src:this.iconUrl}]}):""}});
Ext.define("portal.layer.querier.wfs.WFSQuerier",{extend:"portal.layer.querier.Querier",featureSource:null,constructor:function(a){this.featureSource=a.featureSource?a.featureSource:Ext.create("portal.layer.querier.wfs.featuresources.WFSFeatureSource",{});this.parser=a.parser?a.parser:Ext.create("portal.layer.querier.wfs.Parser",{});this.knownLayerParser=a.knownLayerParser?a.knownLayerParser:Ext.create("portal.layer.querier.wfs.KnownLayerParser",{});this.callParent(arguments)},_generateErrorComponent:function(a){return Ext.create("portal.layer.querier.BaseComponent",
{html:Ext.util.Format.format('\x3cp class\x3d"centeredlabel"\x3e{0}\x3c/p\x3e',a)})},query:function(a,b){var c=a.get("id"),d=a.get("onlineResource"),e=a.get("layer"),f=d.get("name"),g=d.get("url"),h=a.get("onlineResource").get("applicationProfile"),k=null;e.get("sourceType")===portal.layer.Layer.KNOWN_LAYER&&(k=e.get("source"));var l=this;this.featureSource.getFeature(c,f,g,function(c,f,g,q){c?(f=[],f.push(l.parser.parseNode(c,d.get("url"),h)),k&&l.knownLayerParser.canParseKnownLayerFeature(a.get("id"),
k,d,e)&&(c=l.knownLayerParser.parseKnownLayerFeature(a.get("id"),k,d,e))&&f.push(c),b(l,f,a)):b(l,[l._generateErrorComponent(Ext.util.Format.format('There was a problem when looking up the feature with id "{0}"',f))],a)})}});
Ext.define("portal.layer.querier.wfs.WFSWithMapQuerier",{extend:"portal.layer.querier.Querier",featureSource:null,constructor:function(a){this.featureSource=a.featureSource?a.featureSource:Ext.create("portal.layer.querier.wfs.featuresources.WFSFeatureSource",{});this.parser=a.parser?a.parser:Ext.create("portal.layer.querier.wfs.Parser",{});this.knownLayerParser=a.knownLayerParser?a.knownLayerParser:Ext.create("portal.layer.querier.wfs.KnownLayerParser",{});this.callParent(arguments)},_generateErrorComponent:function(a){return Ext.create("portal.layer.querier.BaseComponent",
{html:Ext.util.Format.format('\x3cp class\x3d"centeredlabel"\x3e{0}\x3c/p\x3e',a)})},query:function(a,b){var c=a.get("onlineResource");"WMS"===c.get("type")?this._checkGml32(a,b,this):"WFS"==c.get("type")&&this._handleWFSQuery(a,b)},_checkGml32:function(a,b,c){var d=a.get("onlineResource").get("url");Ext.Ajax.request({url:"checkGml32.do",timeout:18E4,scope:this,params:{serviceUrl:d},callback:function(d,f,g){f&&"true"==g.responseText?this._handleWFSQueryWithBbox(a,b,c):this._handleWMSQuery(a,b,c)}})},
_handleWMSQuery:function(a,b,c){c=a.get("onlineResource").get("applicationProfile");var d=a.get("onlineResource"),e=d.get("name"),f=d.get("url"),g=f;if(c&&-1<c.indexOf("Esri:ArcGIS Server"))for(var h=a.get("cswRecord").get("onlineResources"),k=0;k<h.length;k++)if("WFS"==h[k].get("type")){g=h[k].get("url");break}k=Ext.create("portal.map.Point",{latitude:a.get("lat"),longitude:a.get("lng")});h=new OpenLayers.LonLat(k.getLongitude(),k.getLatitude());h=h.transform("EPSG:4326","EPSG:3857");k=this.map.getTileInformationForPoint(k);
a.get("layer");var l=k.getTileBounds(),l=Ext.util.Format.format("{0},{1},{2},{3}",l.eastBoundLongitude,l.northBoundLatitude,l.westBoundLongitude,l.southBoundLatitude),m=this.generateSLDParams(a),d=Ext.Object.merge({serviceUrl:f,lat:h.lat,lng:h.lon,QUERY_LAYERS:e,x:k.getOffset().x,y:k.getOffset().y,BBOX:l,WIDTH:k.getWidth(),HEIGHT:k.getHeight(),version:d.get("version")},m),e="wmsMarkerPopup.do";a.get("layer").get("source").get("proxyGetFeatureInfoUrl")&&(e=a.get("layer").get("source").get("proxyGetFeatureInfoUrl"));
this._displayWMSPopup(e,d,a,c,g,b,!1)},_handleWFSQueryWithBbox:function(a,b,c){var d=a.get("onlineResource");c=d.get("name");for(var d=d.get("applicationProfile"),e,f=a.get("cswRecord").get("onlineResources"),g=0;g<f.length;g++)if("WFS"==f[g].get("type")){e=f[g].get("url");break}a.get("layer").get("filterer").getParameters().postMethod&&a.get("layer").get("filterer").getParameters();f=Ext.create("portal.util.BBox",{eastBoundLongitude:a.get("lng")-.1,westBoundLongitude:a.get("lng")+.1,northBoundLatitude:a.get("lat")+
.1,southBoundLatitude:a.get("lat")-.1});c=Ext.Object.merge({serviceUrl:e,typeName:c,bbox:Ext.JSON.encode(f),maxFeatures:50});this._displayWMSPopup("getAllGml32Features.do",c,a,d,e,b,!0)},_displayWMSPopup:function(a,b,c,d,e,f,g){Ext.Ajax.request({url:a,timeout:18E4,scope:this,params:b,method:"POST",callback:function(a,b,l){if(b)if(a=portal.util.xml.SimpleDOM.parseStringToDOM(l.responseText),g?b=portal.util.xml.SimpleDOM.getMatchingChildNodes(a.documentElement,"http://www.opengis.net/wfs/2.0","member"):
(b=portal.util.xml.SimpleDOM.getMatchingChildNodes(a.documentElement,"http://www.opengis.net/gml","featureMember"),0===b.length&&(b=portal.util.xml.SimpleDOM.getMatchingChildNodes(a.documentElement,"http://www.opengis.net/gml","featureMembers"))),0===b.length||0===b[0].childNodes.length)f(this,[],c);else{a=b[0].childNodes;b=[];l=c.get("layer");var m=null;l.get("sourceType")===portal.layer.Layer.KNOWN_LAYER&&(m=l.get("source"));for(var n=0;n<a.length;n++){var t=a[n],q=portal.util.xml.SimpleXPath.evaluateXPathString(t,
"@gml:id"),p=this;if(!t){f(p,[p._generateErrorComponent(Ext.util.Format.format('There was a problem when looking up the feature with id "{0}"',q))],c);return}var t=p.parser.parseNode(t,e,d),r=c.get("onlineResource");m&&p.knownLayerParser.canParseKnownLayerFeature(q,m,r,l)?(r=p.knownLayerParser.parseKnownLayerFeature(q,m,r,l))?(t.tabTitle&&(q=t.tabTitle),t.setTitle(t.tabTitle),r.setTitle(r.tabTitle),q=Ext.create("Ext.tab.Panel",{tabTitle:q,layout:"fit",items:[t,r]}),b.push(q)):b.push(t):b.push(t)}f(p,
b,c)}else f(this,[this._generateErrorComponent("There was an error when attempting to contact the remote WMS instance for information about this point.")],c)}})},_handleWFSQuery:function(a,b){var c=a.get("id"),d=a.get("onlineResource"),e=a.get("layer"),f=d.get("name"),g=d.get("url"),h=a.get("onlineResource").get("applicationProfile"),k=null;e.get("sourceType")===portal.layer.Layer.KNOWN_LAYER&&(k=e.get("source"));var l=this;this.featureSource.getFeature(c,f,g,function(c,f,g,q){c?(f=[],f.push(l.parser.parseNode(c,
d.get("url"),h)),k&&l.knownLayerParser.canParseKnownLayerFeature(a.get("id"),k,d,e)&&f.push(l.knownLayerParser.parseKnownLayerFeature(a.get("id"),k,d,e)),b(l,f,a)):b(l,[l._generateErrorComponent(Ext.util.Format.format('There was a problem when looking up the feature with id "{0}"',f))],a)})}});
Ext.define("portal.widgets.field.WMSCustomSearchField",{extend:"Ext.form.field.Text",alias:"widget.wmscustomsearchfield",hasSearch:!1,paramName:"query",initComponent:function(){this.setTriggers({clear:{cls:Ext.baseCSSPrefix+"form-clear-trigger",handler:function(){this.clearClick()}},search:{cls:Ext.baseCSSPrefix+"form-search-trigger",handler:function(){this.searchClick(!1)}}});this.callParent(arguments);this.on("specialkey",function(a,b){b.getKey()==b.ENTER&&this.searchClick(!1)},this)},afterRender:function(){this.callParent();
this.triggerCell.item(0).setDisplayed(!1)},clearClick:function(){var a=this.store,b=a.getProxy();this.hasSearch&&(this.setValue(""),b.extraParams[this.paramName]="",this._clearLayerStore(a),this.hasSearch=!1,this.triggerCell.item(0).setDisplayed(!1),this.updateLayout())},_clearLayerStore:function(a){a.query("active",!0).each(function(a){a.get("layer").removeDataFromMap()});a.removeAll()},searchClick:function(a){var b=this.store,c=b.getProxy(),d=this.getValue();this._clearLayerStore(b);c.extraParams[this.paramName]=
d;1==a&&(c.extraParams.weakCheck="Y");b.loadPage(1);b.on("load",function(a,b,c,h){portal.util.GoogleAnalytic.trackevent("Custom WMS Query","URL:"+d,"ResultCount:"+a.count(),a.count())},this);this.hasSearch=!0;this.triggerCell.item(0).setDisplayed(!0);this.updateLayout()}});
Ext.define("portal.layer.downloader.wms.WMSDownloader",{extend:"portal.layer.downloader.Downloader",constructor:function(a){this.callParent(arguments)},downloadData:function(a,b,c,d){var e=this,f=portal.csw.OnlineResource.getFilteredFromArray(b)[0];a=Ext.create("Ext.data.Store",{fields:["format"],proxy:{type:"ajax",url:"getLayerFormats.do",extraParams:{serviceUrl:f.get("url")},reader:{type:"json",rootProperty:"data"}},autoLoad:!0});Ext.create("Ext.Window",{title:"Download Options",buttonAlign:"right",
width:300,height:150,modal:!0,layout:{type:"vbox",align:"stretch"},buttons:[{text:"Download",iconCls:"download",handler:function(a){a=a.ownerCt.ownerCt;var b=a.items.getAt(1).getValue();if(b&&0!==b.length){var c=e.map.getVisibleMapBounds(),d=e.map.getMapSizeInPixels(),c=Ext.util.Format.format("{0},{1},{2},{3}",0>c.westBoundLongitude?parseInt(c.westBoundLongitude)+360:c.westBoundLongitude,c.southBoundLatitude,0>c.eastBoundLongitude?parseInt(c.eastBoundLongitude)+360:c.eastBoundLongitude,c.northBoundLatitude),
b=Ext.Object.toQueryString({request:"GetMap",service:"WMS",version:"1.1.1",layers:f.get("name"),format:b,styles:"",bgcolor:"0xFFFFFF",transparent:!0,srs:"EPSG:4326",bbox:c,width:d.getWidth(),height:d.getHeight()}),b=Ext.urlAppend(f.get("url"),b);portal.util.FileDownloader.downloadFile("downloadDataAsZip.do",{serviceUrls:[b],filename:"WMSDownload.zip"});a.close()}}}],items:[{xtype:"label",style:"font-size: 12px;",text:"What file format would you like to download this layer as?"},{xtype:"combo",anchor:"100%",
emptyText:"Please select a file format.",forceSelection:!0,queryMode:"remote",triggerAction:"all",typeAhead:!0,typeAheadDelay:500,store:a,displayField:"format",valueField:"format"}]}).show()}});
Ext.define("portal.layer.filterer.forms.WMSLayerFilterForm",{extend:"portal.layer.filterer.BaseFilterForm",constructor:function(a){var b=a.layer.get("filterer");b.getParameter("opacity")||b.setParameter("opacity",1,!0);Ext.apply(a,{border:!1,autoScroll:!1,hideMode:"offsets",width:"100%",labelAlign:"right",bodyStyle:"padding:5px",height:65,layout:"anchor",items:[{xtype:"fieldset",title:"WMS Properties",layout:"fit",height:"100%",items:[{xtype:"slider",fieldLabel:"Opacity",name:"opacity",minValue:0,
increment:.01,decimalPrecision:!1,maxValue:1,value:a.layer.get("filterer").getParameter("opacity"),listeners:{changecomplete:function(a,d){this.layer.get("source").get("active")&&b.setParameter("opacity",d)},scope:this}}]}]});this.callParent(arguments)}});
Ext.define("portal.layer.legend.wms.WMSLegend",{extend:"portal.layer.legend.Legend",iconUrl:"",constructor:function(a){this.iconUrl=a.iconUrl;this.callParent(arguments)},getLegendComponent:function(a,b,c,d,e,f,g){f=Ext.create("portal.layer.legend.wms.WMSLegendForm",{resources:a,filterer:b,sld_body:c,staticLegendUrl:f});e(this,a,b,!0,f);f.addLegends({resources:a,form:f,sld_body:c,isSld_body:d,tryGetCapabilitiesFirst:g})},getLegendIconHtml:function(a,b){return this.iconUrl&&0<this.iconUrl.length?Ext.DomHelper.markup({tag:"div",
style:"text-align:center;",children:[{tag:"img",width:16,height:16,align:"CENTER",src:this.iconUrl}]}):""},statics:{generateImageUrl:function(a,b,c,d,e,f,g,h){h=a.charAt(a.length-1);"?"!==h&&"\x26"!==h&&(a=-1==a.indexOf("?")?a+"?":a+"\x26");a+="REQUEST\x3dGetLegendGraphic\x26SERVICE\x3dWMS";a+="\x26VERSION\x3d"+c;a+="\x26FORMAT\x3dimage/png";a+="\x26HEIGHT\x3d25";a+="\x26BGCOLOR\x3d0xFFFFFF";a+="\x26LAYER\x3d"+escape(b);a+="\x26LAYERS\x3d"+escape(b);e&&(a+="\x26WIDTH\x3d"+e);f&&2E3>f.length&&(a=!0===
g?a+("\x26SLD_BODY\x3d"+escape(f)):a+("\x26SLD\x3d"+encodeURIComponent(f)),a+="\x26LEGEND_OPTIONS\x3dforceLabels:on;minSymbolSize:16");this.styles?a+="\x26STYLES\x3d"+escape(this.styles):d&&-1<d.indexOf("Esri:ArcGIS Server")&&(b=portal.util.xml.SimpleDOM.parseStringToDOM(f),a+="\x26STYLE\x3d"+b.getElementsByTagName("UserStyle")[0].getElementsByTagName("Name")[0].textContent);return a},generateLegendGraphicFromGetCapabilities:function(a,b,c,d,e,f,g,h,k){portal.util.Ajax.request({url:"getLegendURL.do",
timeout:3E4,params:{serviceUrl:a,wmsVersion:c,layerName:b},scope:this,success:function(a,b){k(a)},failure:function(l){l=portal.layer.legend.wms.WMSLegend.generateImageUrl(a,b,c,d,e,f,g,h);k(l)}})},generateLegendUrl:function(a,b,c,d,e,f,g,h,k,l){k?this.generateLegendGraphicFromGetCapabilities(a,b,c,d,e,f,g,h,l):(k=portal.layer.legend.wms.WMSLegend.generateImageUrl(a,b,c,d,e,f,g,h))?l(k):this.generateLegendGraphicFromGetCapabilities(a,b,c,d,e,f,g,h,l)}}});
Ext.define("portal.layer.legend.wms.WMSLegendForm",{extend:"portal.layer.legend.BaseComponent",staticLegendUrl:null,tryGetCapabilitiesFirst:!1,constructor:function(a){this.staticLegendUrl=a.staticLegendUrl;this.tryGetCapabilitiesFirst=a.tryGetCapabilitiesFirst;Ext.apply(a,{html:"\x3cp\x3e Waiting for Legend data ...\x3c/p\x3e"});this.callParent(arguments)},addLegends:function(a){var b=this,c={maxWidth:330,height:30};if(this.staticLegendUrl){var d='\x3ca target\x3d"_blank" href\x3d"'+this.staticLegendUrl+
'"\x3e',d=d+('\x3cimg onerror\x3d"this.alt\x3d\'There was an error loading this legend. Click here to try again in a new window or contact the data supplier.\'" alt\x3d"Loading legend..." src\x3d"'+this.staticLegendUrl+'"/\x3e'),d=d+"\x3c/a\x3e\x3cbr/\x3e\n";a.form.setData(d);b._setFormHeight(a.form,this.staticLegendUrl,c)}else if(a.sld_body&&0<a.sld_body.length&&2E3>a.sld_body.length)this.addStyledLegend(a);else for(var d=portal.csw.OnlineResource.getFilteredFromArray(a.resources,portal.csw.OnlineResource.WMS),
e={},c={maxWidth:330,height:30},f=0;f<d.length;f++){var g=d[f].get("applicationProfile"),h=this._determineWidth(g,a.sld_body);portal.layer.legend.wms.WMSLegend.generateLegendUrl(d[f].get("url"),d[f].get("name"),d[f].get("version"),g,h,a.sld_body,a.isSld_body,void 0,a.tryGetCapabilitiesFirst,function(d){if(!e.hasOwnProperty(d)){null===!d.match(/width/i)&&null!==d.match(/\?/)&&(d+="\x26WIDTH\x3d100");var f="";e[d]=1;Object.getOwnPropertyNames(e).sort().forEach(function(a,b,c){f+='\x3ca target\x3d"_blank" href\x3d"'+
a+'"\x3e';f+='\x3cimg onerror\x3d"this.alt\x3d\'There was an error loading this legend. Click here to try again in a new window or contact the data supplier.\'" alt\x3d"Loading legend..." src\x3d"'+a+'"/\x3e';f+="\x3c/a\x3e";f+="\x3cbr/\x3e\n"});a.form.setData(f);b._setFormHeight(a.form,d,c)}})}},addStyledLegend:function(a){var b=this,c=portal.csw.OnlineResource.getFilteredFromArray(a.resources,portal.csw.OnlineResource.WMS),d=[],e=0;for(e;e<c.length;e++){var f=c[e].get("applicationProfile"),g=this._determineWidth(f,
a.sld_body);portal.layer.legend.wms.WMSLegend.generateLegendUrl(c[e].get("url"),c[e].get("name"),c[e].get("version"),f,g,a.sld_body,a.isSld_body,void 0,b.tryGetCapabilitiesFirst,function(a){-1==d.indexOf(a)&&d.push(a)})}for(var h=!1,e=0;e<d.length&&!h;e++)c=d[e],f=new Image,f.onload=function(){if(0<this.height){var c;c=""+('\x3ca target\x3d"_blank" href\x3d"'+this.src+'"\x3e');c+='\x3cimg onerror\x3d"this.alt\x3d\'There was an error loading this legend. Click here to try again in a new window or contact the data supplier.\'" alt\x3d"Loading legend..." src\x3d"'+
this.src+'"/\x3e';a.form.setData(c+"\x3c/a\x3e");b._setStyledFormHeight(a.form,this);h=!0}},f.src=c},_setStyledFormHeight:function(a,b){var c,d;d=30+b.height;d+=.02*d;c=Math.max(330,b.width);a.setHeight(d);a.setWidth(c)},_setFormHeight:function(a,b,c){var d=new Image;d.onload=function(){c.height+=d.height;c.height+=.02*c.height;c.maxWidth=Math.max(c.maxWidth,d.width);a.setHeight(c.height);a.setWidth(c.maxWidth)};d.src=b},_determineWidth:function(a,b){return a&&-1<a.indexOf("Esri:ArcGIS Server")?300:
b?null:this.getWidth()}});Ext.define("records",{extend:"Ext.data.Model",fields:[{name:"field",type:"string"},{name:"value",type:"string"}]});
Ext.define("portal.layer.querier.wms.WMSMultipleTabDisplayQuerier",{extend:"portal.layer.querier.wms.WMSQuerier",constructor:function(a){this.callParent(arguments)},query:function(a,b){var c=this,d=this.generateWmsProxyQuery(a,"text/xml"),e=a.get("layer").get("name"),f=[];Ext.Ajax.request({url:d,timeout:18E4,scope:this,callback:function(d,h,k){h?(d=portal.util.xml.SimpleDOM.parseStringToDOM(k.responseText),d=(new OpenLayers.Format.WMSGetFeatureInfo).read_FeatureInfoResponse(d),c.populateFeatureFieldsDisplayArray(d,
f),c._drawFeatureFieldsTabs(e,f),b(c,[],a)):b(this,[this.generateErrorComponent("There was an error when attempting to contact the remote WMS instance for information about this point.")],a)}})},_getPopulatedStore:function(a){for(var b=Ext.create("Ext.data.Store",{model:"records"}),c=a.order,d=0;d<c.length;d++){var e=c[d];b.add([{field:e,value:a[e]}])}return b},_fieldNameMapping:function(a){var b=this.getFieldNameMappingMap();return b.hasOwnProperty(a)?b[a]:!1},_drawFeatureFieldsTabs:function(a,b){for(var c=
Ext.create("Ext.Window",{border:!0,layout:"fit",resizable:!1,modal:!0,plain:!1,title:a,constrain:!0,items:[{xtype:"tabpanel",activeItem:0,enableTabScroll:!0,buttonAlign:"center",items:[]}]}),d=c.items.getAt(0),e=0;e<b.length;e++){var f=this._getPopulatedStore(b[e]),g=b[e][this.getTabTitleMappedName()],f=Ext.create("Ext.grid.Panel",{store:f,width:860,hideHeaders:!0,columns:[{text:"Feature",dataIndex:"field",width:250,align:"right",renderer:function(a){return'\x3cspan style\x3d"font-size : 1.2 em; font-weight : bolder"\x3e'+
a+"\x3c/span\x3e"}},{text:"Value",dataIndex:"value",flex:!0,renderer:function(a){return 0==a.indexOf("http")?'\x3ca href\x3d"'+a+'" target\x3d"_blank"\x3e'+a+"\x3c/a\x3e":a},listeners:{delegate:"div a",click:function(a,b,c,d){c=d.innerText.trim();0===c.indexOf("http")&&portal.util.GoogleAnalytic.trackevent("QueryPanelLinkClick",a,b,c)},args:[a,g]}}]});d.add({title:g,items:[f]})}c.show()},getFieldNameMappingMap:portal.util.UnimplementedFunction,getTabTitleMappedName:portal.util.UnimplementedFunction,
populateFeatureFieldsDisplayArray:portal.util.UnimplementedFunction});
Ext.define("portal.map.openlayers.primitives.WMSOverlay",{extend:"portal.map.primitives.BaseWMSPrimitive",config:{wmsLayer:null},constructor:function(a){this.callParent(arguments);var b=null,c=a.layer.getCSWRecordsByResourceURL(a.wmsUrl),d=portal.csw.OnlineResource.getFilteredFromArray(c[0].get("onlineResources"),portal.csw.OnlineResource.WMS),e="1.1.1";0<d.length&&d[0].get("version")&&(e=d[0].get("version"));b="";0<d.length&&d[0].get("applicationProfile")&&(b=d[0].get("applicationProfile"));d=a.layer.get("source").get("singleTile");
c=this._getCSWBoundingBox(c);e={layers:this.getWmsLayer(),version:e,transparent:!0,exceptions:"BLANK",displayOutsideMaxExtent:!0};c={tileOptions:{},isBaseLayer:!1,projection:c.crs,maxExtent:c.bounds,tileOrigin:new OpenLayers.LonLat(-2.003750834E7,-2.003750834E7),displayInLayerSwitcher:!1};1==d&&(c.singleTile=!0,c.ratio=1);"Esri:ArcGIS Server"!==b&&(c.tileOptions.maxGetUrlLength=1500);this.getSld_body()&&0<this.getSld_body().length&&(e.sld_body=this.getSld_body(),e.styles=this._getStylesFromSLD(b),
e.tiled=!0);b=new OpenLayers.Layer.WMS(this.getWmsLayer(),this.getWmsUrl(),e,c);this.getOpacity()&&b.setOpacity(this.getOpacity());b._portalBasePrimitive=this;this.setWmsLayer(b)},_getStylesFromSLD:function(a){return a&&-1<a.indexOf("Esri:ArcGIS Server")?portal.util.xml.SimpleDOM.parseStringToDOM(this.getSld_body()).getElementsByTagName("UserStyle")[0].getElementsByTagName("Name")[0].textContent:null},_getCSWBoundingBox:function(a){for(var b=null,c=null,d=0;d<a.length;d++)c=a[d].get("geographicElements")[0],
b=b?b.combine(c):c,c=c.crs;a={bounds:new OpenLayers.Bounds(b.westBoundLongitude,b.southBoundLatitude,b.eastBoundLongitude,b.northBoundLatitude),crs:c};"EPSG:3857"!=c&&(a.crs="EPSG:3857",a.bounds=a.bounds.transform(c,"EPSG:3857"));return a}});
Ext.define("portal.map.gmap.primitives.WMSOverlay",{extend:"portal.map.primitives.BaseWMSPrimitive",config:{tileLayer:null,tileLayerOverlay:null},constructor:function(a){this.callParent(arguments);var b=new GWMSTileLayer(a.map,new GCopyrightCollection(""),1,17);b._portalBasePrimitive=this;b.baseURL=this.getWmsUrl();b.layers=this.getWmsLayer();b.opacity=this.getOpacity();var c=new GTileLayerOverlay(b);c._portalBasePrimitive=this;this.setTileLayer(b);this.setTileLayerOverlay(c)}});
Ext.define("portal.layer.querier.wms.WMSQuerier",{extend:"portal.layer.querier.Querier",constructor:function(a){this.callParent(arguments)},generateErrorComponent:function(a,b){return Ext.create("portal.layer.querier.BaseComponent",{html:Ext.util.Format.format('\x3cp class\x3d"centeredlabel"\x3e{0}\x3c/p\x3e',a),tabTitle:b?b:"Error"})},isHtmlDataThere:function(a){a=a.toLowerCase();var b=a.indexOf("\x3cbody\x3e"),c=a.indexOf("\x3c/body\x3e");return 0<=b||0<=c?32<c-b:32<a.length},_createTreeNode:function(a){var b=
null;if(portal.util.xml.SimpleDOM.isLeafNode(a))b=portal.util.xml.SimpleDOM.getNodeTextContent(a),b={text:a.tagName+" \x3d "+b,children:[],leaf:!0};else{b=a.tagName;if(0<a.attributes.length){for(var b=b+"(",c=0;c<a.attributes.length;c++)b+=" "+a.attributes[c].nodeName+"\x3d"+a.attributes[c].value;b+=")"}b={text:b,children:[],leaf:!0}}return b},_parseXmlTree:function(a,b){var c=[];Ext.each(a.childNodes,function(a){if(a.nodeType==portal.util.xml.SimpleDOM.XML_NODE_ELEMENT){var e=this._createTreeNode(a);
b.leaf=!1;b.children.push(e);c.push(b);this._parseXmlTree(a,e)}},this);return c},_parseStringXMLtoTreePanel:function(a){var b=portal.util.xml.SimpleDOM.parseStringToDOM(a);a=this._createTreeNode(b.documentElement);this._parseXmlTree(b.documentElement,a);a.expanded=!0;if(1==a.children.length)for(b=a.children[0];b&&!(b.expanded=!0,1<b.children.length);)b=b.children[0];return{layout:"fit",height:300,items:[{xtype:"treepanel",autoScroll:!0,rootVisible:!0,root:a}]}},query:function(a,b){var c=this.generateWmsProxyQuery(a,
"text/html");Ext.Ajax.request({url:c,timeout:18E4,scope:this,callback:function(c,e,f){c=null;e?this.isHtmlDataThere(f.responseText)&&(c=Ext.create("portal.layer.querier.BaseComponent",{autoScroll:!0,html:f.responseText})):c=this.generateErrorComponent("There was an error when attempting to contact the remote WMS instance for information about this point.");null!==c?b(this,[c],a):b(this,[],a)}})}});
Ext.define("portal.layer.querier.wms.WMSXMLFormatQuerier",{extend:"portal.layer.querier.wms.WMSQuerier",constructor:function(a){this.callParent(arguments)},query:function(a,b){var c=this.generateWmsProxyQuery(a,"text/xml");Ext.Ajax.request({url:c,timeout:18E4,scope:this,callback:function(c,e,f){c=null;c=e?Ext.create("portal.layer.querier.BaseComponent",this._parseStringXMLtoTreePanel(f.responseText)):this.generateErrorComponent("There was an error when attempting to contact the remote WMS instance for information about this point.");
null!==c?b(this,[c],a):b(this,[],a)}})}});