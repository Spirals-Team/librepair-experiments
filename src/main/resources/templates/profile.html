<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:dt="http://www.thymeleaf.org/dandelion/datatables"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" lang="en"
      xsi:schemaLocation="http://www.thymeleaf.org/dandelion/datatables
http://www.thymeleaf.org/dandelion/datatables ">
<script src="https://code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.4/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<head>
    <meta charset="UTF-8">
    <title>Monopoly profile</title>
</head>
<body>

<!--/*@thymesVar id="player" status="java.lang.String"*/-->
<p th:text="'Player: ' +  ${player}"></p>
<p th:if="${name}" th:text="'Name: ' + ${name}"></p>
<!--/*@thymesVar id="city" status="java.lang.String"*/-->
<p id="city" th:if="${city}" th:text="'City: ' +  ${city}"></p>
<!--/*@thymesVar id="avatar_url" status="java.lang.String"*/-->
<img th:if="${avatar_url}" height="150" th:src="${avatar_url}">

<h2> Friends: </h2>
<table border="1" dt:table="true">
    <tbody>
    <!--/*@thymesVar id="friends" status="java.util.List"*/-->
    <tr th:each="friend : ${friends}">
        <td><img height="80" th:src="${friend[0]}"></td>
        <td th:text="${friend[1]}"></td>
        <td th:text="${friend[2]}"></td>
        <td>
            <button onclick="onRemoveFriendClick(this)"
                    th:id="'remove_' + ${friend[1]}">Remove
            </button>
        </td>
    </tr>
    </tbody>
</table>
<input id="friend_nickname" type="text" title="Nickname">
<button onclick="onAddFriendClick()"> Add friend</button>


<button onclick="onCreateRoomClick()">Create room</button>

<script>

    var friendNickname = document.getElementById("friend_nickname");

    function onAddFriendClick() {
        $.ajax({
            url: '/player/add_friend?nickname=' + friendNickname.value,
            type: 'PUT',
            success: function (data) {
                alert(data)
            }
        });
    }

    function onRemoveFriendClick(el) {
        var nickname = el.id.substr(7);
        $.ajax({
            url: '/player/remove_friend?nickname=' + nickname,
            type: 'PUT',
            success: function (data) {
                alert(data)
            }
        })
    }

    function onCreateRoomClick() {
        $.post("/rooms/create", function (roomId) {
            $.ajax({
                url: '/player/room?roomId=' + roomId,
                type: 'PUT',
                success: function () {
                    $(location).attr('href', '/room.html');
                }
            })
        });
    }

    var id = null;

    $.get('/player/info', function (data) {
        id = data.id;
    });


    var socket = new SockJS('/lobby');
    var stompClient = Stomp.over(socket);


    stompClient.connect({}, function () {
        stompClient.send('/app/status', {}, JSON.stringify({
            status: "ONLINE",
            place: "SITE",
            playerId: id
        }));
        stompClient.subscribe('/topic/invite/' + id, onMessageReceived);
    });

    function onMessageReceived(payload) {
        var msg = JSON.parse(payload.body);
        if (confirm("Player " + msg.from + " invite you. Join?")) {
            $(location).attr('href', msg.url);
        }
    }
</script>
</body>
</html>