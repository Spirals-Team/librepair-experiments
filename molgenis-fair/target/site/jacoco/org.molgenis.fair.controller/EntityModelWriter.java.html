<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EntityModelWriter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">fair</a> &gt; <a href="index.source.html" class="el_package">org.molgenis.fair.controller</a> &gt; <span class="el_source">EntityModelWriter.java</span></div><h1>EntityModelWriter.java</h1><pre class="source lang-java linenums">package org.molgenis.fair.controller;

import org.eclipse.rdf4j.model.IRI;
import org.eclipse.rdf4j.model.Model;
import org.eclipse.rdf4j.model.Resource;
import org.eclipse.rdf4j.model.impl.LinkedHashModel;
import org.eclipse.rdf4j.model.impl.SimpleValueFactory;
import org.molgenis.data.Entity;
import org.molgenis.data.meta.model.Attribute;
import org.molgenis.data.meta.model.EntityType;
import org.molgenis.data.semantic.LabeledResource;
import org.molgenis.data.semantic.Relation;
import org.molgenis.data.semantic.SemanticTag;
import org.molgenis.semanticsearch.service.TagService;
import org.springframework.stereotype.Component;

import javax.xml.datatype.DatatypeConfigurationException;
import javax.xml.datatype.DatatypeFactory;
import javax.xml.datatype.XMLGregorianCalendar;

import static com.google.common.collect.Iterables.contains;
import static java.util.Arrays.stream;
import static java.util.Objects.requireNonNull;

@Component
public class EntityModelWriter
{
	private static final String KEYWORD = &quot;http://www.w3.org/ns/dcat#keyword&quot;;
	private final IRI rdfTypePredicate;

	private final SimpleValueFactory valueFactory;
	private final TagService&lt;LabeledResource, LabeledResource&gt; tagService;
	private static final DatatypeFactory DATATYPE_FACTORY;

	static
	{
		try
		{
<span class="fc" id="L39">			DATATYPE_FACTORY = DatatypeFactory.newInstance();</span>
		}
<span class="nc" id="L41">		catch (DatatypeConfigurationException e)</span>
		{
<span class="nc" id="L43">			throw new Error(&quot;Could not instantiate javax.xml.datatype.DatatypeFactory&quot;, e);</span>
<span class="fc" id="L44">		}</span>
<span class="fc" id="L45">	}</span>

	public EntityModelWriter(TagService&lt;LabeledResource, LabeledResource&gt; tagService, SimpleValueFactory valueFactory)
<span class="fc" id="L48">	{</span>
<span class="fc" id="L49">		this.valueFactory = requireNonNull(valueFactory);</span>
<span class="fc" id="L50">		this.tagService = requireNonNull(tagService);</span>
<span class="fc" id="L51">		this.rdfTypePredicate = valueFactory.createIRI(&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#type&quot;);</span>
<span class="fc" id="L52">	}</span>

	private void setNamespacePrefixes(Model model)
	{
<span class="fc" id="L56">		model.setNamespace(&quot;rdf&quot;, &quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;);</span>
<span class="fc" id="L57">		model.setNamespace(&quot;rdfs&quot;, &quot;http://www.w3.org/2000/01/rdf-schema#&quot;);</span>
<span class="fc" id="L58">		model.setNamespace(&quot;dcat&quot;, &quot;http://www.w3.org/ns/dcat#&quot;);</span>
<span class="fc" id="L59">		model.setNamespace(&quot;xsd&quot;, &quot;http://www.w3.org/2001/XMLSchema#&quot;);</span>
<span class="fc" id="L60">		model.setNamespace(&quot;owl&quot;, &quot;http://www.w3.org/2002/07/owl#&quot;);</span>
<span class="fc" id="L61">		model.setNamespace(&quot;dct&quot;, &quot;http://purl.org/dc/terms/&quot;);</span>
<span class="fc" id="L62">		model.setNamespace(&quot;lang&quot;, &quot;http://id.loc.gov/vocabulary/iso639-1/&quot;);</span>
<span class="fc" id="L63">		model.setNamespace(&quot;fdpo&quot;, &quot;http://rdf.biosemantics.org/ontologies/fdp-o#&quot;);</span>
<span class="fc" id="L64">		model.setNamespace(&quot;ldp&quot;, &quot;http://www.w3.org/ns/ldp#&quot;);</span>
<span class="fc" id="L65">		model.setNamespace(&quot;foaf&quot;, &quot;http://xmlns.com/foaf/0.1/&quot;);</span>
<span class="fc" id="L66">		model.setNamespace(&quot;orcid&quot;, &quot;http://orcid.org/&quot;);</span>
<span class="fc" id="L67">		model.setNamespace(&quot;r3d&quot;, &quot;http://www.re3data.org/schema/3-0#&quot;);</span>
<span class="fc" id="L68">		model.setNamespace(&quot;sio&quot;, &quot;http://semanticscience.org/resource/&quot;);</span>
<span class="fc" id="L69">	}</span>

	public Model createRdfModel(String subjectIRI, Entity objectEntity)
	{
<span class="fc" id="L73">		Model model = createEmptyModel();</span>
<span class="fc" id="L74">		addEntityToModel(subjectIRI, objectEntity, model);</span>
<span class="fc" id="L75">		return model;</span>
	}

	public Model createEmptyModel()
	{
<span class="fc" id="L80">		Model model = new LinkedHashModel();</span>
<span class="fc" id="L81">		setNamespacePrefixes(model);</span>
<span class="fc" id="L82">		return model;</span>
	}

	public void addEntityToModel(String subjectIRI, Entity objectEntity, Model model)
	{
<span class="fc" id="L87">		Resource subject = valueFactory.createIRI(subjectIRI);</span>
<span class="fc" id="L88">		EntityType entityType = objectEntity.getEntityType();</span>
<span class="fc" id="L89">		addStatementsForAttributeTags(objectEntity, model, subject, entityType);</span>
<span class="fc" id="L90">		addStatementsForEntityTags(model, subject, entityType);</span>
<span class="fc" id="L91">	}</span>

	private void addStatementsForAttributeTags(Entity objectEntity, Model model, Resource subject,
			EntityType entityType)
	{
<span class="fc bfc" id="L96" title="All 2 branches covered.">		for (Attribute objectAttribute : entityType.getAtomicAttributes())</span>
		{
<span class="fc" id="L98">			Object value = objectEntity.get(objectAttribute.getName());</span>
<span class="fc bfc" id="L99" title="All 2 branches covered.">			if (value == null)</span>
			{
<span class="fc" id="L101">				continue;</span>
			}
<span class="fc bfc" id="L103" title="All 2 branches covered.">			for (LabeledResource tag : tagService.getTagsForAttribute(entityType, objectAttribute).get(Relation.isAssociatedWith))</span>
			{
<span class="fc" id="L105">				IRI predicate = valueFactory.createIRI(tag.getIri());</span>
<span class="fc" id="L106">				addRelationForAttribute(model, subject, predicate, objectEntity, objectAttribute);</span>
<span class="fc" id="L107">			}</span>
<span class="fc" id="L108">		}</span>
<span class="fc" id="L109">	}</span>

	void addStatementsForEntityTags(Model model, Resource subject, EntityType entityType)
	{
<span class="fc bfc" id="L113" title="All 2 branches covered.">		for (SemanticTag&lt;EntityType, LabeledResource, LabeledResource&gt; tag : tagService.getTagsForEntity(entityType))</span>
		{
<span class="pc bpc" id="L115" title="1 of 2 branches missed.">			if (tag.getRelation() == Relation.isAssociatedWith)</span>
			{
<span class="fc" id="L117">				LabeledResource object = tag.getObject();</span>
<span class="fc" id="L118">				model.add(subject, rdfTypePredicate, valueFactory.createIRI(object.getIri()));</span>
			}

<span class="fc" id="L121">		}</span>
<span class="fc" id="L122">	}</span>

	private void addRelationForAttribute(Model model, Resource subject, IRI predicate, Entity objectEntity,
			Attribute objectAttribute)
	{
<span class="fc" id="L127">		String name = objectAttribute.getName();</span>

<span class="pc bpc" id="L129" title="1 of 11 branches missed.">		switch (objectAttribute.getDataType())</span>
		{
			case MREF:
			case CATEGORICAL_MREF:
<span class="fc" id="L133">				addRelationForMrefTypeAttribute(model, subject, predicate, objectEntity.getEntities(name));</span>
<span class="fc" id="L134">				break;</span>
			case BOOL:
<span class="fc" id="L136">				model.add(subject, predicate, valueFactory.createLiteral(objectEntity.getBoolean(name)));</span>
<span class="fc" id="L137">				break;</span>
			case DATE:
<span class="fc" id="L139">				XMLGregorianCalendar calendar = DATATYPE_FACTORY.newXMLGregorianCalendar(</span>
<span class="fc" id="L140">						objectEntity.getLocalDate(name).toString());</span>
<span class="fc" id="L141">				model.add(subject, predicate, valueFactory.createLiteral(calendar));</span>
<span class="fc" id="L142">				break;</span>
			case DATE_TIME:
<span class="fc" id="L144">				calendar = DATATYPE_FACTORY.newXMLGregorianCalendar(objectEntity.getInstant(name).toString());</span>
<span class="fc" id="L145">				model.add(subject, predicate, valueFactory.createLiteral(calendar));</span>
<span class="fc" id="L146">				break;</span>
			case DECIMAL:
<span class="fc" id="L148">				model.add(subject, predicate, valueFactory.createLiteral(objectEntity.getDouble(name)));</span>
<span class="fc" id="L149">				break;</span>
			case LONG:
<span class="fc" id="L151">				model.add(subject, predicate, valueFactory.createLiteral(objectEntity.getLong(name)));</span>
<span class="fc" id="L152">				break;</span>
			case INT:
<span class="fc" id="L154">				model.add(subject, predicate, valueFactory.createLiteral(objectEntity.getInt(name)));</span>
<span class="fc" id="L155">				break;</span>
			case ENUM:
			case EMAIL:
			case HTML:
			case TEXT:
			case SCRIPT:
			case STRING:
<span class="fc" id="L162">				addRelationForStringTypeAttribute(model, subject, predicate, objectEntity.getString(name));</span>
<span class="fc" id="L163">				break;</span>
			case HYPERLINK:
<span class="fc" id="L165">				model.add(subject, predicate, valueFactory.createIRI(objectEntity.getString(name)));</span>
<span class="fc" id="L166">				break;</span>
			case XREF:
			case CATEGORICAL:
			case FILE:
<span class="fc" id="L170">				addRelationForXrefTypeAttribute(model, subject, predicate, objectEntity.getEntity(name));</span>
<span class="fc" id="L171">				break;</span>
			default:
<span class="nc" id="L173">				throw new RuntimeException(&quot;DataType &quot; + objectAttribute.getDataType() + &quot;is not supported&quot;);</span>
		}
<span class="fc" id="L175">	}</span>

	private void addRelationForXrefTypeAttribute(Model model, Resource subject, IRI predicate, Entity objectEntity)
	{
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">		if (contains(objectEntity.getEntityType().getAttributeNames(), &quot;IRI&quot;))</span>
		{
<span class="nc" id="L181">			model.add(subject, predicate, valueFactory.createIRI(objectEntity.getString(&quot;IRI&quot;)));</span>
		}
		else
		{
<span class="fc" id="L185">			model.add(subject, predicate,</span>
<span class="fc" id="L186">					valueFactory.createIRI(subject.stringValue() + '/' + objectEntity.getIdValue()));</span>
		}
<span class="fc" id="L188">	}</span>

	private void addRelationForStringTypeAttribute(Model model, Resource subject, IRI predicate, String value)
	{
<span class="fc bfc" id="L192" title="All 2 branches covered.">		if (predicate.stringValue().equals(KEYWORD))</span>
		{
<span class="fc" id="L194">			stream(value.split(&quot;,&quot;)).map(String::trim)</span>
<span class="fc" id="L195">									.forEach(keyword -&gt; model.add(subject, predicate,</span>
<span class="fc" id="L196">											valueFactory.createLiteral(keyword)));</span>
		}
		else
		{
<span class="fc" id="L200">			model.add(subject, predicate, valueFactory.createLiteral(value));</span>
		}
<span class="fc" id="L202">	}</span>

	private void addRelationForMrefTypeAttribute(Model model, Resource subject, IRI predicate,
			Iterable&lt;Entity&gt; objectEntities)
	{
<span class="fc bfc" id="L207" title="All 2 branches covered.">		for (Entity objectEntity : objectEntities)</span>
		{
<span class="fc" id="L209">			model.add(subject, predicate,</span>
<span class="fc" id="L210">					valueFactory.createIRI(subject.stringValue() + '/' + objectEntity.getIdValue()));</span>

<span class="fc" id="L212">		}</span>
<span class="fc" id="L213">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>