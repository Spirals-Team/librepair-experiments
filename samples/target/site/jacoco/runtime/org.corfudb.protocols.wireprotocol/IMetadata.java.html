<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>IMetadata.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">samples</a> &gt; <a href="../index.html" class="el_bundle">runtime</a> &gt; <a href="index.source.html" class="el_package">org.corfudb.protocols.wireprotocol</a> &gt; <span class="el_source">IMetadata.java</span></div><h1>IMetadata.java</h1><pre class="source lang-java linenums">package org.corfudb.protocols.wireprotocol;

import com.esotericsoftware.kryo.NotNull;
import com.google.common.reflect.TypeToken;

import java.util.Arrays;
import java.util.Collections;
import java.util.EnumMap;
import java.util.Map;
import java.util.Optional;
import java.util.Set;
import java.util.UUID;
import java.util.function.Function;
import java.util.stream.Collectors;

import javax.annotation.Nullable;

import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.RequiredArgsConstructor;
import lombok.Value;

import org.corfudb.protocols.logprotocol.CheckpointEntry;
import org.corfudb.runtime.view.Address;

import static org.corfudb.protocols.wireprotocol.IMetadata.LogUnitMetadataType.CHECKPOINTED_STREAM_ID;
import static org.corfudb.protocols.wireprotocol.IMetadata.LogUnitMetadataType.CHECKPOINTED_STREAM_START_LOG_ADDRESS;
import static org.corfudb.protocols.wireprotocol.IMetadata.LogUnitMetadataType.CHECKPOINT_ID;
import static org.corfudb.protocols.wireprotocol.IMetadata.LogUnitMetadataType.CHECKPOINT_TYPE;

/**
 * Created by mwei on 9/18/15.
 */
public interface IMetadata {

<span class="nc" id="L36">    Map&lt;Byte, LogUnitMetadataType&gt; metadataTypeMap =</span>
<span class="nc" id="L37">            Arrays.&lt;LogUnitMetadataType&gt;stream(LogUnitMetadataType.values())</span>
<span class="nc" id="L38">                    .collect(Collectors.toMap(LogUnitMetadataType::asByte, Function.identity()));</span>

    EnumMap&lt;IMetadata.LogUnitMetadataType, Object&gt; getMetadataMap();

    /**
     * Get the streams that belong to this append.
     *
     * @return A set of streams that belong to this append.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    default Set&lt;UUID&gt; getStreams() {
<span class="nc" id="L49">        return (Set&lt;UUID&gt;) ((Map&lt;UUID, Long&gt;)getMetadataMap().getOrDefault(</span>
<span class="nc" id="L50">                LogUnitMetadataType.BACKPOINTER_MAP, Collections.emptyMap())).keySet();</span>
    }

    /**
     * Get whether or not this entry contains a given stream.
     * @param stream    The stream to check.
     * @return          True, if the entry contains the given stream.
     */
    default boolean containsStream(UUID stream) {
<span class="nc" id="L59">        return  getBackpointerMap().keySet().contains(stream);</span>
    }

    /**
     * Get the rank of this append.
     *
     * @return The rank of this append.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    @Nullable
    default DataRank getRank() {
<span class="nc" id="L70">        return (DataRank) getMetadataMap().getOrDefault(LogUnitMetadataType.RANK,</span>
                null);
    }

    /**
     * Set the rank of this append.
     *
     * @param rank The rank of this append.
     */
    default void setRank(@Nullable DataRank rank) {
<span class="nc" id="L80">        EnumMap&lt;LogUnitMetadataType, Object&gt; map = getMetadataMap();</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">        if (rank != null) {</span>
<span class="nc" id="L82">            map.put(LogUnitMetadataType.RANK, rank);</span>
        } else {
<span class="nc bnc" id="L84" title="All 2 branches missed.">            if (map.containsKey(LogUnitMetadataType.RANK)) {</span>
<span class="nc" id="L85">                map.remove(LogUnitMetadataType.RANK);</span>
            }
        }
<span class="nc" id="L88">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    default Map&lt;UUID, Long&gt; getBackpointerMap() {
<span class="nc" id="L92">        return (Map&lt;UUID, Long&gt;) getMetadataMap().getOrDefault(LogUnitMetadataType.BACKPOINTER_MAP,</span>
                Collections.EMPTY_MAP);
    }

    default void setBackpointerMap(Map&lt;UUID, Long&gt; backpointerMap) {
<span class="nc" id="L97">        getMetadataMap().put(LogUnitMetadataType.BACKPOINTER_MAP, backpointerMap);</span>
<span class="nc" id="L98">    }</span>

    default void setGlobalAddress(Long address) {
<span class="nc" id="L101">        getMetadataMap().put(LogUnitMetadataType.GLOBAL_ADDRESS, address);</span>
<span class="nc" id="L102">    }</span>

<span class="nc" id="L104">    default void setClientId(UUID clientId) {getMetadataMap().put(LogUnitMetadataType.CLIENT_ID, clientId); }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    @Nullable
    default UUID getClientId() {
<span class="nc" id="L109">            return (UUID) getMetadataMap().getOrDefault(LogUnitMetadataType.CLIENT_ID,</span>
                    null);
    }

<span class="nc" id="L113">    default void setThreadId(Long threadId) {getMetadataMap().put(LogUnitMetadataType.THREAD_ID, threadId); }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    @Nullable
    default Long getThreadId() {
<span class="nc" id="L118">        return (Long) getMetadataMap().getOrDefault(LogUnitMetadataType.THREAD_ID,</span>
                null);
    }


    /**
     * Get Log's global address (global tail).
     * @return global address
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    default Long getGlobalAddress() {
<span class="nc bnc" id="L129" title="All 2 branches missed.">        if (getMetadataMap() == null</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">                || getMetadataMap().get(LogUnitMetadataType.GLOBAL_ADDRESS) == null) {</span>
<span class="nc" id="L131">            return -1L;</span>
        }
<span class="nc" id="L133">        return Optional.ofNullable((Long) getMetadataMap()</span>
<span class="nc" id="L134">                .get(LogUnitMetadataType.GLOBAL_ADDRESS)).orElse((long) -1);</span>
    }

    default void clearCommit() {
<span class="nc" id="L138">        getMetadataMap().put(LogUnitMetadataType.COMMIT, false);</span>
<span class="nc" id="L139">    }</span>

    default void setCommit() {
<span class="nc" id="L142">        getMetadataMap().put(LogUnitMetadataType.COMMIT, true);</span>
<span class="nc" id="L143">    }</span>

    default boolean hasCheckpointMetadata() {
<span class="nc bnc" id="L146" title="All 4 branches missed.">        return getCheckpointType() != null &amp;&amp; getCheckpointId() != null;</span>
    }

    /**
     * Get checkpoint type.
     */
    @Nullable
    default CheckpointEntry.CheckpointEntryType getCheckpointType() {
<span class="nc" id="L154">        return (CheckpointEntry.CheckpointEntryType) getMetadataMap()</span>
<span class="nc" id="L155">                .getOrDefault(LogUnitMetadataType.CHECKPOINT_TYPE,</span>
                        null);
    }

    default void setCheckpointType(CheckpointEntry.CheckpointEntryType type) {
<span class="nc" id="L160">        getMetadataMap().put(CHECKPOINT_TYPE, type);</span>
<span class="nc" id="L161">    }</span>

    @Nullable
    @SuppressWarnings({&quot;checkstyle:abbreviationaswordinname&quot;, &quot;checkstyle:membername&quot;})
    default UUID getCheckpointId() {
<span class="nc" id="L166">        return (UUID) getMetadataMap().getOrDefault(LogUnitMetadataType.CHECKPOINT_ID,</span>
                null);
    }

    @SuppressWarnings({&quot;checkstyle:abbreviationaswordinname&quot;, &quot;checkstyle:membername&quot;})
    default void setCheckpointId(UUID id) {
<span class="nc" id="L172">        getMetadataMap().put(CHECKPOINT_ID, id);</span>
<span class="nc" id="L173">    }</span>

    default UUID getCheckpointedStreamId() {
<span class="nc" id="L176">        return (UUID) getMetadataMap().getOrDefault(LogUnitMetadataType.CHECKPOINTED_STREAM_ID,</span>
                null);
    }

    default void setCheckpointedStreamId(UUID Id) {
<span class="nc" id="L181">        getMetadataMap().put(CHECKPOINTED_STREAM_ID, Id);</span>
<span class="nc" id="L182">    }</span>

    /**
     * Returns the tail of the checkpointed stream at the time of taking the checkpoint snapshot.
     */
    default Long getCheckpointedStreamStartLogAddress() {
<span class="nc" id="L188">        return (Long) getMetadataMap()</span>
<span class="nc" id="L189">                .getOrDefault(LogUnitMetadataType.CHECKPOINTED_STREAM_START_LOG_ADDRESS,</span>
<span class="nc" id="L190">                        Address.NO_BACKPOINTER);</span>
    }

    default void setCheckpointedStreamStartLogAddress(Long startLogAddress) {
<span class="nc" id="L194">        getMetadataMap().put(CHECKPOINTED_STREAM_START_LOG_ADDRESS, startLogAddress);</span>
<span class="nc" id="L195">    }</span>

<span class="nc" id="L197">    @RequiredArgsConstructor</span>
    public enum LogUnitMetadataType implements ITypedEnum {
<span class="nc" id="L199">        RANK(1, TypeToken.of(DataRank.class)),</span>
<span class="nc" id="L200">        BACKPOINTER_MAP(3, new TypeToken&lt;Map&lt;UUID, Long&gt;&gt;() {}),</span>
<span class="nc" id="L201">        GLOBAL_ADDRESS(4, TypeToken.of(Long.class)),</span>
<span class="nc" id="L202">        COMMIT(5, TypeToken.of(Boolean.class)),</span>
<span class="nc" id="L203">        CHECKPOINT_TYPE(6, TypeToken.of(CheckpointEntry.CheckpointEntryType.class)),</span>
<span class="nc" id="L204">        CHECKPOINT_ID(7, TypeToken.of(UUID.class)),</span>
<span class="nc" id="L205">        CHECKPOINTED_STREAM_ID(8, TypeToken.of(UUID.class)),</span>
<span class="nc" id="L206">        CHECKPOINTED_STREAM_START_LOG_ADDRESS(9, TypeToken.of(Long.class)),</span>
<span class="nc" id="L207">        CLIENT_ID(10, TypeToken.of(UUID.class)),</span>
<span class="nc" id="L208">        THREAD_ID(11, TypeToken.of(Long.class))</span>
        ;
        final int type;
<span class="nc" id="L211">        @Getter</span>
        final TypeToken&lt;?&gt; componentType;

        public byte asByte() {
<span class="nc" id="L215">            return (byte) type;</span>
        }

<span class="nc" id="L218">        public static Map&lt;Byte, LogUnitMetadataType&gt; typeMap =</span>
<span class="nc" id="L219">                Arrays.&lt;LogUnitMetadataType&gt;stream(LogUnitMetadataType.values())</span>
<span class="nc" id="L220">                        .collect(Collectors.toMap(LogUnitMetadataType::asByte,</span>
<span class="nc" id="L221">                                Function.identity()));</span>
    }

<span class="nc bnc" id="L224" title="All 14 branches missed.">    @Value</span>
<span class="nc" id="L225">    @AllArgsConstructor</span>
    class DataRank implements Comparable&lt;DataRank&gt; {
<span class="nc" id="L227">        public long rank;</span>
        @NotNull
<span class="nc" id="L229">        public UUID uuid;</span>

        public DataRank(long rank) {
<span class="nc" id="L232">            this(rank, UUID.randomUUID());</span>
<span class="nc" id="L233">        }</span>

        public DataRank buildHigherRank() {
<span class="nc" id="L236">            return new DataRank(rank + 1, uuid);</span>
        }

        @Override
        public int compareTo(DataRank o) {
<span class="nc" id="L241">            int rankCompared = Long.compare(this.rank, o.rank);</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">            if (rankCompared == 0) {</span>
<span class="nc" id="L243">                return uuid.compareTo(o.getUuid());</span>
            } else {
<span class="nc" id="L245">                return rankCompared;</span>
            }
        }
    }

    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>