<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TrieBasedPolicyEnforcer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Eclipse Ditto :: Model :: Enforcers</a> &gt; <a href="index.source.html" class="el_package">org.eclipse.ditto.model.enforcers.trie</a> &gt; <span class="el_source">TrieBasedPolicyEnforcer.java</span></div><h1>TrieBasedPolicyEnforcer.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2017 Bosch Software Innovations GmbH.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v2.0
 * which accompanies this distribution, and is available at
 * https://www.eclipse.org/org/documents/epl-2.0/index.php
 *
 * Contributors:
 *    Bosch Software Innovations GmbH - initial contribution
 */
package org.eclipse.ditto.model.enforcers.trie;

import static org.eclipse.ditto.model.base.common.ConditionChecker.checkNotNull;

import java.util.Set;
import java.util.stream.Collectors;

import org.eclipse.ditto.json.JsonFactory;
import org.eclipse.ditto.json.JsonField;
import org.eclipse.ditto.json.JsonKey;
import org.eclipse.ditto.json.JsonObject;
import org.eclipse.ditto.model.base.auth.AuthorizationContext;
import org.eclipse.ditto.model.base.auth.AuthorizationSubject;
import org.eclipse.ditto.model.policies.Permissions;
import org.eclipse.ditto.model.policies.Policy;
import org.eclipse.ditto.model.policies.PolicyEntry;
import org.eclipse.ditto.model.policies.ResourceKey;
import org.eclipse.ditto.model.enforcers.EffectedSubjectIds;
import org.eclipse.ditto.model.enforcers.Enforcer;

/**
 * Holds Algorithms to build trie-based indices for a policy and to perform policy checks based on those indices.
 * &lt;p&gt;
 * Each policy is transformed into a trie (en.wikipedia.org/wiki/Trie) with {@link ResourceKey} as key type and with
 * each edge labeled by a {@link JsonKey}. For example, a policy with entries for {@code /attributes/A/B} and {@code
 * /attributes/A/C} is transformed to the following trie:
 * &lt;pre&gt;
 * '/attributes'
 *   |
 *   +--- '/attributes/A'
 *    A    |
 *         |
 *         +---- '/attributes/A/B'
 *         |  B
 *         |
 *         +---- '/attributes/A/C'
 *            C
 * &lt;/pre&gt;
 * Each trie node has a {@link GrantRevokeIndex}, which maps each permission to the set of granted authorization
 * subjects and the set of revoked authorization subjects. The grant-revoke-indices are calculated in 4 different ways
 * to produce 4 tries of the same shape. 3 of those tries are used for policy enforcement. &lt;ol&gt; &lt;li&gt;&lt;em&gt;Raw Trie:&lt;/em&gt;
 * For each policy entry, pairs of permissions and their granted/revoked subjects are added to the trie node at the
 * resource location of the entry. &lt;/li&gt; &lt;li&gt;&lt;em&gt;Inherited Trie:&lt;/em&gt; Encodes the hierarchical nature of policy entries,
 * namely that policy entries are valid also for sub-resources unless overridden. To build it, start from {@code
 * rawTrie}, push granted and revoked subjects from ancestors down to descendants. For each trie node, subjects from
 * ancestors are overridden by subjects defined at the corresponding node in {@code rawTrie}. &lt;/li&gt; &lt;li&gt;&lt;em&gt;Bottom Up
 * Grant Trie:&lt;/em&gt; Supports partial permissions, e. g., a resource is considered readable also when 1 or more
 * sub-resources are readable in an authorization context. To build it, start from {@code inheritedTrie}, push granted
 * subjects from descendants up to ancestors. &lt;/li&gt; &lt;li&gt;&lt;em&gt;Bottom Up Revoke Trie:&lt;/em&gt; Supports unrestricted
 * permissions, e. g., a resource is considered writable only if all sub-resources are writable, and any WRITE-revoked
 * resource make all its super-resources non-writable. To build it, start from {@code inheritedTrie}, push revoked
 * subjects from descendants up to ancestors. &lt;/li&gt; &lt;/ol&gt; See Javadoc of individual methods for more details.
 */
public final class TrieBasedPolicyEnforcer implements Enforcer {

    /**
     * PolicyTrie obtained by propagating grant &amp; revoke sets down from ancestors to descendants.
     */
    private final PolicyTrie inheritedTrie;

    /**
     * PolicyTrie obtained from {@code this.inheritedTrie} by propagating grant sets up from descendants to ancestors.
     */
    private final PolicyTrie bottomUpGrantTrie;

    /**
     * PolicyTrie obtained from {@code this.inheritedTrie} by propagating revoke sets up from descendants to ancestors.
     */
    private final PolicyTrie bottomUpRevokeTrie;

<span class="fc" id="L82">    private TrieBasedPolicyEnforcer(final Iterable&lt;PolicyEntry&gt; policy) {</span>
<span class="fc" id="L83">        final PolicyTrie rawTree = PolicyTrie.fromPolicy(policy);</span>
<span class="fc" id="L84">        inheritedTrie = rawTree.getTransitiveClosure();</span>
<span class="fc" id="L85">        bottomUpGrantTrie = inheritedTrie.getBottomUpGrantTrie();</span>
<span class="fc" id="L86">        bottomUpRevokeTrie = inheritedTrie.getBottomUpRevokeTrie();</span>
<span class="fc" id="L87">    }</span>

    /**
     * Constructs a trie-based policy enforcer from a policy.
     *
     * @param policy The policy to interpret.
     * @return The policy enforcer.
     * @throws NullPointerException if {@code policy} is {@code null}.
     */
    public static TrieBasedPolicyEnforcer newInstance(final Policy policy) {
<span class="fc" id="L97">        return new TrieBasedPolicyEnforcer(checkNotNull(policy, &quot;policy to interpret&quot;));</span>
    }

    /**
     * {@inheritDoc}
     * &lt;p&gt;
     * If the given resource (or one of its sub-resources) are mentioned in the policy, then use the trie {@code
     * bottomUpRevokeTrie} to detect whether any permission is &lt;em&gt;revoked&lt;/em&gt; on a sub-resource. If the given resource
     * is not mentioned in the policy, then its grants/revokes are inherited from a super-resource, and we use {@code
     * inheritedTrie} to locate the inherited grants/revokes.
     */
    @Override
    public boolean hasUnrestrictedPermissions(final ResourceKey resourceKey,
            final AuthorizationContext authorizationContext,
            final Permissions permissions) {

<span class="fc" id="L113">        final PolicyTrie policyTrie = seekWithFallback(resourceKey, bottomUpRevokeTrie, inheritedTrie);</span>
<span class="fc" id="L114">        final GrantRevokeIndex grantRevokeIndex = policyTrie.getGrantRevokeIndex();</span>
<span class="fc" id="L115">        final Set&lt;String&gt; subjectIds = getSubjectIds(authorizationContext);</span>

<span class="fc" id="L117">        return grantRevokeIndex.hasPermissions(subjectIds, permissions);</span>
    }

    /**
     * {@inheritDoc}
     * &lt;p&gt;
     * If the given resource (or one of its sub-resources) are mentioned in the policy, then use the trie {@code
     * bottomUpGrantTrie} to detect whether any permission is &lt;em&gt;granted&lt;/em&gt; on a sub-resource. If the given resource
     * is not mentioned in the policy, then its grants/revokes are inherited from a super-resource, and we use {@code
     * inheritedTrie} to locate the inherited grants/revokes.
     */
    @Override
    public boolean hasPartialPermissions(final ResourceKey resourceKey, final AuthorizationContext authorizationContext,
            final Permissions permissions) {

<span class="fc" id="L132">        final PolicyTrie policyTrie = seekWithFallback(resourceKey, bottomUpGrantTrie, inheritedTrie);</span>
<span class="fc" id="L133">        final GrantRevokeIndex grantRevokeIndex = policyTrie.getGrantRevokeIndex();</span>
<span class="fc" id="L134">        final Set&lt;String&gt; subjectIds = getSubjectIds(authorizationContext);</span>

<span class="fc" id="L136">        return grantRevokeIndex.hasPermissions(subjectIds, permissions);</span>
    }

    @Override
    public EffectedSubjectIds getSubjectIdsWithPermission(final ResourceKey resourceKey,
            final Permissions permissions) {

<span class="fc" id="L143">        checkResourceKey(resourceKey);</span>
<span class="fc" id="L144">        checkPermissions(permissions);</span>
<span class="fc" id="L145">        return inheritedTrie.seekToLeastAncestor(PolicyTrie.getJsonKeyIterator(resourceKey))</span>
<span class="fc" id="L146">                .getGrantRevokeIndex()</span>
<span class="fc" id="L147">                .getEffectedSubjectIds(permissions);</span>
    }

    private static void checkResourceKey(final ResourceKey resourceKey) {
<span class="fc" id="L151">        checkNotNull(resourceKey, &quot;resource key&quot;);</span>
<span class="fc" id="L152">    }</span>

    private static void checkPermissions(final Permissions permissions) {
<span class="fc" id="L155">        checkNotNull(permissions, &quot;permissions to check&quot;);</span>
<span class="fc" id="L156">    }</span>

    @Override
    public Set&lt;String&gt; getSubjectIdsWithPartialPermission(final ResourceKey resourceKey,
            final Permissions permissions) {

<span class="fc" id="L162">        checkResourceKey(resourceKey);</span>
<span class="fc" id="L163">        checkPermissions(permissions);</span>
<span class="fc" id="L164">        final PolicyTrie policyTrie = seekWithFallback(resourceKey, bottomUpGrantTrie, inheritedTrie);</span>
<span class="fc" id="L165">        final GrantRevokeIndex grantRevokeIndex = policyTrie.getGrantRevokeIndex();</span>
<span class="fc" id="L166">        return grantRevokeIndex.getGrantedSubjectIds(permissions);</span>
    }

    @Override
    public JsonObject buildJsonView(final ResourceKey resourceKey,
            final Iterable&lt;JsonField&gt; jsonFields,
            final AuthorizationContext authorizationContext,
            final Permissions permissions) {

<span class="fc" id="L175">        checkResourceKey(resourceKey);</span>
<span class="fc" id="L176">        checkNotNull(jsonFields, &quot;JSON fields&quot;);</span>
<span class="fc" id="L177">        checkPermissions(permissions);</span>

<span class="fc" id="L179">        final Set&lt;String&gt; subjectIds = getSubjectIds(authorizationContext);</span>

<span class="fc" id="L181">        final JsonKey typeKey = JsonKey.of(resourceKey.getResourceType());</span>

<span class="pc bpc" id="L183" title="1 of 2 branches missed.">        if (inheritedTrie.hasChild(typeKey)) {</span>
<span class="fc" id="L184">            final PolicyTrie start = inheritedTrie.seekToLeastAncestor(PolicyTrie.getJsonKeyIterator(resourceKey));</span>
<span class="fc" id="L185">            return start.buildJsonView(jsonFields, subjectIds, permissions);</span>
        } else {
<span class="nc" id="L187">            return JsonFactory.newObject();</span>
        }
    }

    /**
     * Extracts all subject IDs from an authorization context as a set of strings.
     *
     * @param authorizationContext The authorization context.
     * @return The set of subject IDs.
     */
    private static Set&lt;String&gt; getSubjectIds(final AuthorizationContext authorizationContext) {
<span class="fc" id="L198">        checkNotNull(authorizationContext, &quot;Authorization Context&quot;);</span>
<span class="fc" id="L199">        return authorizationContext.stream()</span>
<span class="fc" id="L200">                .map(AuthorizationSubject::getId)</span>
<span class="fc" id="L201">                .collect(Collectors.toSet());</span>
    }

    /**
     * Returns a node in the trie {@code firstTry} whose path from root matches the given resource key exactly if it
     * exists, otherwise seek to the node in the trie {@code fallback} whose path from root matches the resource key the
     * best.
     *
     * @param resourceKey Pointer to a resource.
     * @param firstTry The policy trie to attempt an exact match.
     * @param fallback The policy trie to traverse if no exact match is found in {@code firstTry}.
     * @return The result trie node.
     */
    private static PolicyTrie seekWithFallback(final ResourceKey resourceKey, final PolicyTrie firstTry,
            final PolicyTrie fallback) {

<span class="fc" id="L217">        return firstTry.seekToExactNode(PolicyTrie.getJsonKeyIterator(resourceKey))</span>
<span class="fc" id="L218">                .orElseGet(() -&gt; fallback.seekToLeastAncestor(PolicyTrie.getJsonKeyIterator(resourceKey)));</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.0.201801022044</span></div></body></html>