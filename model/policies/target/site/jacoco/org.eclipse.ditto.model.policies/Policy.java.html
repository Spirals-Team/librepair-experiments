<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Policy.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Eclipse Ditto :: Model :: Policies</a> &gt; <a href="index.source.html" class="el_package">org.eclipse.ditto.model.policies</a> &gt; <span class="el_source">Policy.java</span></div><h1>Policy.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2017 Bosch Software Innovations GmbH.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v2.0
 * which accompanies this distribution, and is available at
 * https://www.eclipse.org/org/documents/epl-2.0/index.php
 *
 * Contributors:
 *    Bosch Software Innovations GmbH - initial contribution
 */
package org.eclipse.ditto.model.policies;

import static org.eclipse.ditto.model.base.common.ConditionChecker.checkNotNull;

import java.time.Instant;
import java.util.Objects;
import java.util.Optional;
import java.util.Set;
import java.util.function.Predicate;
import java.util.stream.Stream;

import javax.annotation.Nullable;
import javax.annotation.concurrent.Immutable;

import org.eclipse.ditto.json.JsonFactory;
import org.eclipse.ditto.json.JsonField;
import org.eclipse.ditto.json.JsonFieldDefinition;
import org.eclipse.ditto.json.JsonFieldSelector;
import org.eclipse.ditto.json.JsonObject;
import org.eclipse.ditto.model.base.json.FieldType;
import org.eclipse.ditto.model.base.json.JsonSchemaVersion;
import org.eclipse.ditto.model.base.json.Jsonifiable;

/**
 * A Policy contains {@link PolicyEntry}s containing information about which {@link Subjects} are granted/revoked
 * which {@link Permissions} on which {@link Resources}.
 */
public interface Policy extends Iterable&lt;PolicyEntry&gt;, Jsonifiable.WithFieldSelectorAndPredicate&lt;JsonField&gt; {

    /**
     * The name of the Json field when a policy is inlined in another Json object.
     */
    String INLINED_FIELD_NAME = &quot;_policy&quot;;

    /**
     * The regex pattern a Policy Namespace has to conform to.
     */
    String NAMESPACE_PREFIX_REGEX = &quot;(?&lt;ns&gt;|(?:(?:[a-zA-Z]\\w*)(?:\\.[a-zA-Z]\\w*)*))&quot;;

    /**
     * The regex pattern a Policy ID has to conform to. Defined by
     * &lt;a href=&quot;http://www.ietf.org/rfc/rfc2396.txt&quot;&gt;RFC-2396&lt;/a&gt;.
     */
    String ID_NON_NAMESPACE_REGEX =
            &quot;(?&lt;id&gt;|(?:[-\\w:@&amp;=+,.!~*'_;]|%\\p{XDigit}{2})(?:[-\\w:@&amp;=+,.!~*'$_;]|%\\p{XDigit}{2})*)&quot;;

    /**
     * The regex pattern a Policy ID has to conform to. Combines &quot;namespace&quot; pattern (java package notation + a
     * semicolon)
     * and &quot;non namespace&quot; (Defined by &lt;a href=&quot;http://www.ietf.org/rfc/rfc2396.txt&quot;&gt;RFC-2396&lt;/a&gt;) pattern.
     */
    String ID_REGEX = NAMESPACE_PREFIX_REGEX + &quot;\\:&quot; + ID_NON_NAMESPACE_REGEX;

    /**
     * Returns a mutable builder with a fluent API for an immutable {@code Policy}.
     *
     * @param id the ID of the new Policy.
     * @return the new builder.
     * @throws PolicyIdInvalidException if {@code id} is invalid.
     */
    static PolicyBuilder newBuilder(final CharSequence id) {
<span class="fc" id="L73">        return PoliciesModelFactory.newPolicyBuilder(id);</span>
    }

    /**
     * Returns a mutable builder with a fluent API for an immutable {@code Policy}. The builder is initialised
     * with the Policy entries of this instance.
     *
     * @return the new builder.
     */
    default PolicyBuilder toBuilder() {
<span class="nc" id="L83">        return PoliciesModelFactory.newPolicyBuilder(this);</span>
    }

    /**
     * Policy is only available in JsonSchemaVersion V_2.
     *
     * @return the supported JsonSchemaVersions of Policy.
     */
    @Override
    default JsonSchemaVersion[] getSupportedSchemaVersions() {
<span class="fc" id="L93">        return new JsonSchemaVersion[]{JsonSchemaVersion.V_2};</span>
    }

    /**
     * Returns the identifier of this Policy.
     *
     * @return the identifier.
     */
    Optional&lt;String&gt; getId();

    /**
     * Returns the namespace of this Policy.
     *
     * @return the namespace of this Policy.
     */
    Optional&lt;String&gt; getNamespace();

    /**
     * Returns the current lifecycle of this Policy.
     *
     * @return the current lifecycle of this Policy.
     */
    Optional&lt;PolicyLifecycle&gt; getLifecycle();

    /**
     * Indicates whether this Policy has the given lifecycle.
     *
     * @param lifecycle the lifecycle to be checked for.
     * @return {@code true} if this Policy has {@code lifecycle} as its lifecycle, {@code false} else.
     */
    default boolean hasLifecycle(@Nullable final PolicyLifecycle lifecycle) {
<span class="nc" id="L124">        return getLifecycle()</span>
<span class="nc" id="L125">                .filter(actualLifecycle -&gt; Objects.equals(actualLifecycle, lifecycle))</span>
<span class="nc" id="L126">                .isPresent();</span>
    }

    /**
     * Returns the current revision of this Policy.
     *
     * @return the current revision of this Policy.
     */
    Optional&lt;PolicyRevision&gt; getRevision();

    /**
     * Returns the modified timestamp of this Policy.
     *
     * @return the timestamp.
     */
    Optional&lt;Instant&gt; getModified();

    /**
     * Returns all available {@link Label}s of this Policy.
     *
     * @return all available labels.
     */
    Set&lt;Label&gt; getLabels();

    /**
     * Indicates whether this Policy contains a PolicyEntry for the specified label.
     *
     * @param label the label to check if this Policy has a PolicyEntry for.
     * @return {@code true} if this Policy contains a PolicyEntry for {@code label}, {@code false} else.
     * @throws NullPointerException if {@code label} is {@code null}.
     * @throws IllegalArgumentException if {@code label} is empty.
     */
    boolean contains(CharSequence label);

    /**
     * Sets the specified entry to a copy of this Policy. A previous entry for the same label is replaced by
     * the specified one.
     *
     * @param entry the entry to be set to this Policy.
     * @return a copy of this Policy with {@code entry} set.
     * @throws NullPointerException if {@code entry} is {@code null}.
     */
    Policy setEntry(PolicyEntry entry);

    /**
     * Returns an Policy entry for the specified label.
     *
     * @param label the label to get the Policy entry for.
     * @return the Policy entry.
     * @throws NullPointerException if {@code label} is {@code null}.
     * @throws IllegalArgumentException if {@code label} is empty.
     */
    Optional&lt;PolicyEntry&gt; getEntryFor(CharSequence label);

    /**
     * Removes the entry identified by the specified label from this Policy.
     *
     * @param label the nabel identifying the entry to be removed from this Policy.
     * @return a copy of this Policy which does not contain the identified entry anymore.
     * @throws NullPointerException if {@code entry} is {@code null}.
     * @throws IllegalArgumentException if {@code label} is empty.
     */
    Policy removeEntry(CharSequence label);

    /**
     * Removes the specified entry from this Policy.
     *
     * @param entry the entry to be removed from this Policy.
     * @return a copy of this Policy which does not contain the specified entry anymore.
     * @throws NullPointerException if {@code entry} is {@code null}.
     */
    Policy removeEntry(PolicyEntry entry);

    /**
     * Sets the given {@link Subjects} to the specified label. All previous entries with the same subject ID in the
     * label are replaced by the specified ones.
     *
     * @param label the label identifying the PolicyEntry to modify.
     * @param subjects the Subjects to set for the PolicyEntry identified by the {@code label}.
     * @return a copy of this Policy with the changed state.
     * @throws NullPointerException if any argument is {@code null}.
     * @throws IllegalArgumentException if {@code label} is empty.
     */
    Policy setSubjectsFor(CharSequence label, Subjects subjects);

    /**
     * Sets the given {@link Subject} to the specified label. A previous entry with the same subject ID in the label is
     * replaced by the specified one.
     *
     * @param label the label identifying the PolicyEntry to modify.
     * @param subject the Subject to set for the PolicyEntry identified by the {@code label}.
     * @return a copy of this Policy with the changed state.
     * @throws NullPointerException if any argument is {@code null}.
     * @throws IllegalArgumentException if {@code label} is empty.
     */
    Policy setSubjectFor(CharSequence label, Subject subject);

    /**
     * Removes the subject identified by the specified subject ID from this Policy.
     *
     * @param label the label identifying the PolicyEntry to modify.
     * @param subjectId the Subject ID to remove from the PolicyEntry identified by the {@code label}.
     * @return a copy of this Policy with the removed subject.
     * @throws NullPointerException if any argument is {@code null}.
     * @throws IllegalArgumentException if {@code label} is empty.
     */
    Policy removeSubjectFor(CharSequence label, SubjectId subjectId);

    /**
     * Removes the specified subject from this Policy.
     *
     * @param label the label identifying the PolicyEntry to modify.
     * @param subject the Subject to remove from the PolicyEntry identified by the {@code label}.
     * @return a copy of this Policy with the removed subject.
     * @throws NullPointerException if any argument is {@code null}.
     * @throws IllegalArgumentException if {@code label} is empty.
     */
    default Policy removeSubjectFor(final CharSequence label, final Subject subject) {
<span class="nc" id="L244">        checkNotNull(subject, &quot;subject to be removed&quot;);</span>
<span class="nc" id="L245">        return removeSubjectFor(label, subject.getId());</span>
    }

    /**
     * Sets the given {@link Resources} to the specified label. All previous entries with the same resource key in the
     * label are replaced by the specified ones.
     *
     * @param label the label identifying the PolicyEntry to modify.
     * @param resources the Resources to set for the PolicyEntry identified by the {@code label}.
     * @return a copy of this Policy with the changed state.
     * @throws NullPointerException if any argument is {@code null}.
     * @throws IllegalArgumentException if {@code label} is empty.
     */
    Policy setResourcesFor(CharSequence label, Resources resources);

    /**
     * Sets the given {@link Resource} to the specified label. A previous entry with the same resource key in the label
     * is replaced by the specified one.
     *
     * @param label the label identifying the PolicyEntry to modify.
     * @param resource the Resource to set for the PolicyEntry identified by the {@code label}.
     * @return a copy of this Policy with the changed state.
     * @throws NullPointerException if any argument is {@code null}.
     * @throws IllegalArgumentException if {@code label} is empty.
     */
    Policy setResourceFor(CharSequence label, Resource resource);

    /**
     * Removes the resource identified by the specified resource path from this Policy.
     *
     * @param label the label identifying the PolicyEntry to modify.
     * @param resourceType the type of the Resource to remove from the PolicyEntry identified by the {@code label}.
     * @param resourcePath the path of the Resource to remove from the PolicyEntry identified by the {@code label}.
     * @return a copy of this Policy with the removed subject.
     * @throws NullPointerException if any argument is {@code null}.
     * @throws IllegalArgumentException if {@code label} or {@code resourceType} is empty.
     */
    default Policy removeResourceFor(final CharSequence label, final String resourceType,
            final CharSequence resourcePath) {

<span class="fc" id="L285">        return removeResourceFor(label, PoliciesModelFactory.newResourceKey(resourceType, resourcePath));</span>
    }

    /**
     * Removes the resource identified by the specified resource key from this Policy.
     *
     * @param label the label identifying the PolicyEntry to modify.
     * @param resourceKey the ResourceKey of the Resource to remove from the PolicyEntry identified by the
     * {@code label}.
     * @return a copy of this Policy with the removed subject.
     * @throws NullPointerException if any argument is {@code null}.
     * @throws IllegalArgumentException if {@code label} is empty.
     */
    Policy removeResourceFor(CharSequence label, ResourceKey resourceKey);

    /**
     * Removes the specified Resource from this Policy.
     *
     * @param label the label identifying the PolicyEntry to modify.
     * @param resource the Resource to remove from the PolicyEntry identified by the {@code label}.
     * @return a copy of this Policy with the removed subject.
     * @throws NullPointerException if any argument is {@code null}.
     * @throws IllegalArgumentException if {@code label} is empty.
     */
    default Policy removeResourceFor(final CharSequence label, final Resource resource) {
<span class="nc" id="L310">        return removeResourceFor(label, checkNotNull(resource, &quot;resource&quot;).getResourceKey());</span>
    }

    /**
     * Set the given {@link EffectedPermissions} on the specified resource key in the specified label.
     *
     * @param label the label identifying the PolicyEntry to modify.
     * @param resourceKey the ResourceKey to set the effected permissions on.
     * @param effectedPermissions the EffectedPermissions to set on the resource in the label.
     * @return a copy of this Policy with the changed state.
     * @throws NullPointerException if any argument is {@code null}.
     * @throws IllegalArgumentException if {@code label} is empty.
     */
    default Policy setEffectedPermissionsFor(final CharSequence label, final ResourceKey resourceKey,
            final EffectedPermissions effectedPermissions) {

<span class="nc" id="L326">        return setResourceFor(label, PoliciesModelFactory.newResource(resourceKey, effectedPermissions));</span>
    }

    /**
     * Returns the {@link EffectedPermissions} for the specified subject ID on the passed resource type and resource
     * path.
     *
     * @param label the label identifying the PolicyEntry to modify.
     * @param subjectId the Subject ID to get the effected permissions for.
     * @param resourceType the Resource type to get the effected permissions for.
     * @param resourcePath the Resource path to get the effected permissions for.
     * @return the effected permissions which are associated with {@code subject} on the passed {@code resourceType} and
     * {@code resourcePath}. The returned set is mutable but disjoint from this Policy; thus modifying the set does not
     * have an impact on this Policy.
     * @throws NullPointerException if any argument is {@code null}.
     * @throws IllegalArgumentException if {@code label} or {@code resourceType} is empty.
     */
    default Optional&lt;EffectedPermissions&gt; getEffectedPermissionsFor(final CharSequence label,
            final SubjectId subjectId,
            final CharSequence resourceType,
            final CharSequence resourcePath) {

<span class="fc" id="L348">        return getEffectedPermissionsFor(label, subjectId,</span>
<span class="fc" id="L349">                PoliciesModelFactory.newResourceKey(resourceType, resourcePath));</span>
    }

    /**
     * Returns the {@link EffectedPermissions} for the specified subject ID on the passed resource key.
     *
     * @param label the label identifying the PolicyEntry to modify.
     * @param subjectId the Subject ID to get the effected permissions for.
     * @param resourceKey the ResourceKey to get the effected permissions for.
     * @return the effected permissions which are associated with {@code subject} on the passed {@code resourceKey}. The
     * returned set is mutable but disjoint from this Policy; thus modifying the set does not have an impact on this
     * Policy.
     * @throws NullPointerException if any argument is {@code null}.
     * @throws IllegalArgumentException if {@code label} is empty.
     */
    Optional&lt;EffectedPermissions&gt; getEffectedPermissionsFor(CharSequence label, SubjectId subjectId,
            ResourceKey resourceKey);

    /**
     * Indicates whether this Policy is empty.
     *
     * @return {@code true} if this Policy does not contain any entry, {@code false} else.
     */
    boolean isEmpty();

    /**
     * Returns the amount of entries this Policy has.
     *
     * @return this Policy's entries amount.
     */
    int getSize();

    /**
     * Returns the entries of this Policy as set. The returned set is modifiable but disjoint from this Policy; thus
     * modifying the entry set has no impact on this Policy.
     *
     * @return an unsorted set of this Policy's entries.
     */
    Set&lt;PolicyEntry&gt; getEntriesSet();

    /**
     * Returns a sequential {@code Stream} with the entries of this Policy as its source.
     *
     * @return a sequential stream of the entries of this Policy.
     */
    Stream&lt;PolicyEntry&gt; stream();

    /**
     * Returns all non hidden marked fields of this Policy.
     *
     * @return a JSON object representation of this Policy including only non hidden marked fields.
     */
    @Override
    default JsonObject toJson() {
<span class="fc" id="L403">        return toJson(FieldType.notHidden());</span>
    }

    @Override
    default JsonObject toJson(final JsonSchemaVersion schemaVersion, final JsonFieldSelector fieldSelector) {
<span class="nc" id="L408">        return toJson(schemaVersion, FieldType.regularOrSpecial()).get(fieldSelector);</span>
    }

    /**
     * Returns a JSON object representation of this policy to embed in another JSON object.
     *
     * @param schemaVersion the JsonSchemaVersion in which to return the JSON.
     * @param predicate determines the content of the result.
     * @return a JSON object representation of this policy to embed in another JSON object.
     * @throws NullPointerException if {@code predicate} is {@code null}.
     */
    default JsonObject toInlinedJson(final JsonSchemaVersion schemaVersion, final Predicate&lt;JsonField&gt; predicate) {
<span class="nc" id="L420">        return JsonFactory.newObjectBuilder()</span>
<span class="nc" id="L421">                .set(INLINED_FIELD_NAME, toJson(schemaVersion, predicate))</span>
<span class="nc" id="L422">                .build();</span>
    }

    /**
     * Returns a JSON object representation of this policy to embed in another JSON object.
     *
     * @param schemaVersion the JsonSchemaVersion in which to return the JSON.
     * @param fieldSelector determines the content of the result.
     * @return a JSON object representation of this policy to embed in another JSON object.
     * @throws NullPointerException if {@code predicate} is {@code null}.
     */
    default JsonObject toInlinedJson(final JsonSchemaVersion schemaVersion, final JsonFieldSelector fieldSelector) {
<span class="nc" id="L434">        return JsonFactory.newObjectBuilder()</span>
<span class="nc" id="L435">                .set(INLINED_FIELD_NAME, toJson(schemaVersion, fieldSelector))</span>
<span class="nc" id="L436">                .build();</span>
    }

    /**
     * An enumeration of the known {@link JsonField}s of a Policy.
     */
    @Immutable
    final class JsonFields {

        /**
         * JSON field containing the {@link JsonSchemaVersion}.
         */
        public static final JsonFieldDefinition&lt;Integer&gt; SCHEMA_VERSION =
<span class="fc" id="L449">                JsonFactory.newIntFieldDefinition(JsonSchemaVersion.getJsonKey(), FieldType.SPECIAL, FieldType.HIDDEN,</span>
                        JsonSchemaVersion.V_2);

        /**
         * JSON field containing the Policy's lifecycle.
         */
<span class="fc" id="L455">        public static final JsonFieldDefinition&lt;String&gt; LIFECYCLE =</span>
<span class="fc" id="L456">                JsonFactory.newStringFieldDefinition(&quot;__lifecycle&quot;, FieldType.SPECIAL, FieldType.HIDDEN,</span>
                        JsonSchemaVersion.V_2);

        /**
         * JSON field containing the Policy's namespace.
         */
<span class="fc" id="L462">        public static final JsonFieldDefinition&lt;String&gt; NAMESPACE =</span>
<span class="fc" id="L463">                JsonFactory.newStringFieldDefinition(&quot;_namespace&quot;, FieldType.SPECIAL, FieldType.HIDDEN,</span>
                        JsonSchemaVersion.V_2);

        /**
         * JSON field containing the Policy's revision.
         */
<span class="fc" id="L469">        public static final JsonFieldDefinition&lt;Long&gt; REVISION =</span>
<span class="fc" id="L470">                JsonFactory.newLongFieldDefinition(&quot;_revision&quot;, FieldType.SPECIAL, FieldType.HIDDEN,</span>
                        JsonSchemaVersion.V_2);

        /**
         * JSON field containing the Policy's modified timestamp in ISO-8601 format.
         */
<span class="fc" id="L476">        public static final JsonFieldDefinition&lt;String&gt; MODIFIED =</span>
<span class="fc" id="L477">                JsonFactory.newStringFieldDefinition(&quot;_modified&quot;, FieldType.SPECIAL, FieldType.HIDDEN,</span>
                        JsonSchemaVersion.V_1, JsonSchemaVersion.V_2);

        /**
         * JSON field containing the Policy's ID.
         */
<span class="fc" id="L483">        public static final JsonFieldDefinition&lt;String&gt; ID =</span>
<span class="fc" id="L484">                JsonFactory.newStringFieldDefinition(&quot;policyId&quot;, FieldType.REGULAR, JsonSchemaVersion.V_2);</span>

        /**
         * JSON field containing the Policy's entries.
         */
<span class="fc" id="L489">        public static final JsonFieldDefinition&lt;JsonObject&gt; ENTRIES =</span>
<span class="fc" id="L490">                JsonFactory.newJsonObjectFieldDefinition(&quot;entries&quot;, FieldType.REGULAR, JsonSchemaVersion.V_2);</span>

<span class="nc" id="L492">        private JsonFields() {</span>
<span class="nc" id="L493">            throw new AssertionError();</span>
        }

    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.0.201801022044</span></div></body></html>