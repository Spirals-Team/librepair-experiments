<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ImmutableThing.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Eclipse Ditto :: Model :: Things</a> &gt; <a href="index.source.html" class="el_package">org.eclipse.ditto.model.things</a> &gt; <span class="el_source">ImmutableThing.java</span></div><h1>ImmutableThing.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2017 Bosch Software Innovations GmbH.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v2.0
 * which accompanies this distribution, and is available at
 * https://www.eclipse.org/org/documents/epl-2.0/index.php
 *
 * Contributors:
 *    Bosch Software Innovations GmbH - initial contribution
 */
package org.eclipse.ditto.model.things;

import java.time.Instant;
import java.util.Objects;
import java.util.Optional;
import java.util.function.Predicate;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import javax.annotation.Nullable;
import javax.annotation.concurrent.Immutable;

import org.eclipse.ditto.json.JsonFactory;
import org.eclipse.ditto.json.JsonField;
import org.eclipse.ditto.json.JsonObject;
import org.eclipse.ditto.json.JsonObjectBuilder;
import org.eclipse.ditto.json.JsonPointer;
import org.eclipse.ditto.json.JsonValue;
import org.eclipse.ditto.model.base.auth.AuthorizationSubject;
import org.eclipse.ditto.model.base.common.ConditionChecker;
import org.eclipse.ditto.model.base.json.FieldType;
import org.eclipse.ditto.model.base.json.JsonSchemaVersion;

/**
 * Representation of one Thing within Ditto.
 */
@Immutable
final class ImmutableThing implements Thing {

<span class="fc" id="L41">    private static final Pattern ID_PATTERN = Pattern.compile(ID_REGEX);</span>

    @Nullable private final String namespace;
    @Nullable private final String thingId;
    @Nullable private final AccessControlList acl;
    @Nullable private final String policyId;
    @Nullable private final Attributes attributes;
    @Nullable private final Features features;
    @Nullable private final ThingLifecycle lifecycle;
    @Nullable private final ThingRevision revision;
    @Nullable private final Instant modified;

    private ImmutableThing(@Nullable final String thingId,
            @Nullable final AccessControlList acl,
            @Nullable final String policyId,
            @Nullable final Attributes attributes,
            @Nullable final Features features,
            @Nullable final ThingLifecycle lifecycle,
            @Nullable final ThingRevision revision,
<span class="fc" id="L60">            @Nullable final Instant modified) {</span>

<span class="fc bfc" id="L62" title="All 2 branches covered.">        if (null != thingId) {</span>
<span class="fc" id="L63">            final Matcher nsMatcher = ID_PATTERN.matcher(thingId);</span>
<span class="fc" id="L64">            nsMatcher.matches();</span>
<span class="fc" id="L65">            namespace = nsMatcher.group(&quot;ns&quot;);</span>
<span class="fc" id="L66">        } else {</span>
<span class="fc" id="L67">            namespace = null;</span>
        }
<span class="fc" id="L69">        this.thingId = thingId;</span>
<span class="fc" id="L70">        this.acl = acl;</span>
<span class="fc" id="L71">        this.policyId = policyId;</span>
<span class="fc" id="L72">        this.attributes = attributes;</span>
<span class="fc" id="L73">        this.features = features;</span>
<span class="fc" id="L74">        this.lifecycle = lifecycle;</span>
<span class="fc" id="L75">        this.revision = revision;</span>
<span class="fc" id="L76">        this.modified = modified;</span>
<span class="fc" id="L77">    }</span>

    /**
     * Creates a new Thing object which is based on the given values.
     *
     * @param thingId the ID of the Thing to be created.
     * @param accessControlList the Access Control List of the Thing to be created.
     * @param attributes the attributes of the Thing to be created.
     * @param features the features of the Thing to be created.
     * @param lifecycle the lifecycle of the Thing to be created.
     * @param revision the revision of the Thing to be created.
     * @param modified the modified timestamp of the thing to be created.
     * @return the {@code Thing} which was created from the given JSON object.
     */
    static Thing of(@Nullable final String thingId,
            @Nullable final AccessControlList accessControlList,
            @Nullable final Attributes attributes,
            @Nullable final Features features,
            @Nullable final ThingLifecycle lifecycle,
            @Nullable final ThingRevision revision,
            @Nullable final Instant modified) {

<span class="fc" id="L99">        return new ImmutableThing(thingId, accessControlList, null, attributes, features, lifecycle, revision,</span>
                modified);
    }

    /**
     * Creates a new Thing object which is based on the given values.
     *
     * @param thingId the ID of the Thing to be created.
     * @param policyId the Policy ID for the Thing to be created.
     * @param attributes the attributes of the Thing to be created.
     * @param features the features of the Thing to be created.
     * @param lifecycle the lifecycle of the Thing to be created.
     * @param revision the revision of the Thing to be created.
     * @param modified the modified timestamp of the thing to be created.
     * @return the {@code Thing} which was created from the given JSON object.
     */
    static Thing of(@Nullable final String thingId,
            @Nullable final String policyId,
            @Nullable final Attributes attributes,
            @Nullable final Features features,
            @Nullable final ThingLifecycle lifecycle,
            @Nullable final ThingRevision revision,
            @Nullable final Instant modified) {

<span class="fc" id="L123">        return new ImmutableThing(thingId, null, policyId, attributes, features, lifecycle, revision, modified);</span>
    }

    @Override
    public Optional&lt;ThingRevision&gt; getRevision() {
<span class="fc" id="L128">        return Optional.ofNullable(revision);</span>
    }

    @Override
    public Optional&lt;Instant&gt; getModified() {
<span class="fc" id="L133">        return Optional.ofNullable(modified);</span>
    }

    @Override
    public Optional&lt;String&gt; getId() {
<span class="fc" id="L138">        return Optional.ofNullable(thingId);</span>
    }

    @Override
    public Optional&lt;String&gt; getNamespace() {
<span class="fc" id="L143">        return Optional.ofNullable(namespace);</span>
    }

    @Override
    public Optional&lt;Attributes&gt; getAttributes() {
<span class="fc" id="L148">        return Optional.ofNullable(attributes);</span>
    }

    @Override
    public Thing setAttributes(@Nullable final Attributes attributes) {
<span class="fc bfc" id="L153" title="All 2 branches covered.">        if (Objects.equals(this.attributes, attributes)) {</span>
<span class="fc" id="L154">            return this;</span>
        }

<span class="fc" id="L157">        return new ImmutableThing(thingId, acl, policyId, attributes, features, lifecycle, revision, modified);</span>
    }

    @Override
    public Thing removeAttributes() {
<span class="fc bfc" id="L162" title="All 2 branches covered.">        if (null == attributes) {</span>
<span class="fc" id="L163">            return this;</span>
        }

<span class="fc" id="L166">        return setAttributes(null);</span>
    }

    @Override
    public Thing setAttribute(final JsonPointer attributePath, final JsonValue attributeValue) {
        final Attributes newAttributes;
<span class="pc bpc" id="L172" title="1 of 4 branches missed.">        if (null == attributes || attributes.isNull()) {</span>
<span class="fc" id="L173">            newAttributes = ThingsModelFactory.newAttributesBuilder()</span>
<span class="fc" id="L174">                    .set(attributePath, attributeValue)</span>
<span class="fc" id="L175">                    .build();</span>
        } else {
<span class="fc" id="L177">            newAttributes = attributes.setValue(attributePath, attributeValue);</span>
        }

<span class="fc" id="L180">        return setAttributes(newAttributes);</span>
    }

    @Override
    public Thing removeAttribute(final JsonPointer attributePath) {
<span class="pc bpc" id="L185" title="2 of 6 branches missed.">        if (null == attributes || attributes.isEmpty() || attributes.isNull()) {</span>
<span class="fc" id="L186">            return this;</span>
        }

<span class="fc" id="L189">        return setAttributes(attributes.remove(attributePath));</span>
    }

    @Override
    public Optional&lt;Features&gt; getFeatures() {
<span class="fc" id="L194">        return Optional.ofNullable(features);</span>
    }

    @Override
    public Thing removeFeatures() {
<span class="fc bfc" id="L199" title="All 2 branches covered.">        if (null == features) {</span>
<span class="fc" id="L200">            return this;</span>
        }

<span class="fc" id="L203">        return setFeatures(null);</span>
    }

    @Override
    public Thing setFeatures(@Nullable final Features features) {
<span class="fc bfc" id="L208" title="All 2 branches covered.">        if (Objects.equals(this.features, features)) {</span>
<span class="fc" id="L209">            return this;</span>
        }

<span class="fc" id="L212">        return new ImmutableThing(thingId, acl, policyId, attributes, features, lifecycle, revision, modified);</span>
    }

    @Override
    public Thing setFeature(final Feature feature) {
        final Features newFeatures;
<span class="pc bpc" id="L218" title="1 of 4 branches missed.">        if (null == features || features.isNull()) {</span>
<span class="fc" id="L219">            newFeatures = ThingsModelFactory.newFeaturesBuilder()</span>
<span class="fc" id="L220">                    .set(feature)</span>
<span class="fc" id="L221">                    .build();</span>
        } else {
<span class="fc" id="L223">            newFeatures = features.setFeature(feature);</span>
        }

<span class="fc" id="L226">        return setFeatures(newFeatures);</span>
    }

    @Override
    public Thing removeFeature(final String featureId) {
<span class="fc bfc" id="L231" title="All 2 branches covered.">        return (null != features) ? setFeatures(features.removeFeature(featureId)) : this;</span>
    }

    @Override
    public Thing setFeatureDefinition(final String featureId, final FeatureDefinition definition) {
<span class="pc bpc" id="L236" title="3 of 4 branches missed.">        if (null == features || features.isNull()) {</span>
<span class="fc" id="L237">            return setFeature(ThingsModelFactory.newFeature(featureId, definition, null));</span>
        }
<span class="nc" id="L239">        return setFeatures(features.setDefinition(featureId, definition));</span>
    }

    @Override
    public Thing removeFeatureDefinition(final String featureId) {
<span class="pc bpc" id="L244" title="1 of 2 branches missed.">        return (null != features) ? setFeatures(features.removeDefinition(featureId)) : this;</span>
    }

    @Override
    public Thing setFeatureProperties(final String featureId, final FeatureProperties properties) {
<span class="pc bpc" id="L249" title="1 of 4 branches missed.">        if (null == features || features.isNull()) {</span>
<span class="fc" id="L250">            return setFeature(ThingsModelFactory.newFeature(featureId, properties));</span>
        }
<span class="fc" id="L252">        return setFeatures(features.setProperties(featureId, properties));</span>
    }

    @Override
    public Thing removeFeatureProperties(final String featureId) {
<span class="fc bfc" id="L257" title="All 2 branches covered.">        return (null != features) ? setFeatures(features.removeProperties(featureId)) : this;</span>
    }

    @Override
    public Thing setFeatureProperty(final String featureId, final JsonPointer propertyJsonPointer,
            final JsonValue propertyValue) {

        final Features newFeatures;
<span class="pc bpc" id="L265" title="1 of 4 branches missed.">        if (null == features || features.isNull()) {</span>
<span class="fc" id="L266">            final FeatureProperties featureProperties = ThingsModelFactory.newFeaturePropertiesBuilder()</span>
<span class="fc" id="L267">                    .set(propertyJsonPointer, propertyValue)</span>
<span class="fc" id="L268">                    .build();</span>
<span class="fc" id="L269">            newFeatures = ThingsModelFactory.newFeatures(ThingsModelFactory.newFeature(featureId, featureProperties));</span>
<span class="fc" id="L270">        } else {</span>
<span class="fc" id="L271">            newFeatures = features.setProperty(featureId, propertyJsonPointer, propertyValue);</span>
        }

<span class="fc" id="L274">        return setFeatures(newFeatures);</span>
    }

    @Override
    public Thing removeFeatureProperty(final String featureId, final JsonPointer propertyPath) {
<span class="fc bfc" id="L279" title="All 2 branches covered.">        return (null != features) ? setFeatures(features.removeProperty(featureId, propertyPath)) : this;</span>
    }

    @Override
    public Optional&lt;AccessControlList&gt; getAccessControlList() {
<span class="fc" id="L284">        return Optional.ofNullable(acl);</span>
    }

    @Override
    public Thing setAccessControlList(final AccessControlList accessControlList) {
<span class="pc bpc" id="L289" title="1 of 2 branches missed.">        if (policyId != null) {</span>
<span class="nc" id="L290">            throw AclInvalidException.newBuilder(thingId)</span>
<span class="nc" id="L291">                    .description(&quot;Could not set v1 ACL to Thing already containing v2 Policy&quot;)</span>
<span class="nc" id="L292">                    .build();</span>
<span class="fc bfc" id="L293" title="All 2 branches covered.">        } else if (Objects.equals(acl, accessControlList)) {</span>
<span class="fc" id="L294">            return this;</span>
        }

<span class="fc" id="L297">        return new ImmutableThing(thingId, accessControlList, null, attributes, features, lifecycle, revision,</span>
                modified);
    }

    @Override
    public Thing setAclEntry(final AclEntry aclEntry) {
        final AccessControlList newAcl;
<span class="pc bpc" id="L304" title="1 of 4 branches missed.">        if (null == acl || acl.isEmpty()) {</span>
<span class="fc" id="L305">            newAcl = ThingsModelFactory.newAcl(aclEntry);</span>
        } else {
<span class="fc" id="L307">            newAcl = acl.setEntry(aclEntry);</span>
        }

<span class="fc" id="L310">        return setAccessControlList(newAcl);</span>
    }

    @Override
    public Thing removeAllPermissionsOf(final AuthorizationSubject authorizationSubject) {
<span class="pc bpc" id="L315" title="1 of 4 branches missed.">        if (null == acl || acl.isEmpty()) {</span>
<span class="fc" id="L316">            return this;</span>
        }

<span class="fc" id="L319">        return setAccessControlList(acl.removeAllPermissionsOf(authorizationSubject));</span>
    }

    @Override
    public Optional&lt;String&gt; getPolicyId() {
<span class="fc" id="L324">        return Optional.ofNullable(policyId);</span>
    }

    @Override
    public Thing setPolicyId(@Nullable final String policyId) {
<span class="fc" id="L329">        return new ImmutableThing(thingId, acl, policyId, attributes, features, lifecycle, revision, modified);</span>
    }

    @Override
    public Optional&lt;ThingLifecycle&gt; getLifecycle() {
<span class="fc" id="L334">        return Optional.ofNullable(lifecycle);</span>
    }

    @Override
    public Thing setLifecycle(final ThingLifecycle newLifecycle) {
<span class="fc" id="L339">        ConditionChecker.checkNotNull(newLifecycle, &quot;lifecycle to be set&quot;);</span>

<span class="fc" id="L341">        return new ImmutableThing(thingId, acl, policyId, attributes, features, newLifecycle, revision, modified);</span>
    }

    @Override
    public JsonObject toJson(final JsonSchemaVersion schemaVersion, final Predicate&lt;JsonField&gt; thePredicate) {
<span class="fc" id="L346">        final Predicate&lt;JsonField&gt; predicate = schemaVersion.and(thePredicate);</span>

<span class="fc" id="L348">        final JsonObjectBuilder jsonObjectBuilder = JsonFactory.newObjectBuilder();</span>
<span class="fc" id="L349">        jsonObjectBuilder.set(JsonFields.SCHEMA_VERSION, schemaVersion.toInt(), predicate);</span>

<span class="fc bfc" id="L351" title="All 2 branches covered.">        if (null != lifecycle) {</span>
<span class="fc" id="L352">            jsonObjectBuilder.set(JsonFields.LIFECYCLE, lifecycle.name(), predicate);</span>
        }

<span class="fc bfc" id="L355" title="All 2 branches covered.">        if (null != revision) {</span>
<span class="fc" id="L356">            jsonObjectBuilder.set(JsonFields.REVISION, revision.toLong(), predicate);</span>
        }

<span class="fc bfc" id="L359" title="All 2 branches covered.">        if (null != modified) {</span>
<span class="fc" id="L360">            jsonObjectBuilder.set(JsonFields.MODIFIED, modified.toString(), predicate);</span>
        }

<span class="fc bfc" id="L363" title="All 2 branches covered.">        if (null != thingId) {</span>
<span class="fc" id="L364">            jsonObjectBuilder.set(JsonFields.NAMESPACE, namespace, predicate);</span>
<span class="fc" id="L365">            jsonObjectBuilder.set(JsonFields.ID, thingId, predicate);</span>
        }

<span class="fc bfc" id="L368" title="All 2 branches covered.">        if (JsonSchemaVersion.V_1.equals(schemaVersion)) {</span>
<span class="fc" id="L369">            final AccessControlList theAcl = getAccessControlList().orElseGet(ThingsModelFactory::emptyAcl);</span>
<span class="fc" id="L370">            jsonObjectBuilder.set(JsonFields.ACL, theAcl.toJson(), predicate);</span>
<span class="fc bfc" id="L371" title="All 2 branches covered.">        } else if (null != policyId) {</span>
<span class="fc" id="L372">            jsonObjectBuilder.set(JsonFields.POLICY_ID, policyId, predicate);</span>
        }

<span class="pc bpc" id="L375" title="1 of 2 branches missed.">        if (null != attributes) {</span>
<span class="fc" id="L376">            jsonObjectBuilder.set(JsonFields.ATTRIBUTES, attributes, predicate);</span>
        }

<span class="fc bfc" id="L379" title="All 2 branches covered.">        if (null != features) {</span>
            // notice: only &quot;not HIDDEN&quot; sub-fields of features are included
<span class="fc" id="L381">            jsonObjectBuilder.set(JsonFields.FEATURES,</span>
<span class="fc" id="L382">                    features.toJson(schemaVersion, thePredicate.and(FieldType.notHidden())), predicate);</span>
        }

<span class="fc" id="L385">        return jsonObjectBuilder.build();</span>
    }

    @Override
    public int hashCode() {
<span class="fc" id="L390">        return Objects.hash(thingId, namespace, policyId, acl, attributes, features, lifecycle, revision,</span>
                modified);
    }

    @SuppressWarnings({&quot;squid:MethodCyclomaticComplexity&quot;, &quot;squid:S1067&quot;, &quot;OverlyComplexMethod&quot;})
    @Override
    public boolean equals(final Object obj) {
<span class="fc bfc" id="L397" title="All 2 branches covered.">        if (this == obj) {</span>
<span class="fc" id="L398">            return true;</span>
        }
<span class="fc bfc" id="L400" title="All 2 branches covered.">        if (obj == null) {</span>
<span class="fc" id="L401">            return false;</span>
        }
<span class="fc bfc" id="L403" title="All 2 branches covered.">        if (getClass() != obj.getClass()) {</span>
<span class="fc" id="L404">            return false;</span>
        }
<span class="fc" id="L406">        final ImmutableThing other = (ImmutableThing) obj;</span>
<span class="fc bfc" id="L407" title="All 2 branches covered.">        return Objects.equals(thingId, other.thingId) &amp;&amp;</span>
<span class="fc bfc" id="L408" title="All 2 branches covered.">                Objects.equals(namespace, other.namespace) &amp;&amp;</span>
<span class="fc bfc" id="L409" title="All 2 branches covered.">                Objects.equals(policyId, other.policyId) &amp;&amp;</span>
<span class="fc bfc" id="L410" title="All 2 branches covered.">                Objects.equals(acl, other.acl) &amp;&amp;</span>
<span class="fc bfc" id="L411" title="All 2 branches covered.">                Objects.equals(attributes, other.attributes) &amp;&amp;</span>
<span class="fc bfc" id="L412" title="All 2 branches covered.">                Objects.equals(features, other.features) &amp;&amp;</span>
<span class="fc bfc" id="L413" title="All 2 branches covered.">                Objects.equals(lifecycle, other.lifecycle) &amp;&amp;</span>
<span class="fc bfc" id="L414" title="All 2 branches covered.">                Objects.equals(revision, other.revision) &amp;&amp;</span>
<span class="fc bfc" id="L415" title="All 2 branches covered.">                Objects.equals(modified, other.modified);</span>
    }

    @Override
    public String toString() {
<span class="nc" id="L420">        return getClass().getSimpleName() + &quot; [thingId=&quot; + thingId + &quot;, namespace=&quot; + namespace + &quot;, acl=&quot; + acl +</span>
                &quot;, policyId=&quot; + policyId + &quot;, attributes=&quot; + attributes + &quot;, features=&quot; + features + &quot;, lifecycle=&quot; +
                lifecycle + &quot;, revision=&quot; + revision + &quot;, modified=&quot; + modified + &quot;]&quot;;
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.0.201801022044</span></div></body></html>