<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AlgorithmTemplateServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">semantic-mapper</a> &gt; <a href="index.source.html" class="el_package">org.molgenis.semanticmapper.service.impl</a> &gt; <span class="el_source">AlgorithmTemplateServiceImpl.java</span></div><h1>AlgorithmTemplateServiceImpl.java</h1><pre class="source lang-java linenums">package org.molgenis.semanticmapper.service.impl;

import org.molgenis.data.DataService;
import org.molgenis.data.meta.model.Attribute;
import org.molgenis.data.support.QueryImpl;
import org.molgenis.js.magma.JsMagmaScriptRunner;
import org.molgenis.script.core.Script;
import org.molgenis.script.core.ScriptParameter;
import org.molgenis.semanticsearch.explain.bean.ExplainedAttribute;
import org.springframework.stereotype.Service;

import java.util.HashMap;
import java.util.Map;
import java.util.stream.Stream;
import java.util.stream.StreamSupport;

import static java.util.Objects.requireNonNull;
import static org.molgenis.script.core.ScriptMetaData.SCRIPT;
import static org.molgenis.script.core.ScriptMetaData.TYPE;

@Service
public class AlgorithmTemplateServiceImpl implements AlgorithmTemplateService
{
	private final DataService dataService;

	public AlgorithmTemplateServiceImpl(DataService dataService)
<span class="fc" id="L27">	{</span>
<span class="fc" id="L28">		this.dataService = requireNonNull(dataService);</span>
<span class="fc" id="L29">	}</span>

	@Override
	public Stream&lt;AlgorithmTemplate&gt; find(Map&lt;Attribute, ExplainedAttribute&gt; attrMatches)
	{
		// get all algorithm templates
<span class="fc" id="L35">		Stream&lt;Script&gt; jsScripts = dataService.findAll(SCRIPT,</span>
<span class="fc" id="L36">				new QueryImpl&lt;Script&gt;().eq(TYPE, JsMagmaScriptRunner.NAME), Script.class);</span>

		// select all algorithm templates that can be used with target and sources
<span class="fc" id="L39">		return jsScripts.flatMap(script -&gt; toAlgorithmTemplate(script, attrMatches));</span>
	}

	private Stream&lt;AlgorithmTemplate&gt; toAlgorithmTemplate(Script script, Map&lt;Attribute, ExplainedAttribute&gt; attrMatches)
	{
		// find attribute for each parameter
<span class="fc" id="L45">		boolean paramMatch = true;</span>
<span class="fc" id="L46">		Map&lt;String, String&gt; model = new HashMap&lt;&gt;();</span>
<span class="fc bfc" id="L47" title="All 2 branches covered.">		for (ScriptParameter param : script.getParameters())</span>
		{
<span class="fc" id="L49">			Attribute attr = mapParamToAttribute(param, attrMatches);</span>
<span class="pc bpc" id="L50" title="1 of 2 branches missed.">			if (attr != null)</span>
			{
<span class="fc" id="L52">				model.put(param.getName(), attr.getName());</span>
			}
			else
			{
<span class="nc" id="L56">				paramMatch = false;</span>
<span class="nc" id="L57">				break;</span>
			}
<span class="fc" id="L59">		}</span>

		// create algorithm template if an attribute was found for all parameters
<span class="fc" id="L62">		AlgorithmTemplate algorithmTemplate = new AlgorithmTemplate(script, model);</span>

<span class="pc bpc" id="L64" title="1 of 2 branches missed.">		return paramMatch ? Stream.of(algorithmTemplate) : Stream.empty();</span>
	}

	private Attribute mapParamToAttribute(ScriptParameter param, Map&lt;Attribute, ExplainedAttribute&gt; attrMatches)
	{

<span class="fc" id="L70">		return attrMatches.entrySet()</span>
<span class="fc" id="L71">						  .stream()</span>
<span class="pc bpc" id="L72" title="1 of 2 branches missed.">						  .filter(entry -&gt; !entry.getValue().getExplainedQueryStrings().isEmpty())</span>
<span class="fc" id="L73">						  .filter(entry -&gt; StreamSupport.stream(</span>
<span class="fc" id="L74">								  entry.getValue().getExplainedQueryStrings().spliterator(), false)</span>
<span class="fc" id="L75">														.allMatch(explain -&gt; explain.getTagName()</span>
<span class="fc" id="L76">																					.equalsIgnoreCase(param.getName())))</span>
<span class="fc" id="L77">						  .map(Map.Entry::getKey)</span>
<span class="fc" id="L78">						  .findFirst()</span>
<span class="fc" id="L79">						  .orElse(null);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>