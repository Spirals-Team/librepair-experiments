<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CategoryMapperUtil.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">semantic-mapper</a> &gt; <a href="index.source.html" class="el_package">org.molgenis.semanticmapper.algorithmgenerator.categorymapper</a> &gt; <span class="el_source">CategoryMapperUtil.java</span></div><h1>CategoryMapperUtil.java</h1><pre class="source lang-java linenums">package org.molgenis.semanticmapper.algorithmgenerator.categorymapper;

import com.google.common.collect.Lists;
import com.google.common.collect.Sets;
import org.jscience.physics.amount.Amount;
import org.molgenis.semanticmapper.algorithmgenerator.bean.AmountWrapper;
import org.molgenis.semanticmapper.algorithmgenerator.categorymapper.convertor.AmountConvertor;
import org.molgenis.semanticmapper.algorithmgenerator.categorymapper.convertor.DailyAmountConvertor;
import org.molgenis.semanticmapper.algorithmgenerator.categorymapper.convertor.NumberAmountConvertor;
import org.molgenis.semanticmapper.algorithmgenerator.categorymapper.convertor.SeveralTimesConvertor;

import javax.measure.converter.UnitConverter;
import javax.measure.unit.NonSI;
import javax.measure.unit.SI;
import javax.measure.unit.Unit;
import java.util.*;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

<span class="nc" id="L20">public class CategoryMapperUtil</span>
{
<span class="fc" id="L22">	private static final List&lt;AmountConvertor&gt; CONVERTORS = Lists.newArrayList(new DailyAmountConvertor(),</span>
			new SeveralTimesConvertor(), new NumberAmountConvertor());

<span class="fc" id="L25">	private static final Pattern NUMBER_PATTERN = Pattern.compile(&quot;\\d+\\.?\\d*&quot;);</span>
	private static final String NON_LETTER_REGEX = &quot;[^a-zA-Z0-9]&quot;;
	private static final List&lt;Unit&lt;?&gt;&gt; DURATION_UNITS;

	static
	{
<span class="fc" id="L31">		DURATION_UNITS = Arrays.asList(SI.SECOND.inverse(), NonSI.MINUTE.inverse(), NonSI.HOUR.inverse(),</span>
<span class="fc" id="L32">				NonSI.DAY.inverse(), NonSI.WEEK.inverse(), NonSI.MONTH.inverse(), NonSI.YEAR.inverse());</span>
	}

	private static final Set&lt;String&gt; POSITIVE_ADJECTIVES;

	static
	{
<span class="fc" id="L39">		POSITIVE_ADJECTIVES = new HashSet&lt;&gt;();</span>
<span class="fc" id="L40">		POSITIVE_ADJECTIVES.add(&quot;almost&quot;);</span>
	}

	private static final Set&lt;String&gt; NEGATIVE_ADJECTIVES;

	static
	{
<span class="fc" id="L47">		NEGATIVE_ADJECTIVES = new HashSet&lt;&gt;();</span>
<span class="fc" id="L48">		NEGATIVE_ADJECTIVES.add(&quot;never&quot;);</span>
<span class="fc" id="L49">		NEGATIVE_ADJECTIVES.add(&quot;less&quot;);</span>
<span class="fc" id="L50">		NEGATIVE_ADJECTIVES.add(&quot;fewer&quot;);</span>
	}

	private static final Map&lt;String, Integer&gt; WORD_TO_NUMBER_MAP;
	private static final double STANDARD_ERROR = 0.0000000001;

	static
	{
<span class="fc" id="L58">		WORD_TO_NUMBER_MAP = new HashMap&lt;&gt;();</span>
<span class="fc" id="L59">		WORD_TO_NUMBER_MAP.put(&quot;one&quot;, 1);</span>
<span class="fc" id="L60">		WORD_TO_NUMBER_MAP.put(&quot;two&quot;, 2);</span>
<span class="fc" id="L61">		WORD_TO_NUMBER_MAP.put(&quot;three&quot;, 3);</span>
<span class="fc" id="L62">		WORD_TO_NUMBER_MAP.put(&quot;four&quot;, 4);</span>
<span class="fc" id="L63">		WORD_TO_NUMBER_MAP.put(&quot;five&quot;, 5);</span>
<span class="fc" id="L64">		WORD_TO_NUMBER_MAP.put(&quot;six&quot;, 6);</span>
<span class="fc" id="L65">		WORD_TO_NUMBER_MAP.put(&quot;seven&quot;, 7);</span>
<span class="fc" id="L66">		WORD_TO_NUMBER_MAP.put(&quot;eight&quot;, 8);</span>
<span class="fc" id="L67">		WORD_TO_NUMBER_MAP.put(&quot;nine&quot;, 9);</span>
<span class="fc" id="L68">		WORD_TO_NUMBER_MAP.put(&quot;ten&quot;, 10);</span>

<span class="fc" id="L70">		WORD_TO_NUMBER_MAP.put(&quot;once&quot;, 1);</span>
<span class="fc" id="L71">		WORD_TO_NUMBER_MAP.put(&quot;twice&quot;, 2);</span>
<span class="fc" id="L72">	}</span>

	public static boolean containNegativeAdjectives(String description)
	{
<span class="fc" id="L76">		String lowerCase = description.toLowerCase();</span>
<span class="fc" id="L77">		return NEGATIVE_ADJECTIVES.stream().anyMatch(lowerCase::contains);</span>
	}

	public static Unit&lt;?&gt; getMoreSpecificUnit(Unit&lt;?&gt; unit)
	{
<span class="nc" id="L82">		int indexOf = DURATION_UNITS.indexOf(unit);</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">		if (indexOf &lt;= 0)</span>
		{
<span class="nc" id="L85">			return unit;</span>
		}
		else
		{
<span class="nc" id="L89">			return DURATION_UNITS.get(--indexOf);</span>
		}
	}

	public static AmountWrapper convertDescriptionToAmount(String description)
	{
<span class="fc" id="L95">		String cleanedDescription = convertWordToNumber(description);</span>
<span class="pc bpc" id="L96" title="1 of 2 branches missed.">		for (AmountConvertor convertor : CONVERTORS)</span>
		{
<span class="fc bfc" id="L98" title="All 2 branches covered.">			if (convertor.matchCriteria(cleanedDescription))</span>
			{
<span class="fc" id="L100">				return convertor.getAmount(cleanedDescription);</span>
			}
<span class="fc" id="L102">		}</span>
<span class="nc" id="L103">		return null;</span>
	}

	public static String convertWordToNumber(String description)
	{
<span class="fc" id="L108">		StringBuilder stringBuilder = new StringBuilder();</span>
<span class="fc bfc" id="L109" title="All 2 branches covered.">		for (String token : description.toLowerCase().split(NON_LETTER_REGEX))</span>
		{
<span class="fc bfc" id="L111" title="All 2 branches covered.">			if (stringBuilder.length() &gt; 0) stringBuilder.append(' ');</span>
<span class="fc bfc" id="L112" title="All 2 branches covered.">			if (WORD_TO_NUMBER_MAP.containsKey(token))</span>
			{
<span class="fc" id="L114">				stringBuilder.append(WORD_TO_NUMBER_MAP.get(token));</span>
			}
			else
			{
<span class="fc" id="L118">				stringBuilder.append(token);</span>
			}
		}
<span class="fc" id="L121">		return stringBuilder.toString();</span>
	}

	public static Unit&lt;?&gt; findDurationUnit(String description)
	{
<span class="fc" id="L126">		Set&lt;String&gt; tokens = Sets.newHashSet(description.toLowerCase().split(NON_LETTER_REGEX));</span>

<span class="fc" id="L128">		List&lt;Unit&lt;?&gt;&gt; candidateUnits = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L130" title="All 2 branches covered.">		for (Unit&lt;?&gt; unit : DURATION_UNITS)</span>
		{
<span class="fc bfc" id="L132" title="All 2 branches covered.">			if (tokens.contains(unit.inverse().toString().toLowerCase()))</span>
			{
<span class="fc" id="L134">				candidateUnits.add(unit);</span>
			}
<span class="fc" id="L136">		}</span>

<span class="fc" id="L138">		return getMostGeneralUnit(candidateUnits);</span>
	}

	public static Unit&lt;?&gt; getMostGeneralUnit(List&lt;Unit&lt;?&gt;&gt; candidateUnits)
	{
<span class="fc" id="L143">		candidateUnits.sort((o1, o2) -&gt;</span>
		{
<span class="fc" id="L145">			UnitConverter converterTo = o1.inverse().getConverterTo(o2.inverse());</span>
<span class="fc bfc" id="L146" title="All 2 branches covered.">			if (converterTo.convert(1) &gt; 1)</span>
			{
<span class="fc" id="L148">				return -1;</span>
			}
			else
			{
<span class="fc" id="L152">				return 1;</span>
			}
		});

<span class="fc bfc" id="L156" title="All 2 branches covered.">		return candidateUnits.isEmpty() ? null : candidateUnits.get(0);</span>
	}

	public static List&lt;Double&gt; extractNumbers(String description)
	{
<span class="fc" id="L161">		List&lt;Double&gt; extractedNumbers = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L162">		String lowerCasedDesc = description.toLowerCase();</span>
<span class="fc" id="L163">		Matcher mather = NUMBER_PATTERN.matcher(lowerCasedDesc);</span>
<span class="fc bfc" id="L164" title="All 2 branches covered.">		while (mather.find())</span>
		{
<span class="fc" id="L166">			extractedNumbers.add(Double.parseDouble(mather.group()));</span>
		}
<span class="fc" id="L168">		return extractedNumbers;</span>
	}

	public static boolean containsNegativeAdjectives(String description)
	{
<span class="nc" id="L173">		String lowerCasedDesc = description.toLowerCase();</span>
<span class="nc" id="L174">		return NEGATIVE_ADJECTIVES.stream().anyMatch(lowerCasedDesc::contains);</span>
	}

	public static boolean isAmountRanged(Amount&lt;?&gt; amount)
	{
<span class="fc bfc" id="L179" title="All 2 branches covered.">		return amount.getMaximumValue() - amount.getMinimumValue() &gt; STANDARD_ERROR;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>