<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PermissionManagerController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">core-ui</a> &gt; <a href="index.source.html" class="el_package">org.molgenis.core.ui.admin.permission</a> &gt; <span class="el_source">PermissionManagerController.java</span></div><h1>PermissionManagerController.java</h1><pre class="source lang-java linenums">package org.molgenis.core.ui.admin.permission;

import com.google.common.collect.LinkedHashMultimap;
import com.google.common.collect.Lists;
import com.google.common.collect.Multimap;
import org.molgenis.core.ui.admin.permission.exception.UnexpectedPermissionException;
import org.molgenis.data.DataService;
import org.molgenis.data.meta.model.EntityType;
import org.molgenis.data.meta.model.EntityTypeMetadata;
import org.molgenis.data.meta.model.Package;
import org.molgenis.data.meta.model.PackageMetadata;
import org.molgenis.data.meta.system.SystemEntityTypeRegistry;
import org.molgenis.data.plugin.model.Plugin;
import org.molgenis.data.plugin.model.PluginIdentity;
import org.molgenis.data.security.EntityIdentity;
import org.molgenis.data.security.EntityIdentityUtils;
import org.molgenis.data.security.EntityTypeIdentity;
import org.molgenis.data.security.PackageIdentity;
import org.molgenis.data.security.auth.Role;
import org.molgenis.data.security.auth.User;
import org.molgenis.security.acl.MutableAclClassService;
import org.molgenis.security.core.PermissionSet;
import org.molgenis.security.permission.Permissions;
import org.molgenis.web.PluginController;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.http.HttpStatus;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.acls.model.*;
import org.springframework.stereotype.Controller;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.context.request.WebRequest;

import javax.validation.Valid;
import java.util.*;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import static java.lang.String.format;
import static java.util.Collections.singletonList;
import static java.util.Comparator.comparing;
import static java.util.Objects.requireNonNull;
import static java.util.stream.Collectors.toList;
import static java.util.stream.Collectors.toSet;
import static org.molgenis.core.ui.admin.permission.PermissionManagerController.URI;
import static org.molgenis.data.plugin.model.PluginMetadata.PLUGIN;
import static org.molgenis.data.security.SidUtils.createRoleSid;
import static org.molgenis.data.security.SidUtils.createUserSid;
import static org.molgenis.data.security.auth.RoleMetadata.ROLE;
import static org.molgenis.data.security.auth.UserMetaData.USER;
import static org.molgenis.security.core.PermissionSet.*;

@Controller
@RequestMapping(URI)
public class PermissionManagerController extends PluginController
{
<span class="fc" id="L59">	private static final Logger LOG = LoggerFactory.getLogger(PermissionManagerController.class);</span>

	public static final String URI = PluginController.PLUGIN_URI_PREFIX + &quot;permissionmanager&quot;;
	public static final String RADIO = &quot;radio-&quot;;

	private final DataService dataService;
	private final MutableAclService mutableAclService;
	private final MutableAclClassService mutableAclClassService;
	private final SystemEntityTypeRegistry systemEntityTypeRegistry;

	public PermissionManagerController(DataService dataService, MutableAclService mutableAclService,
			MutableAclClassService mutableAclClassService, SystemEntityTypeRegistry systemEntityTypeRegistry)
	{
<span class="fc" id="L72">		super(URI);</span>
<span class="fc" id="L73">		this.dataService = requireNonNull(dataService);</span>
<span class="fc" id="L74">		this.mutableAclService = requireNonNull(mutableAclService);</span>
<span class="fc" id="L75">		this.mutableAclClassService = requireNonNull(mutableAclClassService);</span>
<span class="fc" id="L76">		this.systemEntityTypeRegistry = requireNonNull(systemEntityTypeRegistry);</span>
<span class="fc" id="L77">	}</span>

	@GetMapping
	public String init(Model model)
	{
<span class="fc" id="L82">		model.addAttribute(&quot;users&quot;, Lists.newArrayList(getUsers().stream().filter(user -&gt;</span>
		{
<span class="fc" id="L84">			Boolean superuser = user.isSuperuser();</span>
<span class="pc bpc" id="L85" title="1 of 4 branches missed.">			return superuser == null || !superuser;</span>
<span class="fc" id="L86">		}).collect(Collectors.toList())));</span>
<span class="fc" id="L87">		model.addAttribute(&quot;roles&quot;, getRoles());</span>
<span class="fc" id="L88">		model.addAttribute(&quot;entityTypes&quot;, getEntityTypeDtos());</span>
<span class="fc" id="L89">		return &quot;view-permissionmanager&quot;;</span>
	}

	private List&lt;EntityTypeRlsResponse&gt; getEntityTypeDtos()
	{
<span class="pc bpc" id="L94" title="1 of 2 branches missed.">		List&lt;EntityType&gt; entityTypes = getEntityTypes().filter(entityType -&gt; !entityType.isAbstract())</span>
<span class="fc" id="L95">													   .collect(toList());</span>
<span class="fc" id="L96">		Collection&lt;String&gt; aclClasses = mutableAclClassService.getAclClassTypes();</span>
<span class="fc" id="L97">		entityTypes.sort(comparing(EntityType::getLabel));</span>
<span class="fc" id="L98">		return entityTypes.stream().map(entityType -&gt;</span>
		{
<span class="fc" id="L100">			boolean rlsEnabled = aclClasses.contains(EntityIdentityUtils.toType(entityType));</span>
<span class="fc" id="L101">			boolean readOnly = systemEntityTypeRegistry.hasSystemEntityType(entityType.getId());</span>
<span class="fc" id="L102">			return new EntityTypeRlsResponse(entityType.getId(), entityType.getLabel(), rlsEnabled, readOnly);</span>
<span class="fc" id="L103">		}).collect(toList());</span>
	}

	@PreAuthorize(&quot;hasAnyRole('ROLE_SU')&quot;)
	@Transactional(readOnly = true)
	@GetMapping(&quot;/entityclass/role/{rolename}&quot;)
	@ResponseBody
	public Permissions getRoleEntityClassPermissions(@PathVariable String rolename)
	{
<span class="fc" id="L112">		Sid sid = createRoleSid(rolename);</span>
<span class="fc" id="L113">		return getEntityTypePermissions(sid);</span>
	}

	@PreAuthorize(&quot;hasAnyRole('ROLE_SU')&quot;)
	@Transactional(readOnly = true)
	@GetMapping(&quot;/plugin/user/{username}&quot;)
	@ResponseBody
	public Permissions getUserPluginPermissions(@PathVariable String username)
	{
<span class="fc" id="L122">		Sid sid = createUserSid(username);</span>
<span class="fc" id="L123">		return getPluginPermissions(sid);</span>
	}

	@PreAuthorize(&quot;hasAnyRole('ROLE_SU')&quot;)
	@Transactional(readOnly = true)
	@GetMapping(&quot;/package/user/{username}&quot;)
	@ResponseBody
	public Permissions getUserPackagePermissions(@PathVariable String username)
	{
<span class="fc" id="L132">		Sid sid = createUserSid(username);</span>
<span class="fc" id="L133">		return getPackagePermissions(sid);</span>
	}

	@PreAuthorize(&quot;hasAnyRole('ROLE_SU')&quot;)
	@Transactional(readOnly = true)
	@GetMapping(&quot;/package/role/{rolename}&quot;)
	@ResponseBody
	public Permissions getRolePackagePermissions(@PathVariable String rolename)
	{
<span class="fc" id="L142">		Sid sid = createRoleSid(rolename);</span>
<span class="fc" id="L143">		return getPackagePermissions(sid);</span>
	}

	@PreAuthorize(&quot;hasAnyRole('ROLE_SU')&quot;)
	@Transactional(readOnly = true)
	@GetMapping(&quot;/entityclass/user/{username}&quot;)
	@ResponseBody
	public Permissions getUserEntityClassPermissions(@PathVariable String username)
	{
<span class="fc" id="L152">		Sid sid = createUserSid(username);</span>
<span class="fc" id="L153">		return getEntityTypePermissions(sid);</span>
	}

	@PreAuthorize(&quot;hasAnyRole('ROLE_SU')&quot;)
	@Transactional
	@PostMapping(&quot;/update/plugin/role&quot;)
	@ResponseStatus(HttpStatus.OK)
	public void updateRolePluginPermissions(@RequestParam String rolename, WebRequest webRequest)
	{
<span class="fc" id="L162">		Sid sid = createRoleSid(rolename);</span>
<span class="fc" id="L163">		updatePluginPermissions(webRequest, sid);</span>
<span class="fc" id="L164">	}</span>

	@PreAuthorize(&quot;hasAnyRole('ROLE_SU')&quot;)
	@Transactional
	@PostMapping(&quot;/update/entityclass/role&quot;)
	@ResponseStatus(HttpStatus.OK)
	public void updateRoleEntityClassPermissions(@RequestParam String rolename, WebRequest webRequest)
	{
<span class="fc" id="L172">		Sid sid = createRoleSid(rolename);</span>
<span class="fc" id="L173">		updateEntityTypePermissions(webRequest, sid);</span>
<span class="fc" id="L174">	}</span>

	@PreAuthorize(&quot;hasAnyRole('ROLE_SU')&quot;)
	@Transactional
	@PostMapping(&quot;/update/package/role&quot;)
	@ResponseStatus(HttpStatus.OK)
	public void updateRolePackagePermissions(@RequestParam String rolename, WebRequest webRequest)
	{
<span class="fc" id="L182">		Sid sid = createRoleSid(rolename);</span>
<span class="fc" id="L183">		updatePackagePermissions(webRequest, sid);</span>
<span class="fc" id="L184">	}</span>

	@PreAuthorize(&quot;hasAnyRole('ROLE_SU')&quot;)
	@Transactional
	@PostMapping(&quot;/update/package/user&quot;)
	@ResponseStatus(HttpStatus.OK)
	public void updateUserPackagePermissions(@RequestParam String username, WebRequest webRequest)
	{
<span class="fc" id="L192">		Sid sid = createUserSid(username);</span>
<span class="fc" id="L193">		updatePackagePermissions(webRequest, sid);</span>
<span class="fc" id="L194">	}</span>

	@PreAuthorize(&quot;hasAnyRole('ROLE_SU')&quot;)
	@Transactional
	@PostMapping(&quot;/update/plugin/user&quot;)
	@ResponseStatus(HttpStatus.OK)
	public void updateUserPluginPermissions(@RequestParam String username, WebRequest webRequest)
	{
<span class="fc" id="L202">		Sid sid = createUserSid(username);</span>
<span class="fc" id="L203">		updatePluginPermissions(webRequest, sid);</span>
<span class="fc" id="L204">	}</span>

	private void removeSidPluginPermission(Plugin plugin, Sid sid)
	{
<span class="fc" id="L208">		ObjectIdentity objectIdentity = new PluginIdentity(plugin);</span>
<span class="fc" id="L209">		removePermissionForSid(sid, objectIdentity);</span>
<span class="fc" id="L210">	}</span>

	private void createSidPluginPermission(Plugin plugin, Sid sid, PermissionSet pluginPermission)
	{
<span class="fc" id="L214">		ObjectIdentity objectIdentity = new PluginIdentity(plugin);</span>
<span class="fc" id="L215">		createSidPermission(sid, objectIdentity, pluginPermission);</span>
<span class="fc" id="L216">	}</span>

	@PreAuthorize(&quot;hasAnyRole('ROLE_SU')&quot;)
	@Transactional(readOnly = true)
	@GetMapping(&quot;/plugin/role/{rolename}&quot;)
	@ResponseBody
	public Permissions getRolePluginPermissions(@PathVariable String rolename)
	{
<span class="fc" id="L224">		Sid sid = createRoleSid(rolename);</span>
<span class="fc" id="L225">		return getPluginPermissions(sid);</span>
	}

	/**
	 * package-private for testability
	 */
	List&lt;Plugin&gt; getPlugins()
	{
<span class="fc" id="L233">		return dataService.findAll(PLUGIN, Plugin.class).collect(toList());</span>
	}

	@PreAuthorize(&quot;hasAnyRole('ROLE_SU')&quot;)
	@Transactional
	@PostMapping(&quot;/update/entityclass/user&quot;)
	@ResponseStatus(HttpStatus.OK)
	public void updateUserEntityClassPermissions(@RequestParam String username, WebRequest webRequest)
	{
<span class="fc" id="L242">		Sid sid = createUserSid(username);</span>
<span class="fc" id="L243">		updateEntityTypePermissions(webRequest, sid);</span>
<span class="fc" id="L244">	}</span>

	@PreAuthorize(&quot;hasAnyRole('ROLE_SU')&quot;)
	@Transactional
	@PostMapping(&quot;/update/entityclass/rls&quot;)
	@ResponseStatus(HttpStatus.OK)
	public void updateEntityClassRls(@Valid @RequestBody EntityTypeRlsRequest entityTypeRlsRequest)
	{
<span class="fc" id="L252">		String entityTypeId = entityTypeRlsRequest.getId();</span>
<span class="fc bfc" id="L253" title="All 2 branches covered.">		if (systemEntityTypeRegistry.hasSystemEntityType(entityTypeId))</span>
		{
<span class="fc" id="L255">			throw new IllegalArgumentException(&quot;Updating system entity type not allowed&quot;);</span>
		}

<span class="fc" id="L258">		EntityType entityType = dataService.getEntityType(entityTypeId);</span>
<span class="fc" id="L259">		String aclClassType = EntityIdentityUtils.toType(entityType);</span>
<span class="fc" id="L260">		boolean hasAclClass = mutableAclClassService.hasAclClass(aclClassType);</span>
<span class="fc bfc" id="L261" title="All 2 branches covered.">		if (entityTypeRlsRequest.isRlsEnabled())</span>
		{
<span class="pc bpc" id="L263" title="1 of 2 branches missed.">			if (!hasAclClass)</span>
			{
<span class="fc" id="L265">				mutableAclClassService.createAclClass(aclClassType, EntityIdentityUtils.toIdType(entityType));</span>
<span class="fc" id="L266">				dataService.findAll(entityType.getId())</span>
<span class="fc" id="L267">						   .forEach(entity -&gt; mutableAclService.createAcl(new EntityIdentity(entity)));</span>
			}
		}
		else
		{
<span class="pc bpc" id="L272" title="1 of 2 branches missed.">			if (hasAclClass)</span>
			{
<span class="fc" id="L274">				mutableAclClassService.deleteAclClass(aclClassType);</span>
			}
		}
<span class="fc" id="L277">	}</span>

	private static PermissionSet paramValueToPermissionSet(String paramValue)
	{
<span class="pc bpc" id="L281" title="3 of 5 branches missed.">		switch (paramValue.toUpperCase())</span>
		{
			case &quot;COUNT&quot;:
<span class="nc" id="L284">				return PermissionSet.COUNT;</span>
			case &quot;READ&quot;:
<span class="fc" id="L286">				return PermissionSet.READ;</span>
			case &quot;WRITE&quot;:
<span class="fc" id="L288">				return PermissionSet.WRITE;</span>
			case &quot;WRITEMETA&quot;:
<span class="nc" id="L290">				return PermissionSet.WRITEMETA;</span>
			default:
<span class="nc" id="L292">				throw new IllegalArgumentException(format(&quot;Unknown PermissionSet '%s'&quot;, paramValue));</span>
		}
	}

	private void updatePluginPermissions(WebRequest webRequest, Sid sid)
	{
<span class="fc bfc" id="L298" title="All 2 branches covered.">		for (Plugin plugin : getPlugins())</span>
		{
<span class="fc" id="L300">			String param = RADIO + plugin.getId();</span>
<span class="fc" id="L301">			String value = webRequest.getParameter(param);</span>
<span class="pc bpc" id="L302" title="1 of 2 branches missed.">			if (value != null)</span>
			{
<span class="fc bfc" id="L304" title="All 2 branches covered.">				if (!value.equals(&quot;none&quot;))</span>
				{
<span class="fc" id="L306">					createSidPluginPermission(plugin, sid, paramValueToPermissionSet(value));</span>
				}
				else
				{
<span class="fc" id="L310">					removeSidPluginPermission(plugin, sid);</span>
				}
			}
<span class="fc" id="L313">		}</span>
<span class="fc" id="L314">	}</span>

	private void updatePackagePermissions(WebRequest webRequest, Sid sid)
	{
<span class="fc bfc" id="L318" title="All 2 branches covered.">		for (Package pack : getPackages())</span>
		{
<span class="fc" id="L320">			String param = RADIO + pack.getId();</span>
<span class="fc" id="L321">			String value = webRequest.getParameter(param);</span>
<span class="pc bpc" id="L322" title="1 of 2 branches missed.">			if (value != null)</span>
			{
<span class="fc bfc" id="L324" title="All 2 branches covered.">				if (!value.equals(&quot;none&quot;))</span>
				{
<span class="fc" id="L326">					createSidPackagePermission(pack, sid, paramValueToPermissionSet(value));</span>
				}
				else
				{
<span class="fc" id="L330">					removeSidPackagePermission(pack, sid);</span>
				}
			}
<span class="fc" id="L333">		}</span>
<span class="fc" id="L334">	}</span>

	private Permissions getPackagePermissions(Sid sid)
	{
<span class="fc" id="L338">		return getPermissions(sid, getPackages().stream().map(PackageIdentity::new).collect(toList()));</span>
	}

	private Permissions getPluginPermissions(Sid sid)
	{
<span class="fc" id="L343">		return getPermissions(sid, getPlugins().stream().map(PluginIdentity::new).collect(toList()));</span>
	}

	private Permissions getPermissions(Sid sid, List&lt;ObjectIdentity&gt; objectIdentities)
	{
<span class="fc" id="L348">		Map&lt;ObjectIdentity, Acl&gt; aclMap = mutableAclService.readAclsById(objectIdentities, singletonList(sid));</span>
<span class="fc" id="L349">		Set&lt;String&gt; ids = objectIdentities.stream()</span>
<span class="fc" id="L350">										  .map(ObjectIdentity::getIdentifier)</span>
<span class="fc" id="L351">										  .map(Object::toString)</span>
<span class="fc" id="L352">										  .collect(toSet());</span>
<span class="fc" id="L353">		return Permissions.create(ids, getPermissions(aclMap, sid));</span>
	}

	private Multimap&lt;String, String&gt; getPermissions(Map&lt;ObjectIdentity, Acl&gt; acls, Sid sid)
	{
<span class="fc" id="L358">		Multimap&lt;String, String&gt; result = LinkedHashMultimap.create();</span>
<span class="fc" id="L359">		acls.forEach((objectIdentity, acl) -&gt;</span>
		{
<span class="fc" id="L361">			String id = objectIdentity.getIdentifier().toString();</span>
<span class="fc" id="L362">			acl.getEntries()</span>
<span class="fc" id="L363">			   .stream()</span>
<span class="fc" id="L364">			   .filter(ace -&gt; ace.getSid().equals(sid))</span>
<span class="fc" id="L365">			   .map(this::getPermissionString)</span>
<span class="fc" id="L366">			   .forEach(permission -&gt; result.put(id, permission));</span>
<span class="fc" id="L367">		});</span>
<span class="fc" id="L368">		return result;</span>
	}

	private String getPermissionString(AccessControlEntry ace)
	{
<span class="pc bpc" id="L373" title="1 of 5 branches missed.">		switch (ace.getPermission().getMask())</span>
		{
			case COUNT_MASK:
<span class="fc" id="L376">				return &quot;count&quot;;</span>
			case READ_MASK:
<span class="fc" id="L378">				return &quot;read&quot;;</span>
			case WRITE_MASK:
<span class="fc" id="L380">				return &quot;write&quot;;</span>
			case WRITEMETA_MASK:
<span class="fc" id="L382">				return &quot;writemeta&quot;;</span>
			default:
<span class="nc" id="L384">				throw new UnexpectedPermissionException(ace.getPermission());</span>
		}
	}

	private void removeSidEntityTypePermission(EntityType entityType, Sid sid)
	{
<span class="fc" id="L390">		ObjectIdentity objectIdentity = new EntityTypeIdentity(entityType);</span>
<span class="fc" id="L391">		removePermissionForSid(sid, objectIdentity);</span>
<span class="fc" id="L392">	}</span>

	private void createSidEntityTypePermission(EntityType entityType, Sid sid, PermissionSet permissionSet)
	{
<span class="fc" id="L396">		ObjectIdentity objectIdentity = new EntityTypeIdentity(entityType);</span>
<span class="fc" id="L397">		createSidPermission(sid, objectIdentity, permissionSet);</span>
<span class="fc" id="L398">	}</span>

	private void createSidPackagePermission(Package pack, Sid sid, PermissionSet permissionSet)
	{
<span class="fc" id="L402">		ObjectIdentity objectIdentity = new PackageIdentity(pack);</span>
<span class="fc" id="L403">		createSidPermission(sid, objectIdentity, permissionSet);</span>
<span class="fc" id="L404">	}</span>

	private void removeSidPackagePermission(Package pack, Sid sid)
	{
<span class="fc" id="L408">		ObjectIdentity objectIdentity = new PackageIdentity(pack);</span>
<span class="fc" id="L409">		removePermissionForSid(sid, objectIdentity);</span>
<span class="fc" id="L410">	}</span>

	private void removePermissionForSid(Sid sid, ObjectIdentity objectIdentity)
	{
<span class="fc" id="L414">		MutableAcl acl = (MutableAcl) mutableAclService.readAclById(objectIdentity, singletonList(sid));</span>

<span class="fc" id="L416">		boolean aclUpdated = deleteAceIfExists(sid, acl);</span>
<span class="fc bfc" id="L417" title="All 2 branches covered.">		if (aclUpdated)</span>
		{
<span class="fc" id="L419">			mutableAclService.updateAcl(acl);</span>
		}
<span class="fc" id="L421">	}</span>

	private void updateEntityTypePermissions(WebRequest webRequest, Sid sid)
	{
<span class="fc" id="L425">		getEntityTypes().forEach(entityType -&gt;</span>
		{
<span class="fc" id="L427">			String param = RADIO + entityType.getId();</span>
<span class="fc" id="L428">			String value = webRequest.getParameter(param);</span>
<span class="pc bpc" id="L429" title="1 of 2 branches missed.">			if (value != null)</span>
			{
<span class="fc bfc" id="L431" title="All 2 branches covered.">				if (!value.equals(&quot;none&quot;))</span>
				{
<span class="fc" id="L433">					createSidEntityTypePermission(entityType, sid, paramValueToPermissionSet(value));</span>
				}
				else
				{
<span class="fc" id="L437">					removeSidEntityTypePermission(entityType, sid);</span>
				}
			}
<span class="fc" id="L440">		});</span>
<span class="fc" id="L441">	}</span>

	private Permissions getEntityTypePermissions(Sid sid)
	{
<span class="fc" id="L445">		return getPermissions(sid,</span>
<span class="fc" id="L446">				getEntityTypes().collect(toList()).stream().map(EntityTypeIdentity::new).collect(toList()));</span>
	}

	private void createSidPermission(Sid sid, ObjectIdentity objectIdentity,
			org.springframework.security.acls.model.Permission permission)
	{
<span class="fc" id="L452">		MutableAcl acl = (MutableAcl) mutableAclService.readAclById(objectIdentity, singletonList(sid));</span>

<span class="fc" id="L454">		deleteAceIfExists(sid, acl);</span>
<span class="fc" id="L455">		acl.insertAce(0, permission, sid, true);</span>
<span class="fc" id="L456">		mutableAclService.updateAcl(acl);</span>
<span class="fc" id="L457">	}</span>

	/**
	 * package-private for testability
	 */
	List&lt;User&gt; getUsers()
	{
<span class="fc" id="L464">		return dataService.findAll(USER, User.class).collect(toList());</span>
	}

	/**
	 * package-private for testability
	 */
	List&lt;Role&gt; getRoles()
	{
<span class="fc" id="L472">		return dataService.findAll(ROLE, Role.class).collect(toList());</span>
	}

	List&lt;Package&gt; getPackages()
	{
<span class="fc" id="L477">		return dataService.findAll(PackageMetadata.PACKAGE, Package.class).collect(toList());</span>
	}

	private boolean deleteAceIfExists(Sid sid, MutableAcl acl)
	{
<span class="fc" id="L482">		boolean aclUpdated = false;</span>
<span class="fc" id="L483">		int nrEntries = acl.getEntries().size();</span>
<span class="fc bfc" id="L484" title="All 2 branches covered.">		for (int i = nrEntries - 1; i &gt;= 0; i--)</span>
		{
<span class="fc" id="L486">			AccessControlEntry accessControlEntry = acl.getEntries().get(i);</span>
<span class="pc bpc" id="L487" title="1 of 2 branches missed.">			if (accessControlEntry.getSid().equals(sid))</span>
			{
<span class="fc" id="L489">				acl.deleteAce(i);</span>
<span class="fc" id="L490">				aclUpdated = true;</span>
			}
		}
<span class="fc" id="L493">		return aclUpdated;</span>
	}

	private Stream&lt;EntityType&gt; getEntityTypes()
	{
<span class="fc" id="L498">		return dataService.findAll(EntityTypeMetadata.ENTITY_TYPE_META_DATA, EntityType.class);</span>
	}

	@ExceptionHandler(RuntimeException.class)
	@ResponseBody
	@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)
	public Map&lt;String, String&gt; handleRuntimeException(RuntimeException e)
	{
<span class="nc" id="L506">		LOG.error(null, e);</span>
<span class="nc" id="L507">		return Collections.singletonMap(&quot;errorMessage&quot;,</span>
<span class="nc" id="L508">				&quot;An error occurred. Please contact the administrator.&lt;br /&gt;Message:&quot; + e.getMessage());</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>