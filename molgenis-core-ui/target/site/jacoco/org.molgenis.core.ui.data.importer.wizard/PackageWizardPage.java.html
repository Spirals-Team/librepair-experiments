<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PackageWizardPage.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">core-ui</a> &gt; <a href="index.source.html" class="el_package">org.molgenis.core.ui.data.importer.wizard</a> &gt; <span class="el_source">PackageWizardPage.java</span></div><h1>PackageWizardPage.java</h1><pre class="source lang-java linenums">package org.molgenis.core.ui.data.importer.wizard;

import org.molgenis.core.ui.wizard.AbstractWizardPage;
import org.molgenis.core.ui.wizard.Wizard;
import org.molgenis.data.DatabaseAction;
import org.molgenis.data.MolgenisDataException;
import org.molgenis.data.RepositoryCollection;
import org.molgenis.data.file.FileRepositoryCollectionFactory;
import org.molgenis.data.importer.ImportService;
import org.molgenis.data.importer.ImportServiceFactory;
import org.molgenis.data.meta.MetaDataService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Component;
import org.springframework.validation.BindingResult;

import javax.servlet.http.HttpServletRequest;
import java.io.IOException;
import java.util.Collection;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import static java.util.Objects.requireNonNull;
import static java.util.stream.Collectors.toList;
import static org.molgenis.data.meta.model.Package.PACKAGE_SEPARATOR;

@Component
public class PackageWizardPage extends AbstractWizardPage
{
<span class="fc" id="L31">	private static final Logger LOG = LoggerFactory.getLogger(PackageWizardPage.class);</span>

	/**
	 * Auto generated
	 */
	private static final long serialVersionUID = 1L;

	private FileRepositoryCollectionFactory fileRepositoryCollectionFactory;
	private ImportServiceFactory importServiceFactory;
	private MetaDataService metaDataService;

	public PackageWizardPage(FileRepositoryCollectionFactory fileRepositoryCollectionFactory,
			ImportServiceFactory importServiceFactory, MetaDataService metaDataService)
<span class="fc" id="L44">	{</span>
<span class="fc" id="L45">		this.fileRepositoryCollectionFactory = requireNonNull(fileRepositoryCollectionFactory);</span>
<span class="fc" id="L46">		this.importServiceFactory = requireNonNull(importServiceFactory);</span>
<span class="fc" id="L47">		this.metaDataService = requireNonNull(metaDataService);</span>
<span class="fc" id="L48">	}</span>

	@Override
	public String getTitle()
	{
<span class="nc" id="L53">		return &quot;Packages&quot;;</span>
	}

	@Override
	public String handleRequest(HttpServletRequest request, BindingResult result, Wizard wizard)
	{
<span class="fc" id="L59">		ImportWizardUtil.validateImportWizard(wizard);</span>
<span class="fc" id="L60">		ImportWizard importWizard = (ImportWizard) wizard;</span>
<span class="fc" id="L61">		String entityImportOption = importWizard.getEntityImportOption();</span>

<span class="pc bpc" id="L63" title="1 of 2 branches missed.">		if (entityImportOption != null)</span>
		{
			try
			{
				// convert input to database action
<span class="fc" id="L68">				DatabaseAction entityDbAction = ImportWizardUtil.toDatabaseAction(entityImportOption);</span>
<span class="pc bpc" id="L69" title="1 of 2 branches missed.">				if (entityDbAction == null)</span>
				{
<span class="nc" id="L71">					throw new IOException(&quot;unknown database action: &quot; + entityImportOption);</span>
				}

<span class="fc" id="L74">				RepositoryCollection repositoryCollection = fileRepositoryCollectionFactory.createFileRepositoryCollection(</span>
<span class="fc" id="L75">						importWizard.getFile());</span>

<span class="fc" id="L77">				ImportService importService = importServiceFactory.getImportService(importWizard.getFile(),</span>
						repositoryCollection);

				// Do integration test only if there are no previous errors found
<span class="pc bpc" id="L81" title="1 of 2 branches missed.">				if (!importWizard.getEntitiesImportable().containsValue(false))</span>
				{
					// The package name that is selected in the &quot;package selection&quot; page
<span class="fc" id="L84">					String selectedPackage = request.getParameter(&quot;selectedPackage&quot;);</span>

					// The entities that can be imported
<span class="fc" id="L87">					Map&lt;String, Boolean&gt; entitiesImportable = importService.determineImportableEntities(metaDataService,</span>
							repositoryCollection, selectedPackage);

					// The results of the attribute checks are stored in maps with the entityname as key, those need to be updated with the packagename
<span class="fc" id="L91">					updateFieldReports(importWizard, selectedPackage, entitiesImportable);</span>
					// Set the entities that can be imported
<span class="fc" id="L93">					importWizard.setEntitiesImportable(entitiesImportable);</span>

					// The entities that can not be imported. If even one entity can not be imported, everything fails
<span class="fc" id="L96">					List&lt;String&gt; entitiesNotImportable = entitiesImportable.entrySet()</span>
<span class="fc" id="L97">																		   .stream()</span>
<span class="pc bpc" id="L98" title="1 of 2 branches missed.">																		   .filter(entity -&gt; !entity.getValue())</span>
<span class="fc" id="L99">																		   .map(Map.Entry::getKey)</span>
<span class="fc" id="L100">																		   .collect(toList());</span>

<span class="pc bpc" id="L102" title="1 of 2 branches missed.">					if (!entitiesNotImportable.isEmpty())</span>
					{
<span class="nc" id="L104">						throw new MolgenisDataException(</span>
								&quot;You are trying to upload entities that are not compatible with the already existing entities: &quot;
<span class="nc" id="L106">										+ entitiesNotImportable.toString());</span>
					}
				}

			}
<span class="nc" id="L111">			catch (RuntimeException | IOException e)</span>
			{
<span class="nc" id="L113">				ImportWizardUtil.handleException(e, importWizard, result, LOG, entityImportOption);</span>
<span class="fc" id="L114">			}</span>
		}
<span class="fc" id="L116">		return null;</span>
	}

	private void updateFieldReports(ImportWizard importWizard, String pack, Map&lt;String, Boolean&gt; entitiesImportable)
	{
<span class="fc" id="L121">		importWizard.setFieldsAvailable(renameKeys(importWizard.getFieldsAvailable(), pack, entitiesImportable));</span>
<span class="fc" id="L122">		importWizard.setFieldsDetected(renameKeys(importWizard.getFieldsDetected(), pack, entitiesImportable));</span>
<span class="fc" id="L123">		importWizard.setFieldsRequired(renameKeys(importWizard.getFieldsRequired(), pack, entitiesImportable));</span>
<span class="fc" id="L124">		importWizard.setFieldsUnknown(renameKeys(importWizard.getFieldsUnknown(), pack, entitiesImportable));</span>
<span class="fc" id="L125">	}</span>

	private Map&lt;String, Collection&lt;String&gt;&gt; renameKeys(Map&lt;String, Collection&lt;String&gt;&gt; map, String pack,
			Map&lt;String, Boolean&gt; entitiesImportable)
	{
<span class="fc" id="L130">		Map&lt;String, Collection&lt;String&gt;&gt; result = new HashMap&lt;&gt;();</span>
		//if the key is not in the importable entities, this must be caused by the entity being moved into a package
<span class="fc" id="L132">		map.keySet().forEach(key -&gt;</span>
		{
<span class="pc bpc" id="L134" title="1 of 2 branches missed.">			if (!entitiesImportable.keySet().contains(key))</span>
			{
<span class="fc" id="L136">				result.put(pack + PACKAGE_SEPARATOR + key, map.get(key));</span>
			}
			else
			{
<span class="nc" id="L140">				result.put(key, map.get(key));</span>
			}

<span class="fc" id="L143">		});</span>
<span class="fc" id="L144">		return result;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>