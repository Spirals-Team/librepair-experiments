<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Glass.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">chapter_004</a> &gt; <a href="index.source.html" class="el_package">ru.job4j.exchange</a> &gt; <span class="el_source">Glass.java</span></div><h1>Glass.java</h1><pre class="source lang-java linenums">package ru.job4j.exchange;

import java.util.*;

/**
 * @author Michael Hodkov
 * @version $Id$
 * @since 0.1
 *
 * Биржевой стакан.
 */
<span class="fc" id="L12">public class Glass {</span>
<span class="fc" id="L13">    private Map&lt;String, List&lt;Claim&gt;&gt; list = new HashMap&lt;&gt;();</span>

    public void insertClaim(Claim claim) {
<span class="fc bfc" id="L16" title="All 2 branches covered.">        if (claim.getType() == Claim.Type.ADD) {</span>
<span class="fc bfc" id="L17" title="All 2 branches covered.">            if (findDeal(claim) != null) {</span>
<span class="fc" id="L18">                add(claim);</span>
            }
<span class="pc bpc" id="L20" title="1 of 2 branches missed.">        } else if (claim.getType() == Claim.Type.DEL) {</span>
<span class="fc" id="L21">            del(claim, 1);</span>
        }
<span class="fc" id="L23">    }</span>

    private void del(Claim claim, int info) {
<span class="pc bpc" id="L26" title="1 of 2 branches missed.">        if (list.containsKey(claim.getBook())) {</span>
<span class="fc" id="L27">            List&lt;Claim&gt; claimList = list.get(claim.getBook());</span>
<span class="pc bpc" id="L28" title="1 of 2 branches missed.">            if (claimList.remove(claim)) {</span>
<span class="fc bfc" id="L29" title="All 2 branches covered.">                if (info &gt; 0) {</span>
<span class="fc" id="L30">                    System.out.println(String.format(&quot;Заявка на удаление: (%s) исполнена.&quot;, claim.toString()));</span>
                }
<span class="fc bfc" id="L32" title="All 2 branches covered.">                if (claimList.size() == 0) {</span>
<span class="fc" id="L33">                    list.remove(claim.getBook());</span>
                }
<span class="fc" id="L35">                return;</span>
            }

        }
<span class="nc bnc" id="L39" title="All 2 branches missed.">        if (info &gt; 0) {</span>
<span class="nc" id="L40">            System.out.println(String.format(&quot;(ERROR) Заявка на удаление: (%s) не найдена.&quot;, claim.toString()));</span>
        }
<span class="nc" id="L42">    }</span>

    private void add(Claim claim) {
<span class="fc bfc" id="L45" title="All 2 branches covered.">        if (list.containsKey(claim.getBook())) {</span>
<span class="fc" id="L46">            List&lt;Claim&gt; claimList = list.get(claim.getBook());</span>
<span class="fc" id="L47">            claimList.add(claim);</span>
<span class="fc" id="L48">        } else {</span>
<span class="fc" id="L49">            List&lt;Claim&gt; claimList = new LinkedList&lt;&gt;();</span>
<span class="fc" id="L50">            claimList.add(claim);</span>
<span class="fc" id="L51">            list.put(claim.getBook(), claimList);</span>
        }
<span class="fc" id="L53">    }</span>

    private Claim findDeal(Claim claim) {
<span class="fc bfc" id="L56" title="All 2 branches covered.">        if (list.containsKey(claim.getBook())) {</span>
<span class="fc" id="L57">            List&lt;Claim&gt; listClaim = list.get(claim.getBook());</span>
<span class="fc bfc" id="L58" title="All 2 branches covered.">            if (claim.getAction().equals(Claim.Action.ASK)) {</span>
<span class="fc" id="L59">                listClaim = getListFilter(listClaim, Claim.Action.BID);</span>
<span class="pc bpc" id="L60" title="1 of 2 branches missed.">                if (listClaim.size() &gt; 0) {</span>
<span class="fc" id="L61">                    listClaim.sort(new SortedByHigh());</span>
<span class="fc bfc" id="L62" title="All 2 branches covered.">                    for (int i = 0; i &lt; listClaim.size(); i++) {</span>
<span class="fc bfc" id="L63" title="All 2 branches covered.">                        if (listClaim.get(i).getPrice() &gt;= claim.getPrice()) {</span>
<span class="fc" id="L64">                            claim = deal(claim, listClaim.get(i));</span>
<span class="fc bfc" id="L65" title="All 2 branches covered.">                            if (claim == null) {</span>
<span class="fc" id="L66">                                break;</span>
                            }
                        }
                    }
                }
            } else {
<span class="fc" id="L72">                listClaim = getListFilter(listClaim, Claim.Action.ASK);</span>
<span class="pc bpc" id="L73" title="1 of 2 branches missed.">                if (listClaim.size() &gt; 0) {</span>
<span class="fc" id="L74">                    listClaim.sort(new SortedByLow());</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">                    for (int i = 0; i &lt; listClaim.size(); i++) {</span>
<span class="pc bpc" id="L76" title="1 of 2 branches missed.">                        if (listClaim.get(i).getPrice() &lt;= claim.getPrice()) {</span>
<span class="nc" id="L77">                            claim = deal(claim, listClaim.get(i));</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">                            if (claim == null) {</span>
<span class="nc" id="L79">                                break;</span>
                            }
                        }
                    }
                }
            }
        }
<span class="fc" id="L86">        return claim;</span>
    }

    private Claim deal(Claim claimOne, Claim claimTwo) {
<span class="fc" id="L90">        String textClaimOne = claimOne.toString();</span>
<span class="fc" id="L91">        String textClaimTwo = claimTwo.toString();</span>
<span class="fc" id="L92">        String textAddOne = &quot;&quot;;</span>
<span class="fc" id="L93">        String textAddTwo = &quot;&quot;;</span>
        int volume;
<span class="pc bpc" id="L95" title="1 of 2 branches missed.">        float price = claimOne.getPrice() &lt;= claimTwo.getPrice() ? claimOne.getPrice() : claimTwo.getPrice();</span>
<span class="fc bfc" id="L96" title="All 2 branches covered.">        if (claimOne.getVolume() == claimTwo.getVolume()) {</span>
<span class="fc" id="L97">            volume = claimOne.getVolume();</span>
<span class="fc" id="L98">            del(claimTwo, 0);</span>
<span class="fc" id="L99">            claimOne = null;</span>
<span class="fc bfc" id="L100" title="All 2 branches covered.">        } else if (claimOne.getVolume() &gt; claimTwo.getVolume()) {</span>
<span class="fc" id="L101">            volume = claimTwo.getVolume();</span>
<span class="fc" id="L102">            textAddOne = String.format(&quot;(частично : %d шт.) &quot;, volume);</span>
<span class="fc" id="L103">            claimOne.setVolume(claimOne.getVolume() - claimTwo.getVolume());</span>
<span class="fc" id="L104">            del(claimTwo, 0);</span>
        } else {
<span class="fc" id="L106">            volume = claimOne.getVolume();</span>
<span class="fc" id="L107">            textAddTwo = String.format(&quot;(частично : %d шт.) &quot;, volume);</span>
<span class="fc" id="L108">            claimTwo.setVolume(claimTwo.getVolume() - claimOne.getVolume());</span>
<span class="fc" id="L109">            claimOne = null;</span>
        }
<span class="fc" id="L111">        printClaim(textClaimOne, textAddOne, price, volume);</span>
<span class="fc" id="L112">        printClaim(textClaimTwo, textAddTwo, price, volume);</span>
<span class="fc" id="L113">        return claimOne;</span>
    }

    private void printClaim(String text, String textAdd, float price, int volume) {
<span class="fc" id="L117">        System.out.println(String.format(&quot;Заяка: (%s) %sисполнена по цене %.2f объем = %.2f&quot;,</span>
<span class="fc" id="L118">            text, textAdd, price, volume * price));</span>
<span class="fc" id="L119">    }</span>

    private List&lt;Claim&gt; getListFilter(List&lt;Claim&gt; value, Claim.Action action) {
<span class="fc" id="L122">        List&lt;Claim&gt; claimList = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L123" title="All 2 branches covered.">        for (Claim claim : value) {</span>
<span class="fc bfc" id="L124" title="All 2 branches covered.">            if (claim.getAction().equals(action)) {</span>
<span class="fc" id="L125">                claimList.add(claim);</span>
            }
<span class="fc" id="L127">        }</span>
<span class="fc" id="L128">        return claimList;</span>
    }

    public void printGlass() {
<span class="fc bfc" id="L132" title="All 2 branches covered.">        for (Map.Entry listClaim : list.entrySet()) {</span>
<span class="fc" id="L133">            System.out.println(listClaim.getKey());</span>
<span class="fc" id="L134">            System.out.println(String.format(&quot;%10s %7s %10s&quot;, &quot;Покупка&quot;, &quot;Цена&quot;, &quot;Продажа&quot;));</span>
<span class="fc" id="L135">            Map&lt;Float, Integer&gt; filterList = getMapFilter((List&lt;Claim&gt;) listClaim.getValue(), Claim.Action.BID);</span>
<span class="fc bfc" id="L136" title="All 2 branches covered.">            for (Map.Entry item : filterList.entrySet()) {</span>
<span class="fc" id="L137">                System.out.println(String.format(&quot;%7d %11.2f&quot;, item.getValue(), item.getKey()));</span>
<span class="fc" id="L138">            }</span>
<span class="fc" id="L139">            filterList = getMapFilter((List&lt;Claim&gt;) listClaim.getValue(), Claim.Action.ASK);</span>
<span class="fc bfc" id="L140" title="All 2 branches covered.">            for (Map.Entry item : filterList.entrySet()) {</span>
<span class="fc" id="L141">                System.out.println(String.format(&quot;%19.2f %5d&quot;, item.getKey(), item.getValue()));</span>
<span class="fc" id="L142">            }</span>
<span class="fc" id="L143">        }</span>
<span class="fc" id="L144">    }</span>

    private Map&lt;Float, Integer&gt; getMapFilter(List&lt;Claim&gt; value, Claim.Action action) {
<span class="fc" id="L147">        Map&lt;Float, Integer&gt; map = new HashMap&lt;&gt;();</span>
<span class="fc bfc" id="L148" title="All 2 branches covered.">        for (Claim claim : value) {</span>
<span class="fc bfc" id="L149" title="All 2 branches covered.">            if (claim.getAction().equals(action)) {</span>
<span class="fc bfc" id="L150" title="All 2 branches covered.">                if (map.containsKey(claim.getPrice())) {</span>
<span class="fc" id="L151">                    int sum = map.get(claim.getPrice()) + claim.getVolume();</span>
<span class="fc" id="L152">                    map.put(claim.getPrice(), sum);</span>
<span class="fc" id="L153">                } else {</span>
<span class="fc" id="L154">                    map.put(claim.getPrice(), claim.getVolume());</span>
                }
            }
<span class="fc" id="L157">        }</span>
<span class="fc" id="L158">        return map;</span>
    }

    public void see() {
<span class="nc bnc" id="L162" title="All 2 branches missed.">        for (Map.Entry claim : list.entrySet()) {</span>
<span class="nc" id="L163">            System.out.println(claim.getValue().toString());</span>
<span class="nc" id="L164">        }</span>
<span class="nc" id="L165">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>