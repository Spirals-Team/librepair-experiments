<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SchemaLoader.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">core</a> &gt; <a href="index.source.html" class="el_package">org.molgenis.core.util</a> &gt; <span class="el_source">SchemaLoader.java</span></div><h1>SchemaLoader.java</h1><pre class="source lang-java linenums">package org.molgenis.core.util;

import org.apache.commons.io.IOUtils;
import org.springframework.core.io.Resource;
import org.springframework.core.io.support.PathMatchingResourcePatternResolver;
import org.springframework.core.io.support.ResourcePatternResolver;
import org.w3c.dom.ls.LSInput;
import org.w3c.dom.ls.LSResourceResolver;
import org.xml.sax.SAXException;

import javax.xml.XMLConstants;
import javax.xml.transform.stream.StreamSource;
import javax.xml.validation.Schema;
import javax.xml.validation.SchemaFactory;
import java.io.BufferedInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.Reader;

/**
 * Compiles a xsd. Searches on the classpath for the xsd. You don't need to specify the whole path, just the name.
 * Example: &lt;code&gt;new SchemaLoader(&quot;EMeasure.xsd&quot;)&lt;/code&gt;
 *
 * @author erwin
 */
public class SchemaLoader implements LSResourceResolver
{
	private Schema schema;

	public SchemaLoader(String schemaName)
<span class="fc" id="L31">	{</span>
		try
		{

<span class="fc" id="L35">			Resource schemaResource = getSchema(schemaName);</span>

<span class="fc" id="L37">			SchemaFactory schemaFactory = SchemaFactory.newInstance(XMLConstants.W3C_XML_SCHEMA_NS_URI);</span>
<span class="fc" id="L38">			schemaFactory.setResourceResolver(this);</span>

<span class="fc" id="L40">			schema = schemaFactory.newSchema(new StreamSource(schemaResource.getInputStream()));</span>
		}
<span class="nc" id="L42">		catch (SAXException | IOException e)</span>
		{
<span class="nc" id="L44">			throw new RuntimeException(&quot;Could not load schemas&quot;, e);</span>
<span class="fc" id="L45">		}</span>
<span class="fc" id="L46">	}</span>

	public SchemaLoader(InputStream is)
<span class="fc" id="L49">	{</span>
		try
		{
<span class="fc" id="L52">			SchemaFactory schemaFactory = SchemaFactory.newInstance(XMLConstants.W3C_XML_SCHEMA_NS_URI);</span>
<span class="fc" id="L53">			schemaFactory.setResourceResolver(this);</span>

<span class="fc" id="L55">			schema = schemaFactory.newSchema(new StreamSource(is));</span>
		}
<span class="nc" id="L57">		catch (SAXException e)</span>
		{
<span class="nc" id="L59">			throw new RuntimeException(&quot;Could not load schemas&quot;, e);</span>
<span class="fc" id="L60">		}</span>
<span class="fc" id="L61">	}</span>

	public Schema getSchema()
	{
<span class="fc" id="L65">		return schema;</span>
	}

	private Resource getSchema(String schemaName) throws IOException
	{
<span class="pc bpc" id="L70" title="1 of 2 branches missed.">		if (schemaName.contains(&quot;/&quot;))</span>
		{
<span class="nc" id="L72">			schemaName = schemaName.substring(schemaName.lastIndexOf('/'));</span>
		}

<span class="fc" id="L75">		ResourcePatternResolver resourcePatternResolver = new PathMatchingResourcePatternResolver();</span>
<span class="fc" id="L76">		String searchPattern = ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX + &quot;/**/&quot; + schemaName;</span>
<span class="fc" id="L77">		Resource[] resources = resourcePatternResolver.getResources(searchPattern);</span>

<span class="pc bpc" id="L79" title="2 of 4 branches missed.">		if ((resources == null) || (resources.length == 0))</span>
		{
<span class="nc" id="L81">			throw new RuntimeException(&quot;Could not find schema [&quot; + schemaName + &quot;]&quot;);</span>
		}

<span class="fc" id="L84">		return resources[0];</span>
	}

	@Override
	public LSInput resolveResource(String type, String namespaceURI, String publicId, String systemId, String baseURI)
	{
		InputStream resourceAsStream;
		try
		{
<span class="nc" id="L93">			resourceAsStream = getSchema(systemId).getInputStream();</span>
		}
<span class="nc" id="L95">		catch (IOException e)</span>
		{

<span class="nc" id="L98">			throw new RuntimeException(e);</span>
<span class="nc" id="L99">		}</span>

<span class="nc" id="L101">		return new LSInputImpl(publicId, systemId, resourceAsStream);</span>
	}

	protected static class LSInputImpl implements LSInput
	{

		private String publicId;

		private String systemId;

		@Override
		public String getPublicId()
		{
<span class="nc" id="L114">			return publicId;</span>
		}

		@Override
		public void setPublicId(String publicId)
		{
<span class="nc" id="L120">			this.publicId = publicId;</span>
<span class="nc" id="L121">		}</span>

		@Override
		public String getBaseURI()
		{
<span class="nc" id="L126">			return null;</span>
		}

		@Override
		public InputStream getByteStream()
		{
<span class="nc" id="L132">			return null;</span>
		}

		@Override
		public boolean getCertifiedText()
		{
<span class="nc" id="L138">			return false;</span>
		}

		@Override
		public Reader getCharacterStream()
		{
<span class="nc" id="L144">			return null;</span>
		}

		@Override
		public String getEncoding()
		{
<span class="nc" id="L150">			return null;</span>
		}

		@Override
		public String getStringData()
		{
<span class="nc" id="L156">			synchronized (inputStream)</span>
			{
				try
				{
<span class="nc" id="L160">					return IOUtils.toString(inputStream, &quot;UTF-8&quot;);</span>
				}
<span class="nc" id="L162">				catch (IOException e)</span>
				{
<span class="nc" id="L164">					throw new RuntimeException(e);</span>
				}
			}
		}

		@Override
		public void setBaseURI(String baseURI)
		{
<span class="nc" id="L172">		}</span>

		@Override
		public void setByteStream(InputStream byteStream)
		{
<span class="nc" id="L177">		}</span>

		@Override
		public void setCertifiedText(boolean certifiedText)
		{
<span class="nc" id="L182">		}</span>

		@Override
		public void setCharacterStream(Reader characterStream)
		{
<span class="nc" id="L187">		}</span>

		@Override
		public void setEncoding(String encoding)
		{
<span class="nc" id="L192">		}</span>

		@Override
		public void setStringData(String stringData)
		{
<span class="nc" id="L197">		}</span>

		@Override
		public String getSystemId()
		{
<span class="nc" id="L202">			return systemId;</span>
		}

		@Override
		public void setSystemId(String systemId)
		{
<span class="nc" id="L208">			this.systemId = systemId;</span>
<span class="nc" id="L209">		}</span>

		public BufferedInputStream getInputStream()
		{
<span class="nc" id="L213">			return inputStream;</span>
		}

		public void setInputStream(BufferedInputStream inputStream)
		{
<span class="nc" id="L218">			this.inputStream = inputStream;</span>
<span class="nc" id="L219">		}</span>

		private BufferedInputStream inputStream;

		public LSInputImpl(String publicId, String sysId, InputStream input)
<span class="nc" id="L224">		{</span>
<span class="nc" id="L225">			this.publicId = publicId;</span>
<span class="nc" id="L226">			this.systemId = sysId;</span>
<span class="nc" id="L227">			this.inputStream = new BufferedInputStream(input);</span>
<span class="nc" id="L228">		}</span>

	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>