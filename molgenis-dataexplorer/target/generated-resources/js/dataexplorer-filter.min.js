(function(e,c){c.dataexplorer=c.dataexplorer||{};var a=c.dataexplorer.filter=c.dataexplorer.filter||{};a.createFilter=function b(g,f,h){switch(g.fieldType){case"BOOL":case"CATEGORICAL":case"CATEGORICAL_MREF":return a.createSimpleFilter(g,f,h,false);case"XREF":case"FILE":return a.createSimpleFilter(g,f,h,true);case"DATE":case"DATE_TIME":case"DECIMAL":case"LONG":case"EMAIL":case"HTML":case"HYPERLINK":case"STRING":case"ENUM":case"INT":case"TEXT":case"SCRIPT":return a.createComplexFilter(g,f,h,"OR");case"MREF":case"ONE_TO_MANY":return a.createComplexFilter(g,f,h,null);case"COMPOUND":throw"Unsupported data type: "+g.fieldType;default:throw"Unknown data type: "+g.fieldType}};a.createFilters=function d(h){var g={};var f;e(".complex-filter-container",h).each(function(){f=new a.ComplexFilter(e(this).data("attribute"));f.update(e(this));g[f.attribute.href]=f});e(".simple-filter-container",h).each(function(){f=new a.SimpleFilter(e(this).data("attribute"));f.update(e(this));g[f.attribute.href]=f});return g};a.createFilterQueryUserReadableList=function(f){var g=[];e.each(f,function(h,j){var i=c.getAttributeLabel(j.attribute);g.push('<p><a class="feature-filter-edit" data-href="'+h+'" href="#">'+i+": "+a.createFilterQueryUserReadable(j)+'</a><a class="feature-filter-remove" data-href="'+h+'" href="#" title="Remove '+i+' filter" ><span class="glyphicon glyphicon-remove"></span></a></p>')});g.push("</div>");e("#feature-filters").html(g.join(""))};a.createFilterQueryUserReadable=function(i){if(i.isType("complex")){var j=i.getComplexFilterElements();var f=true;if(j){var h=[];var g=false;e.each(j,function(l,k){var m="";if(l>0){if(k.operator==="AND"){if(!g){g=true;h[h.length-1]="("+h[h.length-1]}f=false}else{if(g){g=false;m+=") "}}h.push(" "+k.operator.toLowerCase()+" ")}h.push(a.createSimpleFilterValuesRepresentation(k.simpleFilter))});if(g){h.push(")")}if(h.length<2){f=false}}if(f){return"("+h.join("")+")"}else{return h.join("")}}else{if(i.isType("simple")){return a.createSimpleFilterValuesRepresentation(i)}}};a.createSimpleFilterValuesRepresentation=function(h){var g=h.getValues();switch(h.attribute.fieldType){case"DATE":case"DATE_TIME":case"DECIMAL":case"INT":case"LONG":if(h.fromValue&&h.toValue){return"("+htmlEscape(h.fromValue)+" &le; x &le; "+htmlEscape(h.toValue)+")"}else{if(h.fromValue){return"("+htmlEscape(h.fromValue)+" &le; x)"}else{if(h.toValue){return"(x &le; "+htmlEscape(h.toValue)+")"}else{return""}}}case"EMAIL":case"HTML":case"HYPERLINK":case"STRING":case"TEXT":case"BOOL":case"ENUM":case"SCRIPT":return htmlEscape(g[0]?g[0]:"");case"CATEGORICAL":case"CATEGORICAL_MREF":case"MREF":case"XREF":case"FILE":case"ONE_TO_MANY":var f=(h.operator?h.operator.toLocaleLowerCase():"or");var i=[];e.each(h.getLabels(),function(j,k){i.push("'"+k+"'")});return htmlEscape("("+i.join(" "+f+" ")+")");case"COMPOUND":throw"Unsupported data type: "+h.attribute.fieldType;default:throw"Unknown data type: "+h.attribute.fieldType}};a.createComplexFilter=function(j,i,l,k){var m=e('<div class="complex-filter-container form-group"></div>').data("attribute",j);var h=(k!==undefined&&k!==null?true:false);var g=null;var f=null;if(i){if(i.isType("complex")){e.each(i.getComplexFilterElements(),function(o,n){g=(k?k:n.operator);a.addComplexFilterElementToContainer(m,j,g,n.simpleFilter,l,(o>0?false:true),i.getComplexFilterElements().length,h)})}}else{g=(k?k:null);a.addComplexFilterElementToContainer(m,j,g,null,l,true,null,h)}f=a.createComplexFilterAddButton(m,j,g,l,h);a.addComplexFilterAddButton(m,f);return m};a.addComplexFilterElementToContainer=function(t,i,q,k,p,r,j,f){var n=e('<div class="form-group complex-element-container" data-filter="complex-element-container"></div>');if(p){var h=e('<div class="controls complex-element col-md-9" data-filter="complex-element"></div>')}else{var h=e('<div class="controls complex-element col-md-12" data-filter="complex-element"></div>')}var s=a.createFilterLabel(i,r,p);n.append(s);var m=a.createSimpleFilterControls(i,k,p);m.attr("data-filter","complex-simplefilter");m.addClass("complex-simplefilter");m.css("display","inline-block");var o=e('<div class="controls complex-removebutton-container" data-filter="complex-removebutton-container"></div>');var g=e('<div class="controls complex-addbutton-container" data-filter="complex-addbutton-container"></div>');if(r){h.append(m);if(j>1){o.append(a.createRemoveButtonFirstComplexElement(t))}}else{var l=a.createComplexFilterSelectOperator(q,f,p);h.append(l);h.append(m);o.append(a.createRemoveButtonComplexElementFilter(n))}h.append(g);h.append(o);n.append(h);t.append(n);return n};a.createComplexFilterSelectOperator=function(o,f,k){var h=e('<div class="'+(k?"col-md-9":"col-md-10")+'">');var g=(o==="AND"?"AND":"OR");var n="OR&nbsp;&nbsp;";var i="AND";var j=g==="AND"?i:n;var m=e('<input type="hidden" data-filter="complex-operator" value="'+g+'"/>');h.append(m);var l;if(f===false){l=e('<div class="btn-group" data-filter="complex-operator-container" style="margin-left:45%;"><div>');l.append(e('<a class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" href="#">'+j+' <b class="caret"></a>'));l.append(e('<ul class="dropdown-menu"><li><a data-value="OR">'+n+'</a></li><li><a data-value="AND">'+i+"</a></li></ul>"));e.each(l.find(".dropdown-menu li a"),function(p,q){e(q).click(function(){var r=e(this).attr("data-value");m.val(r);l.find("a:first").html((r==="AND"?i:n)+' <b class="caret"></b>');l.find("a:first").val(r)})});l.find("div:first").remove()}else{l=e('<div data-filter="complex-operator-container" style="width:5%; margin: 0 auto;">'+g+"<div>")}return e('<div class="form-group">').append(h.append(l))};a.createFilterLabel=function(i,g,j){var h=i.label||i.name;if(g&&j){var f=e('<label class="col-md-3 control-label" data-placement="right" data-title="'+i.description+'">'+h+"</label>");if(i.description!==undefined){f.tooltip()}return f}else{if(!g&&j){return e('<label class="col-md-3 control-label"></label>')}else{return null}}};a.addComplexFilterAddButton=function(g,f){e("[data-filter=complex-addbutton-container]",g).last().append(f)};a.createComplexFilterAddButton=function(j,h,f,i,g){return(e('<button class="btn btn-default btn-xs" type="button" data-filter=complex-addbutton><i class="glyphicon glyphicon-plus"></i></button>').click(function(){if(e("[data-filter=complex-removebutton]",j).length===0){e("[data-filter=complex-removebutton-container]",j).append(a.createRemoveButtonFirstComplexElement(j))}a.addComplexFilterElementToContainer(j,h,f,null,i,false,null,g);a.addComplexFilterAddButton(j,e("[data-filter=complex-addbutton]",j))}))};a.createRemoveButtonComplexElementFilter=function(f){return e('<button class="btn btn-default btn-xs" type="button" data-filter=complex-removebutton><i class="glyphicon glyphicon-minus"></i></button>').click(function(){var i=f.parent();var g=e("[data-filter=complex-addbutton]",i);if(e("[data-filter=complex-removebutton]",i).length===2){e("[data-filter=complex-removebutton]",i).remove()}if(e("[data-filter=complex-addbutton]",f).length){var h=e("[data-filter=complex-addbutton-container]",i).eq(-2);h.append(g)}f.remove()})};a.createRemoveButtonFirstComplexElement=function(f){return e('<button class="btn btn-default btn-xs" type="button" data-filter=complex-removebutton><i class="glyphicon glyphicon-minus"></i></button>').click(function(){var j=e(e("[data-filter=complex-element]",f)[0]);var l=e(e("[data-filter=complex-element]",f)[1]);var k=e("[data-filter=complex-simplefilter]",j);var h=e("[data-filter=complex-simplefilter]",l);var i=e("[data-filter=complex-addbutton]",l);var g=e("[data-filter=complex-element-container]",f).eq(1);k.remove();j.append(h);e("[data-filter=complex-addbutton-container]",j).append(i);g.remove();if(e("[data-filter=complex-removebutton]",f.parent()).length===1){e("[data-filter=complex-removebutton]",f.parent()).remove()}})};a.createSimpleFilter=function(i,h,k,g){var l=e('<div class="simple-filter-container form-group"></div>');var f=a.createFilterLabel(i,true,k);l.append(f);l.append(a.createSimpleFilterControls(i,h,k));l.data("attribute",i);if(g){var j=e("<div>").addClass((k?"col-md-9":"col-md-10"));l.children(".col-md-9").wrap(j)}return e('<div class="form-group">').append(l)};a.createSimpleFilterControls=function(w,m,H){var G=e("<div>");G.addClass((H?"col-md-9":"col-md-10"));var I="input-"+w.name+"-"+new Date().getTime();var i=m?m.getValues():null;var z=m?m.fromValue:null;var h=m?m.toValue:null;switch(w.fieldType){case"BOOL":var A={name:I};var o=i&&i[0]==="true"?e.extend({},A,{checked:"checked"}):A;var g=i&&i[0]==="false"?e.extend({},A,{checked:"checked"}):A;var t=createInput(w,o,true);var s=createInput(w,g,false);G.append(e('<div class="filter-radio-inline-container">').append(t.addClass("radio-inline")).append(s.addClass("radio-inline")));break;case"CATEGORICAL":case"CATEGORICAL_MREF":var x=new c.RestClient();var f=x.get(w.refEntity.href);var y=f.href.replace(new RegExp("/meta[^/]*$"),"");var k=x.get(y,{q:{sort:{orders:[{direction:"ASC",property:f.labelAttribute}]}}});e.each(k.items,function(){var J={name:I,id:I};if(i&&e.inArray(this[f.idAttribute],i)>-1){J.checked="checked"}G.append(createInput(w,J,this[f.idAttribute],this[f.labelAttribute]))});break;case"DATE":case"DATE_TIME":var F=I+"-from",C=I+"-to";var p=z?z:undefined;var n=h?h:undefined;var j=createInput(w,{name:F,placeholder:"Start date"},p);var l=createInput(w,{name:C,placeholder:"End date"},n);G.append(e('<div class="form-group">').append(j)).append(e('<div class="form-group">').append(l));break;case"DECIMAL":case"INT":case"LONG":if(w.range){var B=e('<div id="slider" class="form-group"></div>');var D=z?z:w.range.min;var E=h?h:w.range.max;B.editRangeSlider({symmetricPositionning:true,bounds:{min:w.range.min,max:w.range.max},defaultValues:{min:D,max:E},type:"number"});G.addClass("range-container");if(z||h){G.data("dirty",true)}B.bind("userValuesChanged",function(K,J){G.data("dirty",true)});G.append(B)}else{var F=I+"-from",C=I+"-to";var v=e('<label class="horizontal-inline" for="'+F+'">From</label>');var r=e('<label class="horizontal-inline inbetween" for="'+C+'">To</label>');var j=createInput(w,{name:F,id:F,style:"width: 189px"},i?z:undefined).addClass("input-small");var l=createInput(w,{name:C,id:C,style:"width: 189px"},i?h:undefined).addClass("input-small");G.addClass("form-inline").append(v).append(j).append(r).append(l)}break;case"EMAIL":case"HTML":case"HYPERLINK":case"STRING":case"TEXT":case"ENUM":case"SCRIPT":G.append(createInput(w,{name:I,id:I},i?i[0]:undefined));break;case"XREF":case"MREF":case"FILE":case"ONE_TO_MANY":var q=m?m.operator:"OR";var u=e('<div class="xrefmrefsearch">');G.append(u);u.xrefmrefsearch({width:"100%",attribute:w,values:i,labels:m?m.getLabels():null,operator:q,autofocus:"autofocus",isfilter:true});break;case"COMPOUND":throw"Unsupported data type: "+w.fieldType;default:throw"Unknown data type: "+w.fieldType}return G};a.Filter=function(){this.operators={OR:"OR",AND:"AND"};this.types={simple:"simple",complex:"complex"};this.type=undefined;this.operator=this.operators.OR;this.attribute=undefined;this.isType=function(f){return f&&this.types[f]&&this.type===f};this.formatOperator=function(f){return this.operators[f]};return this};a.SimpleFilter=function(h,j,f,i){this.fromValue=j;this.toValue=f;var g=[];var k=[];this.type="simple";this.attribute=h;if(i!==undefined){g.push(i)}this.isEmpty=function(){return !(g.length||this.fromValue||this.toValue)};this.getValues=function(){return g};this.getLabels=function(){return k};this.update=function(n){var o=this.fromValue;var l=this.toValue;var m=this.operator;var m=e(":input[data-filter=xrefmref-operator]",n).val();e(":input",n).not("[type=radio]:not(:checked)").not("[type=checkbox]:not(:checked)").not("[data-filter=complex-operator]").not("[data-filter=xrefmref-operator]").not("button.btn.btn-default.dropdown-toggle").not(".select2-input").not(".exclude").each(function(){var q=e(this).val();var p=e(this).attr("name");if(q){if(h.fieldType==="MREF"||h.fieldType==="XREF"||h.fieldType==="FILE"||h.fieldType=="ONE_TO_MANY"){var r=q.split(",");e(r).each(function(s){g.push(r[s])});k=e(this).data("labels")}else{if(h.fieldType=="CATEGORICAL"||h.fieldType==="CATEGORICAL_MREF"){k.push(e(this).parent().text());g[g.length]=q}else{if(h.fieldType==="INT"||h.fieldType==="LONG"||h.fieldType==="DECIMAL"||h.fieldType==="DATE"||h.fieldType==="DATE_TIME"){if(n.closest(".range-container").data("dirty")||!h.range){if(p&&(p.match(/-to$/g)||p==="sliderright")){l=q}if(p&&(p.match(/-from$/g)||p==="sliderleft")){o=q}}if(h.fieldType==="DECIMAL"||h.fieldType==="INT"||h.fieldType==="LONG"){if(parseFloat(l)<parseFloat(o)){l=undefined}}}else{g[g.length]=q;k[g.length]=q}}}}});this.fromValue=o;this.toValue=l;this.operator=m;return this};this.createQueryRule=function(){var n=this.attribute;var l=this.fromValue;var s=this.toValue;var o=this.operator;var t;var q=n.fieldType==="DATE"||n.fieldType==="DATE_TIME"||n.fieldType==="DECIMAL"||n.fieldType==="INT"||n.fieldType==="LONG";var m=n.parent?n.parent.name+"."+n.name:n.name;if(q){if(n.fieldType==="DATE_TIME"){if(l){l=l.replace("'T'","T")}if(s){s=s.replace("'T'","T")}}if(l&&s){t={operator:"NESTED",nestedRules:[{field:m,operator:"GREATER_EQUAL",value:l},{operator:"AND"},{field:m,operator:"LESS_EQUAL",value:s}]}}else{if(l){t={field:m,operator:"GREATER_EQUAL",value:l}}else{if(s){t={field:m,operator:"LESS_EQUAL",value:s}}}}}else{if(g){var p;switch(n.fieldType){case"BOOL":case"CATEGORICAL":case"CATEGORICAL_MREF":case"DATE":case"DATE_TIME":case"DECIMAL":case"ENUM":case"INT":case"LONG":case"MREF":case"XREF":case"ONE_TO_MANY":case"FILE":p="EQUALS";break;case"EMAIL":case"HTML":case"HYPERLINK":case"SCRIPT":case"STRING":case"TEXT":p="SEARCH";break;case"COMPOUND":throw"Unsupported data type: "+n.fieldType;default:throw"Unknown data type: "+n.fieldType}if(g.length>1){o=o&&o!=="undefined"?o:"OR";if(p==="EQUALS"&&o==="OR"){t={field:m,operator:"IN",value:g}}else{var r={operator:"NESTED",nestedRules:[]};e.each(g,function(u,v){if(u>0){r.nestedRules.push({operator:o})}r.nestedRules.push({field:m,operator:p,value:v})});t=r}}else{t={field:m,operator:p,value:g[0]}}}}return t};return this};a.SimpleFilter.prototype=new a.Filter();a.ComplexFilterElement=function(f){this.simpleFilter=null;this.type="complex-element";this.attribute=f;this.update=function(g){this.operator=this.formatOperator(e(":input[data-filter=complex-operator]",g).val());this.simpleFilter=(new a.SimpleFilter(f)).update(e("[data-filter=complex-simplefilter]",g));return this}};a.ComplexFilterElement.prototype=new a.Filter();a.ComplexFilter=function(f){var g=[];this.type="complex";this.attribute=f;this.update=function(h){e("[data-filter=complex-element]",h).each(function(){var i=(new a.ComplexFilterElement(f)).update(e(this));if(!i.simpleFilter.isEmpty()){g.push(i)}});return this};this.addComplexFilterElement=function(h){if(!h!==null){g.push(h)}return this};this.isEmpty=function(){for(var h=0;h<g.length;h++){if(!g[h].simpleFilter.isEmpty()){return false}}return true};this.getComplexFilterElements=function(){return g};this.createQueryRule=function(){var h=[];var j,k,i=null;e.each(g,function(m,l){if(m>0){j=l.operator;if(j==="AND"){i.nestedRules.push({operator:j})}else{if(j==="OR"){h.push(i);i=null;h.push({operator:j})}}}if(i===null){i={operator:"NESTED",nestedRules:[]}}i.nestedRules.push(l.simpleFilter.createQueryRule())});if(i!==null){h.push(i)}k={operator:"NESTED",nestedRules:h};return k};return this};a.ComplexFilter.prototype=new a.Filter()}($,window.top.molgenis=window.top.molgenis||{}));