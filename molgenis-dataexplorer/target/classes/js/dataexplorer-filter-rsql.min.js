(function(d,l){l.dataexplorer=l.dataexplorer||{};var m=l.dataexplorer.rsql=l.dataexplorer.rsql||{};m.createFiltersFromRsql=function n(r,p,q){k(r,q,p).then(function(s){var t=[];d.each(Object.keys(s),function(){var u=s[this];t.push(f(u.attribute,u.model))});d(document).trigger("updateAttributeFilters",{filters:t})})};function f(q,p){switch(p.type){case"TEXT":return b(q,p);case"RANGE":return o(q,p);case"SIMPLE_REF":return g(q,p);case"COMPLEX_REF":return h(q,p);case"BOOL":return i(q,p)}}function b(r,p){var q=new l.dataexplorer.filter.ComplexFilter(r);d.each(p.lines,function(){var t=new l.dataexplorer.filter.SimpleFilter(r,undefined,undefined,this);var s=new l.dataexplorer.filter.ComplexFilterElement(r);s.simpleFilter=t;q.addComplexFilterElement(s)});return q}function o(r,p){var q=new l.dataexplorer.filter.ComplexFilter(r);d.each(p.lines,function(){var t=new l.dataexplorer.filter.SimpleFilter(r,this.from,this.to);var s=new l.dataexplorer.filter.ComplexFilterElement(r);s.simpleFilter=t;q.addComplexFilterElement(s)});return q}function g(r,p){var q=new l.dataexplorer.filter.SimpleFilter(r,undefined,undefined);d.each(p.values,function(){q.getValues().push(this.value);q.getLabels().push(this.label)});return q}function h(w,t){var q=t.lines;q.push(q[1]);var u=new l.dataexplorer.filter.ComplexFilter(w);for(var s=0;s<q.length;s+=2){var p=q[s];var v=new l.dataexplorer.filter.SimpleFilter(w,undefined,undefined);d.each(p.values,function(){if(this.value.constructor===Array){d.each(this.value,function(){v.getValues().push(this)})}else{v.getValues().push(this.value)}v.getLabels().push(this.label)});v.operator=p.operator;var r=new l.dataexplorer.filter.ComplexFilterElement(w);r.simpleFilter=v;if(s!=0){r.operator=q[s-1]}u.addComplexFilterElement(r)}return u}function i(q,p){return new l.dataexplorer.filter.SimpleFilter(q,undefined,undefined,p.value)}function k(v,u,t){var q=l.rsql.parser.parse(v);var p=l.rsql.transformer.groupBySelector(q);var r={};var s=[];d.each(Object.keys(p),function(){var x=this;var z=p[x];var y=x.indexOf(".");if(y!==-1){var A=x.slice(0,y);var w=x.slice(y+1,x.length);s.push(j(u,A,t).then(function(C){var B=C.refEntity.name;return j(B,w,t).then(function(E){var D=l.rsql.transformer.transformModelPart(E.fieldType,[],z);E.parent={name:A,label:A};r[x]={attribute:E,model:D}})},function(B){throw"An error has occurred: "+x+" "+B.statusText}))}else{s.push(j(u,x,t).then(function(D){if(D.refEntity){var B=l.rsql.transformer.getArguments(z);return e(D.refEntity.name,D.refEntity.idAttribute,D.refEntity.labelAttribute,B,t).then(function(F){var E=l.rsql.transformer.transformModelPart(D.fieldType,F,z);r[x]={attribute:D,model:E}})}else{var C=l.rsql.transformer.transformModelPart(D.fieldType,[],z);r[x]={attribute:D,model:C}}},function(B){throw"An error has occurred: "+x+" "+B.statusText}))}});return Promise.all(s).then(function(){return r})}function j(r,p,q){return q.getAsync("/api/v1/"+encodeURIComponent(r)+"/meta/"+encodeURIComponent(p)+"?expand=refEntity")}function e(q,t,v,p,r){var s=l.rsql.encodeRsqlValue(l.rsql.createRsqlQuery([{field:t,operator:"IN",value:Array.from(p.values())}]));var u="/api/v2/"+q+"?q="+s;return r.getAsync(u).then(function(w){var x={};d.each(w.items,function(){var z=this[t];var y=this[v];x[z]=y});return x},function(w){throw"An error has occurred: "+w.statusText})}m.translateFilterRulesToRSQL=function a(s,r){var q={};if(r){q=l.rsql.transformer.groupBySelector(l.rsql.parser.parse(r))}var p=l.rsql.transformer.groupBySelector(l.rsql.parser.parse(s));d.extend(q,p);return l.rsql.transformer.transformToRSQL(q)};m.removeFilterFromRsqlState=function c(r,q){var p=l.rsql.transformer.groupBySelector(l.rsql.parser.parse(q));if(r in p){delete p[r]}else{d.each(Object.keys(p),function(){var s=this;if(s.indexOf("."+r)!==-1){delete p[s]}})}return l.rsql.transformer.transformToRSQL(p)}}($,window.top.molgenis=window.top.molgenis||{}));