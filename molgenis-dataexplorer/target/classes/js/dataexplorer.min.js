$.when($,window.top.molgenis=window.top.molgenis||{},molgenis.getPluginSettings()).then(function(d,w,s){var q=w.dataexplorer=w.dataexplorer||{};q.getSelectedEntityMeta=x;q.getSelectedAttributes=t;q.getSelectedAttributesTree=F;q.getEntityQuery=c;q.createHeader=k;q.setGenomeAttributes=j;q.getSelectedModule=m;q.getRSQL=i;q.getSearchQuery=E;q.getnToken=a;q.moduleEvents={DATAEXPLORER_URI_CHANGE:"dataexplorer.uri.change"};var o=new w.RestClient();var g=null;var C={};var f=[];var A={};var y=null;var D=[];var l=undefined;var u;var z;if(s[1]!=="success"){w.createAlert([{message:"An error occurred initializing the data explorer."}],"error")}var B=s[0];q.settings=B;var v={entity:null,query:null,attrs:null,mod:null,hideselect:"false",filter:undefined};var e;function a(){return e.nToken}function i(){return e.filter}function m(){return e.mod}function x(){return g}function t(){return f}function F(){return A}function c(){return b()}function E(){return y}function h(K,J,H){var I=[];I.push('<ul class="nav nav-tabs pull-left" style="width: 100%" role="tablist">');d.each(K,function(){var L=w.getContextUrl()+"/module/"+this.id+"?entity="+J;I.push('<li data-id="'+this.id+'"><a href="'+L+'" data-target="#tab-'+this.id+'" data-id="'+this.id+'" role="tab" data-toggle="tab"><img src="/img/'+this.icon+'"> '+this.label+"</a></li>")});I.push('<li class="pull-right">');I.push('<button type="button" class="btn btn-default" id="toggleSelectors">')+I.push('<span id="toggleSelectorsIcon" class="glyphicon glyphicon-resize-horizontal"></span>')+I.push("</button></li>");I.push("</ul>");I.push('<div class="tab-content">');d.each(K,function(){I.push('<div class="tab-pane" id="tab-'+this.id+'" data-id="'+this.id+'">Loading...</div>')});I.push("</div>");H.html(I.join(""))}function n(J,I){var H=d("#feature-selection");H.tree({entityMetaData:J,selectedAttributes:I,onAttributesSelect:function(){f=H.tree("getSelectedAttributes");A=H.tree("getSelectedAttributesTree");d(document).trigger("changeAttributeSelection",{attributes:f,attributesTree:A,totalNrAttributes:Object.keys(J.attributes).length})},onAttributeClick:function(K){d(document).trigger("clickAttribute",{attribute:K})}})}function k(H){d("#entity-class-name").html(H.label);if(H.description){var I=d('<span data-placement="bottom"></span>');I.html(abbreviate(H.description,B.header_abbreviate));I.attr("data-title",H.description);d("#entity-class-description").html(I.tooltip())}else{d("#entity-class-description").html("")}}function j(I,H){u=I;z=H}function b(){var J;var I={q:[]};if(y){if(/\S/.test(y)){var N=/^\s*(?:chr)?([\d]{1,2}|X|Y|MT|XY):([\d]+)(?:-([\d]+)+)?\s*$/g;if(N&&y.match(N)&&z!==undefined&&u!==undefined){var K=N.exec(y);if(K[3]===undefined){J=K[1];var H=K[2];I.q=[{operator:"NESTED",nestedRules:[{field:z,operator:"EQUALS",value:J}]},{operator:"AND"},{operator:"NESTED",nestedRules:[{field:u,operator:"EQUALS",value:H}]}]}else{if(K[3]){J=K[1];var M=K[2];var L=K[3];if(parseInt(M,10)>parseInt(L,10)){w.createAlert([{message:"The start position of the queried range is larger than the stop position. Please check the search query."}],"warning")}else{d(".alerts").empty()}I.q=[{operator:"NESTED",nestedRules:[{operator:"NESTED",nestedRules:[{field:z,operator:"EQUALS",value:J}]}]},{operator:"AND"},{operator:"NESTED",nestedRules:[{field:u,operator:"GREATER_EQUAL",value:M},{operator:"AND"},{field:u,operator:"LESS_EQUAL",value:L}]}]}}}else{I.q.push({operator:"SEARCH",value:y})}}}d.each(C,function(O,P){var Q=P.createQueryRule();if(Q){if(I.q.length>0){I.q.push({operator:"AND"})}I.q.push(Q)}});return I}function G(){d.get(w.getContextUrl()+"/copy?entity="+e.entity).done(function(I){if(I===true){d("#copy-data-btn").removeClass("hidden")}else{d("#copy-data-btn").addClass("hidden")}});d.get(w.getContextUrl()+"/navigatorLinks?entity="+e.entity).done(function(J){if(J.length>0){d("#entity-package-path").removeClass("hidden");const I=[];J.forEach(function(K){if(K.label==="glyphicon-home"){K.label="<span class='glyphicon glyphicon-home' aria-hidden='true'></span> "}var L="<a href='"+K.href+"'>"+K.label+"</a>";I.push(L)});d("#entity-package-path").html("("+I.join(" / ")+")")}else{d("#entity-package-path").addClass("hidden")}});var H=o.getAsync("/api/v1/"+e.entity+"/meta",{expand:["attributes"]},function(I){g=I;f=[];q.createHeader(I);d.each(I.attributes,function(J,K){K.expanded=false;if(e.attrs===undefined||e.attrs===null){if(K.fieldType!=="COMPOUND"){f.push(K)}}else{if(e.attrs==="none"){f=[]}else{d.each(e.attrs,function(L,M){if(K.name===M){f.push(K)}})}}});A={};d.each(f,function(J,L){var K=L.name;A[K]=L.expanded===true?{"*":null}:null});n(I,f);if(B.launch_wizard===true){q.filter.wizard.openFilterWizardModal(I,C)}});d.get(w.getContextUrl()+"/modules?entity="+e.entity).done(function(L){var J=d("#module-nav");D=L.modules;h(L.modules,e.entity,J);var K;if(e.mod){K=d('a[data-toggle="tab"][data-target="#tab-'+e.mod+'"]',J)}else{K=d('a[data-toggle="tab"]',J).first()}e.mod=K.data("id");d.when(H).done(function(){K.tab("show")});function I(){d("#selectors").removeClass("col-md-3").addClass("hidden");d("#modules").removeClass("col-md-9").addClass("col-md-12");d("#toggleSelectorsIcon").removeClass("glyphicon glyphicon-resize-horizontal").addClass("glyphicon glyphicon-resize-small")}function M(){d("#selectors").addClass("col-md-3").removeClass("hidden");d("#modules").removeClass("col-md-12").addClass("col-md-9");d("#toggleSelectorsIcon").removeClass("glyphicon glyphicon-resize-small").addClass("glyphicon glyphicon-resize-horizontal")}d("#toggleSelectors").on("click",function(){if(d("#selectors").hasClass("hidden")){M()}else{I()}})});d("#observationset-search").focus()}function r(I,H){if(window.hasTrackingId){I("set","page",H);I("send","pageview")}if(window.hasMolgenisTrackingId){I("molgenisTracker.set","page",H);I("molgenisTracker.send","pageview")}}function p(){var K={};for(var I in e){if(e.hasOwnProperty(I)){var M=e[I];if(M){K[I]=M}}}if(e.query){delete K.query;for(var H=0;H<e.query.q.length;++H){var L=e.query.q[H];if(L.field===undefined&&L.operator==="SEARCH"){K.query={q:[L]};break}}}var J=e.filter;delete K.filter;if(J){history.pushState(e,"",w.getContextUrl()+"?"+d.param(K)+"&filter="+w.rsql.encodeRsqlValue(J))}else{history.pushState(e,"",w.getContextUrl()+"?"+d.param(K))}d(document).trigger(q.moduleEvents.DATAEXPLORER_URI_CHANGE)}d(function(){var J=d("#observationset-search");var L=d("#dataset-select");d(document).off(q.moduleEvents.DATAEXPLORER_URI_CHANGE);if(window.ga&&(window.hasTrackingId||window.hasMolgenisTrackingId)){d(document).on(q.moduleEvents.DATAEXPLORER_URI_CHANGE,function(){r(ga,d(location).attr("href"))})}d(document).on("show.bs.tab",'a[data-toggle="tab"]',function(O){var N=d(d(O.target).attr("data-target")),M=encodeURI(d(O.target).attr("href"));if(N.data("status")!=="loaded"){N.load(M,function(){N.data("status","loaded")})}});d(document).on("changeQuery",function(N,M){e.query=M;p()});d(document).on("changeEntity",function(N,M){e={entity:M,attributes:[],mod:null};p();g=null;C={};f=[];y=null;if(d("#data-table-container").length>0){React.unmountComponentAtNode(d("#data-table-container")[0])}d("#feature-filters").find("p").remove();J.val("");d("#data-table-pager").empty();d.each(D,function(){d(document).off("."+this.id)});G()});d(document).on("changeModule",function(N,M){e.mod=M;p()});d(document).on("changeAttributeSelection",function(N,M){if(M.attributes.length===0){e.attrs="none"}else{if(M.attributes.length===M.totalNrAttributes){e.attrs=null}else{e.attrs=d.map(M.attributes,function(O){return O.name})}}p()});d(document).on("updateAttributeFilters",function(S,Q){var T=[];for(var O=0;O<Object.keys(Q.filters).length;O++){var N=Object.keys(Q.filters)[O];var P=Q.filters[N];var R=P.createQueryRule();if((R.hasOwnProperty("value")&&R.value!==undefined)||(R.hasOwnProperty("nestedRules")&&R.nestedRules.length>0)){if(T.length>0){T.push({operator:"AND"})}T.push(R)}if(P.isEmpty()){delete C[P.attribute.href]}else{C[P.attribute.href]=P}}if(T.length>0){var M=w.createRsqlQuery(T);e.filter=w.dataexplorer.rsql.translateFilterRulesToRSQL(M,e.filter);p()}else{if(T.length===0){delete e.filter;p()}}q.filter.createFilterQueryUserReadableList(C);d(document).trigger("changeQuery",b())});d(document).on("removeAttributeFilter",function(O,N){delete C[N.attributeUri];q.filter.createFilterQueryUserReadableList(C);var M=N.attributeUri.split("/")[5];e.filter=w.dataexplorer.rsql.removeFilterFromRsqlState(M,e.filter);p();d(document).trigger("changeQuery",b())});d(document).on("clickAttribute",function(O,N){var M=N.attribute;if(M.fieldType!=="COMPOUND"&&(!M.refEntity||!M.parent)){q.filter.dialog.openFilterModal(N.attribute,C[N.attribute.href])}});var I=d("#plugin-container");if(L.length>0){L.select2({width:"resolve"});L.change(function(){d(document).trigger("changeEntity",d(this).val())})}J.change(function(M){y=d(this).val().trim();d(document).trigger("changeQuery",b())});d("#observationset-search").keypress(function(M){if(getInternetExplorerVersion()!=-1){if(M.which==13){d(document).trigger("changeQuery",b());J.change()}}});d("#search-clear-button").click(function(){J.val("");J.change()});d("#filter-wizard-btn").click(function(){q.filter.wizard.openFilterWizardModal(g,C)});d("#module-nav").on("click","ul.nav > li > a",function(M){d(document).trigger("changeModule",d(this).data("id"))});d(I).on("click",".feature-filter-edit",function(N){N.preventDefault();var M=C[d(this).data("href")];q.filter.dialog.openFilterModal(M.attribute,M)});d(I).on("click",".feature-filter-remove",function(M){M.preventDefault();d(document).trigger("removeAttributeFilter",{attributeUri:d(this).data("href")})});d("#delete-data-btn").on("click",function(){bootbox.confirm("Are you sure you want to delete all data for this entity?",function(M){if(M){d.ajax("/api/v1/"+g.name,{type:"DELETE"}).done(function(){document.location.href="/menu/main/dataexplorer?entity="+g.name})}})});d("#copy-data-btn").on("click",function(){bootbox.prompt({title:"<h4>Copy entity ["+g.label+']<h4/><div class="small">Please enter a new entity name.<ul><li>Use max 30 characters.<li>Only letters (a-z, A-Z), digits (0-9), underscores (_) and hashes (#) are allowed.</li></ul><br/>By pushing the ok button you will create an new entity with copied data.</div>',value:g.label+"Copy",callback:function(M){if(M!==null){d.ajax({headers:{Accept:"application/json","Content-Type":"application/json"},type:"POST",url:"/api/v2/copy/"+g.name,data:JSON.stringify({newEntityName:M}),dataType:"json",success:function(N){document.location.href="/menu/main/dataexplorer?entity="+N}})}}})});d("#delete-data-metadata-btn").on("click",function(){bootbox.confirm("Are you sure you want to delete all data and metadata for this entity?",function(M){if(M){d.ajax("/api/v1/"+g.name+"/meta",{type:"DELETE"}).done(function(){document.location.href="/menu/main/dataexplorer"})}})});function K(){if(!e.entity){e.entity=d("#dataset-select").find("option:selected").val()}if(!e.entity){e.entity=d("#dataset-select").find("option:not(:empty)").first().val()}d("#dataset-select").select2("val",e.entity);if(e.hideselect==="true"){d("#dataset-select-container").addClass("hidden")}else{d("#dataset-select-container").removeClass("hidden")}if(e.query){for(var M=0;M<e.query.q.length;++M){var N=e.query.q[M];if(N.field===undefined&&N.operator==="SEARCH"){d("#observationset-search").val(N.value).change();break}}}if(e.filter){w.dataexplorer.rsql.createFiltersFromRsql(e.filter,o,e.entity)}if(e.entity){G()}}if(window.location.search&&window.location.search.length>0){var H=window.location.search.substring(1);if(H.length>0){e=d.deparam(H)}}else{e=v}window.onpopstate=function(M){if(M.state!==null){e=M.state;K()}};K()})});