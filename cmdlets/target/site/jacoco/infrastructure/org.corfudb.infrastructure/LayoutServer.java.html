<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>LayoutServer.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">cmdlets</a> &gt; <a href="../index.html" class="el_bundle">infrastructure</a> &gt; <a href="index.source.html" class="el_package">org.corfudb.infrastructure</a> &gt; <span class="el_source">LayoutServer.java</span></div><h1>LayoutServer.java</h1><pre class="source lang-java linenums">package org.corfudb.infrastructure;

import io.netty.channel.ChannelHandlerContext;

import java.lang.invoke.MethodHandles;
import java.util.Map;

import javax.annotation.Nonnull;
import lombok.Getter;
import lombok.NonNull;
import lombok.extern.slf4j.Slf4j;

import org.corfudb.protocols.wireprotocol.CorfuMsg;
import org.corfudb.protocols.wireprotocol.CorfuMsgType;
import org.corfudb.protocols.wireprotocol.CorfuPayloadMsg;
import org.corfudb.protocols.wireprotocol.LayoutBootstrapRequest;
import org.corfudb.protocols.wireprotocol.LayoutCommittedRequest;
import org.corfudb.protocols.wireprotocol.LayoutMsg;
import org.corfudb.protocols.wireprotocol.LayoutPrepareRequest;
import org.corfudb.protocols.wireprotocol.LayoutPrepareResponse;
import org.corfudb.protocols.wireprotocol.LayoutProposeRequest;
import org.corfudb.protocols.wireprotocol.LayoutProposeResponse;
import org.corfudb.runtime.view.Layout;

/**
 * The layout server serves layouts, which are used by clients to find the
 * Corfu infrastructure.
 *
 * &lt;p&gt;For replication and high availability, the layout server implements a
 * basic Paxos protocol. The layout server functions as a Paxos acceptor,
 * and accepts proposals from clients consisting of a rank and desired
 * layout. The protocol consists of three rounds:
 *
 * &lt;p&gt;1)   Prepare(rank) - Clients first contact each server with a rank.
 * If the server responds with ACK, the server promises not to
 * accept any requests with a rank lower than the given rank.
 * If the server responds with LAYOUT_PREPARE_REJECT, the server
 * informs the client of the current high rank and the request is
 * rejected.
 *
 * &lt;p&gt;2)   Propose(rank,layout) - Clients then contact each server with
 * the previously prepared rank and the desired layout. If no other
 * client has sent a prepare with a higher rank, the layout is
 * persisted, and the server begins serving that layout to other
 * clients. If the server responds with LAYOUT_PROPOSE_REJECT,
 * either another client has sent a prepare with a higher rank,
 * or this was a propose of a previously accepted rank.
 *
 * &lt;p&gt;3)   Committed(rank, layout) - Clients then send a hint to each layout
 * server that a new rank has been accepted by a quorum of
 * servers.
 *
 * &lt;p&gt;Created by mwei on 12/8/15.
 */
//TODO Finer grained synchronization needed for this class.
//TODO Need a janitor to cleanup old phases data and to fill up holes in layout history.
<span class="nc" id="L57">@Slf4j</span>
public class LayoutServer extends AbstractServer {

    /**
     * The options map.
     */
    private final Map&lt;String, Object&gt; opts;

<span class="nc" id="L65">    @Getter</span>
    private final ServerContext serverContext;

    /**
     * Handler for this server.
     */
<span class="nc" id="L71">    @Getter</span>
    private final CorfuMsgHandler handler =
<span class="nc" id="L73">            CorfuMsgHandler.generateHandler(MethodHandles.lookup(), this);</span>

    /**
     * Returns new LayoutServer for context.
     *
     * @param serverContext context object providing settings and objects
     */
<span class="nc" id="L80">    public LayoutServer(@Nonnull ServerContext serverContext) {</span>
<span class="nc" id="L81">        this.opts = serverContext.getServerConfig();</span>
<span class="nc" id="L82">        this.serverContext = serverContext;</span>

<span class="nc bnc" id="L84" title="All 2 branches missed.">        if (serverContext.installSingleNodeLayoutIfAbsent()) {</span>
<span class="nc" id="L85">            setLayoutInHistory(serverContext.getCurrentLayout());</span>
        }
<span class="nc" id="L87">    }</span>



    boolean checkBootstrap(CorfuMsg msg, ChannelHandlerContext ctx, IServerRouter r) {
<span class="nc bnc" id="L92" title="All 2 branches missed.">        if (getCurrentLayout() == null) {</span>
<span class="nc" id="L93">            log.warn(&quot;Received message but not bootstrapped! Message={}&quot;, msg);</span>
<span class="nc" id="L94">            r.sendResponse(ctx, msg, new CorfuMsg(CorfuMsgType.LAYOUT_NOBOOTSTRAP));</span>
<span class="nc" id="L95">            return false;</span>
        }
<span class="nc" id="L97">        return true;</span>
    }

    // Helper Methods

    /**
     * Handle a layout request message.
     *
     * @param msg              corfu message containing LAYOUT_REQUEST
     * @param ctx              netty ChannelHandlerContext
     * @param r                server router
     */
    @ServerHandler(type = CorfuMsgType.LAYOUT_REQUEST)
    public synchronized void handleMessageLayoutRequest(CorfuPayloadMsg&lt;Long&gt; msg,
                                                    ChannelHandlerContext ctx, IServerRouter r) {
<span class="nc bnc" id="L112" title="All 2 branches missed.">        if (!checkBootstrap(msg, ctx, r)) {</span>
<span class="nc" id="L113">            return;</span>
        }
<span class="nc" id="L115">        long epoch = msg.getPayload();</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">        if (epoch &lt;= serverContext.getServerEpoch()) {</span>
<span class="nc" id="L117">            r.sendResponse(ctx, msg, new LayoutMsg(getCurrentLayout(), CorfuMsgType</span>
                    .LAYOUT_RESPONSE));
<span class="nc" id="L119">            return;</span>
        } else {
            // else the client is somehow ahead of the server.
            //TODO figure out a strategy to deal with this situation
<span class="nc" id="L123">            long serverEpoch = serverContext.getServerEpoch();</span>
<span class="nc" id="L124">            r.sendResponse(ctx, msg, new CorfuPayloadMsg&lt;&gt;(CorfuMsgType.WRONG_EPOCH, serverEpoch));</span>
<span class="nc" id="L125">            log.warn(&quot;handleMessageLayoutRequest: Message Epoch {} ahead of Server epoch {}&quot;,</span>
<span class="nc" id="L126">                    epoch, serverEpoch);</span>
        }
<span class="nc" id="L128">    }</span>

    /**
     * Sets the new layout if the server has not been bootstrapped with one already.
     *
     * @param msg corfu message containing LAYOUT_BOOTSTRAP
     * @param ctx netty ChannelHandlerContext
     * @param r   server router
     */
    @ServerHandler(type = CorfuMsgType.LAYOUT_BOOTSTRAP)
    public synchronized void handleMessageLayoutBootstrap(
<span class="nc bnc" id="L139" title="All 2 branches missed.">            @NonNull CorfuPayloadMsg&lt;LayoutBootstrapRequest&gt; msg,</span>
            ChannelHandlerContext ctx,
<span class="nc bnc" id="L141" title="All 2 branches missed.">            @NonNull IServerRouter r) {</span>

<span class="nc bnc" id="L143" title="All 2 branches missed.">        if (getCurrentLayout() == null) {</span>
<span class="nc" id="L144">            log.info(&quot;handleMessageLayoutBootstrap: Bootstrap with new layout={}, {}&quot;,</span>
<span class="nc" id="L145">                    msg.getPayload().getLayout(), msg);</span>
<span class="nc" id="L146">            setCurrentLayout(msg.getPayload().getLayout());</span>
<span class="nc" id="L147">            serverContext.setServerEpoch(getCurrentLayout().getEpoch(), r);</span>
            //send a response that the bootstrap was successful.
<span class="nc" id="L149">            r.sendResponse(ctx, msg, new CorfuMsg(CorfuMsgType.ACK));</span>
        } else {
            // We are already bootstrapped, bootstrap again is not allowed.
<span class="nc" id="L152">            log.warn(&quot;handleMessageLayoutBootstrap: Got a request to bootstrap a server which is &quot;</span>
                    + &quot;already bootstrapped, rejecting!&quot;);
<span class="nc" id="L154">            r.sendResponse(ctx, msg, new CorfuMsg(CorfuMsgType.LAYOUT_ALREADY_BOOTSTRAP));</span>
        }
<span class="nc" id="L156">    }</span>

    /**
     * Accepts a prepare message if the rank is higher than any accepted so far.
     *
     * @param msg corfu message containing LAYOUT_PREPARE
     * @param ctx netty ChannelHandlerContext
     * @param r   server router
     */
    // TODO this can work under a separate lock for this step as it does not change the global
    // components
    @ServerHandler(type = CorfuMsgType.LAYOUT_PREPARE)
    public synchronized void handleMessageLayoutPrepare(
<span class="nc bnc" id="L169" title="All 2 branches missed.">            @NonNull CorfuPayloadMsg&lt;LayoutPrepareRequest&gt; msg,</span>
            ChannelHandlerContext ctx,
<span class="nc bnc" id="L171" title="All 2 branches missed.">            @NonNull IServerRouter r) {</span>

        // Check if the prepare is for the correct epoch
<span class="nc bnc" id="L174" title="All 2 branches missed.">        if (!checkBootstrap(msg, ctx, r)) {</span>
<span class="nc" id="L175">            return;</span>
        }
<span class="nc" id="L177">        Rank prepareRank = new Rank(msg.getPayload().getRank(), msg.getClientID());</span>
<span class="nc" id="L178">        Rank phase1Rank = getPhase1Rank();</span>
<span class="nc" id="L179">        Layout proposedLayout = getProposedLayout();</span>

<span class="nc" id="L181">        long serverEpoch = getServerEpoch();</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">        if (msg.getPayload().getEpoch() != serverEpoch) {</span>
<span class="nc" id="L183">            r.sendResponse(ctx, msg, new CorfuPayloadMsg&lt;&gt;(CorfuMsgType.WRONG_EPOCH, serverEpoch));</span>
<span class="nc" id="L184">            log.trace(&quot;handleMessageLayoutPrepare: Incoming message with wrong epoch, got {}, &quot;</span>
                            + &quot;expected {}, message was: {}&quot;,
<span class="nc" id="L186">                    msg.getPayload().getEpoch(), serverEpoch, msg);</span>
<span class="nc" id="L187">            return;</span>
        }


        // This is a prepare. If the rank is less than or equal to the phase 1 rank, reject.
<span class="nc bnc" id="L192" title="All 4 branches missed.">        if (phase1Rank != null &amp;&amp; prepareRank.lessThanEqualTo(phase1Rank)) {</span>
<span class="nc" id="L193">            log.debug(&quot;handleMessageLayoutPrepare: Rejected phase 1 prepare of rank={}, &quot;</span>
                    + &quot;phase1Rank={}&quot;, prepareRank, phase1Rank);
<span class="nc" id="L195">            r.sendResponse(ctx, msg, CorfuMsgType.LAYOUT_PREPARE_REJECT.payloadMsg(new</span>
<span class="nc" id="L196">                    LayoutPrepareResponse(phase1Rank.getRank(), proposedLayout)));</span>
        } else {
            // Return the layout with the highest rank proposed before.
<span class="nc bnc" id="L199" title="All 2 branches missed.">            Rank highestProposedRank = proposedLayout == null ? new Rank(-1L, msg.getClientID())</span>
<span class="nc" id="L200">                    : getPhase2Rank();</span>
<span class="nc" id="L201">            setPhase1Rank(prepareRank);</span>
<span class="nc" id="L202">            log.debug(&quot;handleMessageLayoutPrepare: New phase 1 rank={}&quot;, getPhase1Rank());</span>
<span class="nc" id="L203">            r.sendResponse(ctx, msg, CorfuMsgType.LAYOUT_PREPARE_ACK.payloadMsg(new</span>
<span class="nc" id="L204">                    LayoutPrepareResponse(highestProposedRank.getRank(), proposedLayout)));</span>
        }
<span class="nc" id="L206">    }</span>

    /**
     * Accepts a proposal for which it had accepted in the prepare phase.
     * A minor optimization is to reject any duplicate propose messages.
     *
     * @param msg corfu message containing LAYOUT_PROPOSE
     * @param ctx netty ChannelHandlerContext
     * @param r   server router
     */
    @ServerHandler(type = CorfuMsgType.LAYOUT_PROPOSE)
    public synchronized void handleMessageLayoutPropose(
<span class="nc bnc" id="L218" title="All 2 branches missed.">            @NonNull CorfuPayloadMsg&lt;LayoutProposeRequest&gt; msg,</span>
            ChannelHandlerContext ctx,
<span class="nc bnc" id="L220" title="All 2 branches missed.">            @NonNull IServerRouter r) {</span>

<span class="nc bnc" id="L222" title="All 2 branches missed.">        if (!checkBootstrap(msg, ctx, r)) {</span>
<span class="nc" id="L223">            return;</span>
        }
<span class="nc" id="L225">        Rank proposeRank = new Rank(msg.getPayload().getRank(), msg.getClientID());</span>
<span class="nc" id="L226">        Rank phase1Rank = getPhase1Rank();</span>

<span class="nc" id="L228">        long serverEpoch = getServerEpoch();</span>

        // Check if the propose is for the correct epoch
<span class="nc bnc" id="L231" title="All 2 branches missed.">        if (msg.getPayload().getEpoch() != serverEpoch) {</span>
<span class="nc" id="L232">            r.sendResponse(ctx, msg, new CorfuPayloadMsg&lt;&gt;(CorfuMsgType.WRONG_EPOCH, serverEpoch));</span>
<span class="nc" id="L233">            log.trace(&quot;handleMessageLayoutPropose: Incoming message with wrong epoch, got {}, &quot;</span>
                            + &quot;expected {}, message was: {}&quot;,
<span class="nc" id="L235">                    msg.getPayload().getEpoch(), serverEpoch, msg);</span>
<span class="nc" id="L236">            return;</span>
        }
        // This is a propose. If no prepare, reject.
<span class="nc bnc" id="L239" title="All 2 branches missed.">        if (phase1Rank == null) {</span>
<span class="nc" id="L240">            log.debug(&quot;handleMessageLayoutPropose: Rejected phase 2 propose of rank={}, &quot;</span>
                    + &quot;phase1Rank=none&quot;, proposeRank);
<span class="nc" id="L242">            r.sendResponse(ctx, msg, CorfuMsgType.LAYOUT_PROPOSE_REJECT.payloadMsg(new</span>
                    LayoutProposeResponse(-1)));
<span class="nc" id="L244">            return;</span>
        }
        // This is a propose. If the rank in the proposal is less than or equal to the highest yet
        // observed prepare rank, reject.
<span class="nc bnc" id="L248" title="All 2 branches missed.">        if (!proposeRank.equals(phase1Rank)) {</span>
<span class="nc" id="L249">            log.debug(&quot;handleMessageLayoutPropose: Rejected phase 2 propose of rank={}, &quot;</span>
                    + &quot;phase1Rank={}&quot;, proposeRank, phase1Rank);
<span class="nc" id="L251">            r.sendResponse(ctx, msg, CorfuMsgType.LAYOUT_PROPOSE_REJECT.payloadMsg(new</span>
<span class="nc" id="L252">                    LayoutProposeResponse(phase1Rank.getRank())));</span>
<span class="nc" id="L253">            return;</span>
        }
<span class="nc" id="L255">        Rank phase2Rank = getPhase2Rank();</span>
<span class="nc" id="L256">        Layout proposeLayout = msg.getPayload().getLayout();</span>
        // In addition, if the rank in the propose message is equal to the current phase 2 rank
        // (already accepted message), reject.
        // This can happen in case of duplicate messages.
<span class="nc bnc" id="L260" title="All 4 branches missed.">        if (phase2Rank != null &amp;&amp; proposeRank.equals(phase2Rank)) {</span>
<span class="nc" id="L261">            log.debug(&quot;handleMessageLayoutPropose: Rejected phase 2 propose of rank={}, &quot;</span>
                    + &quot;phase2Rank={}&quot;, proposeRank, phase2Rank);
<span class="nc" id="L263">            r.sendResponse(ctx, msg, CorfuMsgType.LAYOUT_PROPOSE_REJECT.payloadMsg(new</span>
<span class="nc" id="L264">                    LayoutProposeResponse(phase2Rank.getRank())));</span>
<span class="nc" id="L265">            return;</span>
        }

<span class="nc" id="L268">        log.debug(&quot;handleMessageLayoutPropose: New phase 2 rank={},  layout={}&quot;,</span>
                proposeRank, proposeLayout);
<span class="nc" id="L270">        setPhase2Data(new Phase2Data(proposeRank, proposeLayout));</span>
<span class="nc" id="L271">        r.sendResponse(ctx, msg, new CorfuMsg(CorfuMsgType.ACK));</span>
<span class="nc" id="L272">    }</span>


    /**
     * Force layout enables the server to bypass consensus
     * and accept a new layout.
     *
     * @param msg              corfu message containing LAYOUT_FORCE
     * @param ctx              netty ChannelHandlerContext
     * @param r                server router
     */
    private synchronized void forceLayout(@Nonnull CorfuPayloadMsg&lt;LayoutCommittedRequest&gt; msg,
                                               @Nonnull ChannelHandlerContext ctx,
                                               @Nonnull IServerRouter r) {
<span class="nc" id="L286">        LayoutCommittedRequest req = msg.getPayload();</span>

<span class="nc bnc" id="L288" title="All 2 branches missed.">        if (req.getEpoch() != getServerEpoch()) {</span>
            // return can't force old epochs
<span class="nc" id="L290">            r.sendResponse(ctx, msg, new CorfuMsg(CorfuMsgType.NACK));</span>
<span class="nc" id="L291">            log.warn(&quot;forceLayout: Trying to force a layout with an old epoch. Layout {}, &quot; +</span>
<span class="nc" id="L292">                    &quot;current epoch {}&quot;, req.getLayout(), getServerEpoch());</span>
<span class="nc" id="L293">            return;</span>
        }

<span class="nc" id="L296">        setCurrentLayout(req.getLayout());</span>
<span class="nc" id="L297">        serverContext.setServerEpoch(req.getLayout().getEpoch(), r);</span>
<span class="nc" id="L298">        log.warn(&quot;forceLayout: Forcing new layout {}&quot;, req.getLayout());</span>
<span class="nc" id="L299">        r.sendResponse(ctx, msg, new CorfuMsg(CorfuMsgType.ACK));</span>
<span class="nc" id="L300">    }</span>


    /**
     * Accepts any committed layouts for the current epoch or newer epochs.
     * As part of the accept, the server changes it's current layout and epoch.
     *
     * @param msg corfu message containing LAYOUT_COMMITTED
     * @param ctx netty ChannelHandlerContext
     * @param r   server router
     */
    // TODO If a server does not get SET_EPOCH layout commit message cannot reach it
    // TODO as this message is not set to ignore EPOCH.
    // TODO How do we handle holes in history if we let in layout commit message. Maybe we have a
    // hole filling process
    @ServerHandler(type = CorfuMsgType.LAYOUT_COMMITTED)
    public synchronized void handleMessageLayoutCommit(
<span class="nc bnc" id="L317" title="All 2 branches missed.">            @NonNull CorfuPayloadMsg&lt;LayoutCommittedRequest&gt; msg,</span>
            ChannelHandlerContext ctx,
<span class="nc bnc" id="L319" title="All 2 branches missed.">            @NonNull IServerRouter r) {</span>

<span class="nc bnc" id="L321" title="All 2 branches missed.">        if (msg.getPayload().getForce()) {</span>
<span class="nc" id="L322">            forceLayout(msg, ctx, r);</span>
<span class="nc" id="L323">            return;</span>
        }

<span class="nc" id="L326">        Layout commitLayout = msg.getPayload().getLayout();</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">        if (!checkBootstrap(msg, ctx, r)) {</span>
<span class="nc" id="L328">            return;</span>
        }
<span class="nc" id="L330">        long serverEpoch = getServerEpoch();</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">        if (msg.getPayload().getEpoch() &lt; serverEpoch) {</span>
<span class="nc" id="L332">            r.sendResponse(ctx, msg, new CorfuPayloadMsg&lt;&gt;(CorfuMsgType.WRONG_EPOCH, serverEpoch));</span>
<span class="nc" id="L333">            return;</span>
        }

<span class="nc" id="L336">        setCurrentLayout(commitLayout);</span>
<span class="nc" id="L337">        serverContext.setServerEpoch(msg.getPayload().getEpoch(), r);</span>
<span class="nc" id="L338">        log.info(&quot;New layout committed: {}&quot;, commitLayout);</span>
<span class="nc" id="L339">        r.sendResponse(ctx, msg, new CorfuMsg(CorfuMsgType.ACK));</span>
<span class="nc" id="L340">    }</span>


    public Layout getCurrentLayout() {
<span class="nc" id="L344">        return serverContext.getCurrentLayout();</span>
    }

    /**
     * Sets the current layout in context DataStore.
     *
     * @param layout layout to set
     */
    public void setCurrentLayout(Layout layout) {
<span class="nc" id="L353">        serverContext.setCurrentLayout(layout);</span>
        // set the layout in history as well
<span class="nc" id="L355">        setLayoutInHistory(layout);</span>
<span class="nc" id="L356">    }</span>

    public Rank getPhase1Rank() {
<span class="nc" id="L359">        return serverContext.getPhase1Rank();</span>
    }

    public void setPhase1Rank(Rank rank) {
<span class="nc" id="L363">        serverContext.setPhase1Rank(rank);</span>
<span class="nc" id="L364">    }</span>

    public Phase2Data getPhase2Data() {
<span class="nc" id="L367">        return serverContext.getPhase2Data();</span>
    }

    public void setPhase2Data(Phase2Data phase2Data) {
<span class="nc" id="L371">        serverContext.setPhase2Data(phase2Data);</span>
<span class="nc" id="L372">    }</span>

    public void setLayoutInHistory(Layout layout) {
<span class="nc" id="L375">        serverContext.setLayoutInHistory(layout);</span>
<span class="nc" id="L376">    }</span>

    private long getServerEpoch() {
<span class="nc" id="L379">        return serverContext.getServerEpoch();</span>
    }

    /**
     * Returns the phase 2 rank.
     *
     * @return the phase 2 rank
     */
    public Rank getPhase2Rank() {
<span class="nc" id="L388">        Phase2Data phase2Data = getPhase2Data();</span>
<span class="nc bnc" id="L389" title="All 2 branches missed.">        if (phase2Data != null) {</span>
<span class="nc" id="L390">            return phase2Data.getRank();</span>
        }
<span class="nc" id="L392">        return null;</span>
    }

    /**
     * Returns the proposed layout received in phase 2 data.
     *
     * @return the proposed layout
     */
    public Layout getProposedLayout() {
<span class="nc" id="L401">        Phase2Data phase2Data = getPhase2Data();</span>
<span class="nc bnc" id="L402" title="All 2 branches missed.">        if (phase2Data != null) {</span>
<span class="nc" id="L403">            return phase2Data.getLayout();</span>
        }
<span class="nc" id="L405">        return null;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>