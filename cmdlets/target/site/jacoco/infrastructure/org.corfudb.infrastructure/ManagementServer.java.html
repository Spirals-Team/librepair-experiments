<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ManagementServer.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">cmdlets</a> &gt; <a href="../index.html" class="el_bundle">infrastructure</a> &gt; <a href="index.source.html" class="el_package">org.corfudb.infrastructure</a> &gt; <span class="el_source">ManagementServer.java</span></div><h1>ManagementServer.java</h1><pre class="source lang-java linenums">package org.corfudb.infrastructure;

import io.netty.channel.ChannelHandlerContext;

import java.lang.invoke.MethodHandles;
import java.time.Duration;
import java.util.Map;

import javax.annotation.Nonnull;

import lombok.Getter;
import lombok.extern.slf4j.Slf4j;

import org.corfudb.infrastructure.orchestrator.Orchestrator;

import org.corfudb.protocols.wireprotocol.CorfuMsg;
import org.corfudb.protocols.wireprotocol.CorfuMsgType;
import org.corfudb.protocols.wireprotocol.CorfuPayloadMsg;
import org.corfudb.protocols.wireprotocol.DetectorMsg;
import org.corfudb.protocols.wireprotocol.NodeView;
import org.corfudb.protocols.wireprotocol.ServerMetrics;
import org.corfudb.protocols.wireprotocol.orchestrator.OrchestratorMsg;

import org.corfudb.runtime.CorfuRuntime;
import org.corfudb.runtime.view.IReconfigurationHandlerPolicy;
import org.corfudb.runtime.view.Layout;
import org.corfudb.util.NodeLocator;
import org.corfudb.util.concurrent.SingletonResource;


/**
 * Handles reconfiguration and workflow requests to the Management Server.
 * Spawns the following services:
 * - Management Agent.
 * - Orchestrator.
 *
 * &lt;p&gt;Created by zlokhandwala on 9/28/16.
 */
<span class="nc" id="L39">@Slf4j</span>
public class ManagementServer extends AbstractServer {

    /**
     * The options map.
     */
    private final Map&lt;String, Object&gt; opts;
    private final ServerContext serverContext;

    /**
     * A {@link SingletonResource} which provides a {@link CorfuRuntime}.
     */
<span class="nc" id="L51">    private final SingletonResource&lt;CorfuRuntime&gt; corfuRuntime =</span>
<span class="nc" id="L52">            SingletonResource.withInitial(this::getNewCorfuRuntime);</span>
    /**
     * Policy to be used to handle failures/healing.
     */
    private IReconfigurationHandlerPolicy failureHandlerPolicy;
    private IReconfigurationHandlerPolicy healingPolicy;
    /**
     * Bootstrap endpoint to seed the Management Server.
     */
<span class="nc" id="L61">    @Getter</span>
    private final String bootstrapEndpoint;

<span class="nc" id="L64">    @Getter</span>
    private final ManagementAgent managementAgent;

<span class="nc" id="L67">    @Getter</span>
    private final String localEndpoint;

    private Orchestrator orchestrator;

    /**
     * Returns new ManagementServer.
     *
     * @param serverContext context object providing parameters and objects
     */
<span class="nc" id="L77">    public ManagementServer(ServerContext serverContext) {</span>

<span class="nc" id="L79">        this.opts = serverContext.getServerConfig();</span>
<span class="nc" id="L80">        this.localEndpoint = this.opts.get(&quot;--address&quot;) + &quot;:&quot; + this.opts.get(&quot;&lt;port&gt;&quot;);</span>
<span class="nc" id="L81">        this.serverContext = serverContext;</span>

<span class="nc bnc" id="L83" title="All 2 branches missed.">        bootstrapEndpoint = (opts.get(&quot;--management-server&quot;) != null)</span>
<span class="nc" id="L84">                ? opts.get(&quot;--management-server&quot;).toString() : null;</span>

<span class="nc" id="L86">        this.failureHandlerPolicy = serverContext.getFailureHandlerPolicy();</span>
<span class="nc" id="L87">        this.healingPolicy = serverContext.getHealingHandlerPolicy();</span>

        // Creating a management agent.
<span class="nc" id="L90">        this.managementAgent = new ManagementAgent(corfuRuntime, serverContext);</span>
<span class="nc" id="L91">        this.orchestrator = new Orchestrator(corfuRuntime, serverContext);</span>
<span class="nc" id="L92">    }</span>

    /**
     * Returns a connected instance of the CorfuRuntime.
     *
     * @return A connected instance of runtime.
     */
    private CorfuRuntime getNewCorfuRuntime() {
<span class="nc" id="L100">        final CorfuRuntime.CorfuRuntimeParameters params =</span>
<span class="nc" id="L101">                serverContext.getDefaultRuntimeParameters();</span>
<span class="nc" id="L102">        final CorfuRuntime runtime = CorfuRuntime.fromParameters(params);</span>
        // Runtime can be set up either using the layout or the bootstrapEndpoint address.
<span class="nc bnc" id="L104" title="All 2 branches missed.">        if (serverContext.getManagementLayout() != null) {</span>
<span class="nc" id="L105">            serverContext.getManagementLayout().getLayoutServers()</span>
<span class="nc" id="L106">                    .forEach(runtime::addLayoutServer);</span>
        } else {
<span class="nc" id="L108">            runtime.addLayoutServer(getBootstrapEndpoint());</span>
        }
<span class="nc" id="L110">        runtime.connect();</span>
<span class="nc" id="L111">        log.info(&quot;getCorfuRuntime: Corfu Runtime connected successfully&quot;);</span>
<span class="nc" id="L112">        return runtime;</span>
    }

    /**
     * Handler for this server.
     */
<span class="nc" id="L118">    @Getter</span>
    private final CorfuMsgHandler handler =
<span class="nc" id="L120">            CorfuMsgHandler.generateHandler(MethodHandles.lookup(), this);</span>

    private boolean checkBootstrap(CorfuMsg msg,
                                   ChannelHandlerContext ctx,
                                   IServerRouter r) {
<span class="nc bnc" id="L125" title="All 4 branches missed.">        if (serverContext.getManagementLayout() == null &amp;&amp; bootstrapEndpoint == null) {</span>
<span class="nc" id="L126">            log.warn(&quot;Received message but not bootstrapped! Message={}&quot;, msg);</span>
<span class="nc" id="L127">            return false;</span>
        }
<span class="nc" id="L129">        return true;</span>
    }

    /**
     * Forward an orchestrator request to the orchestrator service.
     *
     * @param msg corfu message containing ORCHESTRATOR_REQUEST
     * @param ctx netty ChannelHandlerContext
     * @param r   server router
     */
    @ServerHandler(type = CorfuMsgType.ORCHESTRATOR_REQUEST)
    public synchronized void handleOrchestratorMsg(@Nonnull CorfuPayloadMsg&lt;OrchestratorMsg&gt; msg,
                                                   @Nonnull ChannelHandlerContext ctx,
                                                   @Nonnull IServerRouter r) {
<span class="nc" id="L143">        log.debug(&quot;Received an orchestrator message {}&quot;, msg);</span>
<span class="nc" id="L144">        orchestrator.handle(msg, ctx, r);</span>
<span class="nc" id="L145">    }</span>

    /**
     * Bootstraps the management server.
     * The msg contains the layout to be bootstrapped.
     *
     * @param msg corfu message containing MANAGEMENT_BOOTSTRAP_REQUEST
     * @param ctx netty ChannelHandlerContext
     * @param r   server router
     */
    @ServerHandler(type = CorfuMsgType.MANAGEMENT_BOOTSTRAP_REQUEST)
    public synchronized void handleManagementBootstrap(CorfuPayloadMsg&lt;Layout&gt; msg,
                                                       ChannelHandlerContext ctx, IServerRouter r) {
<span class="nc bnc" id="L158" title="All 2 branches missed.">        if (serverContext.getManagementLayout() != null) {</span>
            // We are already bootstrapped, bootstrap again is not allowed.
<span class="nc" id="L160">            log.warn(&quot;Got a request to bootstrap a server which is already bootstrapped, &quot;</span>
                    + &quot;rejecting!&quot;);
<span class="nc" id="L162">            r.sendResponse(ctx, msg, new CorfuMsg(CorfuMsgType.MANAGEMENT_ALREADY_BOOTSTRAP_ERROR));</span>
        } else {
<span class="nc" id="L164">            log.info(&quot;Received Bootstrap Layout : {}&quot;, msg.getPayload());</span>
<span class="nc" id="L165">            serverContext.saveManagementLayout(msg.getPayload());</span>
<span class="nc" id="L166">            r.sendResponse(ctx, msg, new CorfuMsg(CorfuMsgType.ACK));</span>

        }
<span class="nc" id="L169">    }</span>

    /**
     * Triggers the failure handler.
     * The msg contains the failed/defected nodes.
     *
     * @param msg corfu message containing MANAGEMENT_FAILURE_DETECTED
     * @param ctx netty ChannelHandlerContext
     * @param r   server router
     */
    @ServerHandler(type = CorfuMsgType.MANAGEMENT_FAILURE_DETECTED)
    public synchronized void handleFailureDetectedMsg(CorfuPayloadMsg&lt;DetectorMsg&gt; msg,
                                                      ChannelHandlerContext ctx, IServerRouter r) {

        // This server has not been bootstrapped yet, ignore all requests.
<span class="nc bnc" id="L184" title="All 2 branches missed.">        if (!checkBootstrap(msg, ctx, r)) {</span>
<span class="nc" id="L185">            r.sendResponse(ctx, msg, new CorfuMsg(CorfuMsgType.MANAGEMENT_NOBOOTSTRAP_ERROR));</span>
<span class="nc" id="L186">            return;</span>
        }

<span class="nc" id="L189">        log.info(&quot;handleFailureDetectedMsg: Received DetectorMsg : {}&quot;, msg.getPayload());</span>

<span class="nc" id="L191">        DetectorMsg detectorMsg = msg.getPayload();</span>
<span class="nc" id="L192">        Layout layout = new Layout(serverContext.getManagementLayout());</span>

        // If this message is stamped with an older epoch which indicates the polling was
        // conducted in an old epoch. This message cannot be considered and is discarded.
<span class="nc bnc" id="L196" title="All 2 branches missed.">        if (!detectorMsg.getDetectorEpoch().equals(layout.getEpoch())) {</span>
<span class="nc" id="L197">            log.error(&quot;handleFailureDetectedMsg: Discarding stale detector message received. &quot;</span>
                            + &quot;detectorEpoch:{} latestLayout epoch:{}&quot;,
<span class="nc" id="L199">                    detectorMsg.getDetectorEpoch(), layout.getEpoch());</span>
<span class="nc" id="L200">            r.sendResponse(ctx, msg, new CorfuMsg(CorfuMsgType.NACK));</span>
<span class="nc" id="L201">            return;</span>
        }

<span class="nc" id="L204">        boolean result = managementAgent.getReconfigurationEventHandler().handleFailure(</span>
                failureHandlerPolicy,
                layout,
<span class="nc" id="L207">                managementAgent.getCorfuRuntime(),</span>
<span class="nc" id="L208">                detectorMsg.getFailedNodes());</span>

<span class="nc bnc" id="L210" title="All 2 branches missed.">        if (result) {</span>
<span class="nc" id="L211">            r.sendResponse(ctx, msg, new CorfuMsg(CorfuMsgType.ACK));</span>
        } else {
<span class="nc" id="L213">            log.error(&quot;handleFailureDetectedMsg: failure handling unsuccessful.&quot;);</span>
<span class="nc" id="L214">            r.sendResponse(ctx, msg, new CorfuMsg(CorfuMsgType.NACK));</span>
        }
<span class="nc" id="L216">    }</span>

    /**
     * Triggers the healing handler.
     * The msg contains the healed nodes.
     *
     * @param msg corfu message containing MANAGEMENT_HEALING_DETECTED
     * @param ctx netty ChannelHandlerContext
     * @param r   server router
     */
    @ServerHandler(type = CorfuMsgType.MANAGEMENT_HEALING_DETECTED)
    public synchronized void handleHealingDetectedMsg(CorfuPayloadMsg&lt;DetectorMsg&gt; msg,
                                                      ChannelHandlerContext ctx, IServerRouter r) {

        // This server has not been bootstrapped yet, ignore all requests.
<span class="nc bnc" id="L231" title="All 2 branches missed.">        if (!checkBootstrap(msg, ctx, r)) {</span>
<span class="nc" id="L232">            r.sendResponse(ctx, msg, new CorfuMsg(CorfuMsgType.MANAGEMENT_NOBOOTSTRAP_ERROR));</span>
<span class="nc" id="L233">            return;</span>
        }

<span class="nc" id="L236">        log.info(&quot;handleHealingDetectedMsg: Received DetectorMsg : {}&quot;, msg.getPayload());</span>

<span class="nc" id="L238">        DetectorMsg detectorMsg = msg.getPayload();</span>
<span class="nc" id="L239">        Layout layout = new Layout(serverContext.getManagementLayout());</span>

        // If this message is stamped with an older epoch which indicates the polling was
        // conducted in an old epoch. This message cannot be considered and is discarded.
<span class="nc bnc" id="L243" title="All 2 branches missed.">        if (!detectorMsg.getDetectorEpoch().equals(layout.getEpoch())) {</span>
<span class="nc" id="L244">            log.error(&quot;handleHealingDetectedMsg: Discarding stale detector message received. &quot;</span>
                            + &quot;detectorEpoch:{} latestLayout epoch:{}&quot;,
<span class="nc" id="L246">                    detectorMsg.getDetectorEpoch(), layout.getEpoch());</span>
<span class="nc" id="L247">            r.sendResponse(ctx, msg, new CorfuMsg(CorfuMsgType.NACK));</span>
<span class="nc" id="L248">            return;</span>
        }

<span class="nc" id="L251">        final Duration retryWorkflowQueryTimeout = Duration.ofSeconds(1L);</span>
<span class="nc" id="L252">        boolean result = managementAgent.getReconfigurationEventHandler().handleHealing(</span>
                healingPolicy,
<span class="nc" id="L254">                managementAgent.getCorfuRuntime(),</span>
<span class="nc" id="L255">                detectorMsg.getHealedNodes(),</span>
                retryWorkflowQueryTimeout);

<span class="nc bnc" id="L258" title="All 2 branches missed.">        if (result) {</span>
<span class="nc" id="L259">            r.sendResponse(ctx, msg, new CorfuMsg(CorfuMsgType.ACK));</span>
        } else {
<span class="nc" id="L261">            log.error(&quot;handleHealingDetectedMsg: healing handling unsuccessful.&quot;);</span>
<span class="nc" id="L262">            r.sendResponse(ctx, msg, new CorfuMsg(CorfuMsgType.NACK));</span>
        }
<span class="nc" id="L264">    }</span>

    /**
     * Handles the heartbeat request.
     * It accumulates the metrics required to build
     * and send the response.
     * The response comprises of the local nodeMetrics and
     * this node's view of the cluster (NodeView).
     *
     * @param msg corfu message containing HEARTBEAT_REQUEST
     * @param ctx netty ChannelHandlerContext
     * @param r   server router
     */
    @ServerHandler(type = CorfuMsgType.HEARTBEAT_REQUEST)
    public void handleHeartbeatRequest(CorfuMsg msg, ChannelHandlerContext ctx, IServerRouter r) {
<span class="nc" id="L279">        ServerMetrics localServerMetrics = getManagementAgent().getLocalServerMetrics();</span>
<span class="nc" id="L280">        NodeView.NodeViewBuilder nodeViewBuilder = NodeView.builder()</span>
<span class="nc" id="L281">                .endpoint(NodeLocator.parseString(getLocalEndpoint()))</span>
                // Fetch the node's view of the cluster.
<span class="nc" id="L283">                .networkMetrics(managementAgent.getConnectivityView());</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">        if (localServerMetrics != null) {</span>
<span class="nc" id="L285">            nodeViewBuilder.serverMetrics(getManagementAgent().getLocalServerMetrics());</span>
        }
<span class="nc" id="L287">        r.sendResponse(ctx, msg, CorfuMsgType.HEARTBEAT_RESPONSE</span>
<span class="nc" id="L288">                .payloadMsg(nodeViewBuilder.build()));</span>
<span class="nc" id="L289">    }</span>

    /**
     * Management Server shutdown:
     * Shuts down the fault detector service.
     */
    public void shutdown() {
<span class="nc" id="L296">        super.shutdown();</span>
<span class="nc" id="L297">        orchestrator.shutdown();</span>
<span class="nc" id="L298">        managementAgent.shutdown();</span>

        // Shut down the Corfu Runtime.
<span class="nc" id="L301">        corfuRuntime.cleanup(CorfuRuntime::shutdown);</span>
<span class="nc" id="L302">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>