<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>BaseHandler.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">generator</a> &gt; <a href="../index.html" class="el_bundle">runtime</a> &gt; <a href="index.source.html" class="el_package">org.corfudb.runtime.clients</a> &gt; <span class="el_source">BaseHandler.java</span></div><h1>BaseHandler.java</h1><pre class="source lang-java linenums">package org.corfudb.runtime.clients;

import io.netty.channel.ChannelHandlerContext;

import java.lang.invoke.MethodHandles;

import lombok.Getter;
import lombok.Setter;
import lombok.extern.slf4j.Slf4j;

import org.corfudb.protocols.wireprotocol.CorfuMsg;
import org.corfudb.protocols.wireprotocol.CorfuMsgType;
import org.corfudb.protocols.wireprotocol.CorfuPayloadMsg;
import org.corfudb.protocols.wireprotocol.ExceptionMsg;
import org.corfudb.protocols.wireprotocol.JSONPayloadMsg;
import org.corfudb.protocols.wireprotocol.VersionInfo;
import org.corfudb.runtime.exceptions.ServerNotReadyException;
import org.corfudb.runtime.exceptions.ShutdownException;
import org.corfudb.runtime.exceptions.WrongEpochException;

/**
 * This is a base client which handles basic Corfu messages such as PING, ACK.
 * This is also responsible for handling unknown server exceptions.
 *
 * &lt;p&gt;Created by zlokhandwala on 2/20/18.
 */
<span class="nc" id="L27">@Slf4j</span>
<span class="nc" id="L28">public class BaseHandler implements IClient {</span>

    /**
     * The router to use for the client.
     */
<span class="nc" id="L33">    @Getter</span>
<span class="nc" id="L34">    @Setter</span>
    public IClientRouter router;

    /** Public functions which are exposed to clients. */

    /**
     * The handler and handlers which implement this client.
     */
<span class="nc" id="L42">    @Getter</span>
    public ClientMsgHandler msgHandler = new ClientMsgHandler(this)
<span class="nc" id="L44">            .generateHandlers(MethodHandles.lookup(), this);</span>

    /**
     * Handle a ping request from the server.
     *
     * @param msg The ping request message
     * @param ctx The context the message was sent under
     * @param r   A reference to the router
     * @return The return value, null since this is a message from the server.
     */
    @ClientHandler(type = CorfuMsgType.PING)
    private static Object handlePing(CorfuMsg msg, ChannelHandlerContext ctx, IClientRouter r) {
<span class="nc" id="L56">        r.sendResponseToServer(ctx, msg, new CorfuMsg(CorfuMsgType.PONG));</span>
<span class="nc" id="L57">        return null;</span>
    }

    /**
     * Handle a pong response from the server.
     *
     * @param msg The ping request message
     * @param ctx The context the message was sent under
     * @param r   A reference to the router
     * @return Always True, since the ping message was successful.
     */
    @ClientHandler(type = CorfuMsgType.PONG)
    private static Object handlePong(CorfuMsg msg, ChannelHandlerContext ctx, IClientRouter r) {
<span class="nc" id="L70">        return true;</span>
    }

    /**
     * Handle an ACK response from the server.
     *
     * @param msg The ping request message
     * @param ctx The context the message was sent under
     * @param r   A reference to the router
     * @return Always True, since the ACK message was successful.
     */
    @ClientHandler(type = CorfuMsgType.ACK)
    private static Object handleAck(CorfuMsg msg, ChannelHandlerContext ctx, IClientRouter r) {
<span class="nc" id="L83">        return true;</span>
    }

    /**
     * Handle a NACK response from the server.
     *
     * @param msg The ping request message
     * @param ctx The context the message was sent under
     * @param r   A reference to the router
     * @return Always True, since the ACK message was successful.
     */
    @ClientHandler(type = CorfuMsgType.NACK)
    private static Object handleNack(CorfuMsg msg, ChannelHandlerContext ctx, IClientRouter r) {
<span class="nc" id="L96">        return false;</span>
    }

    /**
     * Handle a WRONG_EPOCH response from the server.
     *
     * @param msg The wrong epoch message
     * @param ctx The context the message was sent under
     * @param r   A reference to the router
     * @return none, throw a wrong epoch exception instead.
     */
    @ClientHandler(type = CorfuMsgType.WRONG_EPOCH)
    private static Object handleWrongEpoch(CorfuPayloadMsg&lt;Long&gt; msg, ChannelHandlerContext ctx,
                                           IClientRouter r) {
<span class="nc" id="L110">        throw new WrongEpochException(msg.getPayload());</span>
    }

    /**
     * Handle a Version response from the server.
     *
     * @param msg The version message
     * @param ctx The context the message was sent under
     * @param r   A reference to the router
     * @return The versioninfo object.
     */
    @ClientHandler(type = CorfuMsgType.VERSION_RESPONSE)
    private static Object handleVersionResponse(JSONPayloadMsg&lt;VersionInfo&gt; msg,
                                                ChannelHandlerContext ctx, IClientRouter r) {
<span class="nc" id="L124">        return msg.getPayload();</span>
    }

    @ClientHandler(type = CorfuMsgType.NOT_READY)
    private static Object handleNotReady(CorfuMsg msg, ChannelHandlerContext ctx, IClientRouter r) {
<span class="nc" id="L129">        throw new ServerNotReadyException();</span>
    }

    /**
     * Generic handler for a server exception.
     */
    @ClientHandler(type = CorfuMsgType.ERROR_SERVER_EXCEPTION)
    private static Object handleServerException(CorfuPayloadMsg&lt;ExceptionMsg&gt; msg,
                                                ChannelHandlerContext ctx, IClientRouter r)
            throws Throwable {
<span class="nc" id="L139">        log.warn(&quot;Server threw exception for request {}&quot;, msg.getRequestID(),</span>
<span class="nc" id="L140">                msg.getPayload().getThrowable());</span>
<span class="nc" id="L141">        throw msg.getPayload().getThrowable();</span>
    }

    /**
     * Handle a ERROR_SHUTDOWN_EXCEPTION response from the server.
     *
     * @param msg The shutdown exception message
     * @param ctx The context the message was sent under
     * @param r   A reference to the router
     * @return none, throw a shutdown exception instead.
     */
    @ClientHandler(type = CorfuMsgType.ERROR_SHUTDOWN_EXCEPTION)
    private static Object handleShutdownException(CorfuMsg msg, ChannelHandlerContext ctx,
                                                  IClientRouter r) {
<span class="nc" id="L155">        throw new ShutdownException();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>