<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MongoConfig.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Eclipse Ditto :: Services :: Utils :: Config Utils</a> &gt; <a href="index.source.html" class="el_package">org.eclipse.ditto.services.utils.config</a> &gt; <span class="el_source">MongoConfig.java</span></div><h1>MongoConfig.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2017 Bosch Software Innovations GmbH.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v2.0
 * which accompanies this distribution, and is available at
 * https://www.eclipse.org/org/documents/epl-2.0/index.php
 *
 * Contributors:
 *    Bosch Software Innovations GmbH - initial contribution
 */
package org.eclipse.ditto.services.utils.config;

import java.net.URI;
import java.net.URISyntaxException;
import java.net.URLEncoder;
import java.time.Duration;
import java.util.Arrays;
import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.Map;
import java.util.stream.Collectors;

import com.typesafe.config.Config;
import com.typesafe.config.ConfigFactory;

/**
 * Constructs MongoDB URL from a source URL and configuration settings.
 */
public final class MongoConfig {

    private static final String PREFIX = &quot;ditto.services-utils-config.mongodb&quot;;

    private static final String POOL_PREFIX = PREFIX + &quot;.pool&quot;;

    /**
     * Config key of source MongoDB URI.
     */
    public static final String URI = PREFIX + &quot;.uri&quot;;

    /**
     * Config key of connection string options.
     */
    public static final String OPTIONS = PREFIX + &quot;.options&quot;;

    /**
     * Config key of maximum query duration. It is up to the Mongo client to respect it.
     */
    public static final String MAX_QUERY_TIME = PREFIX + &quot;.maxQueryTime&quot;;

    /**
     * Config key of maximum number of connections allowed.
     */
    public static final String POOL_MAX_SIZE = POOL_PREFIX + &quot;.maxSize&quot;;

    /**
     * Maximum number of waiters for a connection to become available from the pool.
     */
    public static final String POOL_MAX_WAIT_QUEUE_SIZE = POOL_PREFIX + &quot;.maxWaitQueueSize&quot;;

    /**
     * Maximum number of seconds a thread waits for a connection to become available.
     */
    public static final String POOL_MAX_WAIT_TIME = POOL_PREFIX + &quot;.maxWaitTimeSecs&quot;;

    /**
     * Whether a jmx connection pool listener should be added.
     */
    public static final String POOL_JMX_LISTENER_ENABLED = POOL_PREFIX + &quot;.jmxListenerEnabled&quot;;

    /**
     * Fallback client configuration.
     */
    private static final Config fallbackMongoConfig;

    /* Fallback configuration values. */
    static {
<span class="fc" id="L78">        final Map&lt;String, Object&gt; fallbackMap = new HashMap&lt;&gt;();</span>
<span class="fc" id="L79">        fallbackMap.put(POOL_MAX_SIZE, 100);</span>
<span class="fc" id="L80">        fallbackMap.put(POOL_MAX_WAIT_QUEUE_SIZE, 100);</span>
<span class="fc" id="L81">        fallbackMap.put(POOL_MAX_WAIT_TIME, Duration.ofSeconds(30));</span>
<span class="fc" id="L82">        fallbackMap.put(POOL_JMX_LISTENER_ENABLED, false);</span>
<span class="fc" id="L83">        fallbackMap.put(MAX_QUERY_TIME, Duration.ofSeconds(60));</span>
<span class="fc" id="L84">        fallbackMongoConfig = ConfigFactory.parseMap(fallbackMap);</span>
<span class="fc" id="L85">    }</span>

    private MongoConfig() {}

    /**
     * Retrieve maximum query duration.
     *
     * @param config The configuration.
     * @return The maximum query duration.
     */
    public static Duration getMaxQueryTime(final Config config) {
<span class="nc" id="L96">        return config.withFallback(fallbackMongoConfig).getDuration(MAX_QUERY_TIME);</span>
    }

    /**
     * Retrieve the maximum number of connections in the connection pool.
     *
     * @param config The configuration.
     * @return The maximum number of connections.
     */
    public static int getPoolMaxSize(final Config config) {
<span class="nc" id="L106">        return config.withFallback(fallbackMongoConfig).getInt(POOL_MAX_SIZE);</span>
    }

    /**
     * Retrieve the maximum number of threads waiting for a connection to become available.
     *
     * @param config The configuration.
     * @return The maximum number of waiting threads.
     */
    public static int getPoolMaxWaitQueueSize(final Config config) {
<span class="nc" id="L116">        return config.withFallback(fallbackMongoConfig).getInt(POOL_MAX_WAIT_QUEUE_SIZE);</span>
    }

    /**
     * Retrieve the maximum time to wait for a connection to become available.
     *
     * @param config The configuration.
     * @return The maximum wait time.
     */
    public static Duration getPoolMaxWaitTime(final Config config) {
<span class="nc" id="L126">        return config.withFallback(fallbackMongoConfig).getDuration(POOL_MAX_WAIT_TIME);</span>
    }

    /**
     * Whether a JMX {@code ConnectionPoolListener} should be added.
     *
     * @param config The configuration.
     * @return whether the JMXConnectionPoolListener should be added.
     */
    public static boolean getJmxListenerEnabled(final Config config) {
<span class="nc" id="L136">        return config.withFallback(fallbackMongoConfig).getBoolean(POOL_JMX_LISTENER_ENABLED);</span>
    }

    /**
     * Computes MongoDB URI from configured source URI and MongoDB settings.
     *
     * @param config Config object containing source URI and MongoDB settings.
     * @return URI adapted from source URI with parameters set according to MongoDB settings.
     */
    public static String getMongoUri(final Config config) {
        try {
<span class="fc" id="L147">            final URI sourceUri = new URI(config.getString(URI));</span>
<span class="fc" id="L148">            final LinkedHashMap&lt;String, String&gt; query = parseQuery(sourceUri.getQuery());</span>

            // set connection string options
<span class="fc bfc" id="L151" title="All 2 branches covered.">            final Config options = config.hasPath(OPTIONS) ? config.getConfig(OPTIONS) : ConfigFactory.empty();</span>
<span class="fc" id="L152">            options.entrySet().forEach(</span>
                    // null values are not present in the entry set, the values of those parameters are unchanged.
<span class="fc" id="L154">                    entry -&gt; query.put(entry.getKey(), entry.getValue().unwrapped().toString()));</span>

<span class="fc" id="L156">            final String targetQueryString = unparseQuery(query);</span>
<span class="fc" id="L157">            final URI targetUri =</span>
<span class="fc" id="L158">                    new URI(sourceUri.getScheme(), sourceUri.getAuthority(), sourceUri.getPath(),</span>
<span class="fc bfc" id="L159" title="All 2 branches covered.">                            targetQueryString.isEmpty() ? null : targetQueryString, sourceUri.getFragment());</span>

<span class="fc" id="L161">            return targetUri.toASCIIString();</span>
<span class="nc" id="L162">        } catch (final URISyntaxException e) {</span>
            // Mongo URI is misconfigured. There is nothing we can do beside making the caller crash.
<span class="nc" id="L164">            throw new IllegalArgumentException(e);</span>
        }
    }

    /**
     * Tests whether Mongo URI is defined in configuration.
     *
     * @param config The configuration object.
     * @return Whether Mongo URI is defined.
     */
    public static boolean isUriDefined(final Config config) {
<span class="nc" id="L175">        return config.hasPath(URI);</span>
    }

    /**
     * Parses URI query string into a map between strings such that the ordering of the query parameters is preserved.
     *
     * @param queryString the query string.
     * @return A map object mapping parameter names to parameter values, the iteration order of whose map entries is the
     * order the parameters are listed in the query string. The return type is {@code LinkedHashMap} to signify the
     * order guarantee.
     */
    static LinkedHashMap&lt;String, String&gt; parseQuery(final String queryString) {
<span class="fc" id="L187">        final LinkedHashMap&lt;String, String&gt; params = new LinkedHashMap&lt;&gt;();</span>
<span class="fc bfc" id="L188" title="All 2 branches covered.">        if (queryString != null) {</span>
<span class="fc" id="L189">            Arrays.stream(queryString.split(&quot;&amp;&quot;)).forEach(paramDefinition -&gt; {</span>
<span class="fc" id="L190">                final int i = paramDefinition.indexOf(&quot;=&quot;);</span>
<span class="pc bpc" id="L191" title="1 of 2 branches missed.">                if (i &gt;= 0) {</span>
<span class="fc" id="L192">                    final String paramName = paramDefinition.substring(0, i);</span>
<span class="fc" id="L193">                    final String paramValue = paramDefinition.substring(i + 1);</span>
<span class="fc" id="L194">                    params.put(paramName, paramValue);</span>
                }
<span class="fc" id="L196">            });</span>
        }
<span class="fc" id="L198">        return params;</span>
    }

    private static String unparseQuery(final LinkedHashMap&lt;String, String&gt; query) {
<span class="fc" id="L202">        return query.entrySet().stream().map(entry -&gt; {</span>
            // using deprecated URL encode method because the recommended method throws UnsupportedEncodingException
<span class="fc" id="L204">            final String parameterName = URLEncoder.encode(entry.getKey());</span>
<span class="fc" id="L205">            final String parameterValue = URLEncoder.encode(entry.getValue());</span>
<span class="fc" id="L206">            return String.format(&quot;%s=%s&quot;, parameterName, parameterValue);</span>
<span class="fc" id="L207">        }).collect(Collectors.joining(&quot;&amp;&quot;));</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.0.201801022044</span></div></body></html>