<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ComparableCache.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Eclipse Ditto :: Services :: Utils :: Persistence Utils</a> &gt; <a href="index.source.html" class="el_package">org.eclipse.ditto.services.utils.persistence.mongo</a> &gt; <span class="el_source">ComparableCache.java</span></div><h1>ComparableCache.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2017 Bosch Software Innovations GmbH.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v2.0
 * which accompanies this distribution, and is available at
 * https://www.eclipse.org/org/documents/epl-2.0/index.php
 *
 * Contributors:
 *    Bosch Software Innovations GmbH - initial contribution
 */
package org.eclipse.ditto.services.utils.persistence.mongo;

import static java.util.Objects.requireNonNull;

import java.util.Map;
import java.util.concurrent.ConcurrentMap;
import java.util.concurrent.atomic.AtomicBoolean;

import javax.annotation.Nullable;

import org.eclipse.ditto.services.utils.cache.CaffeineCache;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.codahale.metrics.MetricRegistry;
import com.github.benmanes.caffeine.cache.Caffeine;

/**
 * Cache implementation for {@link Comparable} values which performs updates only when a value is new or greater than
 * the existing one.
 *
 * @param &lt;K&gt; the type of keys maintained by this cache
 * @param &lt;V&gt; the type of mapped values, has to extend {@link Comparable}
 */
final class ComparableCache&lt;K, V extends Comparable&lt;V&gt;&gt; {

<span class="fc" id="L38">    private static final Logger LOGGER = LoggerFactory.getLogger(ComparableCache.class);</span>

    private final ConcurrentMap&lt;K, V&gt; internalCache;

    /**
     * Constructor.
     *
     * @param size the (maximum) size of this cache
     */
    public ComparableCache(final int size) {
<span class="fc" id="L48">        this(size, null);</span>
<span class="fc" id="L49">    }</span>

    /**
     * Constructor.
     *
     * @param size the (maximum) size of this cache
     * @param namedMetricRegistry the named {@link MetricRegistry} for cache statistics.
     */
<span class="fc" id="L57">    public ComparableCache(final int size, @Nullable final Map.Entry&lt;String, MetricRegistry&gt; namedMetricRegistry) {</span>
<span class="fc" id="L58">        final Caffeine&lt;Object, Object&gt; caffeine = Caffeine.newBuilder().maximumSize(size);</span>

<span class="fc" id="L60">        final CaffeineCache&lt;K, V&gt; caffeineCache = CaffeineCache.of(caffeine, namedMetricRegistry);</span>
<span class="fc" id="L61">        this.internalCache = caffeineCache.asMap();</span>
<span class="fc" id="L62">    }</span>

    /**
     * Returns the value which is associated with the specified key.
     *
     * @param key the key to get the associated value for.
     * @return the value which is associated with the specified key or {@code null}.
     * @throws NullPointerException if {@code key} is {@code null}.
     */
    @Nullable
    public V get(final K key) {
<span class="fc" id="L73">        requireNonNull(key);</span>

<span class="fc" id="L75">        return internalCache.get(key);</span>
    }

    /**
     * Associates the specified value with the specified key, if it is new or greater than the existing value.
     *
     * @param key the key to be associated with {@code newValue}.
     * @param newValue the newValue to be associated with {@code key}.
     * @return {@code true}, if a value for {@code key} did not yet exist or {@code newValue} is greater than the
     * existing value.
     * @throws NullPointerException if {@code key} or {@code newValue} is {@code null}.
     */
    public boolean updateIfNewOrGreater(final K key, final V newValue) {
<span class="fc" id="L88">        requireNonNull(key);</span>
<span class="fc" id="L89">        requireNonNull(newValue);</span>

<span class="fc" id="L91">        final AtomicBoolean updated = new AtomicBoolean(false);</span>

<span class="fc" id="L93">        internalCache.compute(key, (k, existingValue) -&gt; {</span>
<span class="fc bfc" id="L94" title="All 4 branches covered.">            if (existingValue == null || newValue.compareTo(existingValue) &gt; 0) {</span>
<span class="fc" id="L95">                updated.set(true);</span>
<span class="fc" id="L96">                return newValue;</span>
            }

<span class="fc" id="L99">            return existingValue;</span>
        });

<span class="fc" id="L102">        final boolean result = updated.get();</span>
<span class="fc" id="L103">        LOGGER.debug(&quot;Cache update with key &lt;{}&gt; and value &lt;{}&gt; returned: &lt;{}&gt;&quot;, key, newValue, result);</span>
<span class="fc" id="L104">        return result;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.0.201801022044</span></div></body></html>