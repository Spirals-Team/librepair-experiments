<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ThingSearchRoute.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Eclipse Ditto :: Services :: Gateway :: Endpoints</a> &gt; <a href="index.source.html" class="el_package">org.eclipse.ditto.services.gateway.endpoints.routes.thingsearch</a> &gt; <span class="el_source">ThingSearchRoute.java</span></div><h1>ThingSearchRoute.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2017 Bosch Software Innovations GmbH.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v2.0
 * which accompanies this distribution, and is available at
 * https://www.eclipse.org/org/documents/epl-2.0/index.php
 *
 * Contributors:
 *    Bosch Software Innovations GmbH - initial contribution
 */
package org.eclipse.ditto.services.gateway.endpoints.routes.thingsearch;

import static akka.http.javadsl.server.Directives.get;
import static akka.http.javadsl.server.Directives.parameterOptional;
import static akka.http.javadsl.server.Directives.path;
import static akka.http.javadsl.server.Directives.pathEndOrSingleSlash;

import java.util.Arrays;
import java.util.List;
import java.util.Optional;
import java.util.Set;
import java.util.function.Function;
import java.util.stream.Collectors;

import org.eclipse.ditto.model.base.headers.DittoHeaders;
import org.eclipse.ditto.services.gateway.endpoints.directives.CustomPathMatchers;
import org.eclipse.ditto.services.gateway.endpoints.routes.AbstractRoute;
import org.eclipse.ditto.signals.commands.thingsearch.query.CountThings;
import org.eclipse.ditto.signals.commands.thingsearch.query.QueryThings;

import akka.actor.ActorRef;
import akka.actor.ActorSystem;
import akka.http.javadsl.server.Directives;
import akka.http.javadsl.server.RequestContext;
import akka.http.javadsl.server.Route;

/**
 * Builder for creating Akka HTTP routes for {@code /search/things}.
 */
public final class ThingSearchRoute extends AbstractRoute {

    public static final String PATH_SEARCH = &quot;search&quot;;
    public static final String PATH_THINGS = &quot;things&quot;;

    private static final String PATH_COUNT = &quot;count&quot;;

    /**
     * Constructs the {@code /search/things} route builder.
     *
     * @param proxyActor an actor selection of the command delegating actor.
     * @param actorSystem the ActorSystem to use.
     * @throws NullPointerException if any argument is {@code null}.
     */
    public ThingSearchRoute(final ActorRef proxyActor, final ActorSystem actorSystem) {
<span class="fc" id="L56">        super(proxyActor, actorSystem);</span>
<span class="fc" id="L57">    }</span>

    /**
     * Builds the {@code /search} route.
     *
     * @return the {@code /search}} route.
     */
    public Route buildSearchRoute(final RequestContext ctx, final DittoHeaders dittoHeaders) {
<span class="fc" id="L65">        return Directives.rawPathPrefix(CustomPathMatchers.mergeDoubleSlashes().concat(PATH_SEARCH), () -&gt;</span>
<span class="fc" id="L66">                Directives.rawPathPrefix(CustomPathMatchers.mergeDoubleSlashes().concat(PATH_THINGS),</span>
                        () -&gt; // /search/things
<span class="fc" id="L68">                                Directives.route(</span>
                                        // /search/things/count
<span class="pc" id="L70">                                        path(PATH_COUNT, () -&gt; countThings(ctx, dittoHeaders)),</span>
                                        // /search/things
<span class="fc" id="L72">                                        pathEndOrSingleSlash(() -&gt; searchThings(ctx, dittoHeaders))</span>
                                )
                )
        );
    }

    /*
     * Describes {@code /search/things/count} route.
     *
     * @return {@code /search/things/count} route.
     */
    private Route countThings(final RequestContext ctx, final DittoHeaders dittoHeaders) {
<span class="nc" id="L84">        return get(() -&gt; // GET things/count?filter=&lt;filterString&gt;&amp;namespaces=&lt;namespacesString&gt;</span>
<span class="nc" id="L85">                parameterOptional(ThingSearchParameter.FILTER.toString(), filterString -&gt;</span>
<span class="nc" id="L86">                        parameterOptional(ThingSearchParameter.NAMESPACES.toString(), namespacesString -&gt;</span>
<span class="nc" id="L87">                                handlePerRequest(ctx, CountThings.of(calculateFilter(filterString),</span>
<span class="nc" id="L88">                                        calculateNamespaces(namespacesString), dittoHeaders))</span>
                        )
                )
        );
    }

    /*
     * Describes {@code /search/things} route.
     *
     * @return {@code /search/things} route.
     */
    private Route searchThings(final RequestContext ctx, final DittoHeaders dittoHeaders) {
<span class="fc" id="L100">        return get(</span>
                () -&gt; // GET things?filter=&lt;filterString&gt;&amp;options=&lt;optionsString&gt;&amp;fields=&lt;fieldsString&gt;&amp;namespaces=&lt;namespacesString&gt;
<span class="fc" id="L102">                        parameterOptional(ThingSearchParameter.FILTER.toString(), filterString -&gt;</span>
<span class="fc" id="L103">                                parameterOptional(ThingSearchParameter.NAMESPACES.toString(), namespacesString -&gt;</span>
<span class="fc" id="L104">                                        parameterOptional(ThingSearchParameter.OPTION.toString(), optionsString -&gt;</span>
<span class="fc" id="L105">                                                parameterOptional(ThingSearchParameter.FIELDS.toString(),</span>
<span class="fc" id="L106">                                                        fieldsString -&gt; handlePerRequest(ctx,</span>
<span class="fc" id="L107">                                                                QueryThings.of(calculateFilter(filterString),</span>
<span class="fc" id="L108">                                                                        calculateOptions(optionsString),</span>
<span class="fc" id="L109">                                                                        AbstractRoute.calculateSelectedFields(</span>
                                                                                fieldsString)
<span class="fc" id="L111">                                                                                .orElse(null),</span>
<span class="fc" id="L112">                                                                        calculateNamespaces(namespacesString),</span>
                                                                        dittoHeaders))
                                                )
                                        )
                                )
                        )
        );
    }

    @SuppressWarnings(&quot;OptionalUsedAsFieldOrParameterType&quot;)
    private static String calculateFilter(final Optional&lt;String&gt; filterString) {
<span class="fc" id="L123">        return filterString.orElse(null);</span>
    }

    @SuppressWarnings(&quot;OptionalUsedAsFieldOrParameterType&quot;)
    private static Set&lt;String&gt; calculateNamespaces(final Optional&lt;String&gt; namespacesString) {

<span class="fc" id="L129">        final Function&lt;String, Set&lt;String&gt;&gt; splitAndRemoveEmpty =</span>
<span class="nc" id="L130">                s -&gt; Arrays.stream(s.split(&quot;,&quot;))</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">                        .filter(segment -&gt; !segment.isEmpty())</span>
<span class="nc" id="L132">                        .collect(Collectors.toSet());</span>

        // if no namespaces are given explicitly via query parameter,
        // return null to signify the lack of namespace restriction
<span class="fc" id="L136">        final Set&lt;String&gt; defaultNamespaces = null;</span>

<span class="fc" id="L138">        return namespacesString.map(splitAndRemoveEmpty).orElse(defaultNamespaces);</span>
    }

    @SuppressWarnings(&quot;OptionalUsedAsFieldOrParameterType&quot;)
    private static List&lt;String&gt; calculateOptions(final Optional&lt;String&gt; optionsString) {
<span class="fc" id="L143">        return optionsString</span>
<span class="pc" id="L144">                .map(s -&gt; Arrays.asList(s.split(&quot;,&quot;)))</span>
<span class="fc" id="L145">                .orElse(null);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.0.201801022044</span></div></body></html>