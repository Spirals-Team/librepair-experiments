<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MailSettingsImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">settings</a> &gt; <a href="index.source.html" class="el_package">org.molgenis.settings.mail</a> &gt; <span class="el_source">MailSettingsImpl.java</span></div><h1>MailSettingsImpl.java</h1><pre class="source lang-java linenums">package org.molgenis.settings.mail;

import org.molgenis.data.Entity;
import org.molgenis.data.Sort;
import org.molgenis.data.meta.AttributeType;
import org.molgenis.data.meta.SystemEntityType;
import org.molgenis.data.meta.model.Attribute;
import org.molgenis.settings.DefaultSettingsEntity;
import org.molgenis.settings.DefaultSettingsEntityType;
import org.molgenis.util.mail.MailSettings;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.DependsOn;
import org.springframework.stereotype.Component;

import javax.annotation.Nullable;
import java.nio.charset.Charset;
import java.util.Collections;
import java.util.Objects;
import java.util.Properties;
import java.util.Set;

import static java.util.stream.Collectors.toMap;
import static java.util.stream.StreamSupport.stream;
import static org.molgenis.data.meta.AttributeType.BOOL;
import static org.molgenis.data.meta.model.Package.PACKAGE_SEPARATOR;
import static org.molgenis.settings.PropertyType.KEY;
import static org.molgenis.settings.SettingsPackage.PACKAGE_SETTINGS;
import static org.molgenis.settings.mail.JavaMailPropertyType.JAVA_MAIL_PROPERTY;
import static org.molgenis.settings.mail.JavaMailPropertyType.MAIL_SETTINGS_REF;

@Component
public class MailSettingsImpl extends DefaultSettingsEntity implements MailSettings
{
	private static final long serialVersionUID = 1L;
	private static final String ID = &quot;MailSettings&quot;;

	public MailSettingsImpl(Entity entity)
	{
<span class="fc" id="L39">		super(ID);</span>
<span class="fc" id="L40">		set(entity);</span>
<span class="fc" id="L41">	}</span>

	public MailSettingsImpl()
	{
<span class="nc" id="L45">		super(ID);</span>
<span class="nc" id="L46">	}</span>

	// workaround for dependency error running platform integration tests on build server
	@DependsOn(value = &quot;org.molgenis.settings.mail.JavaMailPropertyType&quot;)
	@Component
	public static class Meta extends DefaultSettingsEntityType
	{
		@SuppressWarnings(&quot;unused&quot;)
		public static final String MAIL_SETTINGS = PACKAGE_SETTINGS + PACKAGE_SEPARATOR + ID;
		/**
		 * For conversion: Pick up defaults from molgenis-server.properties file where these settings used to be defined.
		 */
		@Value(&quot;${mail.host:smtp.gmail.com}&quot;)
		private String mailHost;
		@Value(&quot;${mail.port:587}&quot;)
		private String mailPort;
		@Value(&quot;${mail.protocol:smtp}&quot;)
		private String mailProtocol;
		@Value(&quot;${mail.username:#{null}}&quot;)
		private String mailUsername;
		@Value(&quot;${mail.password:#{null}}&quot;)
		private String mailPassword;
		@Value(&quot;${mail.java.auth:true}&quot;)
		private String mailJavaAuth;
		@Value(&quot;${mail.java.starttls.enable:true}&quot;)
		private String mailJavaStartTlsEnable;
		@Value(&quot;${mail.java.quitwait:false}&quot;)
		private String mailJavaQuitWait;

		public static final String HOST = &quot;host&quot;;
		public static final String PORT = &quot;port&quot;;
		public static final String PROTOCOL = &quot;protocol&quot;;
		public static final String USERNAME = &quot;username&quot;;
		public static final String PASSWORD = &quot;password&quot;;
		public static final String DEFAULT_ENCODING = &quot;defaultEncoding&quot;;
		public static final String JAVA_MAIL_PROPS = &quot;props&quot;;
		public static final String TEST_CONNECTION = &quot;testConnection&quot;;
		private JavaMailPropertyType mailSenderPropertyType;

		public Meta(JavaMailPropertyType mailSenderPropertyType)
		{
<span class="nc" id="L87">			super(ID);</span>
<span class="nc" id="L88">			this.mailSenderPropertyType = Objects.requireNonNull(mailSenderPropertyType);</span>
<span class="nc" id="L89">		}</span>

		@Override
		public void init()
		{
<span class="nc" id="L94">			super.init();</span>
<span class="nc" id="L95">			setLabel(&quot;Mail settings&quot;);</span>
<span class="nc" id="L96">			setDescription(</span>
					&quot;Configuration properties for email support. Will be used to send email from Molgenis. See also the MailSenderProp entity.&quot;);
<span class="nc" id="L98">			addAttribute(HOST).setDefaultValue(mailHost).setNillable(false).setDescription(&quot;SMTP server host.&quot;);</span>
<span class="nc" id="L99">			addAttribute(PORT).setDataType(AttributeType.INT)</span>
<span class="nc" id="L100">							  .setDefaultValue(mailPort)</span>
<span class="nc" id="L101">							  .setNillable(false)</span>
<span class="nc" id="L102">							  .setDescription(&quot;SMTP server port.&quot;);</span>
<span class="nc" id="L103">			addAttribute(PROTOCOL).setDefaultValue(mailProtocol)</span>
<span class="nc" id="L104">								  .setNillable(false)</span>
<span class="nc" id="L105">								  .setDescription(&quot;Protocol used by the SMTP server.&quot;);</span>
<span class="nc" id="L106">			addAttribute(USERNAME).setDefaultValue(mailUsername).setDescription(&quot;Login user of the SMTP server.&quot;);</span>
<span class="nc" id="L107">			addAttribute(PASSWORD).setDefaultValue(mailPassword).setDescription(&quot;Login password of the SMTP server.&quot;);</span>
<span class="nc" id="L108">			addAttribute(DEFAULT_ENCODING).setDefaultValue(&quot;UTF-8&quot;)</span>
<span class="nc" id="L109">										  .setNillable(false)</span>
<span class="nc" id="L110">										  .setDescription(&quot;Default MimeMessage encoding.&quot;);</span>
<span class="nc" id="L111">			Attribute refAttr = mailSenderPropertyType.getAttribute(MAIL_SETTINGS_REF);</span>
<span class="nc" id="L112">			addAttribute(JAVA_MAIL_PROPS).setDataType(AttributeType.ONE_TO_MANY)</span>
<span class="nc" id="L113">										 .setRefEntity(mailSenderPropertyType)</span>
<span class="nc" id="L114">										 .setMappedBy(refAttr)</span>
<span class="nc" id="L115">										 .setOrderBy(new Sort(KEY))</span>
<span class="nc" id="L116">										 .setNillable(true)</span>
<span class="nc" id="L117">										 .setLabel(&quot;Properties&quot;)</span>
<span class="nc" id="L118">										 .setDescription(</span>
												 &quot;JavaMail properties. The default values are tuned to connect with Google mail.&quot;
														 + &quot;If you want to connect to a different provider, these properties should be edited in the Data Explorer.&quot;
														 + &quot;Select the &quot; + JAVA_MAIL_PROPERTY + &quot; entity.&quot;);
<span class="nc" id="L122">			addAttribute(TEST_CONNECTION).setDataType(BOOL).setDefaultValue(&quot;true&quot;).setNillable(false).</span>
<span class="nc" id="L123">					setDescription(&quot;Indicates if the connection should be tested when saving these settings.&quot;);</span>
<span class="nc" id="L124">		}</span>

		@Override
		public Set&lt;SystemEntityType&gt; getDependencies()
		{
<span class="nc" id="L129">			return Collections.singleton(mailSenderPropertyType);</span>
		}
	}

	@Override
	public String getHost()
	{
<span class="nc" id="L136">		return getString(Meta.HOST);</span>
	}

	@Override
	public int getPort()
	{
<span class="nc" id="L142">		return getInt(Meta.PORT);</span>
	}

	@Override
	public String getProtocol()
	{
<span class="nc" id="L148">		return getString(Meta.PROTOCOL);</span>
	}

	@Override
	@Nullable
	public String getUsername()
	{
<span class="fc" id="L155">		return getString(Meta.USERNAME);</span>
	}

	@Override
	@Nullable
	public String getPassword()
	{
<span class="fc" id="L162">		return getString(Meta.PASSWORD);</span>
	}

	@Override
	public Charset getDefaultEncoding()
	{
<span class="nc" id="L168">		return Charset.forName(getString(Meta.DEFAULT_ENCODING));</span>
	}

	@Override
	public Properties getJavaMailProperties()
	{
<span class="nc" id="L174">		Properties result = new Properties();</span>
<span class="nc" id="L175">		result.putAll(stream(getEntities(Meta.JAVA_MAIL_PROPS, JavaMailProperty.class).spliterator(), false).collect(</span>
<span class="nc" id="L176">				toMap(JavaMailProperty::getKey, JavaMailProperty::getValue)));</span>
<span class="nc" id="L177">		return result;</span>
	}

	@Override
	public boolean isTestConnection()
	{
<span class="fc" id="L183">		return getBoolean(Meta.TEST_CONNECTION);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>