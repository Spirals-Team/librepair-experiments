<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ImmutableJsonFieldSelectorBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Eclipse Ditto :: JSON</a> &gt; <a href="index.source.html" class="el_package">org.eclipse.ditto.json</a> &gt; <span class="el_source">ImmutableJsonFieldSelectorBuilder.java</span></div><h1>ImmutableJsonFieldSelectorBuilder.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2017 Bosch Software Innovations GmbH.
 *
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v2.0
 * which accompanies this distribution, and is available at
 * https://www.eclipse.org/org/documents/epl-2.0/index.php
 *
 * Contributors:
 *    Bosch Software Innovations GmbH - initial contribution
 */
package org.eclipse.ditto.json;

import static java.util.Objects.requireNonNull;

import java.util.Iterator;
import java.util.LinkedHashSet;
import java.util.Objects;
import java.util.Set;

import javax.annotation.Nullable;
import javax.annotation.concurrent.NotThreadSafe;

/**
 * Builder for creating instances of {@link ImmutableJsonFieldSelector}.
 */
@NotThreadSafe
final class ImmutableJsonFieldSelectorBuilder implements JsonFieldSelectorBuilder {

    private final Set&lt;JsonPointer&gt; pointers;
    @Nullable private String jsonFieldSelectorString;

<span class="fc" id="L33">    private ImmutableJsonFieldSelectorBuilder() {</span>
<span class="fc" id="L34">        pointers = new LinkedHashSet&lt;&gt;(); // use LinkedHashSet to preserve insertion order</span>
<span class="fc" id="L35">    }</span>

    /**
     * Returns a new instance of {@code ImmutableJsonFieldSelectorBuilder}.
     *
     * @return the instance.
     */
    public static ImmutableJsonFieldSelectorBuilder newInstance() {
<span class="fc" id="L43">        return new ImmutableJsonFieldSelectorBuilder();</span>
    }

    @Override
    public JsonFieldSelectorBuilder addPointerString(final String pointerString,
            final String... furtherPointerStrings) {

<span class="fc" id="L50">        requireNonNull(furtherPointerStrings, &quot;The further JSON pointer strings to be added must not be null!&quot;);</span>

<span class="fc" id="L52">        addPointerString(pointerString);</span>
<span class="fc bfc" id="L53" title="All 2 branches covered.">        for (final String furtherPointerString : furtherPointerStrings) {</span>
<span class="fc" id="L54">            addPointerString(furtherPointerString);</span>
        }

<span class="fc" id="L57">        return this;</span>
    }

    private void addPointerString(@Nullable final CharSequence pointerString) {
<span class="pc bpc" id="L61" title="1 of 2 branches missed.">        if (null != pointerString) {</span>
<span class="fc" id="L62">            pointers.add(JsonFactory.newPointer(pointerString));</span>
        }
<span class="fc" id="L64">    }</span>

    @Override
    public JsonFieldSelectorBuilder addPointerStrings(final Iterable&lt;String&gt; pointerStrings) {
<span class="fc" id="L68">        requireNonNull(pointerStrings, &quot;The JSON pointer strings to be added must not be null!&quot;);</span>

<span class="fc bfc" id="L70" title="All 2 branches covered.">        for (final String pointerString : pointerStrings) {</span>
<span class="fc" id="L71">            addPointerString(pointerString);</span>
<span class="fc" id="L72">        }</span>

<span class="fc" id="L74">        return this;</span>
    }

    @Override
    public JsonFieldSelectorBuilder addPointer(@Nullable final JsonPointer pointer,
            final JsonPointer... furtherPointers) {

<span class="fc" id="L81">        requireNonNull(furtherPointers, &quot;The further JSON pointers to be added must not be null!&quot;);</span>

<span class="fc" id="L83">        addPointer(pointer);</span>
<span class="fc bfc" id="L84" title="All 2 branches covered.">        for (final JsonPointer furtherPointer : furtherPointers) {</span>
<span class="fc" id="L85">            addPointer(furtherPointer);</span>
        }

<span class="fc" id="L88">        return this;</span>
    }

    private void addPointer(@Nullable final JsonPointer pointer) {
<span class="fc bfc" id="L92" title="All 4 branches covered.">        final boolean pointerAdded = (null != pointer) &amp;&amp; pointers.add(pointer);</span>
<span class="pc bpc" id="L93" title="3 of 4 branches missed.">        if (null != jsonFieldSelectorString &amp;&amp; pointerAdded) {</span>
            // The field selector string can only be preserved as long as no additional pointers are added afterwards.
<span class="nc" id="L95">            jsonFieldSelectorString = null;</span>
        }
<span class="fc" id="L97">    }</span>

    @Override
    public JsonFieldSelectorBuilder addPointers(final Iterable&lt;JsonPointer&gt; pointers) {
<span class="fc" id="L101">        requireNonNull(pointers, &quot;The JSON pointers to be added must not be null!&quot;);</span>

<span class="fc bfc" id="L103" title="All 2 branches covered.">        for (final JsonPointer pointer : pointers) {</span>
<span class="fc" id="L104">            addPointer(pointer);</span>
<span class="fc" id="L105">        }</span>

<span class="fc" id="L107">        return this;</span>
    }

    @Override
    public JsonFieldSelectorBuilder addFieldDefinition(@Nullable final JsonFieldDefinition fieldDefinition,
            final JsonFieldDefinition... furtherFieldDefinitions) {

<span class="fc" id="L114">        requireNonNull(furtherFieldDefinitions, &quot;The further JSON field definitions to be added must not be null!&quot;);</span>

<span class="fc" id="L116">        addFieldDefinition(fieldDefinition);</span>
<span class="fc bfc" id="L117" title="All 2 branches covered.">        for (final JsonFieldDefinition furtherFieldDefinition : furtherFieldDefinitions) {</span>
<span class="fc" id="L118">            addFieldDefinition(furtherFieldDefinition);</span>
        }

<span class="fc" id="L121">        return this;</span>
    }

    private void addFieldDefinition(@Nullable final JsonFieldDefinition fieldDefinition) {
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">        if (null != fieldDefinition) {</span>
<span class="fc" id="L126">            addPointer(fieldDefinition.getPointer());</span>
        }
<span class="fc" id="L128">    }</span>

    @Override
    public JsonFieldSelectorBuilder addFieldDefinitions(final Iterable&lt;JsonFieldDefinition&gt; fieldDefinitions) {
<span class="fc" id="L132">        requireNonNull(fieldDefinitions, &quot;The JSON field definitions must not be null!&quot;);</span>

<span class="fc bfc" id="L134" title="All 2 branches covered.">        for (final JsonFieldDefinition fieldDefinition : fieldDefinitions) {</span>
<span class="fc" id="L135">            addFieldDefinition(fieldDefinition);</span>
<span class="fc" id="L136">        }</span>

<span class="fc" id="L138">        return this;</span>
    }

    @Override
    public JsonFieldSelectorBuilder addFieldSelector(final JsonFieldSelector fieldSelector) {
<span class="fc" id="L143">        return addPointers(requireNonNull(fieldSelector, &quot;The JSON field selector must not be null!&quot;));</span>
    }

    @Override
    public JsonFieldSelectorBuilder addFieldSelectorString(@Nullable final String fieldSelectorString,
            final JsonParseOptions options) {

<span class="fc" id="L150">        requireNonNull(options, &quot;The JSON parse options must not be null!&quot;);</span>
<span class="pc bpc" id="L151" title="1 of 4 branches missed.">        if (null == fieldSelectorString || fieldSelectorString.isEmpty()) {</span>
<span class="fc" id="L152">            return this;</span>
        }

<span class="fc" id="L155">        final JsonFieldSelector fieldSelector = JsonFactory.newFieldSelector(fieldSelectorString, options);</span>
<span class="fc" id="L156">        final boolean arePointersInitiallyEmpty = pointers.isEmpty();</span>
<span class="fc" id="L157">        addPointers(fieldSelector);</span>
<span class="pc bpc" id="L158" title="1 of 2 branches missed.">        if (arePointersInitiallyEmpty) {</span>
            // We can only set the field selector string if there were no other pointers beforehand.
<span class="fc" id="L160">            jsonFieldSelectorString = fieldSelectorString;</span>
        }

<span class="fc" id="L163">        return this;</span>
    }

    @Override
    public JsonFieldSelectorBuilder addFieldSelectorString(@Nullable final String fieldSelectorString) {
<span class="fc" id="L168">        final JsonParseOptions options = JsonFactory.newParseOptionsBuilder().withoutUrlDecoding().build();</span>
<span class="fc" id="L169">        return addFieldSelectorString(fieldSelectorString, options);</span>
    }

    @Override
    public JsonFieldSelectorBuilder removePointer(@Nullable final JsonPointer jsonPointer) {
<span class="pc bpc" id="L174" title="2 of 4 branches missed.">        final boolean pointerRemoved = (null != jsonPointer) &amp;&amp; pointers.remove(jsonPointer);</span>
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">        if (pointerRemoved) {</span>
<span class="fc" id="L176">            resetJsonFieldSelectorString();</span>
        }

<span class="fc" id="L179">        return this;</span>
    }

    @Override
    public JsonFieldSelectorBuilder removePointers(final Iterable&lt;JsonPointer&gt; jsonPointers) {
<span class="nc" id="L184">        requireNonNull(jsonPointers, &quot;The JSON Pointers to be removed must not be null!&quot;);</span>

<span class="nc bnc" id="L186" title="All 2 branches missed.">        for (final JsonPointer jsonPointer : jsonPointers) {</span>
<span class="nc" id="L187">            removePointer(jsonPointer);</span>
<span class="nc" id="L188">        }</span>

<span class="nc" id="L190">        return this;</span>
    }

    @Override
    public JsonFieldSelectorBuilder removePointerString(@Nullable final String pointerString) {
<span class="nc bnc" id="L195" title="All 2 branches missed.">        if (null == pointerString) {</span>
<span class="nc" id="L196">            return this;</span>
        }
<span class="nc" id="L198">        return removePointer(JsonFactory.newPointer(pointerString));</span>
    }

    @Override
    public JsonFieldSelectorBuilder removePointerStrings(final Iterable&lt;String&gt; pointerStrings) {
<span class="nc" id="L203">        requireNonNull(pointerStrings, &quot;The JSON Pointer strings to be removed must not be null!&quot;);</span>

<span class="nc bnc" id="L205" title="All 2 branches missed.">        for (final String pointerString : pointerStrings) {</span>
<span class="nc" id="L206">            removePointerString(pointerString);</span>
<span class="nc" id="L207">        }</span>

<span class="nc" id="L209">        return this;</span>
    }

    @Override
    public JsonFieldSelectorBuilder removeFieldDefinition(@Nullable final JsonFieldDefinition fieldDefinition) {
<span class="nc bnc" id="L214" title="All 2 branches missed.">        if (null == fieldDefinition) {</span>
<span class="nc" id="L215">            return this;</span>
        }
<span class="nc" id="L217">        return removePointer(fieldDefinition.getPointer());</span>
    }

    @Override
    public JsonFieldSelectorBuilder removeFieldDefinitions(final Iterable&lt;JsonFieldDefinition&gt; fieldDefinitions) {
<span class="nc" id="L222">        requireNonNull(fieldDefinitions, &quot;The JSON field definitions to be removed must not be null!&quot;);</span>

<span class="nc bnc" id="L224" title="All 2 branches missed.">        for (final JsonFieldDefinition fieldDefinition : fieldDefinitions) {</span>
<span class="nc" id="L225">            removeFieldDefinition(fieldDefinition);</span>
<span class="nc" id="L226">        }</span>

<span class="nc" id="L228">        return this;</span>
    }

    private void resetJsonFieldSelectorString() {
<span class="fc bfc" id="L232" title="All 2 branches covered.">        if (null != jsonFieldSelectorString) {</span>
<span class="fc" id="L233">            jsonFieldSelectorString = null;</span>
        }
<span class="fc" id="L235">    }</span>

    @Override
    public Iterator&lt;JsonPointer&gt; iterator() {
<span class="fc" id="L239">        return new JsonPointerIterator(pointers.iterator());</span>
    }

    @Override
    public JsonFieldSelector build() {
<span class="fc" id="L244">        return ImmutableJsonFieldSelector.of(pointers, jsonFieldSelectorString);</span>
    }

    @Override
    public boolean equals(final Object o) {
<span class="nc bnc" id="L249" title="All 2 branches missed.">        if (this == o) {</span>
<span class="nc" id="L250">            return true;</span>
        }
<span class="nc bnc" id="L252" title="All 4 branches missed.">        if (o == null || getClass() != o.getClass()) {</span>
<span class="nc" id="L253">            return false;</span>
        }
<span class="nc" id="L255">        final ImmutableJsonFieldSelectorBuilder that = (ImmutableJsonFieldSelectorBuilder) o;</span>
<span class="nc" id="L256">        return Objects.equals(pointers, that.pointers);</span>
    }

    @Override
    public int hashCode() {
<span class="nc" id="L261">        return Objects.hash(pointers);</span>
    }

    @Override
    public String toString() {
<span class="nc" id="L266">        return getClass().getSimpleName() + &quot; [&quot; + &quot;pointers=&quot; + pointers + &quot;]&quot;;</span>
    }

    private final class JsonPointerIterator implements Iterator&lt;JsonPointer&gt; {

        private final Iterator&lt;JsonPointer&gt; pointerIterator;
        private JsonPointer currentPointer;

<span class="fc" id="L274">        private JsonPointerIterator(final Iterator&lt;JsonPointer&gt; thePointerIterator) {</span>
<span class="fc" id="L275">            pointerIterator = thePointerIterator;</span>
<span class="fc" id="L276">            currentPointer = null;</span>
<span class="fc" id="L277">        }</span>

        @Override
        public boolean hasNext() {
<span class="fc" id="L281">            return pointerIterator.hasNext();</span>
        }

        @Override
        public JsonPointer next() {
<span class="fc" id="L286">            currentPointer = pointerIterator.next();</span>
<span class="fc" id="L287">            return currentPointer;</span>
        }

        @Override
        public void remove() {
<span class="fc" id="L292">            pointerIterator.remove();</span>
<span class="pc bpc" id="L293" title="1 of 2 branches missed.">            if (null != currentPointer) {</span>
<span class="fc" id="L294">                resetJsonFieldSelectorString();</span>
<span class="fc" id="L295">                currentPointer = null;</span>
            }
<span class="fc" id="L297">        }</span>

    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.0.201801022044</span></div></body></html>