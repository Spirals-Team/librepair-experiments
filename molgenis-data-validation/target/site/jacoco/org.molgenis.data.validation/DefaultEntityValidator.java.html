<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DefaultEntityValidator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">data-validation</a> &gt; <a href="index.source.html" class="el_package">org.molgenis.data.validation</a> &gt; <span class="el_source">DefaultEntityValidator.java</span></div><h1>DefaultEntityValidator.java</h1><pre class="source lang-java linenums">package org.molgenis.data.validation;

import com.google.common.collect.Lists;
import com.google.common.collect.Sets;
import org.apache.commons.lang3.StringUtils;
import org.molgenis.data.DataService;
import org.molgenis.data.DatabaseAction;
import org.molgenis.data.Entity;
import org.molgenis.data.meta.model.Attribute;
import org.molgenis.data.meta.model.EntityType;
import org.molgenis.data.support.QueryImpl;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Component;

import java.util.Iterator;
import java.util.List;
import java.util.Set;

import static java.util.Objects.requireNonNull;

@Component
public class DefaultEntityValidator implements EntityValidator
{
<span class="nc" id="L25">	private static final Logger LOG = LoggerFactory.getLogger(DefaultEntityValidator.class);</span>

	private final DataService dataService;
	private final EntityAttributesValidator entityAttributesValidator;
	private final ExpressionValidator expressionValidator;

	public DefaultEntityValidator(DataService dataService, EntityAttributesValidator entityAttributesValidator,
			ExpressionValidator expressionValidator)
<span class="nc" id="L33">	{</span>
<span class="nc" id="L34">		this.dataService = dataService;</span>
<span class="nc" id="L35">		this.entityAttributesValidator = entityAttributesValidator;</span>
<span class="nc" id="L36">		this.expressionValidator = requireNonNull(expressionValidator);</span>
<span class="nc" id="L37">	}</span>

	@Override
	public void validate(Iterable&lt;? extends Entity&gt; entities, EntityType meta, DatabaseAction dbAction)
	{
<span class="nc" id="L42">		Set&lt;ConstraintViolation&gt; violations = checkNotNull(entities, meta);</span>
<span class="nc" id="L43">		violations.addAll(checkUniques(entities, meta, dbAction));</span>

<span class="nc" id="L45">		long rownr = 0;</span>
<span class="nc bnc" id="L46" title="All 2 branches missed.">		for (Entity entity : entities)</span>
		{
<span class="nc" id="L48">			rownr++;</span>
<span class="nc" id="L49">			Set&lt;ConstraintViolation&gt; entityViolations = entityAttributesValidator.validate(entity, meta);</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">			for (ConstraintViolation entityViolation : entityViolations)</span>
			{
<span class="nc" id="L52">				entityViolation.setRowNr(rownr);</span>
<span class="nc" id="L53">				violations.add(entityViolation);</span>
<span class="nc" id="L54">			}</span>
<span class="nc" id="L55">		}</span>

<span class="nc bnc" id="L57" title="All 2 branches missed.">		if (!violations.isEmpty())</span>
		{
<span class="nc" id="L59">			LOG.info(&quot;Validation violations:&quot; + violations);</span>
<span class="nc" id="L60">			throw new MolgenisValidationException(violations);</span>
		}
<span class="nc" id="L62">	}</span>

	private Set&lt;ConstraintViolation&gt; checkNotNull(Iterable&lt;? extends Entity&gt; entities, EntityType meta)
	{
<span class="nc" id="L66">		Set&lt;ConstraintViolation&gt; violations = Sets.newLinkedHashSet();</span>

<span class="nc bnc" id="L68" title="All 2 branches missed.">		for (Attribute attr : meta.getAtomicAttributes())</span>
		{
<span class="nc bnc" id="L70" title="All 6 branches missed.">			if (!attr.isNillable() &amp;&amp; !attr.equals(meta.getIdAttribute()) &amp;&amp; !attr.isAuto())</span>
			{
<span class="nc" id="L72">				long rowNr = 0;</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">				for (Entity entity : entities)</span>
				{
<span class="nc" id="L75">					rowNr++;</span>
<span class="nc bnc" id="L76" title="All 4 branches missed.">					if (mustDoNotNullCheck(meta, attr, entity) &amp;&amp; entity.get(attr.getName()) == null)</span>
					{
<span class="nc" id="L78">						String message = String.format(</span>
<span class="nc" id="L79">								&quot;The attribute '%s' of entity '%s' with key '%s' can not be null.&quot;, attr.getName(),</span>
<span class="nc" id="L80">								meta.getId(), entity.getString(meta.getLabelAttribute().getName()));</span>
<span class="nc" id="L81">						violations.add(new ConstraintViolation(message, rowNr));</span>
					}
<span class="nc" id="L83">				}</span>
			}
<span class="nc" id="L85">		}</span>

<span class="nc" id="L87">		return violations;</span>
	}

	public boolean mustDoNotNullCheck(EntityType entityType, Attribute attr, Entity entity)
	{
		// Do not validate is visibleExpression resolves to false
<span class="nc bnc" id="L93" title="All 4 branches missed.">		if (StringUtils.isNotBlank(attr.getVisibleExpression()) &amp;&amp; !expressionValidator.resolveBooleanExpression(</span>
<span class="nc" id="L94">				attr.getVisibleExpression(), entity)) return false;</span>

<span class="nc" id="L96">		return true;</span>
	}

	private Set&lt;ConstraintViolation&gt; checkUniques(Iterable&lt;? extends Entity&gt; entities, EntityType meta,
			DatabaseAction dbAction)
	{
<span class="nc" id="L102">		Set&lt;ConstraintViolation&gt; violations = Sets.newLinkedHashSet();</span>

<span class="nc bnc" id="L104" title="All 2 branches missed.">		for (Attribute attr : meta.getAtomicAttributes())</span>
		{
<span class="nc bnc" id="L106" title="All 8 branches missed.">			if (attr.isUnique() &amp;&amp; !attr.equals(meta.getIdAttribute()) &amp;&amp; !(attr.equals(meta.getLabelAttribute()) &amp;&amp; (</span>
					dbAction == DatabaseAction.ADD_UPDATE_EXISTING)))
			{
				// Gather all attribute values
				// FIXME: keeping everything in memory is not scaleable
<span class="nc" id="L111">				List&lt;Object&gt; values = Lists.newArrayList();</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">				for (Entity entity : entities)</span>
				{
<span class="nc" id="L114">					Object value = entity.get(attr.getName());</span>
<span class="nc" id="L115">					values.add(value);</span>
<span class="nc" id="L116">				}</span>

				// Create 'in' query, should find only find itself or nothing
<span class="nc bnc" id="L119" title="All 2 branches missed.">				if (!values.isEmpty())</span>
				{
<span class="nc" id="L121">					String entityTypeId = meta.getId();</span>

<span class="nc" id="L123">					long count = dataService.count(entityTypeId, new QueryImpl&lt;&gt;().in(attr.getName(), values));</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">					if (count &gt; 0)</span>
					{
						// Go through the list to find the violators
<span class="nc" id="L127">						long found = 0;</span>
<span class="nc" id="L128">						Iterator&lt;? extends Entity&gt; it = entities.iterator();</span>

<span class="nc bnc" id="L130" title="All 4 branches missed.">						while (it.hasNext() &amp;&amp; (found &lt; count))</span>
						{
<span class="nc" id="L132">							Entity entity = it.next();</span>

<span class="nc" id="L134">							Object value = entity.get(attr.getName());</span>
<span class="nc" id="L135">							Entity existing = dataService.findOne(entityTypeId,</span>
<span class="nc" id="L136">									new QueryImpl&lt;&gt;().eq(attr.getName(), value));</span>

<span class="nc bnc" id="L138" title="All 2 branches missed.">							if (existing != null)</span>
							{
								// If dbAction is null check on id if its an update of itself or a new insert. Violation
								// if dbAction is ADD
<span class="nc bnc" id="L142" title="All 8 branches missed.">								if (((dbAction == null) &amp;&amp; !idEquals(entity, existing, meta)) || ((dbAction != null)</span>
										&amp;&amp; (dbAction == DatabaseAction.ADD)))
								{
<span class="nc" id="L145">									String message = String.format(</span>
											&quot;The attribute '%s' of entity '%s' with key '%s' must be unique, but the value '%s' already exists.&quot;,
<span class="nc" id="L147">											attr.getName(), meta.getId(),</span>
<span class="nc" id="L148">											entity.getString(meta.getLabelAttribute().getName()), value);</span>
<span class="nc" id="L149">									violations.add(new ConstraintViolation(message));</span>
								}

<span class="nc" id="L152">								found++;</span>
							}
<span class="nc" id="L154">						}</span>
					}
				}

			}
<span class="nc" id="L159">		}</span>

<span class="nc" id="L161">		return violations;</span>
	}

	// Check is two entities have the same id (pk)
	private boolean idEquals(Entity e1, Entity e2, EntityType meta)
	{
<span class="nc bnc" id="L167" title="All 2 branches missed.">		if (meta.getIdAttribute() != null)</span>
		{
<span class="nc" id="L169">			String id1 = e1.getString(meta.getIdAttribute().getName());</span>
<span class="nc" id="L170">			String id2 = e2.getString(meta.getIdAttribute().getName());</span>

<span class="nc bnc" id="L172" title="All 6 branches missed.">			if ((id1 != null) &amp;&amp; (id2 != null) &amp;&amp; id1.equals(id2))</span>
			{
<span class="nc" id="L174">				return true;</span>
			}
		}

<span class="nc" id="L178">		return false;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>