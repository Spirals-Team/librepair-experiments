<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GoogleAuthenticationProcessingFilter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">security</a> &gt; <a href="index.source.html" class="el_package">org.molgenis.security.google</a> &gt; <span class="el_source">GoogleAuthenticationProcessingFilter.java</span></div><h1>GoogleAuthenticationProcessingFilter.java</h1><pre class="source lang-java linenums">package org.molgenis.security.google;

import com.google.api.client.googleapis.auth.oauth2.GoogleIdToken;
import com.google.api.client.googleapis.auth.oauth2.GoogleIdToken.Payload;
import com.google.api.client.googleapis.auth.oauth2.GoogleIdTokenVerifier;
import com.google.api.client.googleapis.auth.oauth2.GooglePublicKeysManager;
import org.molgenis.data.DataService;
import org.molgenis.data.security.auth.User;
import org.molgenis.data.security.auth.UserFactory;
import org.molgenis.security.core.token.UnknownTokenException;
import org.molgenis.security.login.MolgenisLoginController;
import org.molgenis.security.settings.AuthenticationSettings;
import org.molgenis.security.user.UserDetailsService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.security.authentication.AuthenticationServiceException;
import org.springframework.security.authentication.BadCredentialsException;
import org.springframework.security.authentication.DisabledException;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.web.authentication.AbstractAuthenticationProcessingFilter;
import org.springframework.security.web.authentication.SimpleUrlAuthenticationFailureHandler;
import org.springframework.security.web.util.matcher.AntPathRequestMatcher;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.security.GeneralSecurityException;
import java.util.Collection;
import java.util.Collections;
import java.util.List;
import java.util.UUID;

import static java.lang.String.format;
import static java.util.Objects.requireNonNull;
import static org.molgenis.data.security.auth.UserMetaData.*;
import static org.molgenis.security.core.runas.RunAsSystemAspect.runAsSystem;
import static org.springframework.http.HttpMethod.POST;

public class GoogleAuthenticationProcessingFilter extends AbstractAuthenticationProcessingFilter
{
<span class="fc" id="L44">	private static final Logger LOG = LoggerFactory.getLogger(GoogleAuthenticationProcessingFilter.class);</span>

	public static final String GOOGLE_AUTHENTICATION_URL = &quot;/login/google&quot;;
	static final String PARAM_ID_TOKEN = &quot;id_token&quot;;
	private static final String PROFILE_KEY_GIVEN_NAME = &quot;given_name&quot;;
	private static final String PROFILE_KEY_FAMILY_NAME = &quot;family_name&quot;;

	private final GooglePublicKeysManager googlePublicKeysManager;
	private final DataService dataService;
	private final UserDetailsService userDetailsService;
	private final AuthenticationSettings authenticationSettings;
	private final UserFactory userFactory;

	public GoogleAuthenticationProcessingFilter(GooglePublicKeysManager googlePublicKeysManager,
			DataService dataService, UserDetailsService userDetailsService,
			AuthenticationSettings authenticationSettings, UserFactory userFactory)
	{
<span class="fc" id="L61">		super(new AntPathRequestMatcher(GOOGLE_AUTHENTICATION_URL, POST.toString()));</span>
<span class="fc" id="L62">		this.userFactory = requireNonNull(userFactory);</span>

<span class="fc" id="L64">		setAuthenticationFailureHandler(new SimpleUrlAuthenticationFailureHandler(&quot;/login?error&quot;));</span>

<span class="fc" id="L66">		this.googlePublicKeysManager = requireNonNull(googlePublicKeysManager);</span>
<span class="fc" id="L67">		this.dataService = requireNonNull(dataService);</span>
<span class="fc" id="L68">		this.userDetailsService = requireNonNull(userDetailsService);</span>
<span class="fc" id="L69">		this.authenticationSettings = requireNonNull(authenticationSettings);</span>
<span class="fc" id="L70">	}</span>

	@Override
	public Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response)
			throws IOException, ServletException
	{
<span class="fc bfc" id="L76" title="All 2 branches covered.">		if (!authenticationSettings.getGoogleSignIn())</span>
		{
<span class="fc" id="L78">			throw new AuthenticationServiceException(&quot;Google authentication not available&quot;);</span>
		}

<span class="fc" id="L81">		String idTokenString = request.getParameter(PARAM_ID_TOKEN);</span>

<span class="pc bpc" id="L83" title="1 of 2 branches missed.">		if (idTokenString != null)</span>
		{
			// verify token string is valid
			GoogleIdToken idToken;
			try
			{
<span class="nc" id="L89">				idToken = verify(idTokenString);</span>
			}
<span class="nc" id="L91">			catch (GeneralSecurityException e)</span>
			{
<span class="nc" id="L93">				throw new UnknownTokenException(e.getMessage(), e);</span>
<span class="nc" id="L94">			}</span>

			// google token is null implies that verification failed
<span class="nc bnc" id="L97" title="All 2 branches missed.">			if (idToken != null)</span>
			{
<span class="nc" id="L99">				return createAuthentication(idToken.getPayload());</span>
			}
			else
			{
<span class="nc" id="L103">				throw new BadCredentialsException(format(&quot;Token [%s] verification failed&quot;, idTokenString));</span>
			}
		}
<span class="fc" id="L106">		throw new UnknownTokenException(idTokenString);</span>
	}

	private GoogleIdToken verify(String idTokenString) throws GeneralSecurityException, IOException
	{
<span class="nc" id="L111">		List&lt;String&gt; audience = Collections.singletonList(authenticationSettings.getGoogleAppClientId());</span>
<span class="nc" id="L112">		GoogleIdTokenVerifier googleIdTokenVerifier = new GoogleIdTokenVerifier.Builder(</span>
<span class="nc" id="L113">				googlePublicKeysManager).setAudience(audience).build();</span>
<span class="nc" id="L114">		return googleIdTokenVerifier.verify(idTokenString);</span>
	}

	private Authentication createAuthentication(Payload payload)
	{
<span class="nc" id="L119">		String email = payload.getEmail();</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">		if (email == null)</span>
		{
<span class="nc" id="L122">			throw new AuthenticationServiceException(</span>
					&quot;Google URI token is missing required [email] claim, did you forget to specify scope [email]?&quot;);
		}
<span class="nc" id="L125">		Boolean emailVerified = payload.getEmailVerified();</span>
<span class="nc bnc" id="L126" title="All 4 branches missed.">		if (emailVerified != null &amp;&amp; !emailVerified)</span>
		{
<span class="nc" id="L128">			throw new AuthenticationServiceException(&quot;Google account email is not verified&quot;);</span>
		}
<span class="nc" id="L130">		String principal = payload.getSubject();</span>
<span class="nc" id="L131">		String credentials = payload.getAccessTokenHash();</span>

<span class="nc" id="L133">		return runAsSystem(() -&gt;</span>
		{
			User user;

<span class="nc" id="L137">			user = dataService.query(USER, User.class).eq(GOOGLEACCOUNTID, principal).findOne();</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">			if (user == null)</span>
			{
				// no user with google account
<span class="nc" id="L141">				user = dataService.query(USER, User.class).eq(EMAIL, email).findOne();</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">				if (user != null)</span>
				{
					// connect google account to user
<span class="nc" id="L145">					user.setGoogleAccountId(principal);</span>
<span class="nc" id="L146">					dataService.update(USER, user);</span>
				}
				else
				{
					// create new user
<span class="nc" id="L151">					String username = email;</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">					String givenName = payload.containsKey(PROFILE_KEY_GIVEN_NAME) ? payload.get(PROFILE_KEY_GIVEN_NAME)</span>
<span class="nc" id="L153">																							.toString() : null;</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">					String familyName = payload.containsKey(PROFILE_KEY_FAMILY_NAME) ? payload.get(</span>
<span class="nc" id="L155">							PROFILE_KEY_FAMILY_NAME).toString() : null;</span>
<span class="nc" id="L156">					user = createMolgenisUser(username, email, givenName, familyName, principal);</span>
				}
			}
<span class="nc bnc" id="L159" title="All 2 branches missed.">			if (!user.isActive())</span>
			{
<span class="nc" id="L161">				throw new DisabledException(MolgenisLoginController.ERROR_MESSAGE_DISABLED);</span>
			}
			// create authentication
<span class="nc" id="L164">			Collection&lt;? extends GrantedAuthority&gt; authorities = userDetailsService.getAuthorities(user);</span>
<span class="nc" id="L165">			return new UsernamePasswordAuthenticationToken(user.getUsername(), credentials, authorities);</span>
		});
	}

	private User createMolgenisUser(String username, String email, String givenName, String familyName,
			String googleAccountId)
	{
<span class="nc bnc" id="L172" title="All 2 branches missed.">		if (!authenticationSettings.getSignUp())</span>
		{
<span class="nc" id="L174">			throw new AuthenticationServiceException(&quot;Google authentication not possible: sign up disabled&quot;);</span>
		}

<span class="nc bnc" id="L177" title="All 2 branches missed.">		if (authenticationSettings.getSignUpModeration())</span>
		{
<span class="nc" id="L179">			throw new AuthenticationServiceException(&quot;Google authentication not possible: sign up moderation enabled&quot;);</span>
		}

		// create user
<span class="nc" id="L183">		LOG.info(&quot;first login for [{}], creating MOLGENIS user&quot;, username);</span>
<span class="nc" id="L184">		User user = userFactory.create();</span>
<span class="nc" id="L185">		user.setUsername(username);</span>
<span class="nc" id="L186">		user.setPassword(UUID.randomUUID().toString());</span>
<span class="nc" id="L187">		user.setEmail(email);</span>
<span class="nc" id="L188">		user.setActive(true);</span>
<span class="nc" id="L189">		user.setSuperuser(false);</span>
<span class="nc" id="L190">		user.setChangePassword(false);</span>
<span class="nc bnc" id="L191" title="All 2 branches missed.">		if (givenName != null)</span>
		{
<span class="nc" id="L193">			user.setFirstName(givenName);</span>
		}
<span class="nc bnc" id="L195" title="All 2 branches missed.">		if (familyName != null)</span>
		{
<span class="nc" id="L197">			user.setLastName(familyName);</span>
		}
<span class="nc" id="L199">		user.setGoogleAccountId(googleAccountId);</span>
<span class="nc" id="L200">		dataService.add(USER, user);</span>
<span class="nc" id="L201">		return user;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>