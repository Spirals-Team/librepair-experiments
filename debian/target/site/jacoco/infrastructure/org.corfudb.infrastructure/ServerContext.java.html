<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ServerContext.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">debian</a> &gt; <a href="../index.html" class="el_bundle">infrastructure</a> &gt; <a href="index.source.html" class="el_package">org.corfudb.infrastructure</a> &gt; <span class="el_source">ServerContext.java</span></div><h1>ServerContext.java</h1><pre class="source lang-java linenums">package org.corfudb.infrastructure;

import com.codahale.metrics.MetricRegistry;

import com.google.common.util.concurrent.ThreadFactoryBuilder;
import io.netty.channel.EventLoopGroup;
import java.time.Duration;
import java.util.*;

import java.util.concurrent.ThreadFactory;
import javax.annotation.Nonnull;
import lombok.Getter;
import lombok.Setter;

import lombok.extern.slf4j.Slf4j;
import org.corfudb.comm.ChannelImplementation;
import org.corfudb.runtime.CorfuRuntime;
import org.corfudb.runtime.CorfuRuntime.CorfuRuntimeParameters;
import org.corfudb.runtime.exceptions.WrongEpochException;
import org.corfudb.runtime.view.ConservativeFailureHandlerPolicy;
import org.corfudb.runtime.view.IReconfigurationHandlerPolicy;
import org.corfudb.runtime.view.Layout;
import org.corfudb.runtime.view.Layout.LayoutSegment;
import org.corfudb.infrastructure.management.FailureDetector;
import org.corfudb.infrastructure.management.HealingDetector;
import org.corfudb.infrastructure.management.IDetector;
import org.corfudb.runtime.view.SequencerHealingPolicy;
import org.corfudb.util.MetricsUtils;
import org.corfudb.util.UuidUtils;

import static org.corfudb.util.MetricsUtils.isMetricsReportingSetUp;

/**
 * Server Context:
 * &lt;ul&gt;
 * &lt;li&gt;Contains the common node level {@link DataStore}&lt;/li&gt;
 * &lt;li&gt;Responsible for Server level EPOCH &lt;/li&gt;
 * &lt;li&gt;Should contain common services/utilities that the different Servers in a node require.&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * &lt;p&gt;Note:
 * It is created in {@link CorfuServer} and then
 * passed to all the servers including {@link NettyServerRouter}.
 *
 * &lt;p&gt;Created by mdhawan on 8/5/16.
 */
<span class="nc" id="L47">@Slf4j</span>
public class ServerContext implements AutoCloseable {
    // Layout Server
    private static final String PREFIX_EPOCH = &quot;SERVER_EPOCH&quot;;
    private static final String KEY_EPOCH = &quot;CURRENT&quot;;
    private static final String PREFIX_LAYOUT = &quot;LAYOUT&quot;;
    private static final String KEY_LAYOUT = &quot;CURRENT&quot;;
    private static final String PREFIX_PHASE_1 = &quot;PHASE_1&quot;;
    private static final String KEY_SUFFIX_PHASE_1 = &quot;RANK&quot;;
    private static final String PREFIX_PHASE_2 = &quot;PHASE_2&quot;;
    private static final String KEY_SUFFIX_PHASE_2 = &quot;DATA&quot;;
    private static final String PREFIX_LAYOUTS = &quot;LAYOUTS&quot;;

    // Sequencer Server
    private static final String PREFIX_TAIL_SEGMENT = &quot;TAIL_SEGMENT&quot;;
    private static final String KEY_TAIL_SEGMENT = &quot;CURRENT&quot;;
    private static final String PREFIX_STARTING_ADDRESS = &quot;STARTING_ADDRESS&quot;;
    private static final String KEY_STARTING_ADDRESS = &quot;CURRENT&quot;;
    private static final String KEY_SEQUENCER = &quot;SEQUENCER&quot;;
    private static final String PREFIX_SEQUENCER_EPOCH = &quot;EPOCH&quot;;

    // Management Server
    private static final String PREFIX_MANAGEMENT = &quot;MANAGEMENT&quot;;
    private static final String MANAGEMENT_LAYOUT = &quot;LAYOUT&quot;;

    /** The node Id, stored as a base64 string. */
    public static final String NODE_ID = &quot;NODE_ID&quot;;

    /**
     * various duration constants.
     */
<span class="nc" id="L78">    public static final Duration SMALL_INTERVAL = Duration.ofMillis(60_000);</span>
<span class="nc" id="L79">    public static final Duration SHUTDOWN_TIMER = Duration.ofSeconds(5);</span>


<span class="nc" id="L82">    @Getter</span>
    private final Map&lt;String, Object&gt; serverConfig;

<span class="nc" id="L85">    @Getter</span>
    private final DataStore dataStore;

<span class="nc" id="L88">    @Getter</span>
<span class="nc" id="L89">    @Setter</span>
    private IServerRouter serverRouter;

<span class="nc" id="L92">    @Getter</span>
<span class="nc" id="L93">    @Setter</span>
    private IDetector failureDetector;

<span class="nc" id="L96">    @Getter</span>
<span class="nc" id="L97">    @Setter</span>
    private IDetector healingDetector;

<span class="nc" id="L100">    @Getter</span>
<span class="nc" id="L101">    @Setter</span>
    private IReconfigurationHandlerPolicy failureHandlerPolicy;

<span class="nc" id="L104">    @Getter</span>
<span class="nc" id="L105">    @Setter</span>
    private IReconfigurationHandlerPolicy healingHandlerPolicy;

<span class="nc" id="L108">    @Getter</span>
    private final EventLoopGroup clientGroup;

<span class="nc" id="L111">    @Getter</span>
    private final EventLoopGroup bossGroup;

<span class="nc" id="L114">    @Getter</span>
    private final EventLoopGroup workerGroup;

<span class="nc" id="L117">    @Getter</span>
<span class="nc" id="L118">    @Setter</span>
    private boolean bindToAllInterfaces = false;

<span class="nc" id="L121">    @Getter</span>
<span class="nc" id="L122">    public static final MetricRegistry metrics = new MetricRegistry();</span>

    /**
     * Returns a new ServerContext.
     *
     * @param serverConfig map of configuration strings to objects
     */
<span class="nc" id="L129">    public ServerContext(Map&lt;String, Object&gt; serverConfig) {</span>
<span class="nc" id="L130">        this.serverConfig = serverConfig;</span>
<span class="nc" id="L131">        this.dataStore = new DataStore(serverConfig);</span>
<span class="nc" id="L132">        generateNodeId();</span>
<span class="nc" id="L133">        this.serverRouter = serverRouter;</span>
<span class="nc" id="L134">        this.failureDetector = new FailureDetector();</span>
<span class="nc" id="L135">        this.healingDetector = new HealingDetector();</span>
<span class="nc" id="L136">        this.failureHandlerPolicy = new ConservativeFailureHandlerPolicy();</span>
<span class="nc" id="L137">        this.healingHandlerPolicy = new SequencerHealingPolicy();</span>

        // Setup the netty event loops. In tests, these loops may be provided by
        // a test framework to save resources.
<span class="nc" id="L141">        final boolean providedEventLoops =</span>
<span class="nc" id="L142">                 getChannelImplementation().equals(ChannelImplementation.LOCAL);</span>

<span class="nc bnc" id="L144" title="All 2 branches missed.">        clientGroup = providedEventLoops</span>
<span class="nc" id="L145">            ? getServerConfig(EventLoopGroup.class, &quot;client&quot;) :</span>
<span class="nc" id="L146">            getNewClientGroup();</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">        workerGroup = providedEventLoops</span>
<span class="nc" id="L148">            ? getServerConfig(EventLoopGroup.class, &quot;worker&quot;) :</span>
<span class="nc" id="L149">            getNewWorkerGroup();</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">        bossGroup = providedEventLoops</span>
<span class="nc" id="L151">            ? getServerConfig(EventLoopGroup.class, &quot;boss&quot;) :</span>
<span class="nc" id="L152">            getNewBossGroup();</span>

        // Metrics setup &amp; reporting configuration
<span class="nc" id="L155">        String mp = &quot;corfu.server.&quot;;</span>
<span class="nc" id="L156">        synchronized (metrics) {</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">            if (!isMetricsReportingSetUp(metrics)) {</span>
//                addJvmMetrics(metrics, mp);
//                MetricsUtils.addCacheGauges(metrics, mp + &quot;datastore.cache.&quot;, dataStore.getCache());
<span class="nc" id="L160">                MetricsUtils.metricsReportingSetup(metrics);</span>
            }
<span class="nc" id="L162">        }</span>
<span class="nc" id="L163">    }</span>

    /** Get the {@link ChannelImplementation}to use.
     *
     * @return              The server channel type.
     */
    public ChannelImplementation getChannelImplementation() {
<span class="nc" id="L170">        final String type = getServerConfig(String.class, &quot;--implementation&quot;);</span>
<span class="nc" id="L171">        return ChannelImplementation.valueOf(type.toUpperCase());</span>
    }


    public CorfuRuntimeParameters getDefaultRuntimeParameters() {
<span class="nc" id="L176">        return CorfuRuntime.CorfuRuntimeParameters.builder()</span>
<span class="nc" id="L177">                .nettyEventLoop(clientGroup)</span>
<span class="nc" id="L178">                .shutdownNettyEventLoop(false)</span>
<span class="nc" id="L179">                .tlsEnabled((Boolean) serverConfig.get(&quot;--enable-tls&quot;))</span>
<span class="nc" id="L180">                .keyStore((String) serverConfig.get(&quot;--keystore&quot;))</span>
<span class="nc" id="L181">                .ksPasswordFile((String) serverConfig.get(&quot;--keystore-password-file&quot;))</span>
<span class="nc" id="L182">                .trustStore((String) serverConfig.get(&quot;--truststore&quot;))</span>
<span class="nc" id="L183">                .tsPasswordFile((String) serverConfig.get(&quot;--truststore-password-file&quot;))</span>
<span class="nc" id="L184">                .saslPlainTextEnabled((Boolean) serverConfig.get(&quot;--enable-sasl-plain-text-auth&quot;))</span>
<span class="nc" id="L185">                .usernameFile((String) serverConfig.get(&quot;--sasl-plain-text-username-file&quot;))</span>
<span class="nc" id="L186">                .passwordFile((String) serverConfig.get(&quot;--sasl-plain-text-password-file&quot;))</span>
<span class="nc" id="L187">                .build();</span>
    }

    /** Generate a Node Id if not present.
     *
     */
    private void generateNodeId() {
<span class="nc" id="L194">        String currentId = getDataStore().get(String.class, &quot;&quot;, ServerContext.NODE_ID);</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">        if (currentId == null) {</span>
<span class="nc" id="L196">            String idString = UuidUtils.asBase64(UUID.randomUUID());</span>
<span class="nc" id="L197">            log.info(&quot;No Node Id, setting to new Id={}&quot;, idString);</span>
<span class="nc" id="L198">            getDataStore().put(String.class, &quot;&quot;, ServerContext.NODE_ID, idString);</span>
<span class="nc" id="L199">        } else {</span>
<span class="nc" id="L200">            log.info(&quot;Node Id = {}&quot;, currentId);</span>
        }
<span class="nc" id="L202">    }</span>

    /** Get the node id as an UUID.
     *
     * @return  A UUID for this node.
     */
    public UUID getNodeId() {
<span class="nc" id="L209">        return UuidUtils.fromBase64(getNodeIdBase64());</span>
    }

    /** Get the node id as a base64 string.
     *
     * @return A node ID for this node, as a base64 string.
     */
    public String getNodeIdBase64() {
<span class="nc" id="L217">        return getDataStore().get(String.class, &quot;&quot;, ServerContext.NODE_ID);</span>
    }

    /** Get a field from the server configuration map.
     *
     * @param type          The type of the field.
     * @param optionName    The name of the option to retrieve.
     * @param &lt;T&gt;           The type of the field to return.
     * @return              The field with the give option name.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    public &lt;T&gt; T getServerConfig(Class&lt;T&gt; type, String optionName) {
<span class="nc" id="L229">        return (T) getServerConfig().get(optionName);</span>
    }


    /** Install a single node layout if and only if no layout is currently installed.
     *  Synchronized, so this method is thread-safe.
     *
     *  @return True, if a new layout was installed, false otherwise.
     */
    public synchronized boolean installSingleNodeLayoutIfAbsent() {
<span class="nc bnc" id="L239" title="All 4 branches missed.">        if ((Boolean) getServerConfig().get(&quot;--single&quot;) &amp;&amp; getCurrentLayout() == null) {</span>
<span class="nc" id="L240">            setCurrentLayout(getNewSingleNodeLayout());</span>
<span class="nc" id="L241">            return true;</span>
        }
<span class="nc" id="L243">        return false;</span>
    }

    /** Get a new single node layout used for self-bootstrapping a server started with
     *  the -s flag.
     *
     *  @returns A new single node layout with a unique cluster Id
     *  @throws IllegalArgumentException    If the cluster id was not auto, base64 or a UUID string
     */
    public Layout getNewSingleNodeLayout() {
<span class="nc" id="L253">        final String clusterIdString = (String) getServerConfig().get(&quot;--cluster-id&quot;);</span>
        UUID clusterId;
<span class="nc bnc" id="L255" title="All 2 branches missed.">        if (clusterIdString.equals(&quot;auto&quot;)) {</span>
<span class="nc" id="L256">            clusterId = UUID.randomUUID();</span>
        } else {
            // Is it a UUID?
            try {
<span class="nc" id="L260">                clusterId = UUID.fromString(clusterIdString);</span>
<span class="nc" id="L261">            } catch (IllegalArgumentException ignore) {</span>
                // Must be a base64 id, otherwise we will throw InvalidArgumentException again
<span class="nc" id="L263">                clusterId = UuidUtils.fromBase64(clusterIdString);</span>
<span class="nc" id="L264">            }</span>
        }
<span class="nc" id="L266">        log.info(&quot;getNewSingleNodeLayout: Bootstrapping with cluster Id {} [{}]&quot;,</span>
<span class="nc" id="L267">            clusterId, UuidUtils.asBase64(clusterId));</span>
<span class="nc" id="L268">        String localAddress = getServerConfig().get(&quot;--address&quot;) + &quot;:&quot;</span>
<span class="nc" id="L269">            + getServerConfig().get(&quot;&lt;port&gt;&quot;);</span>
<span class="nc" id="L270">        return new Layout(</span>
<span class="nc" id="L271">            Collections.singletonList(localAddress),</span>
<span class="nc" id="L272">            Collections.singletonList(localAddress),</span>
<span class="nc" id="L273">            Collections.singletonList(new LayoutSegment(</span>
                Layout.ReplicationMode.CHAIN_REPLICATION,
                0L,
                -1L,
<span class="nc" id="L277">                Collections.singletonList(</span>
                    new Layout.LayoutStripe(
<span class="nc" id="L279">                        Collections.singletonList(localAddress)</span>
                    )
                )
            )),
            0L,
            clusterId
        );
    }

    /** Get the current {@link Layout} stored in the {@link DataStore}.
     *  @return The current stored {@link Layout}
     */
    public Layout getCurrentLayout() {
<span class="nc" id="L292">        return getDataStore().get(Layout.class, PREFIX_LAYOUT, KEY_LAYOUT);</span>
    }

    /** Set the current {@link Layout} stored in the {@link DataStore}.
     *
     * @param layout The {@link Layout} to set in the {@link DataStore}.
     */
    public void setCurrentLayout(Layout layout) {
<span class="nc" id="L300">        getDataStore().put(Layout.class, PREFIX_LAYOUT, KEY_LAYOUT, layout);</span>
<span class="nc" id="L301">    }</span>

    /**
     * The epoch of this router. This is managed by the base server implementation.
     */
    public synchronized long getServerEpoch() {
<span class="nc" id="L307">        Long epoch = dataStore.get(Long.class, PREFIX_EPOCH, KEY_EPOCH);</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">        return epoch == null ? 0 : epoch;</span>
    }

    /**
     * Set the serverRouter epoch.
     *
     * @param serverEpoch the epoch to set
     */
    public synchronized void setServerEpoch(long serverEpoch, IServerRouter r) {
<span class="nc" id="L317">        Long lastEpoch = dataStore.get(Long.class, PREFIX_EPOCH, KEY_EPOCH);</span>
<span class="nc bnc" id="L318" title="All 4 branches missed.">        if (lastEpoch == null || lastEpoch &lt; serverEpoch) {</span>
<span class="nc" id="L319">            dataStore.put(Long.class, PREFIX_EPOCH, KEY_EPOCH, serverEpoch);</span>
<span class="nc" id="L320">            r.setServerEpoch(serverEpoch);</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">        } else if (serverEpoch == lastEpoch) {</span>
            // Setting to the same epoch, don't need to do anything.
        } else {
            // Regressing, throw an exception.
<span class="nc" id="L325">            throw new WrongEpochException(lastEpoch);</span>
        }
<span class="nc" id="L327">    }</span>

    public Rank getPhase1Rank() {
<span class="nc" id="L330">        return dataStore.get(Rank.class, PREFIX_PHASE_1,</span>
<span class="nc" id="L331">                getServerEpoch() + KEY_SUFFIX_PHASE_1);</span>
    }

    public void setPhase1Rank(Rank rank) {
<span class="nc" id="L335">        dataStore.put(Rank.class, PREFIX_PHASE_1,</span>
<span class="nc" id="L336">                getServerEpoch() + KEY_SUFFIX_PHASE_1, rank);</span>
<span class="nc" id="L337">    }</span>

    public Phase2Data getPhase2Data() {
<span class="nc" id="L340">        return dataStore.get(Phase2Data.class, PREFIX_PHASE_2,</span>
<span class="nc" id="L341">                getServerEpoch() + KEY_SUFFIX_PHASE_2);</span>
    }

    public void setPhase2Data(Phase2Data phase2Data) {
<span class="nc" id="L345">        dataStore.put(Phase2Data.class, PREFIX_PHASE_2,</span>
<span class="nc" id="L346">                getServerEpoch() + KEY_SUFFIX_PHASE_2, phase2Data);</span>
<span class="nc" id="L347">    }</span>

    public void setLayoutInHistory(Layout layout) {
<span class="nc" id="L350">        dataStore.put(Layout.class, PREFIX_LAYOUTS, String.valueOf(layout.getEpoch()), layout);</span>
<span class="nc" id="L351">    }</span>

    public long getTailSegment() {
<span class="nc" id="L354">        Long tailSegment = dataStore.get(Long.class, PREFIX_TAIL_SEGMENT, KEY_TAIL_SEGMENT);</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">        return tailSegment == null ? 0 : tailSegment;</span>
    }

    public void setTailSegment(long tailSegment) {
<span class="nc" id="L359">        dataStore.put(Long.class, PREFIX_TAIL_SEGMENT, KEY_TAIL_SEGMENT, tailSegment);</span>
<span class="nc" id="L360">    }</span>

    /**
     * Returns the dataStore starting address.
     *
     * @return the starting address
     */
    public long getStartingAddress() {
<span class="nc" id="L368">        Long startingAddress = dataStore.get(Long.class, PREFIX_STARTING_ADDRESS,</span>
                KEY_STARTING_ADDRESS);
<span class="nc bnc" id="L370" title="All 2 branches missed.">        return startingAddress == null ? 0 : startingAddress;</span>
    }

    public void setStartingAddress(long startingAddress) {
<span class="nc" id="L374">        dataStore.put(Long.class, PREFIX_STARTING_ADDRESS, KEY_STARTING_ADDRESS, startingAddress);</span>
<span class="nc" id="L375">    }</span>

    /**
     * Persists the sequencer epoch. This is set only by the SequencerServer in the resetServer.
     * No lock required as it relies on the resetServer lock.
     *
     * @param sequencerEpoch Epoch to persist.
     */
    public void setSequencerEpoch(long sequencerEpoch) {
<span class="nc" id="L384">        dataStore.put(Long.class, KEY_SEQUENCER, PREFIX_SEQUENCER_EPOCH, sequencerEpoch);</span>
<span class="nc" id="L385">    }</span>

    /**
     * Fetch the persisted sequencer epoch.
     *
     * @return Sequencer epoch.
     */
    public long getSequencerEpoch() {
<span class="nc" id="L393">        Long epoch = dataStore.get(Long.class, KEY_SEQUENCER, PREFIX_SEQUENCER_EPOCH);</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">        return epoch == null ? Layout.INVALID_EPOCH : epoch;</span>
    }

    /**
     * Sets the management layout in the persistent datastore.
     *
     * @param layout Layout to be persisted
     */
    public synchronized void saveManagementLayout(Layout layout) {
        // Cannot update with a null layout.
<span class="nc bnc" id="L404" title="All 2 branches missed.">        if (layout == null) {</span>
<span class="nc" id="L405">            log.warn(&quot;saveManagementLayout: Attempted to update with null layout&quot;);</span>
<span class="nc" id="L406">            return;</span>
        }
<span class="nc" id="L408">        Layout currentLayout = getManagementLayout();</span>
        // Update only if new layout has a higher epoch than the existing layout.
<span class="nc bnc" id="L410" title="All 4 branches missed.">        if (currentLayout == null || layout.getEpoch() &gt; currentLayout.getEpoch()) {</span>
            // Persisting this new updated layout
<span class="nc" id="L412">            dataStore.put(Layout.class, PREFIX_MANAGEMENT, MANAGEMENT_LAYOUT, layout);</span>
<span class="nc" id="L413">            log.info(&quot;saveManagementLayout: Updated to new layout at epoch {}&quot;,</span>
<span class="nc" id="L414">                    getManagementLayout().getEpoch());</span>
        } else {
<span class="nc" id="L416">            log.debug(&quot;saveManagementLayout: &quot;</span>
                            + &quot;Ignoring layout because new epoch {} &lt;= old epoch {}&quot;,
<span class="nc" id="L418">                    layout.getEpoch(), currentLayout.getEpoch());</span>
        }
<span class="nc" id="L420">    }</span>

    /**
     * Fetches the management layout from the persistent datastore.
     *
     * @return The last persisted layout
     */
    public synchronized Layout getManagementLayout() {
<span class="nc" id="L428">        return dataStore.get(Layout.class, PREFIX_MANAGEMENT, MANAGEMENT_LAYOUT);</span>
    }

    /** Get a new &quot;boss&quot; group, which services (accepts) incoming connections.
     *
     * @return              A boss group.
     */
    private EventLoopGroup getNewBossGroup() {
<span class="nc" id="L436">        final ThreadFactory threadFactory = new ThreadFactoryBuilder()</span>
<span class="nc" id="L437">                .setNameFormat(getThreadPrefix() + &quot;accept-%d&quot;)</span>
<span class="nc" id="L438">                .build();</span>
<span class="nc" id="L439">        EventLoopGroup group = getChannelImplementation().getGenerator()</span>
<span class="nc" id="L440">                .generate(1, threadFactory);</span>
<span class="nc" id="L441">        log.info(&quot;getBossGroup: Type {}&quot;, group.getClass().getSimpleName());</span>
<span class="nc" id="L442">        return group;</span>
    }

    /** Get a new &quot;worker&quot; group, which services incoming requests.
     *
     * @return          A worker group.
     */
    private @Nonnull EventLoopGroup getNewWorkerGroup() {
<span class="nc" id="L450">        final ThreadFactory threadFactory = new ThreadFactoryBuilder()</span>
<span class="nc" id="L451">                .setNameFormat(getThreadPrefix() + &quot;worker-%d&quot;)</span>
<span class="nc" id="L452">                .build();</span>

<span class="nc" id="L454">        final int requestedThreads =</span>
<span class="nc" id="L455">                Integer.parseInt(getServerConfig(String.class, &quot;--Threads&quot;));</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">        final int numThreads = requestedThreads == 0</span>
<span class="nc" id="L457">                ? Runtime.getRuntime().availableProcessors() * 2</span>
                : requestedThreads;
<span class="nc" id="L459">        EventLoopGroup group = getChannelImplementation().getGenerator()</span>
<span class="nc" id="L460">            .generate(numThreads, threadFactory);</span>

<span class="nc" id="L462">        log.info(&quot;getWorkerGroup: Type {} with {} threads&quot;,</span>
<span class="nc" id="L463">                group.getClass().getSimpleName(), numThreads);</span>
<span class="nc" id="L464">        return group;</span>
    }

    /** Get a new &quot;client&quot; group, which services incoming client requests.
     *
     * @return          A worker group.
     */
    private @Nonnull EventLoopGroup getNewClientGroup() {
<span class="nc" id="L472">        final ThreadFactory threadFactory = new ThreadFactoryBuilder()</span>
<span class="nc" id="L473">                .setNameFormat(getThreadPrefix() + &quot;client-%d&quot;)</span>
<span class="nc" id="L474">                .build();</span>

<span class="nc" id="L476">        final int requestedThreads =</span>
<span class="nc" id="L477">            Integer.parseInt(getServerConfig(String.class, &quot;--Threads&quot;));</span>
<span class="nc bnc" id="L478" title="All 2 branches missed.">        final int numThreads = requestedThreads == 0</span>
<span class="nc" id="L479">            ? Runtime.getRuntime().availableProcessors() * 2</span>
            : requestedThreads;
<span class="nc" id="L481">        EventLoopGroup group = getChannelImplementation().getGenerator()</span>
<span class="nc" id="L482">            .generate(numThreads, threadFactory);</span>

<span class="nc" id="L484">        log.info(&quot;getClientGroup: Type {} with {} threads&quot;,</span>
<span class="nc" id="L485">            group.getClass().getSimpleName(), numThreads);</span>
<span class="nc" id="L486">        return group;</span>
    }

    /** Get the prefix for threads this server creates.
     *
     * @return  A string that should be prepended to threads this server creates.
     */
    public @Nonnull String getThreadPrefix() {
<span class="nc" id="L494">        final String prefix = getServerConfig(String.class, &quot;--Prefix&quot;);</span>
<span class="nc bnc" id="L495" title="All 2 branches missed.">        if (prefix.equals(&quot;&quot;)) {</span>
<span class="nc" id="L496">            return &quot;&quot;;</span>
        } else {
<span class="nc" id="L498">            return prefix + &quot;-&quot;;</span>
        }
    }

    /**
     * {@inheritDoc}
     *
     * &lt;p&gt;Cleans up and releases all resources (such as thread pools and files) opened
     * by this {@link ServerContext}.
     */
    @Override
    public void close() {
        // Shutdown the active event loops unless they were provided to us
<span class="nc bnc" id="L511" title="All 2 branches missed.">        if (!getChannelImplementation().equals(ChannelImplementation.LOCAL)) {</span>
<span class="nc" id="L512">            clientGroup.shutdownGracefully();</span>
<span class="nc" id="L513">            bossGroup.shutdownGracefully();</span>
<span class="nc" id="L514">            workerGroup.shutdownGracefully();</span>
        }
<span class="nc" id="L516">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>