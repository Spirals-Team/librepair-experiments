<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AttributeFilterToFetchConverter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">data-rest</a> &gt; <a href="index.source.html" class="el_package">org.molgenis.data.rest.v2</a> &gt; <span class="el_source">AttributeFilterToFetchConverter.java</span></div><h1>AttributeFilterToFetchConverter.java</h1><pre class="source lang-java linenums">package org.molgenis.data.rest.v2;

import org.molgenis.data.Fetch;
import org.molgenis.data.UnknownAttributeException;
import org.molgenis.data.file.model.FileMetaMetaData;
import org.molgenis.data.meta.AttributeType;
import org.molgenis.data.meta.model.Attribute;
import org.molgenis.data.meta.model.EntityType;

import static org.molgenis.data.meta.AttributeType.FILE;
import static org.molgenis.data.support.EntityTypeUtils.isReferenceType;

/**
 * Converts {@link AttributeFilter} to {@link Fetch}.
 */
<span class="nc" id="L16">public class AttributeFilterToFetchConverter</span>
{
	/**
	 * Converts {@link AttributeFilter} to {@link Fetch} based on {@link EntityType}.
	 *
	 * @param attrFilter the {@link AttributeFilter} to convert
	 * @param entityType {@link EntityType} for the entity
	 * @return {@link Fetch}, or null for 'all attributes' {@link AttributeFilter} there are no refEntities
	 * @throws UnknownAttributeException if the entity does not have one of the attributes mentioned in the filter
	 */
	public static Fetch convert(AttributeFilter attrFilter, EntityType entityType, String languageCode)
	{
<span class="fc bfc" id="L28" title="All 4 branches covered.">		if (attrFilter == null || attrFilter.isStar())</span>
		{
<span class="fc" id="L30">			return createDefaultEntityFetch(entityType, languageCode);</span>
		}

<span class="fc" id="L33">		Fetch fetch = new Fetch();</span>
<span class="fc" id="L34">		createFetchContentRec(attrFilter, entityType, fetch, languageCode);</span>
<span class="fc" id="L35">		return fetch;</span>
	}

	private static void createFetchContentRec(AttributeFilter attrFilter, EntityType entityType, Fetch fetch,
			String languageCode)
	{
<span class="fc bfc" id="L41" title="All 2 branches covered.">		if (attrFilter.isIncludeAllAttrs())</span>
		{
<span class="fc" id="L43">			entityType.getAtomicAttributes()</span>
<span class="fc" id="L44">					  .forEach(attr -&gt; fetch.field(attr.getName(), createDefaultAttributeFetch(attr, languageCode)));</span>
		}

<span class="fc bfc" id="L47" title="All 2 branches covered.">		if (attrFilter.isIncludeIdAttr())</span>
		{
<span class="fc" id="L49">			fetch.field(entityType.getIdAttribute().getName());</span>
		}

<span class="fc bfc" id="L52" title="All 2 branches covered.">		if (attrFilter.isIncludeLabelAttr())</span>
		{
<span class="fc" id="L54">			fetch.field(entityType.getLabelAttribute(languageCode).getName());</span>
		}

<span class="fc" id="L57">		attrFilter.forEach(entry -&gt;</span>
		{
<span class="fc" id="L59">			String attrName = entry.getKey();</span>
<span class="fc" id="L60">			Attribute attr = getAttribute(entityType, attrName);</span>
<span class="fc" id="L61">			createFetchContentRec(attrFilter, entityType, attr, fetch, languageCode);</span>
<span class="fc" id="L62">		});</span>
<span class="fc" id="L63">	}</span>

	private static void createFetchContentRec(AttributeFilter attrFilter, EntityType entityType, Attribute attr,
			Fetch fetch, String languageCode)
	{
<span class="fc" id="L68">		AttributeType attrType = attr.getDataType();</span>
<span class="pc bfc" id="L69" title="All 3 branches covered.">		switch (attrType)</span>
		{
			case COMPOUND:
			{
<span class="fc bfc" id="L73" title="All 2 branches covered.">				AttributeFilter subAttrFilter =</span>
<span class="fc" id="L74">						attrFilter != null ? attrFilter.getAttributeFilter(entityType, attr) : null;</span>
<span class="pc bpc" id="L75" title="1 of 4 branches missed.">				if (subAttrFilter != null &amp;&amp; !subAttrFilter.isIncludeAllAttrs())</span>
				{
					// include compound attribute parts defined by filter
<span class="pc bpc" id="L78" title="1 of 2 branches missed.">					if (subAttrFilter.isIncludeIdAttr())</span>
					{
<span class="nc" id="L80">						createFetchContentRec(subAttrFilter, entityType, entityType.getIdAttribute(), fetch,</span>
								languageCode);
					}
<span class="pc bpc" id="L83" title="1 of 2 branches missed.">					if (subAttrFilter.isIncludeLabelAttr())</span>
					{
<span class="nc" id="L85">						createFetchContentRec(subAttrFilter, entityType, entityType.getLabelAttribute(languageCode),</span>
								fetch, languageCode);
					}
<span class="fc" id="L88">					subAttrFilter.forEach(entry -&gt;</span>
					{
<span class="fc" id="L90">						String attrPartName = entry.getKey();</span>
<span class="fc" id="L91">						Attribute attrPart = attr.getChild(attrPartName);</span>
<span class="fc" id="L92">						createFetchContentRec(subAttrFilter, entityType, attrPart, fetch, languageCode);</span>
<span class="fc" id="L93">					});</span>
				}
				else
				{
					// include all compound attribute parts
<span class="fc" id="L98">					attr.getChildren()</span>
<span class="fc" id="L99">						.forEach(attrPart -&gt; createFetchContentRec(subAttrFilter, entityType, attrPart, fetch,</span>
								languageCode));
				}
<span class="fc" id="L102">				break;</span>
			}
			case CATEGORICAL:
			case CATEGORICAL_MREF:
			case FILE:
			case MREF:
			case XREF:
			case ONE_TO_MANY:
			{
<span class="fc bfc" id="L111" title="All 2 branches covered.">				AttributeFilter subAttrFilter =</span>
<span class="fc" id="L112">						attrFilter != null ? attrFilter.getAttributeFilter(entityType, attr) : null;</span>
				Fetch subFetch;
<span class="fc bfc" id="L114" title="All 2 branches covered.">				if (subAttrFilter != null)</span>
				{
<span class="fc" id="L116">					subFetch = convert(subAttrFilter, attr.getRefEntity(), languageCode);</span>

				}
				else
				{
<span class="fc" id="L121">					subFetch = createDefaultAttributeFetch(attr, languageCode);</span>
				}
<span class="fc" id="L123">				fetch.field(attr.getName(), subFetch);</span>
<span class="fc" id="L124">				break;</span>
			}
			// $CASES-OMITTED$
			default:
<span class="fc" id="L128">				fetch.field(attr.getName());</span>
				break;
		}
<span class="fc" id="L131">	}</span>

	private static Attribute getAttribute(EntityType entityType, String attrName)
	{
<span class="fc" id="L135">		Attribute attr = entityType.getAttribute(attrName);</span>
<span class="fc bfc" id="L136" title="All 2 branches covered.">		if (attr == null)</span>
		{
<span class="fc" id="L138">			throw new UnknownAttributeException(entityType, attrName);</span>
		}
<span class="fc" id="L140">		return attr;</span>
	}

	/**
	 * Create default entity fetch that fetches all attributes.
	 *
	 * @return default entity fetch or null
	 */
	public static Fetch createDefaultEntityFetch(EntityType entityType, String languageCode)
	{
<span class="fc" id="L150">		boolean hasRefAttr = false;</span>
<span class="fc" id="L151">		Fetch fetch = new Fetch();</span>
<span class="fc bfc" id="L152" title="All 2 branches covered.">		for (Attribute attr : entityType.getAtomicAttributes())</span>
		{
<span class="fc" id="L154">			Fetch subFetch = createDefaultAttributeFetch(attr, languageCode);</span>
<span class="fc bfc" id="L155" title="All 2 branches covered.">			if (subFetch != null)</span>
			{
<span class="fc" id="L157">				hasRefAttr = true;</span>
			}
<span class="fc" id="L159">			fetch.field(attr.getName(), subFetch);</span>
<span class="fc" id="L160">		}</span>
<span class="fc bfc" id="L161" title="All 2 branches covered.">		return hasRefAttr ? fetch : null;</span>
	}

	/**
	 * Create default fetch for the given attribute. For attributes referencing entities the id and label value are
	 * fetched. Additionally for file entities the URL is fetched. For other attributes the default fetch is null;
	 *
	 * @return default attribute fetch or null
	 */
	public static Fetch createDefaultAttributeFetch(Attribute attr, String languageCode)
	{
		Fetch fetch;
<span class="fc bfc" id="L173" title="All 2 branches covered.">		if (isReferenceType(attr))</span>
		{
<span class="fc" id="L175">			fetch = new Fetch();</span>
<span class="fc" id="L176">			EntityType refEntityType = attr.getRefEntity();</span>
<span class="fc" id="L177">			String idAttrName = refEntityType.getIdAttribute().getName();</span>
<span class="fc" id="L178">			fetch.field(idAttrName);</span>

<span class="fc" id="L180">			String labelAttrName = refEntityType.getLabelAttribute(languageCode).getName();</span>
<span class="fc bfc" id="L181" title="All 2 branches covered.">			if (!labelAttrName.equals(idAttrName))</span>
			{
<span class="fc" id="L183">				fetch.field(labelAttrName);</span>
			}

<span class="fc bfc" id="L186" title="All 2 branches covered.">			if (attr.getDataType() == FILE)</span>
			{
<span class="fc" id="L188">				fetch.field(FileMetaMetaData.URL);</span>
			}
<span class="fc" id="L190">		}</span>
		else
		{
<span class="fc" id="L193">			fetch = null;</span>
		}
<span class="fc" id="L195">		return fetch;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>