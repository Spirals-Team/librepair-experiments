<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SnpEffRunner.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">data-annotators</a> &gt; <a href="index.source.html" class="el_package">org.molgenis.data.annotation.core.entity.impl.snpeff</a> &gt; <span class="el_source">SnpEffRunner.java</span></div><h1>SnpEffRunner.java</h1><pre class="source lang-java linenums">package org.molgenis.data.annotation.core.entity.impl.snpeff;

import com.google.common.collect.Iterators;
import com.google.common.collect.Lists;
import com.google.common.collect.PeekingIterator;
import org.molgenis.data.Entity;
import org.molgenis.data.MolgenisDataException;
import org.molgenis.data.annotation.core.effects.EffectsMetaData;
import org.molgenis.data.annotation.core.utils.JarRunner;
import org.molgenis.data.annotation.web.settings.SnpEffAnnotatorSettings;
import org.molgenis.data.meta.model.Attribute;
import org.molgenis.data.meta.model.AttributeFactory;
import org.molgenis.data.meta.model.EntityType;
import org.molgenis.data.meta.model.EntityTypeFactory;
import org.molgenis.data.populate.IdGenerator;
import org.molgenis.data.support.DynamicEntity;
import org.molgenis.data.vcf.VcfRepository;
import org.molgenis.data.vcf.model.VcfAttributes;
import org.molgenis.security.core.runas.RunAsSystemAspect;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Component;

import java.io.*;
import java.util.*;
import java.util.regex.Pattern;

import static com.google.common.collect.Iterators.peekingIterator;
import static java.io.File.createTempFile;
import static org.molgenis.data.annotation.core.effects.EffectsMetaData.*;
import static org.molgenis.data.meta.AttributeType.XREF;

@Component
public class SnpEffRunner
{
	private final EntityTypeFactory entityTypeFactory;
	private final AttributeFactory attributeFactory;
	private final VcfAttributes vcfAttributes;

<span class="fc" id="L40">	private static final Logger LOG = LoggerFactory.getLogger(SnpEffAnnotator.class);</span>

	private String snpEffPath;

	private static final String CHARSET = &quot;UTF-8&quot;;
	public static final String ENTITY_NAME_SUFFIX = &quot;EFFECTS&quot;;

	public static final String NAME = &quot;snpEff&quot;;
	public static final String ANN = &quot;ANN&quot;;

<span class="fc" id="L50">	private EffectsMetaData effectsMetaData = new EffectsMetaData();</span>

	private final JarRunner jarRunner;
	private final Entity snpEffAnnotatorSettings;
	private final IdGenerator idGenerator;

	public SnpEffRunner(JarRunner jarRunner, Entity snpEffAnnotatorSettings, IdGenerator idGenerator,
			VcfAttributes vcfAttributes, EffectsMetaData effectsMetaData, EntityTypeFactory entityTypeFactory,
			AttributeFactory attributeFactory)
<span class="fc" id="L59">	{</span>
<span class="fc" id="L60">		this.jarRunner = jarRunner;</span>
<span class="fc" id="L61">		this.snpEffAnnotatorSettings = snpEffAnnotatorSettings;</span>
<span class="fc" id="L62">		this.idGenerator = idGenerator;</span>
<span class="fc" id="L63">		this.vcfAttributes = vcfAttributes;</span>
<span class="fc" id="L64">		this.effectsMetaData = effectsMetaData;</span>
<span class="fc" id="L65">		this.entityTypeFactory = entityTypeFactory;</span>
<span class="fc" id="L66">		this.attributeFactory = attributeFactory;</span>
<span class="fc" id="L67">	}</span>

	public Iterator&lt;Entity&gt; getSnpEffects(Iterable&lt;Entity&gt; source)
	{
		try
		{
<span class="nc" id="L73">			File inputVcf = getInputVcfFile(source.iterator());</span>
<span class="nc" id="L74">			return getSnpEffects(source.iterator(), inputVcf);</span>
		}
<span class="nc" id="L76">		catch (IOException e)</span>
		{
<span class="nc" id="L78">			throw new MolgenisDataException(&quot;Exception making temporary VCF file&quot;, e);</span>
		}
	}

	@SuppressWarnings(&quot;resource&quot;)
	public Iterator&lt;Entity&gt; getSnpEffects(Iterator&lt;Entity&gt; source, final File inputVcf)
	{
		try
		{
<span class="pc bpc" id="L87" title="1 of 2 branches missed.">			if (!source.hasNext()) return Collections.&lt;Entity&gt;emptyList().iterator();</span>

			// get meta data by peeking at the first entity (work-around for issue #4701)
<span class="fc" id="L90">			PeekingIterator&lt;Entity&gt; peekingSourceIterator = Iterators.peekingIterator(source);</span>
<span class="fc" id="L91">			EntityType sourceEMD = peekingSourceIterator.peek().getEntityType();</span>

<span class="fc" id="L93">			List&lt;String&gt; params = Arrays.asList(&quot;-Xmx2g&quot;, getSnpEffPath(), &quot;hg19&quot;, &quot;-noStats&quot;, &quot;-noLog&quot;, &quot;-lof&quot;,</span>
					&quot;-canon&quot;, &quot;-ud&quot;, &quot;0&quot;, &quot;-spliceSiteSize&quot;, &quot;5&quot;);
<span class="fc" id="L95">			File outputVcf = jarRunner.runJar(NAME, params, inputVcf);</span>

<span class="fc" id="L97">			VcfRepository repo = new VcfRepository(outputVcf, &quot;SNPEFF_OUTPUT_VCF_&quot; + inputVcf.getName(), vcfAttributes,</span>
					entityTypeFactory, attributeFactory);

<span class="fc" id="L100">			PeekingIterator&lt;Entity&gt; snpEffResultIterator = peekingIterator(repo.iterator());</span>

<span class="fc" id="L102">			return new Iterator&lt;Entity&gt;()</span>
<span class="fc" id="L103">			{</span>
<span class="fc" id="L104">				final LinkedList&lt;Entity&gt; effects = Lists.newLinkedList();</span>

				@Override
				public boolean hasNext()
				{
<span class="fc bfc" id="L109" title="All 4 branches covered.">					return (peekingSourceIterator.hasNext() || !effects.isEmpty());</span>
				}

				@Override
				public Entity next()
				{
<span class="fc bfc" id="L115" title="All 2 branches covered.">					if (effects.isEmpty())</span>
					{
						// go to next source entity and get effects
<span class="fc" id="L118">						Entity sourceEntity = peekingSourceIterator.next();</span>
<span class="fc" id="L119">						String chromosome = sourceEntity.getString(VcfAttributes.CHROM);</span>
<span class="fc" id="L120">						Integer position = sourceEntity.getInt(VcfAttributes.POS);</span>

<span class="pc bpc" id="L122" title="2 of 4 branches missed.">						if (chromosome != null &amp;&amp; position != null)</span>
						{
<span class="fc" id="L124">							Entity snpEffEntity = getSnpEffEntity(snpEffResultIterator, chromosome, position);</span>
<span class="fc bfc" id="L125" title="All 2 branches covered.">							if (snpEffEntity != null)</span>
							{
<span class="fc" id="L127">								effects.addAll(getSnpEffectsFromSnpEffEntity(sourceEntity, snpEffEntity,</span>
<span class="fc" id="L128">										getTargetEntityType(sourceEMD)));</span>
							}
							else
							{
<span class="fc" id="L132">								effects.add(getEmptyEffectsEntity(sourceEntity, getTargetEntityType(sourceEMD)));</span>
							}
<span class="fc" id="L134">						}</span>
						else
						{
<span class="nc" id="L137">							effects.add(getEmptyEffectsEntity(sourceEntity, getTargetEntityType(sourceEMD)));</span>
						}
					}
<span class="fc" id="L140">					return effects.removeFirst();</span>
				}

			};
		}
<span class="nc" id="L145">		catch (IOException e)</span>
		{
<span class="nc" id="L147">			throw new UncheckedIOException(e);</span>
		}
<span class="nc" id="L149">		catch (InterruptedException e)</span>
		{
<span class="nc" id="L151">			throw new MolgenisDataException(&quot;Exception running SnpEff&quot;, e);</span>
		}
	}

	/**
	 * Returns the next entity containing SnpEff annotations if its Chrom and Pos match. This implementation works
	 * because SnpEff always returns output in the same order as the input
	 *
	 * @param snpEffResultIterator the snpEff results
	 * @param chromosome           chromosome for the entity that is being annotated
	 * @param position             position for the entity that is being annotated
	 * @return {@link Entity}
	 */
	private Entity getSnpEffEntity(PeekingIterator&lt;Entity&gt; snpEffResultIterator, String chromosome, int position)
	{
<span class="pc bpc" id="L166" title="1 of 2 branches missed.">		if (snpEffResultIterator.hasNext())</span>
		{
<span class="fc" id="L168">			Entity entityCandidate = snpEffResultIterator.peek();</span>
<span class="fc bfc" id="L169" title="All 4 branches covered.">			if (chromosome.equals(entityCandidate.getString(VcfAttributes.CHROM)) &amp;&amp; position == entityCandidate.getInt(</span>
<span class="pc bpc" id="L170" title="1 of 2 branches missed.">					VcfAttributes.POS) &amp;&amp; entityCandidate.getString(SnpEffRunner.ANN) != null)</span>
			{
<span class="fc" id="L172">				snpEffResultIterator.next();</span>
<span class="fc" id="L173">				return entityCandidate;</span>
			}
		}
<span class="fc" id="L176">		return null;</span>
	}

	private Entity getEmptyEffectsEntity(Entity sourceEntity, EntityType effectsEMD)
	{
<span class="fc" id="L181">		Entity effect = new DynamicEntity(effectsEMD);</span>
<span class="fc" id="L182">		effect.set(ID, idGenerator.generateId());</span>
<span class="fc" id="L183">		effect.set(VARIANT, sourceEntity);</span>

<span class="fc" id="L185">		return effect;</span>
	}

	// ANN=G|intron_variant|MODIFIER|LOC101926913|LOC101926913|transcript|NR_110185.1|Noncoding|5/5|n.376+9526G&gt;C||||||,G|non_coding_exon_variant|MODIFIER|LINC01124|LINC01124|transcript|NR_027433.1|Noncoding|1/1|n.590G&gt;C||||||;
	private List&lt;Entity&gt; getSnpEffectsFromSnpEffEntity(Entity sourceEntity, Entity snpEffEntity, EntityType effectsEMD)
	{
<span class="fc" id="L191">		String[] annotations = snpEffEntity.getString(SnpEffRunner.ANN).split(Pattern.quote(&quot;,&quot;), -1);</span>

<span class="fc" id="L193">		List&lt;Entity&gt; effects = Lists.newArrayList();</span>
<span class="fc bfc" id="L194" title="All 2 branches covered.">		for (String annotation : annotations)</span>
		{
<span class="fc" id="L196">			String[] fields = annotation.split(Pattern.quote(&quot;|&quot;), -1);</span>

<span class="fc" id="L198">			Entity effect = new DynamicEntity(effectsEMD);</span>

<span class="pc bpc" id="L200" title="1 of 2 branches missed.">			if (fields.length &gt;= 15)</span>
			{
<span class="fc" id="L202">				effect.set(ID, idGenerator.generateId());</span>
<span class="fc" id="L203">				effect.set(VARIANT, sourceEntity);</span>

<span class="fc" id="L205">				effect.set(ALT, fields[0]);</span>
<span class="fc" id="L206">				effect.set(GENE_NAME, fields[4]);</span>
<span class="fc" id="L207">				effect.set(ANNOTATION, fields[1]);</span>
<span class="fc" id="L208">				effect.set(PUTATIVE_IMPACT, fields[2]);</span>
<span class="fc" id="L209">				effect.set(GENE_NAME, fields[3]);</span>
<span class="fc" id="L210">				effect.set(GENE_ID, fields[4]);</span>
<span class="fc" id="L211">				effect.set(FEATURE_TYPE, fields[5]);</span>
<span class="fc" id="L212">				effect.set(FEATURE_ID, fields[6]);</span>
<span class="fc" id="L213">				effect.set(TRANSCRIPT_BIOTYPE, fields[7]);</span>
<span class="fc" id="L214">				effect.set(RANK_TOTAL, fields[8]);</span>
<span class="fc" id="L215">				effect.set(HGVS_C, fields[9]);</span>
<span class="fc" id="L216">				effect.set(HGVS_P, fields[10]);</span>
<span class="fc" id="L217">				effect.set(C_DNA_POSITION, fields[11]);</span>
<span class="fc" id="L218">				effect.set(CDS_POSITION, fields[12]);</span>
<span class="fc" id="L219">				effect.set(PROTEIN_POSITION, fields[13]);</span>
<span class="fc" id="L220">				effect.set(DISTANCE_TO_FEATURE, fields[14]);</span>
<span class="fc" id="L221">				effect.set(ERRORS, fields[15]);</span>
			}
			else
			{
<span class="nc" id="L225">				LOG.info(&quot;No results for CHROM:{} POS:{} REF:{} ALT:{} &quot;, effect.getString(VcfAttributes.CHROM),</span>
<span class="nc" id="L226">						effect.getString(VcfAttributes.POS), effect.getString(VcfAttributes.REF),</span>
<span class="nc" id="L227">						effect.getString(VcfAttributes.ALT));</span>
			}

<span class="fc" id="L230">			effects.add(effect);</span>
		}

<span class="fc" id="L233">		return effects;</span>
	}

	/**
	 * Converts entities to a VCF file that can be passed to SnpEff.
	 *
	 * @param source the Entities to convert to VCF
	 * @return a VCF file
	 */
	public File getInputVcfFile(Iterator&lt;Entity&gt; source) throws IOException
	{
<span class="fc" id="L244">		File vcf = createTempFile(NAME, &quot;.vcf&quot;);</span>
<span class="fc" id="L245">		try (BufferedWriter bw = new BufferedWriter(new OutputStreamWriter(new FileOutputStream(vcf), CHARSET)))</span>
		{
<span class="fc" id="L247">			bw.write(VcfAttributes.CHROM + &quot;\t&quot; + VcfAttributes.POS + &quot;\t&quot; + VcfAttributes.ID + &quot;\t&quot; + VcfAttributes.REF</span>
					+ &quot;\t&quot; + VcfAttributes.ALT + &quot;\t&quot; + VcfAttributes.QUAL + &quot;\t&quot; + VcfAttributes.FILTER + &quot;\t&quot;
					+ VcfAttributes.INFO + &quot;\n&quot;);
<span class="fc bfc" id="L250" title="All 2 branches covered.">			while (source.hasNext())</span>
			{
<span class="fc" id="L252">				Entity entity = source.next();</span>
<span class="fc" id="L253">				StringBuilder builder = new StringBuilder();</span>
<span class="fc" id="L254">				builder.append(entity.getString(VcfAttributes.CHROM));</span>
<span class="fc" id="L255">				builder.append(&quot;\t&quot;);</span>
<span class="fc" id="L256">				builder.append(entity.getInt(VcfAttributes.POS));</span>
<span class="fc" id="L257">				builder.append(&quot;\t.\t&quot;);//ID</span>
<span class="fc" id="L258">				builder.append(entity.getString(VcfAttributes.REF));</span>
<span class="fc" id="L259">				builder.append(&quot;\t&quot;);</span>
<span class="fc" id="L260">				builder.append(entity.getString(VcfAttributes.ALT));</span>
<span class="fc" id="L261">				builder.append(&quot;\t.\t&quot;);//QUAL</span>
<span class="fc" id="L262">				builder.append(&quot;\t.\t&quot;);//FILTER</span>
<span class="fc" id="L263">				builder.append(&quot;.&quot;);//INFO</span>

<span class="fc bfc" id="L265" title="All 2 branches covered.">				if (source.hasNext())</span>
				{
<span class="fc" id="L267">					builder.append(&quot;\n&quot;);</span>
				}

<span class="fc" id="L270">				bw.write(builder.toString());</span>
<span class="fc" id="L271">			}</span>
		}

<span class="fc" id="L274">		return vcf;</span>
	}

	/**
	 * Gets the path to the SnpEff JAR. Returns null when the path is not found or snpEffAnnotatorSettings is null.
	 *
	 * @return the path to the SnpEff JAR, or null
	 */
	public String getSnpEffPath()
	{
<span class="pc bpc" id="L284" title="1 of 2 branches missed.">		if (snpEffAnnotatorSettings != null)</span>
		{
<span class="fc" id="L286">			snpEffPath = RunAsSystemAspect.runAsSystem(</span>
<span class="fc" id="L287">					() -&gt; snpEffAnnotatorSettings.getString(SnpEffAnnotatorSettings.Meta.SNPEFF_JAR_LOCATION));</span>

<span class="pc bpc" id="L289" title="1 of 2 branches missed.">			if (snpEffPath != null)</span>
			{
<span class="nc" id="L291">				File snpEffFile = new File(snpEffPath);</span>
<span class="nc bnc" id="L292" title="All 4 branches missed.">				if (snpEffFile.exists() &amp;&amp; snpEffFile.isFile())</span>
				{
<span class="nc" id="L294">					LOG.info(&quot;SnpEff found at: &quot; + snpEffFile.getAbsolutePath());</span>
				}
				else
				{
<span class="nc" id="L298">					LOG.debug(&quot;SnpEff not found at: &quot; + snpEffFile.getAbsolutePath());</span>
<span class="nc" id="L299">					snpEffPath = null;</span>
				}
			}
		}

<span class="fc" id="L304">		return snpEffPath;</span>
	}

	/**
	 * @param sourceEntityType The entity type for the entity that is being annotated by snpEff
	 * @return entityType Returns the EntityType for the effect entity
	 */
	public EntityType getTargetEntityType(EntityType sourceEntityType)
	{
<span class="fc" id="L313">		EntityType entityType = entityTypeFactory.create()</span>
<span class="fc" id="L314">												 .setId(sourceEntityType.getId() + ENTITY_NAME_SUFFIX)</span>
<span class="fc" id="L315">												 .setLabel(sourceEntityType.getId() + &quot;_&quot; + ENTITY_NAME_SUFFIX)</span>
<span class="fc" id="L316">												 .setPackage(sourceEntityType.getPackage());</span>
<span class="fc" id="L317">		entityType.setBackend(sourceEntityType.getBackend());</span>
<span class="fc" id="L318">		Attribute id = attributeFactory.create()</span>
<span class="fc" id="L319">									   .setName(EffectsMetaData.ID)</span>
<span class="fc" id="L320">									   .setAuto(true)</span>
<span class="fc" id="L321">									   .setVisible(false)</span>
<span class="fc" id="L322">									   .setIdAttribute(true);</span>
<span class="fc" id="L323">		entityType.addAttribute(id);</span>
<span class="fc bfc" id="L324" title="All 2 branches covered.">		for (Attribute attr : effectsMetaData.getOrderedAttributes())</span>
		{
<span class="fc" id="L326">			entityType.addAttribute(attr);</span>
<span class="fc" id="L327">		}</span>
<span class="fc" id="L328">		entityType.addAttribute(attributeFactory.create()</span>
<span class="fc" id="L329">												.setName(EffectsMetaData.VARIANT)</span>
<span class="fc" id="L330">												.setNillable(false)</span>
<span class="fc" id="L331">												.setDataType(XREF)</span>
<span class="fc" id="L332">												.setRefEntity(sourceEntityType));</span>
<span class="fc" id="L333">		return entityType;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>