<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>QueryImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">data</a> &gt; <a href="index.source.html" class="el_package">org.molgenis.data.support</a> &gt; <span class="el_source">QueryImpl.java</span></div><h1>QueryImpl.java</h1><pre class="source lang-java linenums">package org.molgenis.data.support;

import org.molgenis.data.*;
import org.molgenis.data.QueryRule.Operator;

import java.util.*;
import java.util.stream.Stream;

public class QueryImpl&lt;E extends Entity&gt; implements Query&lt;E&gt;
{
<span class="fc" id="L11">	private final List&lt;List&lt;QueryRule&gt;&gt; rules = new ArrayList&lt;&gt;();</span>

	private int offset;
	private int pageSize;
	private Sort sort;
	/**
	 * {@link Fetch} that defines which entity attributes to retrieve.
	 */
	private Fetch fetch;

	@Override
	public Repository&lt;E&gt; getRepository()
	{
<span class="fc" id="L24">		return repository;</span>
	}

	public void setRepository(Repository&lt;E&gt; repository)
	{
<span class="nc" id="L29">		this.repository = repository;</span>
<span class="nc" id="L30">	}</span>

	private Repository&lt;E&gt; repository;

	public static &lt;T extends Entity&gt; Query&lt;T&gt; query()
	{
<span class="fc" id="L36">		return new QueryImpl&lt;&gt;();</span>
	}

	public static &lt;T extends Entity&gt; Query&lt;T&gt; EQ(String attributeName, Object value)
	{
<span class="fc" id="L41">		return QueryImpl.&lt;T&gt;query().eq(attributeName, value);</span>
	}

	public static &lt;T extends Entity&gt; Query&lt;T&gt; IN(String attributeName, Iterable&lt;?&gt; values)
	{
<span class="nc" id="L46">		return QueryImpl.&lt;T&gt;query().in(attributeName, values);</span>
	}

	public QueryImpl()
<span class="fc" id="L50">	{</span>
<span class="fc" id="L51">		this.rules.add(new ArrayList&lt;&gt;());</span>
<span class="fc" id="L52">	}</span>

	public QueryImpl(Repository&lt;E&gt; repository)
	{
<span class="fc" id="L56">		this();</span>
<span class="fc" id="L57">		this.repository = repository;</span>
<span class="fc" id="L58">	}</span>

	public QueryImpl(Query&lt;E&gt; q)
	{
<span class="fc" id="L62">		this();</span>
<span class="pc bpc" id="L63" title="1 of 2 branches missed.">		for (QueryRule rule : q.getRules())</span>
		{
<span class="nc" id="L65">			addRule(rule);</span>
<span class="nc" id="L66">		}</span>
<span class="fc" id="L67">		this.pageSize = q.getPageSize();</span>
<span class="fc" id="L68">		this.offset = q.getOffset();</span>
<span class="fc" id="L69">		this.sort = q.getSort();</span>
<span class="fc" id="L70">		this.fetch = q.getFetch();</span>
<span class="fc" id="L71">	}</span>

	public QueryImpl(QueryRule queryRule)
	{
<span class="nc" id="L75">		this();</span>
<span class="nc" id="L76">		addRule(queryRule);</span>
<span class="nc" id="L77">	}</span>

	public QueryImpl(List&lt;QueryRule&gt; queryRules)
	{
<span class="nc" id="L81">		this();</span>
<span class="nc" id="L82">		queryRules.forEach(this::addRule);</span>
<span class="nc" id="L83">	}</span>

	public void addRule(QueryRule rule)
	{
<span class="fc" id="L87">		this.rules.get(this.rules.size() - 1).add(rule);</span>
<span class="fc" id="L88">	}</span>

	@Override
	public Long count()
	{
<span class="nc bnc" id="L93" title="All 2 branches missed.">		if (repository == null) throw new RuntimeException(&quot;Query failed: repository not set&quot;);</span>
<span class="nc" id="L94">		return repository.count(this);</span>
	}

	@Override
	public Stream&lt;E&gt; findAll()
	{
<span class="pc bpc" id="L100" title="1 of 2 branches missed.">		if (repository == null) throw new RuntimeException(&quot;Query failed: repository not set&quot;);</span>
<span class="fc" id="L101">		return repository.findAll(this);</span>
	}

	@Override
	public E findOne()
	{
<span class="nc bnc" id="L107" title="All 2 branches missed.">		if (repository == null) throw new RuntimeException(&quot;Query failed: repository not set&quot;);</span>
<span class="nc" id="L108">		return repository.findOne(this);</span>
	}

	@Override
	public List&lt;QueryRule&gt; getRules()
	{
<span class="pc bpc" id="L114" title="1 of 2 branches missed.">		if (this.rules.size() &gt; 1)</span>
<span class="nc" id="L115">			throw new MolgenisDataException(&quot;Nested query not closed, use unnest() or unnestAll()&quot;);</span>

<span class="pc bpc" id="L117" title="1 of 2 branches missed.">		if (!this.rules.isEmpty())</span>
		{
<span class="fc" id="L119">			List&lt;QueryRule&gt; rules = this.rules.get(this.rules.size() - 1);</span>

<span class="fc" id="L121">			return Collections.unmodifiableList(rules);</span>
		}
<span class="nc" id="L123">		else return Collections.emptyList();</span>
	}

	@Override
	public int getPageSize()
	{
<span class="fc" id="L129">		return pageSize;</span>
	}

	public QueryImpl&lt;E&gt; setPageSize(int pageSize)
	{
<span class="fc" id="L134">		this.pageSize = pageSize;</span>
<span class="fc" id="L135">		return this;</span>
	}

	@Override
	public int getOffset()
	{
<span class="fc" id="L141">		return offset;</span>
	}

	public QueryImpl&lt;E&gt; setOffset(int offset)
	{
<span class="fc" id="L146">		this.offset = offset;</span>
<span class="fc" id="L147">		return this;</span>
	}

	@Override
	public Sort getSort()
	{
<span class="fc" id="L153">		return sort;</span>
	}

	public void setSort(Sort sort)
	{
<span class="nc" id="L158">		this.sort = sort;</span>
<span class="nc" id="L159">	}</span>

	@Override
	public Query&lt;E&gt; search(String searchTerms)
	{
<span class="nc" id="L164">		rules.get(this.rules.size() - 1).add(new QueryRule(Operator.SEARCH, searchTerms));</span>
<span class="nc" id="L165">		return this;</span>
	}

	@Override
	public Query&lt;E&gt; search(String field, String searchTerms)
	{
<span class="nc" id="L171">		rules.get(this.rules.size() - 1).add(new QueryRule(field, Operator.SEARCH, searchTerms));</span>
<span class="nc" id="L172">		return this;</span>
	}

	@Override
	public Query&lt;E&gt; or()
	{
<span class="fc" id="L178">		rules.get(this.rules.size() - 1).add(new QueryRule(Operator.OR));</span>
<span class="fc" id="L179">		return this;</span>
	}

	@Override
	public Query&lt;E&gt; and()
	{
<span class="fc" id="L185">		rules.get(this.rules.size() - 1).add(new QueryRule(Operator.AND));</span>
<span class="fc" id="L186">		return this;</span>
	}

	@Override
	public Query&lt;E&gt; not()
	{
<span class="nc" id="L192">		rules.get(this.rules.size() - 1).add(new QueryRule(Operator.NOT));</span>
<span class="nc" id="L193">		return this;</span>
	}

	@Override
	public Query&lt;E&gt; like(String field, String value)
	{
<span class="nc" id="L199">		rules.get(this.rules.size() - 1).add(new QueryRule(field, Operator.LIKE, value));</span>
<span class="nc" id="L200">		return this;</span>
	}

	@Override
	public Query&lt;E&gt; eq(String field, Object value)
	{
<span class="fc" id="L206">		rules.get(this.rules.size() - 1).add(new QueryRule(field, Operator.EQUALS, value));</span>
<span class="fc" id="L207">		return this;</span>
	}

	@Override
	public Query&lt;E&gt; in(String field, Iterable&lt;?&gt; valueIterable)
	{
<span class="fc" id="L213">		rules.get(this.rules.size() - 1).add(new QueryRule(field, Operator.IN, valueIterable));</span>
<span class="fc" id="L214">		return this;</span>
	}

	@Override
	public Query&lt;E&gt; gt(String field, Object value)
	{
<span class="nc" id="L220">		rules.get(this.rules.size() - 1).add(new QueryRule(field, Operator.GREATER, value));</span>
<span class="nc" id="L221">		return this;</span>
	}

	@Override
	public Query&lt;E&gt; ge(String field, Object value)
	{
<span class="nc" id="L227">		rules.get(this.rules.size() - 1).add(new QueryRule(field, Operator.GREATER_EQUAL, value));</span>
<span class="nc" id="L228">		return this;</span>
	}

	@Override
	public Query&lt;E&gt; le(String field, Object value)
	{
<span class="nc" id="L234">		rules.get(this.rules.size() - 1).add(new QueryRule(field, Operator.LESS_EQUAL, value));</span>
<span class="nc" id="L235">		return this;</span>
	}

	@Override
	public Query&lt;E&gt; lt(String field, Object value)
	{
<span class="nc" id="L241">		rules.get(this.rules.size() - 1).add(new QueryRule(field, Operator.LESS, value));</span>
<span class="nc" id="L242">		return this;</span>
	}

	@Override
	public Query&lt;E&gt; nest()
	{
		// add element to our nesting list...
<span class="fc" id="L249">		this.rules.add(new ArrayList&lt;&gt;());</span>
<span class="fc" id="L250">		return this;</span>
	}

	@Override
	public Query&lt;E&gt; unnest()
	{
<span class="pc bpc" id="L256" title="1 of 2 branches missed.">		if (this.rules.size() == 1) throw new MolgenisDataException(&quot;Cannot unnest root element of query&quot;);</span>

		// remove last element and add to parent as nested rule
<span class="fc" id="L259">		QueryRule nested = new QueryRule(Operator.NESTED, this.rules.get(this.rules.size() - 1));</span>
<span class="fc" id="L260">		this.rules.remove(this.rules.get(this.rules.size() - 1));</span>
<span class="fc" id="L261">		this.rules.get(this.rules.size() - 1).add(nested);</span>
<span class="fc" id="L262">		return this;</span>
	}

	@Override
	public Query&lt;E&gt; unnestAll()
	{
<span class="nc bnc" id="L268" title="All 2 branches missed.">		while (this.rules.size() &gt; 1)</span>
		{
<span class="nc" id="L270">			unnest();</span>
		}
<span class="nc" id="L272">		return this;</span>
	}

	@Override
	public Query&lt;E&gt; rng(String field, Object from, Object to)
	{
<span class="fc" id="L278">		rules.get(this.rules.size() - 1).add(new QueryRule(field, Operator.RANGE, Arrays.asList(from, to)));</span>
<span class="fc" id="L279">		return this;</span>
	}

	@Override
	public Query&lt;E&gt; pageSize(int pageSize)
	{
<span class="nc" id="L285">		setPageSize(pageSize);</span>
<span class="nc" id="L286">		return this;</span>
	}

	@Override
	public Query&lt;E&gt; offset(int offset)
	{
<span class="nc" id="L292">		setOffset(offset);</span>
<span class="nc" id="L293">		return this;</span>
	}

	@Override
	public Sort sort()
	{
<span class="nc" id="L299">		this.sort = new Sort();</span>
<span class="nc" id="L300">		return this.sort;</span>
	}

	@Override
	public Query&lt;E&gt; sort(Sort sort)
	{
<span class="nc" id="L306">		setSort(sort);</span>
<span class="nc" id="L307">		return this;</span>
	}

	@Override
	public Iterator&lt;E&gt; iterator()
	{
<span class="nc bnc" id="L313" title="All 2 branches missed.">		if (repository == null) throw new RuntimeException(&quot;Query failed: repository not set&quot;);</span>
<span class="nc" id="L314">		return repository.findAll(this).iterator();</span>
	}

	@Override
	public Fetch getFetch()
	{
<span class="fc" id="L320">		return fetch;</span>
	}

	@Override
	public void setFetch(Fetch fetch)
	{
<span class="fc" id="L326">		this.fetch = fetch;</span>
<span class="fc" id="L327">	}</span>

	@Override
	public Fetch fetch()
	{
<span class="fc" id="L332">		this.fetch = new Fetch();</span>
<span class="fc" id="L333">		return getFetch();</span>
	}

	@Override
	public Query&lt;E&gt; fetch(Fetch fetch)
	{
<span class="fc" id="L339">		setFetch(fetch);</span>
<span class="fc" id="L340">		return this;</span>
	}

	@Override
	public boolean equals(Object o)
	{
<span class="pc bpc" id="L346" title="1 of 2 branches missed.">		if (this == o) return true;</span>
<span class="pc bpc" id="L347" title="2 of 4 branches missed.">		if (o == null || getClass() != o.getClass()) return false;</span>
<span class="fc" id="L348">		QueryImpl&lt;?&gt; query = (QueryImpl&lt;?&gt;) o;</span>
<span class="pc bpc" id="L349" title="2 of 6 branches missed.">		return offset == query.offset &amp;&amp; pageSize == query.pageSize &amp;&amp; Objects.equals(rules, query.rules)</span>
<span class="pc bpc" id="L350" title="1 of 2 branches missed.">				&amp;&amp; Objects.equals(sort, query.sort);</span>
	}

	@Override
	public int hashCode()
	{
<span class="nc" id="L356">		return Objects.hash(rules, offset, pageSize, sort);</span>
	}

	@Override
	public String toString()
	{
<span class="fc" id="L362">		StringBuilder builder = new StringBuilder();</span>
<span class="pc bpc" id="L363" title="1 of 2 branches missed.">		if (!rules.isEmpty())</span>
		{
<span class="pc bpc" id="L365" title="1 of 2 branches missed.">			if (rules.size() == 1)</span>
			{
<span class="fc" id="L367">				List&lt;QueryRule&gt; rule = rules.get(0);</span>
<span class="pc bpc" id="L368" title="1 of 2 branches missed.">				if (!rule.isEmpty())</span>
				{
<span class="fc" id="L370">					builder.append(&quot;rules=&quot;).append(rule);</span>
				}
<span class="fc" id="L372">			}</span>
			else
			{
<span class="nc" id="L375">				builder.append(&quot;rules=&quot;).append(rules);</span>
			}
		}
<span class="pc bpc" id="L378" title="1 of 2 branches missed.">		if (offset != 0)</span>
		{
<span class="nc bnc" id="L380" title="All 2 branches missed.">			if (builder.length() &gt; 0)</span>
			{
<span class="nc" id="L382">				builder.append(&quot;, &quot;);</span>
			}
<span class="nc" id="L384">			builder.append(&quot;offset=&quot;).append(offset);</span>
		}
<span class="pc bpc" id="L386" title="1 of 2 branches missed.">		if (pageSize != 0)</span>
		{
<span class="nc bnc" id="L388" title="All 2 branches missed.">			if (builder.length() &gt; 0)</span>
			{
<span class="nc" id="L390">				builder.append(&quot;, &quot;);</span>
			}
<span class="nc" id="L392">			builder.append(&quot;pageSize=&quot;).append(pageSize);</span>
		}
<span class="pc bpc" id="L394" title="1 of 2 branches missed.">		if (sort != null)</span>
		{
<span class="nc bnc" id="L396" title="All 2 branches missed.">			if (builder.length() &gt; 0)</span>
			{
<span class="nc" id="L398">				builder.append(&quot;, &quot;);</span>
			}
<span class="nc" id="L400">			builder.append(&quot;sort=&quot;).append(sort);</span>
		}
<span class="pc bpc" id="L402" title="1 of 2 branches missed.">		if (fetch != null)</span>
		{
<span class="nc bnc" id="L404" title="All 2 branches missed.">			if (builder.length() &gt; 0)</span>
			{
<span class="nc" id="L406">				builder.append(&quot;, &quot;);</span>
			}
<span class="nc" id="L408">			builder.append(&quot;fetch=&quot;).append(fetch);</span>
		}
<span class="fc" id="L410">		return builder.toString();</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>